<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroFin Manager v9.9.9 (Margin Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
        .animate-slideIn { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.3s ease-in-out; }
        .receipt-pattern { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 8px 8px; }
        /* Toggle Switch Styles */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        @media print {
            body > * { display: none !important; }
            body > .print-visible { display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; height: auto !important; z-index: 9999 !important; background: white !important; margin: 0 !important; padding: 0 !important; overflow: visible !important; }
            .print-visible .bg-white { box-shadow: none !important; max-width: 100% !important; width: 100% !important; border-radius: 0 !important; }
            .print-visible .overflow-y-auto { overflow: visible !important; height: auto !important; max-height: none !important; }
        .print-visible * { visibility: visible !important; }
        .no-print { display: none !important; }
    }
    /* Custom Scrollbar for Sidebar */
    .sidebar-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-hidden">

    <div class="flex h-screen">
        <aside class="w-64 bg-slate-900 text-slate-300 flex-col hidden md:flex transition-all duration-300 h-screen">
            <!-- Header: Logo -->
            <div class="p-6 pb-4 shrink-0">
                <div class="flex items-center gap-3 text-white">
                    <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/50"><i data-lucide="dollar-sign" class="w-5 h-5"></i></div>
                    <div><span class="font-bold text-lg tracking-tight block">MicroFin</span><span class="text-[10px] text-slate-400">Manager v9.9.9</span></div>
                </div>
            </div>
            
            <!-- Nav: Scrollable Area -->
            <div class="flex-1 overflow-y-auto px-4 pb-4 sidebar-scroll">
                <nav class="space-y-1" id="desktop-nav"></nav>
            </div>

            <!-- Footer: User Profile -->
            <div class="p-4 border-t border-slate-800 shrink-0">
                 <div class="flex items-center gap-3 p-2 rounded hover:bg-slate-800 transition cursor-pointer group" onclick="App.logout()">
                     <div id="user-avatar" class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold shadow-lg">AD</div>
                     <div class="flex-1 min-w-0">
                         <p class="text-sm font-medium text-white truncate" id="user-name">Admin</p>
                         <p class="text-[10px] text-slate-500 truncate uppercase" id="user-role">Administrator</p>
                     </div>
                     <i data-lucide="log-out" class="w-4 h-4 text-slate-500 group-hover:text-red-400 transition"></i>
                 </div>
            </div>
        </aside>

        <div id="mobile-menu-overlay" class="fixed inset-0 z-40 hidden">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="App.toggleMobileMenu(false)"></div>
            <aside class="absolute left-0 top-0 bottom-0 w-64 bg-slate-900 text-slate-300 flex flex-col animate-slideIn shadow-2xl h-full">
                <!-- Mobile Header -->
                <div class="p-6 pb-4 shrink-0">
                    <div class="flex items-center gap-3 text-white"><i data-lucide="dollar-sign" class="w-5 h-5"></i><span class="font-bold text-lg">MicroFin</span></div>
                </div>
                
                <!-- Mobile Nav: Scrollable -->
                <div class="flex-1 overflow-y-auto px-4 pb-4 sidebar-scroll">
                    <nav class="space-y-1" id="mobile-nav"></nav>
                </div>

                <!-- Mobile Footer -->
                <div class="p-4 border-t border-slate-800 shrink-0">
                    <button onclick="App.logout()" class="w-full flex items-center gap-2 text-red-400 hover:text-red-300 text-sm font-bold p-2"><i data-lucide="log-out" class="w-4 h-4"></i> Logout</button>
                </div>
            </aside>
        </div>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            <header class="bg-white border-b border-slate-200 p-4 md:hidden flex justify-between items-center z-10 shrink-0">
                <span class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="dollar-sign" class="text-blue-600 w-5 h-5"></i> MicroFin</span>
                <button onclick="App.toggleMobileMenu(true)" class="text-slate-600 p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
            </header>

            <div class="hidden md:flex justify-between items-center p-8 pb-4 shrink-0">
                <h1 id="page-title" class="text-2xl font-bold text-slate-800 capitalize">Dashboard</h1>
                <div class="flex items-center gap-4">
                    <button id="offline-indicator" onclick="Data.processQueue(true)" class="hidden bg-red-500 hover:bg-red-600 text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2 shadow-sm transition-all" title="Click to Retry Sync">
                        <i data-lucide="wifi-off" class="w-3 h-3"></i> 
                        <span><span id="offline-count">0</span> Pending</span>
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <span id="last-sync-label" class="text-[10px] text-slate-400 font-medium hidden lg:block"></span>
                        <button id="sync-btn" onclick="Data.sync()" class="text-slate-500 hover:text-blue-600 transition flex items-center gap-2" title="Sync Data"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                    </div>
                    <div class="relative group">
                        <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
                        <input type="text" id="search-input" placeholder="Search..." class="pl-9 pr-8 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-blue-500 w-64" oninput="App.handleSearch(this.value)" />
                        <button id="search-clear" onclick="App.clearSearch()" class="absolute right-2 top-2.5 text-slate-400 hover:text-red-500 hidden transition-colors" title="Clear"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>

            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 pt-0"></div>
        </main>
    </div>

    <!-- MODALS -->
    <!-- Multi-User Lock Screen -->
    <div id="modal-lock-screen" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur-md text-white transition-opacity duration-300">
        <div class="bg-white/10 p-8 rounded-2xl backdrop-blur-xl border border-white/10 shadow-2xl w-full max-w-sm text-center animate-fadeIn relative">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-900/50">
                <i data-lucide="users" class="w-8 h-8 text-white"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Welcome Back</h2>
            <div id="login-loading" class="hidden py-6">
                <div class="flex justify-center mb-4"><i data-lucide="loader-2" class="w-10 h-10 text-blue-400 animate-spin"></i></div>
                <p class="text-slate-300 text-sm animate-pulse font-medium">Connecting to Database...</p>
                <p class="text-[10px] text-slate-500 mt-2">Fetching Users & Data</p>
            </div>
            <div id="login-form-container">
                <p class="text-slate-300 text-sm mb-6">Select your profile to login.</p>
                <form onsubmit="App.unlockApp(event)" class="space-y-4">
                    <div class="relative">
                        <select id="login-user-select" class="w-full bg-slate-800/80 border border-slate-600 rounded-lg px-4 py-3 text-white appearance-none focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 cursor-pointer text-sm font-medium">
                            <!-- Populated by JS -->
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                    <input type="password" id="lock-passcode" class="w-full bg-slate-800/80 border border-slate-600 rounded-lg px-4 py-3 text-center text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all tracking-widest font-mono" placeholder="Enter PIN" autocomplete="off" inputmode="numeric">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-900/50 transition-all transform hover:scale-[1.02] active:scale-95 flex justify-center items-center gap-2">
                        <span>Login</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
            <div class="mt-6 text-[10px] text-slate-500">System v9.9.9 ‚Ä¢ Secure Access</div>
        </div>
    </div>

    <!-- NEW: Fixed Deposit Modal -->
    <div id="modal-fixed-deposit" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded text-indigo-600"><i data-lucide="lock" class="w-4 h-4"></i></div>
                    New Fixed Deposit
                </h3>
                <button onclick="UI.closeModal('modal-fixed-deposit')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-fd" onsubmit="App.handleFDSubmit(event)" class="space-y-4">
                <input type="hidden" name="memberId" id="fd-member-id">
                
                <div class="relative group">
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Select Member</label>
                    <input id="fd-member-search" oninput="UI.filterFDMember(this.value)" placeholder="Search Name..." class="w-full pl-3 pr-4 py-2 border rounded text-sm focus:outline-none focus:border-indigo-500" autocomplete="off">
                    <div id="fd-member-dropdown" class="absolute left-0 right-0 top-full bg-white border shadow-xl max-h-40 overflow-y-auto hidden z-20"></div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Principal Amount</label>
                    <input name="principal" id="fd-principal" type="number" required oninput="Logic.calcFD()" class="w-full border p-2 rounded text-lg font-bold text-slate-800 focus:outline-none focus:border-indigo-500" placeholder="0">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Interest Rate (%)</label>
                        <input name="rate" id="fd-rate" type="number" step="0.1" required oninput="Logic.calcFD()" class="w-full border p-2 rounded text-sm" placeholder="e.g. 10">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Duration (Months)</label>
                        <input name="duration" id="fd-duration" type="number" required oninput="Logic.calcFD()" class="w-full border p-2 rounded text-sm" placeholder="e.g. 12">
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Payout Frequency</label>
                    <select name="frequency" id="fd-frequency" onchange="Logic.calcFD()" class="w-full border p-2 rounded text-sm bg-slate-50 font-medium">
                        <option value="Maturity">On Maturity (Principal + Interest)</option>
                        <option value="Monthly">Monthly Payout (Interest Only)</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Start Date</label>
                        <input name="startDate" id="fd-start-date" type="date" required onchange="Logic.calcFD()" class="w-full border p-2 rounded text-sm text-slate-600">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Maturity Date</label>
                        <input name="maturityDate" id="fd-end-date" type="date" readonly class="w-full border p-2 rounded text-sm bg-slate-100 text-slate-500 cursor-not-allowed">
                    </div>
                </div>

                <div class="bg-indigo-50 p-3 rounded border border-indigo-100 mt-2">
                    <div class="flex justify-between items-end">
                        <span class="text-xs font-bold text-indigo-600 uppercase" id="fd-final-label">Maturity Amount</span>
                        <span id="fd-maturity-display" class="text-xl font-bold text-indigo-800">0</span>
                    </div>
                    <div class="text-[10px] text-indigo-400 mt-1 flex justify-between">
                        <span>Profit: <span id="fd-profit-display">0</span></span>
                        <span>Mode: <span id="fd-mode-display">Simple Interest</span></span>
                    </div>
                    <input type="hidden" name="maturityAmount" id="fd-maturity-val">
                </div>

                <button type="submit" id="btn-save-fd" class="w-full bg-indigo-600 text-white py-2 rounded text-sm font-bold shadow hover:bg-indigo-700 transition mt-2">Create Fixed Deposit</button>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="modal-user-management" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-800">Add New User</h3>
                <button onclick="UI.closeModal('modal-user-management')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form onsubmit="App.handleUserAdd(event)" class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500 uppercase">Name</label><input name="name" required class="w-full border p-2 rounded text-sm mt-1" placeholder="e.g. John Doe"></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Role</label>
                    <select name="role" class="w-full border p-2 rounded text-sm mt-1">
                        <option value="Staff">Staff (Restricted)</option>
                        <option value="Manager">Manager (Restricted)</option>
                        <option value="Admin">Admin (Full Access)</option>
                    </select>
                </div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Login PIN</label><input name="pin" type="tel" required pattern="[0-9]{4,6}" class="w-full border p-2 rounded text-sm mt-1 font-mono" placeholder="4-6 digits"></div>
                <button type="submit" id="btn-save-user" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold shadow hover:bg-blue-700 transition mt-2">Create User</button>
            </form>
        </div>
    </div>

    <!-- NEW: Product/Inventory Modal -->
    <div id="modal-product" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-800" id="prod-modal-title">Add Inventory Item</h3>
                <button onclick="UI.closeModal('modal-product')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-product" onsubmit="App.handleProductSubmit(event)" class="space-y-4">
                <input type="hidden" name="id">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Product Name</label>
                    <input name="name" required class="w-full border p-2 rounded text-sm mt-1" placeholder="e.g. Rice Cooker">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Category</label>
                    <input name="category" class="w-full border p-2 rounded text-sm mt-1" placeholder="e.g. Electronics" list="cat-list">
                    <datalist id="cat-list"><option value="Electronics"><option value="Furniture"><option value="Vehicle"><option value="Appliance"></datalist>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Buy Price</label><input name="buyPrice" type="number" required class="w-full border p-2 rounded text-sm mt-1" placeholder="0"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Sell Price</label><input name="sellPrice" type="number" required class="w-full border p-2 rounded text-sm mt-1" placeholder="0"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Stock Qty</label><input name="stock" type="number" required class="w-full border p-2 rounded text-sm mt-1 font-bold" placeholder="0"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Min Alert</label><input name="minStock" type="number" required class="w-full border p-2 rounded text-sm mt-1" value="5"></div>
                </div>
                <button type="submit" id="btn-save-product" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold shadow hover:bg-blue-700 transition mt-2">Save Product</button>
            </form>
        </div>
    </div>

    <!-- NEW: Restriction Manager Modal -->
    <div id="modal-restrictions" class="hidden fixed inset-0 z-[85] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[90vh]">
            <div class="flex justify-between p-4 border-b bg-red-50 rounded-t-xl">
                <h3 class="font-bold text-red-900 flex items-center gap-2"><i data-lucide="ban" class="w-5 h-5"></i> Block List Manager</h3>
                <button onclick="UI.closeModal('modal-restrictions')"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-4 border-b bg-white">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
                    <input id="restrict-search" oninput="App.renderRestrictionList(this.value)" placeholder="Search member to block/unblock..." class="w-full pl-9 pr-4 py-2 border rounded text-sm focus:outline-none focus:border-red-500 bg-slate-50 focus:bg-white" autocomplete="off">
                </div>
            </div>
            <div id="restrict-list" class="flex-1 overflow-y-auto p-2 bg-slate-50 space-y-2"></div>
        </div>
    </div>

    <!-- NEW: Loan Simulator Modal -->
    <div id="modal-loan-simulator" class="hidden fixed inset-0 z-[85] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <div class="bg-indigo-100 p-1.5 rounded text-indigo-600"><i data-lucide="calculator" class="w-4 h-4"></i></div>
                    Quick Loan Simulator
                </h3>
                <button onclick="UI.closeModal('modal-loan-simulator')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase font-bold text-slate-500 block mb-1">Principal Amount</label>
                    <input type="number" id="sim-principal" oninput="Logic.calcSim()" class="w-full border p-2 rounded text-lg font-bold text-slate-800 focus:outline-none focus:border-indigo-500" placeholder="0">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-500 block mb-1">Interest Rate (%)</label>
                        <input type="number" id="sim-rate" oninput="Logic.calcSim()" class="w-full border p-2 rounded text-sm" placeholder="0">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-500 block mb-1">Duration (Inst.)</label>
                        <input type="number" id="sim-duration" oninput="Logic.calcSim()" class="w-full border p-2 rounded text-sm" placeholder="Count">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] uppercase font-bold text-slate-500 block mb-1">Frequency</label>
                    <select id="sim-freq" onchange="Logic.calcSim()" class="w-full border p-2 rounded text-sm bg-slate-50">
                        <option value="Weekly">Weekly</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Daily">Daily</option>
                    </select>
                </div>

                <div id="sim-result-box" class="bg-slate-900 text-white p-4 rounded-xl shadow-lg mt-4 opacity-50 transition-opacity duration-300">
                    <div class="flex justify-between items-end mb-2 border-b border-slate-700 pb-2">
                        <span class="text-xs text-slate-400 font-bold uppercase">EMI Amount</span>
                        <span id="sim-emi" class="text-2xl font-bold text-green-400">0</span>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Total Interest:</span>
                        <span id="sim-interest" class="font-bold text-slate-200">0</span>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>Total Payable:</span>
                        <span id="sim-total" class="font-bold text-slate-200">0</span>
                    </div>
                </div>
                
                <button onclick="UI.copySimulatorResult()" class="w-full bg-slate-100 text-slate-600 font-bold py-2 rounded text-xs hover:bg-slate-200 transition flex items-center justify-center gap-2">
                    <i data-lucide="copy" class="w-3 h-3"></i> Copy details for Member
                </button>
            </div>
        </div>
    </div>

    <div id="modal-transaction" class="hidden fixed inset-0 z-[95] flex items-center justify-center bg-black/50 p-4 animate-fadeIn"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6"><h3 id="tx-title" class="font-bold mb-4 text-slate-800">Transaction</h3><form id="form-transaction" class="space-y-4" onsubmit="App.handleTransactionSubmit(event)"><input type="hidden" name="contextId" id="tx-context-id"><input type="hidden" name="category" id="tx-category"><input type="hidden" name="editingTxId" id="tx-editing-id"><input type="hidden" id="tx-specific-member">
    <!-- NEW: Hidden field to store Group/DPS ID for reference -->
    <input type="hidden" id="tx-reference-id">
    <!-- NEW: Hidden field for Custom Data (e.g. FD Month) -->
    <input type="hidden" id="tx-custom-data">
    
    <!-- NEW: Member Selection for Quick Deposit -->
    <div id="tx-member-select-box" class="hidden">
        <label class="text-xs text-slate-500 font-bold uppercase block mb-1">Select Member</label>
        <div class="relative group">
            <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
            <input type="text" id="tx-member-search" oninput="UI.filterTxMember(this.value)" placeholder="Search Name or ID..." class="w-full pl-9 pr-4 py-2 border rounded text-sm focus:outline-none focus:border-blue-500" autocomplete="off">
            <div id="tx-member-dropdown" class="absolute left-0 right-0 top-full bg-white border shadow-xl max-h-40 overflow-y-auto hidden z-20"></div>
        </div>
    </div>

    <div>
        <label class="text-xs text-slate-500 font-bold uppercase block mb-1">Amount</label>
        <input name="amount" id="tx-amount" type="number" step="any" required placeholder="0.00" class="w-full border p-2 rounded text-lg font-bold text-slate-800 focus:outline-none focus:border-blue-500">
        <div id="tx-hint" class="hidden mt-1 text-xs"></div>
    </div>

    <!-- PENALTY FIELD (New) -->
    <div id="tx-penalty-box" class="hidden bg-red-50 p-2 rounded border border-red-100">
        <div class="flex justify-between items-center mb-1">
            <label class="text-[10px] text-red-600 font-bold uppercase">Penalty / Late Fine</label>
            <button type="button" id="btn-waive-penalty" onclick="App.toggleWaivePenalty()" class="text-[10px] text-slate-500 underline hover:text-slate-800">Waive</button>
        </div>
        <input name="penalty" id="tx-penalty" type="number" step="any" placeholder="0" class="w-full border p-1.5 rounded text-sm font-bold text-red-600 bg-white focus:outline-none focus:border-red-400">
    </div>

    <div class="grid grid-cols-2 gap-3"><div><label class="text-xs text-slate-500 font-bold uppercase block mb-1">Date</label><input name="date" type="date" required class="w-full border p-2 rounded text-sm bg-white"></div><div><label id="tx-meta-label" class="text-xs text-slate-500 font-bold uppercase block mb-1">Remarks</label><input name="collectedBy" id="tx-meta-input" placeholder="Auto-filled" class="w-full border p-2 rounded text-sm bg-slate-50 text-slate-500 font-medium"></div></div><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="UI.closeModal('modal-transaction')" class="px-4 py-2 text-sm text-slate-600 font-medium hover:bg-slate-100 rounded">Cancel</button><button type="submit" id="btn-save-tx" class="bg-blue-600 text-white px-6 py-2 rounded text-sm font-bold shadow hover:bg-blue-700 transition" data-original-text="Confirm">Confirm</button></div></form></div></div>

    <div id="modal-refinance" class="hidden fixed inset-0 z-[75] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm"><div class="flex justify-between p-4 border-b"><h3 class="font-bold">Refinance Loan</h3><button onclick="UI.closeModal('modal-refinance')"><i data-lucide="x"></i></button></div><form id="form-refinance" class="p-6 space-y-4" onsubmit="App.handleRefinanceSubmit(event)"><input type="hidden" id="ref-old-id"><div class="bg-slate-50 p-3 rounded text-sm mb-2"><div class="flex justify-between text-slate-500 text-xs"><span>Existing Loan</span><span id="ref-old-name" class="font-bold"></span></div><div class="flex justify-between mt-1 items-center"><span>Outstanding Balance</span><span id="ref-old-bal" class="font-bold text-red-600 text-lg"></span></div><input type="hidden" id="ref-old-bal-val"></div><div><label class="text-xs text-slate-500">Top-up Amount</label><input id="ref-topup" type="number" required oninput="Logic.calcRefinance()" class="w-full border p-2 rounded text-sm font-bold text-green-600" placeholder="0"></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs text-slate-500">New Duration</label><input id="ref-duration" type="number" required class="w-full border p-2 rounded text-sm" placeholder="Count"></div><div><label class="text-xs text-slate-500">New Rate (%)</label><input id="ref-rate" type="number" required class="w-full border p-2 rounded text-sm" value="0"></div></div><div class="border-t pt-3 flex justify-between items-center"><span class="text-xs font-bold text-slate-500 uppercase">New Principal</span><span id="ref-new-principal" class="font-bold text-xl text-blue-700">0</span><input type="hidden" id="ref-new-principal-val"></div><button type="submit" id="btn-save-refinance" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold mt-4 shadow hover:bg-blue-700">Confirm Refinance</button></form></div></div>

    <div id="modal-daily-report" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-black/50 p-4 animate-fadeIn"><div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]"><div class="flex justify-between p-4 border-b"><h3 class="font-bold text-slate-800">Daily Cash Report</h3><div class="flex gap-2"><button onclick="App.downloadDailyReportPDF()" class="text-blue-600 hover:text-blue-800 p-1" title="Download PDF"><i data-lucide="download" class="w-5 h-5"></i></button><button onclick="UI.closeModal('modal-daily-report')" class="text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="bg-slate-50 p-3 border-b flex flex-wrap gap-3 items-center"><div class="relative"><select id="dr-filter" onchange="UI.toggleFilterVisibility('dr', App.renderDailyReport)" class="pl-2 pr-8 py-1 rounded border text-xs"><option value="today">Today</option><option value="specific">Specific Date</option><option value="range">Date Range</option><option value="upto">Up To Date</option></select></div><input type="date" id="dr-date-start" onchange="App.renderDailyReport()" class="hidden border rounded px-2 py-1 text-xs"><input type="date" id="dr-date-end" onchange="App.renderDailyReport()" class="hidden border rounded px-2 py-1 text-xs"></div><div id="dr-content" class="p-6 overflow-y-auto bg-white flex-1"><div class="text-center mb-6"><h2 class="text-xl font-bold uppercase tracking-widest text-slate-800">Cash Flow Report</h2><p class="text-xs text-slate-500 mt-1" id="dr-display-date"></p><p class="text-[10px] text-slate-400 mt-1">Generated: <span id="dr-timestamp"></span></p></div><div class="grid grid-cols-3 gap-4 mb-6 text-center"><div class="p-3 bg-green-50 rounded border border-green-100"><p class="text-[10px] uppercase font-bold text-green-600">Total In</p><p class="text-lg font-bold text-green-700" id="dr-total-in">0</p></div><div class="p-3 bg-red-50 rounded border border-red-100"><p class="text-[10px] uppercase font-bold text-red-600">Total Out</p><p class="text-lg font-bold text-red-700" id="dr-total-out">0</p></div><div class="p-3 bg-slate-100 rounded border border-slate-200"><p class="text-[10px] uppercase font-bold text-slate-600">Net Cash</p><p class="text-lg font-bold text-slate-800" id="dr-net">0</p></div></div><table class="w-full text-sm mb-4"><thead class="bg-slate-50 text-xs font-bold uppercase text-slate-500 border-b"><tr><th class="p-2 text-left">Category</th><th class="p-2 text-center">Count</th><th class="p-2 text-right">Amount</th></tr></thead><tbody id="dr-body" class="divide-y divide-slate-100"></tbody><tfoot class="border-t-2 border-slate-100 font-bold bg-slate-50"><tr><td class="p-2">TOTAL</td><td class="p-2 text-center" id="dr-total-count">0</td><td class="p-2 text-right" id="dr-net-total">0</td></tr></tfoot></table><div class="mt-8 pt-4 border-t border-dashed text-center text-[10px] text-slate-400"><p>Approved By</p><div class="h-8"></div><p>_______________________</p></div></div></div></div>

    <div id="modal-member" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="font-bold mb-4">Member Details</h3>
            <form id="form-member" class="space-y-4" onsubmit="App.handleMemberSubmit(event)">
                <input type="hidden" name="id">
                <div class="grid grid-cols-2 gap-3"><input name="name" required placeholder="Full Name" class="w-full border p-2 rounded text-sm" /><select name="type" class="w-full border p-2 rounded text-sm"><option value="Personal">Personal</option><option value="Business">Business</option></select></div>
                <input name="phone" required placeholder="Phone" class="w-full border p-2 rounded text-sm" /><input name="address" placeholder="Address" class="w-full border p-2 rounded text-sm" />
                
                <!-- NEW: Flagging System -->
                <div id="member-flag-box" class="hidden">
                    <label class="text-[10px] text-slate-400 block mb-1 uppercase font-bold">Member Flag (Risk/VIP)</label>
                    <select name="flag" class="w-full border p-2 rounded text-sm bg-slate-50 font-bold text-slate-700">
                        <option value="">None (Standard)</option>
                        <option value="High Risk">üö© High Risk (Red Flag)</option>
                        <option value="VIP">üåü VIP (Gold Star)</option>
                        <option value="Flight Risk">‚ö†Ô∏è Flight Risk (Warning)</option>
                        <option value="Defaulter">üö´ Defaulter (Banned)</option>
                    </select>
                </div>

                <div class="border-t pt-3 mt-1">
                    <p class="text-xs font-bold text-slate-500 mb-2 uppercase">Savings Configuration</p>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="text-[10px] text-slate-400 block mb-1">Frequency</label><select name="savingType" id="mem-saving-type" onchange="UI.toggleSavingDate(this.value)" class="w-full border p-2 rounded text-sm"><option value="Daily">Daily</option><option value="Weekly">Weekly</option><option value="Monthly">Monthly</option></select></div>
                        <div><label class="text-[10px] text-slate-400 block mb-1">Target Amount</label><input name="savingAmount" type="number" placeholder="0.00" class="w-full border p-2 rounded text-sm" /></div>
                    </div>
                    <div id="mem-saving-weekly-box" class="hidden mb-3"><label class="text-[10px] text-slate-400 block mb-1">Preferred Day</label><select name="savingDateWeekly" id="mem-saving-date-weekly" class="w-full border p-2 rounded text-sm bg-slate-50"><option value="Saturday">Saturday</option><option value="Sunday">Sunday</option><option value="Monday">Monday</option><option value="Tuesday">Tuesday</option><option value="Wednesday">Wednesday</option><option value="Thursday">Thursday</option><option value="Friday">Friday</option></select></div>
                    <div id="mem-saving-monthly-box" class="hidden mb-3"><label class="text-[10px] text-slate-400 block mb-1">Day of Month (1-31)</label><input name="savingDateMonthly" id="mem-saving-date-monthly" type="number" min="1" max="31" placeholder="e.g. 5" class="w-full border p-2 rounded text-sm bg-slate-50" /></div>
                </div>
                <div class="border-t pt-3 mt-1"><label class="text-[10px] text-slate-400 block mb-1">Status</label><select name="status" class="w-full border p-2 rounded text-sm"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div>
                <div id="box-send-welcome" class="mt-4 flex items-center gap-2 bg-blue-50 p-2 rounded border border-blue-100"><input type="checkbox" id="chk-send-welcome" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300"><label for="chk-send-welcome" class="text-xs font-bold text-slate-700 cursor-pointer">Send Welcome Message (SMS)</label></div>
                <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="UI.closeModal('modal-member')" class="px-4 py-2 text-sm text-slate-600">Cancel</button><button type="submit" id="btn-save-member" class="bg-blue-600 text-white px-4 py-2 rounded text-sm flex items-center gap-2"><span>Save</span></button></div>
            </form>
        </div>
    </div>
    <div id="modal-loan" class="hidden fixed inset-0 z-[75] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]"><div class="flex justify-between p-4 border-b"><h3 id="loan-modal-title" class="font-bold">Loan</h3><button onclick="UI.closeModal('modal-loan')"><i data-lucide="x"></i></button></div><form id="form-loan" class="p-6 overflow-y-auto space-y-4" onsubmit="App.handleLoanSubmit(event)"><input type="hidden" name="id"><div class="bg-slate-100 p-1 rounded flex text-xs mb-4"><button type="button" onclick="UI.toggleLoanType('Cash')" id="type-cash" class="flex-1 py-2 rounded bg-white shadow text-blue-600">Cash</button><button type="button" onclick="UI.toggleLoanType('Product')" id="type-product" class="flex-1 py-2 rounded text-slate-500">Product</button></div><input type="hidden" name="category" id="loanCategory" value="Cash"><div class="relative group dropdown-container"><label class="text-xs text-slate-500">Borrower</label><input id="member-search" oninput="UI.filterDropdown(this.value)" placeholder="Search..." class="w-full border p-2 rounded text-sm" autocomplete="off"><input type="hidden" name="memberId" id="selected-member-id"><div id="loan-member-warning" class="hidden mt-1 p-2 bg-red-50 border border-red-100 rounded text-xs text-red-600 font-bold flex items-center gap-2 animate-fadeIn"><i data-lucide="alert-triangle" class="w-4 h-4"></i> <span>Has Active Loan!</span></div><div id="member-dropdown" class="absolute left-0 right-0 top-full bg-white border shadow-xl max-h-40 overflow-y-auto hidden z-20"></div></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs text-slate-500">Ref. No *</label><input name="refNo" required class="w-full border p-2 rounded text-sm"></div><div><label class="text-xs text-slate-500">Remarks</label><input name="remarks" class="w-full border p-2 rounded text-sm"></div></div><div class="grid grid-cols-2 gap-3"><input name="guarantorName" placeholder="Guarantor Name" class="border p-2 rounded text-sm"><input name="guarantorPhone" placeholder="Guarantor Phone" class="border p-2 rounded text-sm"></div>
    
    <!-- Updated Product Fields for Inventory Integration -->
    <div id="product-fields" class="hidden space-y-3">
        <div class="relative">
            <label class="text-xs text-slate-500 block mb-1">Search Inventory</label>
            <input id="inv-search-loan" oninput="App.filterInventoryDropdown(this.value)" placeholder="Start typing product name..." class="w-full border p-2 rounded text-sm bg-purple-50 focus:bg-white" autocomplete="off">
            <div id="inv-dropdown-loan" class="absolute left-0 right-0 top-full bg-white border shadow-xl max-h-40 overflow-y-auto hidden z-20"></div>
            <input type="hidden" name="productId" id="selected-product-id">
        </div>
        <input name="productName" id="loan-prod-name" placeholder="Product Name (Auto-filled)" class="w-full border p-2 rounded text-sm bg-slate-50" readonly>
        <div class="grid grid-cols-2 gap-3">
            <input id="prod-price" type="number" oninput="Logic.calcPrincipal()" placeholder="Price" name="productPrice" class="border p-2 rounded text-sm bg-slate-50" readonly>
            <input name="downPayment" id="prod-dp" type="number" oninput="Logic.calcPrincipal()" placeholder="Down Payment" class="border p-2 rounded text-sm font-bold text-green-600">
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3"><div><label class="text-xs text-slate-500">Principal</label><input name="principal" id="loan-principal" type="number" required oninput="Logic.calcEMI()" class="w-full border p-2 rounded text-sm font-bold"></div><div><label class="text-xs text-slate-500">Rate (%)</label><input name="rate" id="loan-rate" value="0" type="number" oninput="Logic.calcEMI()" class="w-full border p-2 rounded text-sm"></div></div><div class="grid grid-cols-2 gap-3"><div><label class="text-xs text-slate-500">Type</label><select name="loanType" id="loan-type" onchange="Logic.calcEMI()" class="w-full border p-2 rounded text-sm"><option value="Weekly">Weekly</option><option value="Monthly">Monthly</option><option value="Daily">Daily</option></select></div><div><label class="text-xs text-slate-500">Duration *</label><input name="duration" id="loan-duration" type="number" required oninput="Logic.calcEMI()" placeholder="Count" class="w-full border p-2 rounded text-sm"></div></div>
    
    <!-- New Loan Field: Penalty -->
    <div><label class="text-xs text-slate-500 text-red-500 font-bold">Penalty / Late Fine (Optional)</label><input name="penalty" type="number" placeholder="Default Penalty Amount" class="w-full border border-red-100 p-2 rounded text-sm bg-red-50 text-red-700"></div>

    <div id="emi-preview" class="hidden bg-blue-50 p-3 rounded text-center"><div class="flex justify-between font-bold text-slate-800"><span>Total:</span><span id="calc-total">0</span></div><div class="text-blue-700 font-bold text-xl mt-1">‡ß≥<span id="calc-emi">0</span></div></div><div class="flex justify-end gap-2"><button type="button" onclick="UI.closeModal('modal-loan')" class="px-4 py-2 text-sm">Cancel</button><button type="submit" id="btn-save-loan" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Save</button></div></form></div></div>
    <div id="modal-assistant" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4 animate-fadeIn"><div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col max-h-[90vh]"><div class="flex justify-between items-center p-4 border-b bg-slate-50 rounded-t-xl"><h3 class="font-bold flex items-center gap-2 text-slate-800" id="ast-title"><i data-lucide="bot" class="w-5 h-5 text-indigo-600"></i> Assistant</h3><div class="flex items-center gap-2"><select id="ast-filter-select" onchange="App.assistantUpcomingFilter=this.value;App.renderAssistant()" class="hidden text-xs border p-1.5 rounded bg-white text-slate-600 focus:outline-none focus:border-indigo-500 font-bold shadow-sm"><option value="all">All Types</option><option value="Daily">Daily</option><option value="Weekly">Weekly</option><option value="Monthly">Monthly</option></select><button onclick="UI.closeModal('modal-assistant')" class="text-slate-500 hover:text-slate-800 transition"><i data-lucide="x"></i></button></div></div><div class="flex border-b bg-slate-50" id="ast-tabs">
        <button onclick="UI.switchAssistantTab('collection')" id="tab-ast-collection" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 border-indigo-600 text-indigo-600 bg-white rounded-tl-lg transition-colors">Collections</button>
        <button onclick="UI.switchAssistantTab('upcoming')" id="tab-ast-upcoming" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors">Upcoming</button>
        <button onclick="UI.switchAssistantTab('reminder')" id="tab-ast-reminder" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors">Reminders</button>
    </div>
    <div class="p-6 overflow-y-auto bg-slate-50/50 flex-1"><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-6"><div class="bg-white p-3 rounded border border-indigo-100 text-center shadow-sm"><p class="text-[10px] font-bold text-indigo-600 uppercase" id="ast-stat-label">Due Today</p><h3 id="ast-total-due" class="text-lg font-bold">0</h3></div><div class="bg-white p-3 rounded border border-orange-100 text-center shadow-sm"><p class="text-[10px] font-bold text-orange-600 uppercase">Overdue</p><h3 id="ast-total-overdue" class="text-lg font-bold">0</h3></div><div class="bg-white p-3 rounded border border-blue-100 text-center shadow-sm"><p class="text-[10px] font-bold text-blue-600 uppercase">Total Outstanding</p><h3 id="ast-grand-outstanding" class="text-lg font-bold">0</h3></div><div class="bg-white p-3 rounded border border-slate-200 text-center shadow-sm"><p class="text-[10px] font-bold text-slate-500 uppercase">Count</p><h3 id="ast-count" class="text-lg font-bold">0</h3></div><div class="bg-white p-3 rounded border border-red-100 text-center shadow-sm"><p class="text-[10px] font-bold text-red-600 uppercase">Risk / Missed</p><h3 id="ast-risk" class="text-lg font-bold">0</h3></div></div><div id="ast-list" class="space-y-2"></div></div></div></div>
    <div id="modal-deleted-items" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/50 p-4 animate-fadeIn"><div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col max-h-[90vh]"><div class="flex justify-between p-4 border-b"><h3 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i> <span id="deleted-modal-title">Deleted Receipts</span></h3><div class="flex gap-2"><button onclick="App.downloadPDF('deleted-list', 'Log_Report')" class="text-blue-600 hover:text-blue-800 p-1" title="Download PDF"><i data-lucide="download" class="w-5 h-5"></i></button><button onclick="UI.closeModal('modal-deleted-items')" class="text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="p-6 overflow-y-auto bg-slate-50 flex-1" id="deleted-list"></div></div></div>
    <div id="modal-cat-detail" class="hidden fixed inset-0 z-[95] flex items-center justify-center bg-black/50 p-4 animate-fadeIn"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]"><div class="flex justify-between p-4 border-b"><h3 class="font-bold text-slate-800" id="cd-title">Category Details</h3><div class="flex gap-2"><button onclick="App.downloadPDF('cd-list', 'Category_Details')" class="text-blue-600 hover:text-blue-800 p-1" title="Download PDF"><i data-lucide="download" class="w-5 h-5"></i></button><button onclick="UI.closeModal('modal-cat-detail')" class="text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div></div><div class="p-4 overflow-y-auto" id="cd-list"></div></div></div>
    
    <!-- Passbook Modal Updated -->
    <div id="modal-passbook" class="hidden fixed inset-0 z-[85] flex items-center justify-center bg-black/50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between p-4 border-b">
                <h3 id="pb-name" class="font-bold">Passbook</h3>
                <div class="flex gap-2">
                    <button onclick="App.downloadPDF('pb-content', 'History_Passbook')" class="text-blue-600 hover:text-blue-800 p-1" title="Download PDF"><i data-lucide="download" class="w-5 h-5"></i></button>
                    <button onclick="UI.closeModal('modal-passbook')" class="text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto" id="pb-content">
                <div class="grid grid-cols-2 gap-4 mb-4" id="pb-stats-member"></div>
                <div id="pb-stats-loan" class="hidden mb-4"></div>
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-sm text-slate-700">Transaction History</h4>
                    <select id="pb-filter-type" onchange="UI.renderHistoryTable(this.value)" class="text-xs border p-1 rounded bg-white text-slate-600 focus:outline-none focus:border-blue-500">
                        <option value="All">All Transactions</option>
                        <option value="Deposit">Deposit</option>
                        <option value="Withdrawal">Withdrawal</option>
                        <option value="DPS Withdrawal">DPS Withdrawal</option>
                        <option value="Balance Forward">Balance Forward</option>
                        <option value="Collection">Collection</option>
                        <option value="Disbursement">Disbursement</option>
                        <option value="Down Payment">Down Payment</option>
                        <option value="Group Contrib.">Group Contrib.</option>
                        <option value="Group Payout">Group Payout</option>
                        <option value="DPS Payment">DPS Payment</option>
                        <option value="FD Withdrawal">FD Payout</option>
                        <option value="FD Interest">FD Interest Payout</option>
                    </select>
                </div>
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-2">Date</th>
                            <th class="p-2">TxID</th>
                            <th class="p-2">Type</th>
                            <th class="p-2">Remarks</th>
                            <th class="p-2">Operator</th>
                            <th class="p-2 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="pb-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-receipt" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/60 p-4 animate-fadeIn"><div class="bg-white rounded-xl w-full max-w-sm overflow-hidden relative"><button onclick="UI.closeModal('modal-receipt')" class="absolute right-3 top-3 text-white/70 hover:text-white z-10"><i data-lucide="x" class="w-5 h-5"></i></button><div class="bg-slate-900 p-4 text-center text-white font-bold text-xs uppercase tracking-widest relative">Receipt</div><div class="p-6 bg-slate-50 receipt-pattern"><div id="receipt-printable" class="bg-white p-6 shadow border text-sm font-mono"><h2 class="font-bold text-xl text-center border-b-2 border-dashed pb-4 mb-4">MicroFin</h2><div class="space-y-2" id="rcpt-content"></div></div><div class="grid grid-cols-2 gap-2 mt-4"><button onclick="Utils.sendWhatsApp()" class="bg-green-600 text-white py-2 rounded text-xs font-bold shadow-sm hover:bg-green-700 transition">WhatsApp</button><button onclick="Utils.sendSMS(App.receiptData.phone, App.receiptData.text)" class="bg-slate-800 text-white py-2 rounded text-xs font-bold shadow-sm hover:bg-slate-900 transition flex justify-center items-center gap-1"><i data-lucide="message-square" class="w-3 h-3"></i> SMS</button><button onclick="App.downloadPDF('receipt-printable', 'Receipt')" class="bg-blue-600 text-white py-2 rounded text-xs font-bold shadow-sm hover:bg-blue-700 transition">Download PDF</button><button onclick="Utils.copyReceipt()" class="bg-white border border-slate-300 py-2 rounded text-xs font-bold text-slate-700 hover:bg-slate-50 transition">Copy Text</button></div></div></div></div>
    <div id="modal-cash-breakdown" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/60 p-4"><div class="bg-white rounded-xl p-6 w-full max-w-sm"><h3 class="font-bold mb-4">Cash Analysis</h3><div id="cb-content" class="space-y-2 text-sm"></div><button onclick="UI.closeModal('modal-cash-breakdown')" class="mt-4 w-full bg-slate-100 py-2 rounded text-sm">Close</button></div></div>
    <div id="modal-schedule" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/60 p-4 print-visible"><div class="bg-white rounded-xl w-full max-w-2xl h-full md:h-auto flex flex-col"><div class="flex justify-between p-4 border-b no-print"><h3 class="font-bold">Schedule</h3><div class="flex gap-2"><button onclick="App.downloadPDF('schedule-content', 'Schedule')" class="text-blue-600 text-sm flex gap-1"><i data-lucide="download" class="w-4"></i> PDF</button><button onclick="window.print()" class="text-slate-600 text-sm flex gap-1"><i data-lucide="printer" class="w-4"></i> Print</button><button onclick="UI.closeModal('modal-schedule')"><i data-lucide="x"></i></button></div></div><div class="p-6 overflow-y-auto" id="schedule-content"></div></div></div>
    <div id="modal-confirm" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-black/50 p-4"><div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 text-center"><h3 class="font-bold text-lg mb-2">Confirm Action</h3><p id="confirm-msg" class="text-sm text-slate-500 mb-4">Are you sure?</p><input id="confirm-input-pass" type="password" placeholder="Passcode" class="hidden w-full border p-2 rounded mb-4 text-center text-sm"><div class="flex gap-3 justify-center"><button onclick="UI.closeModal('modal-confirm')" class="px-4 py-2 text-slate-600 rounded bg-slate-100">Cancel</button><button id="btn-confirm-yes" onclick="App.executeConfirm()" class="bg-red-600 text-white px-4 py-2 rounded flex items-center gap-2 justify-center min-w-[80px]" data-original-text="Yes">Yes</button></div></div></div>

    <div id="modal-consolidate-savings" class="hidden fixed inset-0 z-[85] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[90vh]">
            <div class="flex justify-between p-4 border-b bg-indigo-50 rounded-t-xl">
                <h3 class="font-bold text-indigo-900 flex items-center gap-2"><i data-lucide="archive" class="w-5 h-5"></i> Consolidate Savings</h3>
                <button onclick="UI.closeModal('modal-consolidate-savings')"><i data-lucide="x"></i></button>
            </div>
            <form id="form-consolidate" class="p-6 space-y-4" onsubmit="App.handleConsolidateSubmit(event)">
                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded text-xs text-yellow-800 mb-2">
                    <strong class="block mb-1"><i data-lucide="shield-alert" class="w-3 h-3 inline"></i> Data Protection:</strong>
                    This action will <strong>archive</strong> all individual savings transactions for the selected member and replace them with a single "Balance Forward" entry. A PDF report will be generated automatically.
                </div>
                
                <div>
                    <label class="text-xs text-slate-500 uppercase font-bold">Select Member</label>
                    <div class="relative group mt-1">
                        <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
                        <input id="cons-member-search" oninput="App.filterConsolidateMembers(this.value)" placeholder="Search member..." class="w-full pl-9 pr-4 py-2 border rounded text-sm focus:outline-none focus:border-indigo-500" autocomplete="off">
                        <input type="hidden" name="memberId" id="cons-member-id" required>
                        <div id="cons-member-dropdown" class="absolute left-0 right-0 top-full bg-white border shadow-xl max-h-40 overflow-y-auto hidden z-20"></div>
                    </div>
                </div>

                <div id="cons-preview" class="hidden space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-50 p-2 rounded border text-center">
                            <span class="text-[10px] uppercase text-slate-500 font-bold">Records Found</span>
                            <div class="font-bold text-slate-800" id="cons-count">0</div>
                        </div>
                        <div class="bg-blue-50 p-2 rounded border border-blue-100 text-center">
                            <span class="text-[10px] uppercase text-blue-600 font-bold">Net Balance</span>
                            <div class="font-bold text-blue-700 text-lg" id="cons-balance">0</div>
                            <input type="hidden" name="netBalance" id="cons-balance-val">
                        </div>
                    </div>
                    <div class="text-xs text-center text-slate-400">
                        Total In: <span id="cons-in" class="font-bold text-green-600">0</span> ‚Ä¢ Total Out: <span id="cons-out" class="font-bold text-red-600">0</span>
                    </div>
                </div>

                <div class="border-t pt-4">
                    <label class="text-xs text-slate-500 uppercase font-bold">Admin Passcode</label>
                    <input type="password" id="cons-passcode" class="w-full border p-2 rounded text-sm mt-1 text-center font-mono tracking-widest" placeholder="****" required>
                </div>

                <div class="flex justify-end gap-2 mt-2">
                    <button type="button" onclick="UI.closeModal('modal-consolidate-savings')" class="px-4 py-2 text-sm text-slate-600">Cancel</button>
                    <button type="submit" id="btn-exec-consolidate" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">Generate Report & Consolidate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Group Loan Modal -->
    <div id="modal-group" class="hidden fixed inset-0 z-[75] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="flex justify-between p-4 border-b">
                <h3 class="font-bold" id="group-modal-title">Create Group Loan</h3>
                <button onclick="UI.closeModal('modal-group')"><i data-lucide="x"></i></button>
            </div>
            <form id="form-group" class="p-6 overflow-y-auto space-y-4" onsubmit="App.handleGroupSubmit(event)">
                <input type="hidden" name="id" id="group-id">
                <div><label class="text-xs text-slate-500">Group Name</label><input name="name" required placeholder="e.g. Weekly Lottery Group A" class="w-full border p-2 rounded text-sm" /></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs text-slate-500">Frequency</label><select name="frequency" class="w-full border p-2 rounded text-sm"><option value="Weekly">Weekly</option><option value="Monthly">Monthly</option><option value="Daily">Daily</option></select></div>
                    <div><label class="text-xs text-slate-500">Per Person Contrib.</label><input name="contribution" type="number" required placeholder="1000" class="w-full border p-2 rounded text-sm" /></div>
                </div>
                
                <!-- NEW Group Field: Penalty -->
                <div><label class="text-xs text-slate-500 text-red-500 font-bold">Penalty / Late Fine</label><input name="penalty" type="number" placeholder="0" class="w-full border border-red-100 p-2 rounded text-sm bg-red-50 text-red-700"></div>

                <div>
                    <label class="text-xs text-slate-500 mb-1 block">Select Members</label>
                    <div class="relative mb-2">
                        <i data-lucide="search" class="absolute left-2 top-2 text-slate-400 w-4 h-4"></i>
                        <input type="text" id="group-member-search" oninput="App.filterGroupMembers(this.value)" placeholder="Search members..." class="w-full pl-8 pr-2 py-1.5 border rounded text-xs bg-slate-50 focus:bg-white focus:outline-none focus:border-blue-500 transition-colors">
                    </div>
                    <div class="border rounded p-2 max-h-48 overflow-y-auto bg-slate-50" id="group-member-list">
                        <!-- Checkboxes populated by JS -->
                    </div>
                    <div class="text-[10px] text-slate-400 mt-1 flex justify-between">
                        <span id="group-selected-count">0 selected</span>
                        <span>Total Pot: <span id="group-pot-preview" class="font-bold text-slate-700">0</span></span>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-2">
                    <button type="button" onclick="UI.closeModal('modal-group')" class="px-4 py-2 text-sm">Cancel</button>
                    <button type="submit" id="btn-save-group" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Create Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Create Group DPS Modal -->
    <div id="modal-group-dps" class="hidden fixed inset-0 z-[75] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="flex justify-between p-4 border-b">
                <h3 class="font-bold" id="dps-modal-title">Create Group DPS</h3>
                <button onclick="UI.closeModal('modal-group-dps')"><i data-lucide="x"></i></button>
            </div>
            <form id="form-group-dps" class="p-6 overflow-y-auto space-y-4" onsubmit="App.handleGroupDPSSubmit(event)">
                <input type="hidden" name="id" id="dps-id">
                <div><label class="text-xs text-slate-500">Group Name</label><input name="name" required placeholder="e.g. Monthly Savings Circle 2026" class="w-full border p-2 rounded text-sm" /></div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs text-slate-500">Frequency</label><select name="frequency" class="w-full border p-2 rounded text-sm"><option value="Monthly">Monthly</option><option value="Weekly">Weekly</option><option value="Daily">Daily</option></select></div>
                    <div><label class="text-xs text-slate-500">Contribution (Per Person)</label><input name="contribution" type="number" required placeholder="500" class="w-full border p-2 rounded text-sm" /></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs text-slate-500">Maturity Duration (Months)</label><input name="duration" type="number" required placeholder="12" class="w-full border p-2 rounded text-sm" /></div>
                    <div><label class="text-xs text-slate-500">Start Date</label><input name="startDate" type="date" required class="w-full border p-2 rounded text-sm" /></div>
                </div>
                
                <!-- NEW DPS Field: Penalty -->
                <div><label class="text-xs text-slate-500 text-red-500 font-bold">Penalty / Late Fine</label><input name="penalty" type="number" placeholder="0" class="w-full border border-red-100 p-2 rounded text-sm bg-red-50 text-red-700"></div>

                <div>
                    <label class="text-xs text-slate-500 mb-1 block">Select Members</label>
                    <div class="relative mb-2">
                        <i data-lucide="search" class="absolute left-2 top-2 text-slate-400 w-4 h-4"></i>
                        <input type="text" id="dps-member-search" oninput="App.filterDPSMembers(this.value)" placeholder="Search members..." class="w-full pl-8 pr-2 py-1.5 border rounded text-xs bg-slate-50 focus:bg-white focus:outline-none focus:border-blue-500 transition-colors">
                    </div>
                    <div class="border rounded p-2 max-h-48 overflow-y-auto bg-slate-50" id="dps-member-list"></div>
                    <div class="text-[10px] text-slate-400 mt-1 flex justify-between">
                        <span id="dps-selected-count">0 selected</span>
                        <span>Total Monthly Pot: <span id="dps-pot-preview" class="font-bold text-slate-700">0</span></span>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-2">
                    <button type="button" onclick="UI.closeModal('modal-group-dps')" class="px-4 py-2 text-sm">Cancel</button>
                    <button type="submit" id="btn-save-dps" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Save DPS Group</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NEW: DPS Result Modal -->
    <div id="modal-dps-result" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm text-center p-6">
            <div id="dps-result-icon" class="w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 bg-slate-100"><i data-lucide="check" class="w-6 h-6 text-slate-600"></i></div>
            <h3 class="font-bold text-lg mb-2">Batch Collection</h3>
            <p id="dps-result-msg" class="text-sm text-slate-500 mb-4"></p>
            <div id="dps-fail-list" class="hidden text-left bg-red-50 p-2 rounded text-xs text-red-700 mb-4 max-h-32 overflow-y-auto"></div>
            <button onclick="UI.closeModal('modal-dps-result')" class="w-full bg-slate-800 text-white py-2 rounded text-sm font-bold">Close</button>
        </div>
    </div>

    <!-- NEW: Group DPS History Modal -->
    <div id="modal-dps-history" class="hidden fixed inset-0 z-[85] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[90vh]">
            <div class="flex justify-between p-4 border-b bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-slate-800" id="dps-history-title">Collection History</h3>
                <button onclick="UI.closeModal('modal-dps-history')"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1" id="dps-history-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- NEW: Global DPS Summary Modal -->
    <div id="modal-global-dps" class="hidden fixed inset-0 z-[85] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between p-4 border-b bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5 text-indigo-600"></i> All DPS Members Summary</h3>
                <div class="flex gap-2">
                     <button onclick="App.downloadPDF('global-dps-list', 'DPS_Global_Report')" class="text-blue-600 hover:text-blue-800 p-1" title="Download PDF"><i data-lucide="download" class="w-5 h-5"></i></button>
                     <button onclick="UI.closeModal('modal-global-dps')"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1" id="global-dps-list"></div>
        </div>
    </div>

    <!-- NEW: Member Profile Modal -->
    <div id="modal-member-profile" class="hidden fixed inset-0 z-[85] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between p-4 border-b bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="contact" class="w-5 h-5 text-blue-600"></i> <span id="mp-header-name">Member Portfolio</span>
                </h3>
                <div class="flex gap-2">
                    <button onclick="App.downloadPDF('mp-content', 'Member_Profile')" class="text-blue-600 hover:text-blue-800 p-1" title="Download PDF"><i data-lucide="download" class="w-5 h-5"></i></button>
                    <button onclick="UI.closeModal('modal-member-profile')"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div id="mp-content" class="p-6 overflow-y-auto flex-1 bg-slate-50/50">
                <!-- Content populated dynamically -->
            </div>
        </div>
    </div>

    <!-- NEW: Broadcast Message Modal -->
    <div id="modal-broadcast" class="hidden fixed inset-0 z-[95] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <div class="bg-orange-100 p-1.5 rounded text-orange-600"><i data-lucide="megaphone" class="w-4 h-4"></i></div>
                    Broadcast Message
                </h3>
                <button onclick="UI.closeModal('modal-broadcast')"><i data-lucide="x"></i></button>
            </div>
            <form onsubmit="App.handleBroadcastSubmit(event)">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Target Audience</label>
                    <select id="bc-target" onchange="App.toggleBroadcastTarget(this.value)" class="w-full border p-2 rounded text-sm bg-slate-50 font-bold focus:outline-none focus:border-orange-500">
                        <option value="all">All Active Members</option>
                        <option value="group">Specific Group Loan</option>
                        <option value="dps">Specific DPS Group</option>
                    </select>
                </div>
                <div id="bc-group-select-box" class="hidden mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Select Group</label>
                    <select id="bc-specific-group" class="w-full border p-2 rounded text-sm focus:outline-none focus:border-orange-500"></select>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Message Body</label>
                    <textarea name="message" id="bc-message" rows="4" class="w-full border p-2 rounded text-sm focus:outline-none focus:border-orange-500 font-medium text-slate-700" placeholder="e.g., Office Closed Tomorrow due to Holiday..." required oninput="document.getElementById('bc-char-count').innerText = this.value.length"></textarea>
                    <div class="text-right text-[10px] text-slate-400 mt-1"><span id="bc-char-count">0</span> chars</div>
                </div>
                <div class="bg-yellow-50 p-3 rounded text-[10px] text-yellow-800 mb-4 border border-yellow-200">
                    <strong class="block mb-1"><i data-lucide="info" class="w-3 h-3 inline mr-1"></i> Note:</strong>
                    Messages will be sent to selected members who have a valid phone number. Standard SMS API charges may apply.
                </div>
                <button type="submit" id="btn-send-broadcast" class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-2.5 rounded text-sm font-bold shadow-lg hover:shadow-xl hover:from-orange-600 hover:to-red-700 transition flex items-center justify-center gap-2">
                    <i data-lucide="send" class="w-4 h-4"></i> Send Broadcast
                </button>
            </form>
        </div>
    </div>

    <!-- Group Risk Modal -->
    <div id="modal-group-risk" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/50 p-4 animate-fadeIn">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[90vh]">
            <div class="flex justify-between p-4 border-b bg-orange-50 rounded-t-xl">
                <h3 class="font-bold text-orange-800 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5"></i> Insufficient Funds</h3>
                <button onclick="UI.closeModal('modal-group-risk')"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="bg-white border border-slate-200 rounded p-3 mb-4 text-center shadow-sm">
                    <p class="text-xs text-slate-500 uppercase font-bold tracking-wider">Next Contribution</p>
                    <div class="flex justify-center items-baseline gap-2 mt-1">
                        <h2 class="text-xl font-bold text-slate-800" id="gr-date"></h2>
                        <span class="text-xs font-bold px-2 py-0.5 rounded-full" id="gr-days-tag"></span>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1" id="gr-info"></p>
                </div>
                
                <h4 class="font-bold text-sm text-slate-700 mb-2 flex justify-between items-center">
                    <span>At Risk Members</span>
                    <span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full" id="gr-count">0</span>
                </h4>
                <div id="gr-list" class="space-y-2"></div>
                <div id="gr-safe-msg" class="hidden text-center p-6 text-slate-400 italic bg-slate-50 rounded border border-dashed text-sm">
                    <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 text-green-500"></i>
                    All members have sufficient funds.
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Container for PDF Generation -->
    <div style="position: absolute; height: 0; overflow: hidden; width: 0;">
        <div id="pdf-generator-container" class="w-[700px] bg-white p-8 text-slate-900 relative"></div>
        <div id="dps-report-container" class="w-[700px] bg-white p-8 text-slate-900 relative"></div>
        <div id="group-cycle-report-container" class="w-[700px] bg-white p-8 text-slate-900 relative"></div>
    </div>

    <!-- Notification Toast (Moved here to ensure it stays on top of Lock Screen) -->
    <div id="notification-toast" class="fixed top-4 right-4 z-[9999] px-4 py-3 rounded-lg shadow-lg text-white text-sm flex items-center gap-2 hidden animate-slideIn"></div>

    <script>
        const APPS_SCRIPT_TEMPLATE = `
function doGet(e) { return handle(e); }
function doPost(e) { return handle(e); }

function onEdit(e) {
  if (!e) return;
  var sheet = e.source.getActiveSheet();
  var range = e.range;
  if (sheet.getName() == 'Transactions' && range.getColumn() == 4) { // Edited Amount
    var row = range.getRow();
    var txId = sheet.getRange(row, 1).getValue(); // Col A is TxID
    var type = sheet.getRange(row, 6).getValue();
    var loanId = sheet.getRange(row, 2).getValue();
    
    // Valid types that exist in other sheets
    if (type == 'Collection' || type == 'Down Payment') {
      // Use helper to update linked sheet based on unique TxID
      syncLinkedAmount(e.source, txId, type, e.value);
    }
  }
}

function syncLinkedAmount(ss, txId, type, newAmount) {
    if (type == 'Collection') {
        var s = ss.getSheetByName('Collections');
        if (s) {
            var data = s.getDataRange().getValues();
            for (var i = 1; i < data.length; i++) {
                // Col 0 is ID (TxID). STRICT MATCH.
                if (String(data[i][0]) == String(txId)) {
                    s.getRange(i + 1, 4).setValue(newAmount);
                    break;
                }
            }
        }
    }
}

function handle(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(30000);
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    // Reordered Sheet Sequence with Inventory. Renamed Penalties to Income.
    ['Users', 'Members', 'Transactions', 'Savings', 'Expenses', 'Capital', 'ProductSales', 'Inventory', 'Loans', 'FixedDeposits', 'Collections', 'ArchivedLoans', 'Group Loan', 'GroupDPS', 'GroupDPSCollection', 'Income', 'DeletedReceipts', 'EditingHistory', 'FailedLog', 'Config'].forEach(function(n) {
      if (!ss.getSheetByName(n)) {
        var s = ss.insertSheet(n);
        if (n == 'Users') s.appendRow(['ID', 'Name', 'PIN', 'Role', 'Status']);
        if (n == 'Members') s.appendRow(['ID', 'Name', 'Phone', 'Address', 'Status', 'AccountType', 'SavingType', 'SavingAmount', 'SavingDate', 'Operator', 'Flag', 'Restrictions']);
        if (n == 'Transactions') s.appendRow(['ID', 'Ref. ID', 'Name', 'Amount', 'Date', 'Type', 'Remarks', 'Operator']);
        if (n == 'Savings') s.appendRow(['ID', 'MemberName', 'Amount', 'Date', 'Type', 'Remarks', 'Operator']);
        if (n == 'Expenses') s.appendRow(['ID', 'Description', 'Amount', 'Date', 'Type', 'Operator']);
        if (n == 'Capital') s.appendRow(['ID', 'Description', 'Amount', 'Date', 'Type', 'Operator']);
        if (n == 'ProductSales') s.appendRow(['Date', 'InvoiceID', 'Customer', 'Product', 'Price', 'DownPayment', 'DueAmount']);
        if (n == 'Inventory') s.appendRow(['ID', 'Name', 'Category', 'BuyPrice', 'SellPrice', 'Stock', 'MinStock', 'Operator']);
        // UPDATED: Added ProductId at the end (Col 20 / Index 19)
        if (n == 'Loans') s.appendRow(['DisbursementDate', 'ID', 'MemberID', 'Name', 'Principal', 'Rate', 'Total', 'Paid', 'Status', 'Type', 'Category', 'ProdName', 'GName', 'GPhone', 'Duration', 'RefNo', 'Remarks', 'Penalty', 'Operator', 'ProductId']);
        if (n == 'FixedDeposits') s.appendRow(['ID', 'MemberID', 'Principal', 'Rate', 'Duration', 'StartDate', 'MaturityDate', 'MaturityAmount', 'Status', 'Operator', 'PayoutTxID', 'Frequency']);
        if (n == 'Collections') s.appendRow(['ID', 'Ref. ID', 'Name', 'Amount', 'Date', 'Remarks', 'Operator']);
        if (n == 'ArchivedLoans') s.appendRow(['ID', 'DisbursementDate', 'MemberID', 'Name', 'Principal', 'Rate', 'Total', 'Paid', 'Status', 'Type', 'Category', 'RefNo', 'ArchivedDate', 'DriveLink', 'Operator']);
        if (n == 'Group Loan') s.appendRow(['ID', 'Name', 'MemberIDs', 'Contribution', 'Frequency', 'StartDate', 'History', 'Status', 'Penalty', 'Operator']);
        if (n == 'GroupDPS') s.appendRow(['ID', 'Name', 'MemberIDs', 'Contribution', 'Frequency', 'StartDate', 'Duration', 'Status', 'Operator', 'History', 'Penalty']);
        if (n == 'GroupDPSCollection') s.appendRow(['Date', 'GroupID', 'GroupName', 'BatchNo', 'MemberName', 'Amount', 'TxID', 'LinkedTxID', 'ReportLink', 'Operator']);
        if (n == 'Income') s.appendRow(['ID', 'Date', 'MemberName', 'Ref. ID', 'Amount', 'SourceType', 'Reason', 'Remarks', 'Operator']);
        if (n == 'DeletedReceipts') s.appendRow(['DeletedAt', 'TxDate', 'TxID', 'Type', 'Name', 'Ref. ID', 'Amount', 'Remarks', 'Note', 'Operator']);
        if (n == 'EditingHistory') s.appendRow(['Timestamp', 'Type', 'ID', 'Changes', 'Operator']);
        if (n == 'FailedLog') s.appendRow(['Date', 'LoanID', 'MemberName', 'Amount', 'Reason']);
        if (n == 'Config') s.appendRow(['Key', 'Value', 'Updated']);
      }
    });
    var op = e.parameter.op, d = e.postData ? JSON.parse(e.postData.contents) : {};
    op = d.type || op;
    var res = {};
    var operator = d.operator || 'System';
    
    if (op == 'getData') {
      var configSheet = ss.getSheetByName('Config');
      var notice = '', sysConfig = '{}', smsKey = '', adminMobile = '';
      if (configSheet) {
        var cData = configSheet.getDataRange().getValues();
        for(var k=1; k<cData.length; k++) {
          if(cData[k][0] == 'AdminNotice') { notice = cData[k][1]; }
          if(cData[k][0] == 'SysConfig') { sysConfig = cData[k][1]; }
          if(cData[k][0] == 'SmsApiKey') { smsKey = cData[k][1]; }
          if(cData[k][0] == 'AdminMobile') { adminMobile = cData[k][1]; }
        }
      }
      // Fetch recent history for dashboard alerts
      var histData = [];
      var histSheet = ss.getSheetByName('EditingHistory');
      if (histSheet) {
         var lastRow = histSheet.getLastRow();
         if (lastRow > 1) {
             // Get last 20 rows
             var startRow = Math.max(2, lastRow - 19);
             histData = histSheet.getRange(startRow, 1, lastRow - startRow + 1, 5).getValues().reverse();
         }
      }

      res = {
        version: '9.9.9', // Bumped version for Margin Fix
        members: ss.getSheetByName('Members').getDataRange().getValues().slice(1),
        loans: ss.getSheetByName('Loans').getDataRange().getValues().slice(1),
        fixedDeposits: ss.getSheetByName('FixedDeposits').getDataRange().getValues().slice(1),
        transactions: ss.getSheetByName('Transactions').getDataRange().getValues().slice(1),
        archivedLoans: ss.getSheetByName('ArchivedLoans').getDataRange().getValues().slice(1),
        groups: ss.getSheetByName('Group Loan').getDataRange().getValues().slice(1),
        groupDPS: ss.getSheetByName('GroupDPS').getDataRange().getValues().slice(1),
        inventory: ss.getSheetByName('Inventory').getDataRange().getValues().slice(1),
        income: ss.getSheetByName('Income').getDataRange().getValues().slice(1), // Added Income
        users: ss.getSheetByName('Users').getDataRange().getValues().slice(1),
        recentHistory: histData,
        notice: notice,
        sysConfig: sysConfig,
        smsKey: smsKey,
        adminMobile: adminMobile
      };
    } 
    else if (op == 'getDeleted') { res = { data: ss.getSheetByName('DeletedReceipts').getDataRange().getValues().slice(1) }; }
    else if (op == 'getHistory') { res = { data: ss.getSheetByName('EditingHistory').getDataRange().getValues().slice(1) }; }
    else if (d.type == 'updateNotice') { updateConfigKey(ss, 'AdminNotice', d.text); res = { status: 'success' }; }
    else if (d.type == 'updateSysConfig') { updateConfigKey(ss, 'SysConfig', JSON.stringify(d.config)); res = { status: 'success' }; }
    else if (d.type == 'updateSmsKey') { updateConfigKey(ss, 'SmsApiKey', d.key); res = { status: 'success' }; }
    else if (d.type == 'updateAdminMobile') { updateConfigKey(ss, 'AdminMobile', d.mobile); res = { status: 'success' }; }
    else if (d.type == 'addMember') { 
        ss.getSheetByName('Members').appendRow([d.id, d.name, d.phone, d.address, d.status, d.accountType, d.savingType, d.savingAmount, d.savingDate, operator, d.flag || '', d.restrictions || '{}']); 
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Add Member', d.id, 'New Member: ' + d.name, operator]);
        res = { status: 'success' }; 
    }
    else if (d.type == 'addProduct') { ss.getSheetByName('Inventory').appendRow([d.id, d.name, d.category, d.buyPrice, d.sellPrice, d.stock, d.minStock, operator]); res = { status: 'success' }; }
    else if (d.type == 'addFD') {
        ss.getSheetByName('FixedDeposits').appendRow([d.id, d.memberId, d.principal, d.rate, d.duration, d.startDate, d.maturityDate, d.maturityAmount, 'Active', operator, '', d.frequency || 'Maturity']);
        ss.getSheetByName('Transactions').appendRow([d.txId, d.id, d.memberName, d.principal, d.startDate, 'Deposit', 'Fixed Deposit Principal', operator]);
        ss.getSheetByName('Savings').appendRow([d.txId, d.memberName, d.principal, d.startDate, 'Deposit', 'Fixed Deposit', operator]);
        res = { status: 'success' };
    }
    else if (d.type == 'closeFD') {
        var s = ss.getSheetByName('FixedDeposits'), v = s.getDataRange().getValues();
        var link = '';
        if(d.pdf) { 
            try { 
                var f = getFDReportFolder(); 
                var b = Utilities.newBlob(Utilities.base64Decode(d.pdf), 'application/pdf', d.fileName + '.pdf'); 
                var fi = f.createFile(b); 
                fi.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); 
                link = fi.getUrl(); 
            } catch(e) {} 
        }
        for(var i=1; i<v.length; i++) {
            if(String(v[i][0]) == String(d.id)) {
                s.getRange(i+1, 9).setValue('Closed');
                // Handle PayoutTxID column (Index 10) to store History JSON with Closing Link
                var currentVal = v[i][10];
                var history = [];
                try { history = JSON.parse(currentVal || '[]'); if(!Array.isArray(history)) history = []; } catch(e) { history = []; }
                history.push({ type: 'Closing', link: link, txId: d.txId, date: d.date, amount: d.payoutAmount });
                s.getRange(i+1, 11).setValue(JSON.stringify(history));
                break;
            }
        }
        
        // --- DELETE ORIGINAL PRINCIPAL TRANSACTION ---
        var tS = ss.getSheetByName('Transactions'), tD = tS.getDataRange().getValues();
        var txIdToRemove = null;
        for(var i=tD.length-1; i>=1; i--) {
            // Col 1 (Ref ID) == FD ID AND Category == Deposit
            if(String(tD[i][1]) == String(d.id) && tD[i][5] == 'Deposit') {
                txIdToRemove = tD[i][0];
                tS.deleteRow(i+1);
                break; 
            }
        }
        if(txIdToRemove) {
            var sS = ss.getSheetByName('Savings'), sD = sS.getDataRange().getValues();
            for(var i=sD.length-1; i>=1; i--) {
                if(String(sD[i][0]) == String(txIdToRemove)) {
                    sS.deleteRow(i+1);
                    break;
                }
            }
        }
        // ---------------------------------------------
        
        // Transaction logging
        if(d.target === 'SAVINGS') {
             // Log as Deposit (Positive) because it goes into Savings
             ss.getSheetByName('Transactions').appendRow([d.txId, 'SAVINGS', d.memberName, d.payoutAmount, d.date, 'Deposit', 'FD Closing: ' + d.id, operator]); 
             ss.getSheetByName('Savings').appendRow([d.txId, d.memberName, d.payoutAmount, d.date, 'Deposit', 'FD Closing', operator]);
        } else {
             // Legacy fallback
             ss.getSheetByName('Transactions').appendRow([d.txId, 'SAVINGS', d.memberName, -d.payoutAmount, d.date, 'FD Withdrawal', 'Maturity Payout', operator]);
             ss.getSheetByName('Savings').appendRow([d.txId, d.memberName, d.payoutAmount, d.date, 'FD Withdrawal', 'Maturity Payout', operator]);
        }
        res = { status: 'success', link: link };
    }
    else if (d.type == 'payFDMonthlyInterest') {
        var s = ss.getSheetByName('FixedDeposits'), v = s.getDataRange().getValues();
        var history = [];
        for(var i=1; i<v.length; i++) {
            if(String(v[i][0]) == String(d.id)) {
                var cell = s.getRange(i+1, 11); // PayoutTxID column
                var val = cell.getValue();
                try { history = JSON.parse(val); if(!Array.isArray(history)) history = []; } catch(e) { history = val ? [{tx: val, note: 'Legacy'}] : []; }
                history.push({ month: d.month, txId: d.txId, amount: d.amount, date: d.date });
                cell.setValue(JSON.stringify(history));
                break;
            }
        }
        ss.getSheetByName('Transactions').appendRow([d.txId, 'SAVINGS', d.memberName, d.amount, d.date, 'FD Interest', d.collectedBy, operator]);
        ss.getSheetByName('Savings').appendRow([d.txId, d.memberName, d.amount, d.date, 'FD Interest', d.collectedBy, operator]);
        res = { status: 'success' };
    }
    else if (d.type == 'editProduct') {
        var s = ss.getSheetByName('Inventory'), v = s.getDataRange().getValues();
        for(var i=1; i<v.length; i++) {
            if(String(v[i][0]) == String(d.id)) {
                s.getRange(i+1, 2, 1, 6).setValues([[d.name, d.category, d.buyPrice, d.sellPrice, d.stock, d.minStock]]);
                break;
            }
        }
        res = { status: 'success' };
    }
    else if (d.type == 'deleteProduct') { deleteRow(ss, 'Inventory', d.id); res = { status: 'success' }; }
    else if (d.type == 'editMember') { 
        var s = ss.getSheetByName('Members');
        var v = s.getDataRange().getValues();
        var changeLog = 'Edited Member: ' + d.name;
        for (var i = 1; i < v.length; i++) {
            if (String(v[i][0]) == String(d.id)) {
                var oldName = v[i][1];
                s.getRange(i + 1, 2, 1, 8).setValues([[d.name, d.phone, d.address, d.status, d.accountType, d.savingType, d.savingAmount, d.savingDate]]);
                s.getRange(i + 1, 11).setValue(d.flag || '');
                s.getRange(i + 1, 12).setValue(d.restrictions || '{}');
                if (String(oldName) !== String(d.name)) updateNameEverywhere(ss, d.id, d.name, oldName);
                break;
            }
        }
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Edit Member', d.id, changeLog, operator]);
        res = { status: 'success' }; 
    }
    else if (d.type == 'batchTransactions') {
      d.txs.forEach(function(tx) {
        ss.getSheetByName('Transactions').appendRow([tx.id, tx.loanId, tx.memberName, tx.amount, tx.date, tx.category, tx.collectedBy, operator]);
        if(tx.category === 'Penalty') {
             ss.getSheetByName('Income').appendRow([tx.id, tx.date, tx.memberName, tx.loanId, tx.amount, tx.typeTx || 'Loan', tx.collectedBy, tx.collectedBy, operator]);
        }
        else if(tx.loanId=='SAVINGS' || String(tx.loanId).indexOf('GD-')==0 || tx.category=='Withdrawal' || tx.category=='Group Contrib.' || tx.category=='Group Payout' || tx.category=='DPS Transfer' || tx.category=='DPS Payment' || tx.category=='DPS Withdrawal' || tx.category=='Deposit' || tx.category=='Bad Debt' || tx.category=='FD Withdrawal' || tx.category=='FD Interest') 
            ss.getSheetByName('Savings').appendRow([tx.id, tx.memberName, Math.abs(tx.amount), tx.date, tx.category, tx.remarks || tx.collectedBy, operator]);
        else if(tx.category=='Collection') 
            ss.getSheetByName('Collections').appendRow([tx.id, tx.loanId, tx.memberName, tx.amount, tx.date, tx.collectedBy, operator]);
      });
      res = { status: 'success' };
    }
    else if (d.type == 'updateGroupDPSCollection') {
        var link = '';
        if(d.pdf) { 
            try { 
                var f = getGroupDPSFolder(d.folderName), b = Utilities.newBlob(Utilities.base64Decode(d.pdf), 'application/pdf', d.fileName + '.pdf'), fi = f.createFile(b); 
                fi.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); 
                link = fi.getUrl(); 
            } catch(e) {} 
        }
        
        ss.getSheetByName('GroupDPSCollection').appendRow([d.date, d.id, d.folderName, d.serial, 'BATCH_SUMMARY', d.batchAmount, '-', '-', link, operator]);

        var s = ss.getSheetByName('GroupDPS'), v = s.getDataRange().getValues();
        for(var i=1; i<v.length; i++) {
            if(String(v[i][0])==String(d.id)) { 
                var history = [];
                try { history = JSON.parse(v[i][9] || '[]'); } catch(e) {}
                history.push({ serial: d.serial, date: d.date, amount: d.batchAmount, link: link });
                s.getRange(i+1, 10).setValue(JSON.stringify(history)); 
                break; 
            }
        }
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Run DPS', d.id, 'Batch #' + d.serial + ': ' + d.batchAmount, operator]);
        
        if (d.txs && d.txs.length > 0) {
             d.txs.forEach(function(tx) {
                if (tx.category === 'DPS Installment') {
                    ss.getSheetByName('Transactions').appendRow([tx.id, tx.loanId, tx.memberName, tx.amount, tx.date, tx.category, tx.collectedBy, operator]);
                    ss.getSheetByName('Savings').appendRow([tx.id, tx.memberName, Math.abs(tx.amount), tx.date, tx.category, tx.collectedBy, operator]);
                }
             });
        }
        res = { status: 'success', link: link };
    }
    else if (d.type == 'runGroupLoanCycle') {
        var link = '';
        if(d.pdf) { 
            try { 
                var f = getGroupLoanFolder(d.folderName); 
                var b = Utilities.newBlob(Utilities.base64Decode(d.pdf), 'application/pdf', d.fileName + '.pdf'); 
                var fi = f.createFile(b); 
                fi.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); 
                link = fi.getUrl(); 
            } catch(e) {} 
        }
        var s = ss.getSheetByName('Group Loan'), v = s.getDataRange().getValues();
        for(var i=1; i<v.length; i++) {
            if(String(v[i][0]) == String(d.id)) {
                var history = []; try { history = JSON.parse(v[i][6] || '[]'); } catch(e) {}
                history.push({ cycle: d.cycleNo, date: d.date, winnerId: d.winnerId, winnerName: d.winnerName, amount: d.potAmount, link: link });
                s.getRange(i+1, 7).setValue(JSON.stringify(history));
                var memberIDs = JSON.parse(v[i][2] || '[]');
                if (history.length >= memberIDs.length) s.getRange(i+1, 8).setValue('Completed');
                break;
            }
        }
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Run Group Cycle', d.id, 'Cycle #' + d.cycleNo + ' Winner: ' + d.winnerName, operator]);
        if (d.txs && d.txs.length > 0) {
            d.txs.forEach(function(tx) {
                ss.getSheetByName('Transactions').appendRow([tx.id, tx.loanId, tx.memberName, tx.amount, tx.date, tx.category, tx.collectedBy, operator]);
                ss.getSheetByName('Savings').appendRow([tx.id, tx.memberName, Math.abs(tx.amount), tx.date, tx.category, tx.collectedBy, operator]);
            });
        }
        res = { status: 'success', link: link };
    }
    else if (d.type == 'editTransaction') {
        var s = ss.getSheetByName('Transactions'), v = s.getDataRange().getValues();
        for (var i = 1; i < v.length; i++) {
            if (String(v[i][0]) == String(d.id)) {
                var r = v[i], log = [], oldA = Number(r[3]), newA = Number(d.amount);
                if (Math.abs(Math.abs(oldA) - Math.abs(newA)) > 0.001) log.push('Amt: ' + oldA + '->' + newA);
                if (r[6] != d.collectedBy) log.push('Ref: ' + r[6] + '->' + d.collectedBy);
                s.getRange(i + 1, 4).setValue(d.amount); s.getRange(i + 1, 5).setValue(d.date); s.getRange(i + 1, 7).setValue(d.collectedBy);
                var mS = null, mCol = 0;
                if (r[5] == 'Collection' || r[5] == 'Down Payment') { mS = ss.getSheetByName('Collections'); mCol = 4; }
                else if (['Deposit', 'Withdrawal', 'Group Contrib.', 'Group Payout', 'DPS Transfer', 'DPS Payment', 'DPS Withdrawal', 'Bad Debt', 'FD Withdrawal', 'FD Interest'].indexOf(r[5]) > -1 || r[1] == 'SAVINGS' || String(r[1]).indexOf('GD-') == 0) { mS = ss.getSheetByName('Savings'); mCol = 3; }
                if (mS) {
                    var mV = mS.getDataRange().getValues();
                    for (var k = 1; k < mV.length; k++) {
                        if (String(mV[k][0]) == String(d.id)) {
                            mS.getRange(k + 1, mCol).setValue((mCol == 3) ? Math.abs(d.amount) : d.amount);
                            mS.getRange(k + 1, mCol + 1).setValue(d.date);
                            break;
                        }
                    }
                }
                if (log.length > 0) ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Edit Tx', d.id, log.join(', '), operator]);
                break;
            }
        }
        res = { status: 'success' };
    }
    else if (d.type == 'addUser') { ss.getSheetByName('Users').appendRow([d.id, d.name, d.pin, d.role, 'Active']); ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Add User', d.id, 'Added ' + d.name, operator]); res = { status: 'success' }; }
    else if (d.type == 'deleteUser') { deleteRow(ss, 'Users', d.id); ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Delete User', d.id, 'Deleted', operator]); res = { status: 'success' }; }
    else if (d.type == 'addIncome') { ss.getSheetByName('Income').appendRow([d.id, d.date, d.memberName, d.refId, d.amount, d.sourceType, d.reason, d.remarks, operator]); res = { status: 'success' }; }
    else if (d.type.startsWith('add') || d.type.startsWith('edit') || d.type.startsWith('delete') || d.type.startsWith('archive') || d.type.startsWith('consolidate')) {
        handleStandardOps(d, ss, res, operator);
    }
    else if (d.type == 'updateGroup') {
        var s = ss.getSheetByName('Group Loan'), v = s.getDataRange().getValues();
        for(var i=1; i<v.length; i++) if(String(v[i][0])==String(d.id)) { s.getRange(i+1,7).setValue(d.history); s.getRange(i+1,8).setValue(d.status); break; }
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Update Group', d.id, 'Status: ' + d.status, operator]);
        res = { status: 'success' };
    }
    return ContentService.createTextOutput(JSON.stringify(res)).setMimeType(ContentService.MimeType.JSON);
  } catch (e) { return ContentService.createTextOutput(JSON.stringify({ error: e.toString() })).setMimeType(ContentService.MimeType.JSON); } finally { lock.releaseLock(); }
}

function updateConfigKey(ss, key, val) {
    var s = ss.getSheetByName('Config');
    var found = false;
    var data = s.getDataRange().getValues();
    for(var i=1; i<data.length; i++) {
        if(data[i][0] == key) {
            s.getRange(i+1, 2, 1, 2).setValues([[val, new Date()]]);
            found = true;
            break;
        }
    }
    if(!found) s.appendRow([key, val, new Date()]);
}

function handleStandardOps(d, ss, res, operator) {
    if (d.type == 'addLoan') {
        d.principal = Number(d.principal)||0; d.downPayment = Number(d.downPayment)||0;
        // UPDATED: Date moved to first column in appendRow. Added ProductId at end.
        ss.getSheetByName('Loans').appendRow([d.date, d.id, d.memberId, d.memberName, d.principal, d.rate, d.totalRepayable, 0, 'Active', d.loanType, d.category, d.productName, d.guarantorName, d.guarantorPhone, d.duration, d.refNo, d.remarks, d.penalty||0, operator, d.productId||'']);
        ss.getSheetByName('Transactions').appendRow([d.id, d.id, d.memberName, -Math.abs(d.principal), d.date, 'Disbursement', d.collectedBy, operator]);
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Add Loan', d.id, 'New ' + d.loanType + ' Loan: ' + d.principal, operator]);
        if(d.category == 'Product') ss.getSheetByName('ProductSales').appendRow([d.date, d.id, d.memberName, d.productName, d.principal + d.downPayment, d.downPayment, d.totalRepayable]);
        
        // --- INVENTORY ADJUSTMENT ---
        if(d.category == 'Product' && d.productId) {
            var invS = ss.getSheetByName('Inventory');
            if(invS) {
                var invD = invS.getDataRange().getValues();
                for(var i=1; i<invD.length; i++) {
                    if(String(invD[i][0]) == String(d.productId)) {
                        var current = Number(invD[i][5]); // Col F is Stock (index 5)
                        invS.getRange(i+1, 6).setValue(current - 1); 
                        break;
                    }
                }
            }
        }
    } else if (d.type == 'addCollection') {
        ss.getSheetByName('Transactions').appendRow([d.id, d.loanId, d.memberName, d.amount, d.date, d.category, d.collectedBy, operator]);
        ss.getSheetByName('Collections').appendRow([d.id, d.loanId, d.memberName, d.amount, d.date, d.collectedBy, operator]);
    } else if (d.type == 'addPenalty') {
        ss.getSheetByName('Transactions').appendRow([d.id, d.loanId, d.memberName, d.amount, d.date, d.category, d.collectedBy, operator]);
        // Updated to use d.refId if present, else fall back to loanId for the Ref. ID column (Index 3)
        ss.getSheetByName('Income').appendRow([d.id, d.date, d.memberName, d.refId || d.loanId, d.amount, d.sourceType || 'Loan', d.reason || 'Late Fee', d.collectedBy, operator]);
    } else if (d.type == 'addSavingsTx') {
        ss.getSheetByName('Transactions').appendRow([d.id, d.loanId, d.memberName, d.amount, d.date, d.category, d.collectedBy, operator]);
        if (d.loanId === 'CAPITAL') {
            ss.getSheetByName('Capital').appendRow([d.id, d.collectedBy, d.amount, d.date, d.category, operator]);
        } else if (d.loanId === 'OFFICE') {
            if (d.category === 'Other Income') {
                 // Route Other Income to Income Sheet
                 ss.getSheetByName('Income').appendRow([d.id, d.date, d.memberName||'Office', 'OFFICE', d.amount, 'Other', d.category, d.collectedBy, operator]);
            } else {
                 // Expenses stay in Expenses
                 ss.getSheetByName('Expenses').appendRow([d.id, d.collectedBy, d.amount, d.date, d.category, operator]);
            }
        } else {
            ss.getSheetByName('Savings').appendRow([d.id, d.memberName, Math.abs(d.amount), d.date, d.category, d.collectedBy, operator]);
        }
    } else if (d.type == 'deleteTransaction') {
        var tS = ss.getSheetByName('Transactions'), tV = tS.getDataRange().getValues(), delSheet = ss.getSheetByName('DeletedReceipts');
        for(var i=1; i<tV.length; i++) {
            if(String(tV[i][0]) == String(d.id)) {
                if(delSheet) delSheet.appendRow([new Date(), tV[i][4], tV[i][0], tV[i][5], tV[i][2], tV[i][1], tV[i][3], tV[i][6], 'Manual Delete', operator]);
                break;
            }
        }
        deleteRow(ss, 'Transactions', d.id); deleteRow(ss, 'Collections', d.id); deleteRow(ss, 'Savings', d.id); deleteRow(ss, 'Income', d.id); deleteRow(ss, 'Capital', d.id); deleteRow(ss, 'Expenses', d.id);
    } else if (d.type == 'editLoan') {
        var s = ss.getSheetByName('Loans'), v = s.getDataRange().getValues();
        for (var i = 1; i < v.length; i++) {
            // UPDATED: Check index 1 for ID (since Date is at 0)
            if (String(v[i][1]) == String(d.id)) {
                var r = v[i], pd = (d.paid!==undefined)?d.paid:r[7], st = (d.status!==undefined)?d.status:r[8];
                // UPDATED: Principal is now at index 4 (col 5), so getRange(row, 5, ...)
                // Columns: Date(1), ID(2), MemID(3), Name(4), Principal(5)...
                s.getRange(i + 1, 5, 1, 14).setValues([[d.principal, d.rate, d.totalRepayable, pd, st, d.loanType, d.category, d.productName, d.guarantorName, d.guarantorPhone, d.duration, d.refNo, d.remarks, d.penalty||0]]);
                break;
            }
        }
        if(d.principal !== undefined) {
             var tS = ss.getSheetByName('Transactions'), tV = tS.getDataRange().getValues();
             for(var i=1; i<tV.length; i++) if(String(tV[i][1]) == String(d.id) && tV[i][5] == 'Disbursement') { tS.getRange(i+1, 4).setValue(-Math.abs(d.principal)); break; }
        }
        if (d.category == 'Product') {
            if (d.downPayment !== undefined) {
                 var tS = ss.getSheetByName('Transactions'), tV = tS.getDataRange().getValues();
                 for(var i=1; i<tV.length; i++) if(String(tV[i][1]) == String(d.id) && tV[i][5] == 'Down Payment') { tS.getRange(i+1, 4).setValue(d.downPayment); break; }
            }
            upsertProductSale(ss, d.id, d.memberName, d.productName, d.principal, d.downPayment, d.totalRepayable);
        }
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Edit Loan', d.id, 'Updated Loan Details', operator]);
    } else if (d.type == 'editGroup') {
        var s = ss.getSheetByName('Group Loan'), v = s.getDataRange().getValues();
        for(var i=1; i<v.length; i++) if(String(v[i][0])==String(d.id)) { s.getRange(i+1,2,1,8).setValues([[d.name, d.memberIDs, d.contribution, d.frequency, d.startDate, d.history, d.status, d.penalty||0]]); break; }
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Edit Group', d.id, 'Updated Group', operator]);
    } else if (d.type == 'addGroup') {
        ss.getSheetByName('Group Loan').appendRow([d.id, d.name, d.memberIDs, d.contribution, d.frequency, d.startDate, d.history, d.status, d.penalty||0, operator]);
    } else if (d.type == 'deleteGroup') { deleteRow(ss, 'Group Loan', d.id); ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Delete Group', d.id, 'Deleted', operator]);
    } else if (d.type == 'editGroupDPS') {
        var s = ss.getSheetByName('GroupDPS'), v = s.getDataRange().getValues();
        for(var i=1; i<v.length; i++) if(String(v[i][0])==String(d.id)) { s.getRange(i+1,2,1,10).setValues([[d.name, d.memberIDs, d.contribution, d.frequency, d.startDate, d.duration, d.status, operator, v[i][9], d.penalty||0]]); break; }
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Edit DPS', d.id, 'Updated DPS', operator]);
    } else if (d.type == 'addGroupDPS') {
        ss.getSheetByName('GroupDPS').appendRow([d.id, d.name, d.memberIDs, d.contribution, d.frequency, d.startDate, d.duration, d.status, operator, '[]', d.penalty||0]);
    } else if (d.type == 'deleteGroupDPS') { deleteRow(ss, 'GroupDPS', d.id); ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Delete DPS', d.id, 'Deleted', operator]);
    } else if (d.type == 'deleteMember') { deleteRow(ss, 'Members', d.id); ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Delete Member', d.id, 'Deleted', operator]);
    } else if (d.type == 'deleteLoan') { deleteRow(ss, 'Loans', d.id); ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Delete Loan', d.id, 'Deleted', operator]);
    } else if (d.type == 'archiveLoan') {
        var s = ss.getSheetByName('Loans'), v = s.getDataRange().getValues(), rowIdx = -1, lD = null;
        for (var i = 1; i < v.length; i++) {
            // UPDATED: Check index 1 for ID
            if (String(v[i][1]) == String(d.id)) { 
                rowIdx = i + 1; lD = v[i]; break; 
            }
        }
        if (rowIdx > -1) {
            var link = '';
            if (d.pdf) { try { var f = getDriveFolder(), pB = Utilities.newBlob(Utilities.base64Decode(d.pdf), 'application/pdf', d.name + '.pdf'), pF = f.createFile(pB); pF.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); link = pF.getUrl(); } catch (e) {} }
            // UPDATED: lD indices shifted by +1 because Date is at 0
            // lD[0]=Date, lD[1]=ID, lD[2]=MemID, lD[3]=Name, lD[4]=Principal...
            ss.getSheetByName('ArchivedLoans').appendRow([lD[1], d.disbursementDate || '', lD[2], lD[3], lD[4], lD[5], lD[6], lD[7], 'Archived', lD[9], lD[10], lD[15], Utilities.formatDate(new Date(), ss.getSpreadsheetTimeZone(), 'yyyy-MM-dd'), link, operator]);
            s.deleteRow(rowIdx);
            
            deleteRowsByCol(ss, 'Transactions', 1, d.id, operator); 
            deleteRowsByCol(ss, 'Collections', 1, d.id);

            // --- ONE ROW INCOME LOGIC ---
            // 1. Delete ANY existing income records for this loan (e.g. individual penalties)
            // Income Sheet Cols: 0=ID, 1=Date, 2=Name, 3=RefID. We match RefID (Col 3).
            deleteRowsByCol(ss, 'Income', 3, d.id);

            // 2. Add the single consolidated summary row if provided
            if (d.incomeSummary) {
                var is = d.incomeSummary;
                // Income Sheet: ID, Date, MemberName, Ref. ID, Amount, SourceType, Reason, Remarks, Operator
                ss.getSheetByName('Income').appendRow([is.id, is.date, is.memberName, is.refId, is.amount, 'Loan Profit', 'Archive Summary', is.remarks, operator]);
            }
        }
    } else if (d.type == 'archiveGroup') {
        var s = ss.getSheetByName('Group Loan');
        var v = s.getDataRange().getValues();
        for(var i=1; i<v.length; i++) {
            if(String(v[i][0]) == String(d.id)) {
                s.getRange(i+1, 8).setValue('Archived');
                break;
            }
        }
        // Consolidate Income for Group (One Row Logic)
        deleteRowsByCol(ss, 'Income', 3, d.id); 
        if (d.incomeSummary) {
             var is = d.incomeSummary;
             ss.getSheetByName('Income').appendRow([is.id, is.date, is.memberName, is.refId, is.amount, 'Group Income', 'Archive Summary', is.remarks, operator]);
        }
        res = { status: 'success' };
    } else if (d.type == 'consolidateSavings') {
        var ids = d.idsToRemove, sT = ss.getSheetByName('Transactions'), sS = ss.getSheetByName('Savings'), vT = sT.getDataRange().getValues(), vS = sS.getDataRange().getValues();
        for (var i = vT.length - 1; i >= 1; i--) if (ids.indexOf(String(vT[i][0])) > -1) sT.deleteRow(i + 1);
        for (var i = vS.length - 1; i >= 1; i--) if (ids.indexOf(String(vS[i][0])) > -1) sS.deleteRow(i + 1);
        var tx = d.newTx, link = '';
        if(d.pdf) { try { var f = getSavingsFolder(d.folderName), b = Utilities.newBlob(Utilities.base64Decode(d.pdf), 'application/pdf', d.name + '.pdf'), fi = f.createFile(b); fi.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); link = fi.getUrl(); } catch(e){} }
        if(link) tx.collectedBy += '|' + link;
        sT.appendRow([tx.id, tx.loanId, tx.memberName, tx.amount, tx.date, tx.category, tx.collectedBy, operator]);
        sS.appendRow([tx.id, tx.memberName, Math.abs(tx.amount), tx.date, tx.category, tx.collectedBy, operator]);
        ss.getSheetByName('EditingHistory').appendRow([new Date(), 'Consolidate', tx.id, 'Consolidated ' + ids.length + ' records', operator]);
        res.link = link;
    }
    res.status = 'success';
}

function upsertProductSale(ss, id, memberName, prodName, principal, dp, total) {
  var ps = ss.getSheetByName('ProductSales'); if (!ps) return;
  var v = ps.getDataRange().getValues(), found = !1;
  for (var i = 1; i < v.length; i++) if (String(v[i][1]) == String(id)) { ps.getRange(i + 1, 4, 1, 4).setValues([[prodName, Number(principal)+Number(dp), dp, total]]); found = !0; break; }
  if (!found) ps.appendRow([Utilities.formatDate(new Date(), ss.getSpreadsheetTimeZone(), 'yyyy-MM-dd'), id, memberName, prodName, Number(principal)+Number(dp), dp, total]);
}
function updateNameEverywhere(ss, id, newName, oldName) {
  var s = ss.getSheetByName('Loans'), v = s.getDataRange().getValues();
  for (var i = 1; i < v.length; i++) {
      // UPDATED: Check ID at index 1 (since Date is at 0)
      if (String(v[i][1]) == String(id)) {
          // Name is at column 4 (index 3)
          s.getRange(i + 1, 4).setValue(newName);
      }
  }
  var t = ss.getSheetByName('Transactions'), tv = t.getDataRange().getValues();
  for (var i = 1; i < tv.length; i++) if (tv[i][2] == oldName) t.getRange(i + 1, 3).setValue(newName);
  ['Savings', 'Collections', 'ProductSales'].forEach(function(shName) { var sheet = ss.getSheetByName(shName); if (sheet) { var sv = sheet.getDataRange().getValues(), colIdx = (shName == 'Savings') ? 2 : 3; for (var i = 1; i < sv.length; i++) if (sv[i][colIdx - 1] == oldName) sheet.getRange(i + 1, colIdx).setValue(newName); } });
}
function deleteRow(ss, sheetName, id) { 
    var s = ss.getSheetByName(sheetName); if(!s)return; 
    var data = s.getDataRange().getValues(); 
    // UPDATED: For 'Loans' sheet, ID is at index 1. For others, it's at index 0.
    var idIndex = (sheetName == 'Loans') ? 1 : 0;
    
    for (var i = 1; i < data.length; i++) {
        if (String(data[i][idIndex]) == String(id)) { 
            s.deleteRow(i + 1); 
            break; 
        } 
    }
}
function deleteRowsByCol(ss, sheetName, colIndex, value, operator) { var s = ss.getSheetByName(sheetName); if(!s)return; var data = s.getDataRange().getValues(); var archiveSheet = ss.getSheetByName('DeletedReceipts'); for (var i = data.length - 1; i >= 1; i--) if (String(data[i][colIndex]) == String(value)) { if (sheetName == 'Transactions' && archiveSheet) archiveSheet.appendRow([new Date(), data[i][4], data[i][0], data[i][5], data[i][2], data[i][1], data[i][3], data[i][6], 'Cascade Delete', operator]); s.deleteRow(i + 1); } }
function getDriveFolder() { var r=DriveApp.getFoldersByName("MicroFin Archives"),root=r.hasNext()?r.next():DriveApp.createFolder("MicroFin Archives"),lIter=root.getFoldersByName("Loans"),lFolder=lIter.hasNext()?lIter.next():root.createFolder("Loans"),aIter=lFolder.getFoldersByName("Archived Loan"),aFolder=aIter.hasNext()?aIter.next():lFolder.createFolder("Archived Loan"),n=new Date(),y=String(n.getFullYear()),m=Utilities.formatDate(n,Session.getScriptTimeZone(),"MMMM"),yIter=aFolder.getFoldersByName(y),yFolder=yIter.hasNext()?yIter.next():aFolder.createFolder(y),mIter=yFolder.getFoldersByName(m);return mIter.hasNext()?mIter.next():yFolder.createFolder(m);}
function getSavingsFolder(n){var r=DriveApp.getFoldersByName("MicroFin Archives"),root=r.hasNext()?r.next():DriveApp.createFolder("MicroFin Archives"),sIter=root.getFoldersByName("Savings"),sFolder=sIter.hasNext()?sIter.next():root.createFolder("Savings"),tIter=sFolder.getFoldersByName(n);return tIter.hasNext()?tIter.next():sFolder.createFolder(n);}
function getGroupDPSFolder(groupName){
  var r=DriveApp.getFoldersByName("MicroFin Archives"); var root=r.hasNext()?r.next():DriveApp.createFolder("MicroFin Archives");
  var dpsIter=root.getFoldersByName("GroupDPS Report"); var dpsFolder=dpsIter.hasNext()?dpsIter.next():root.createFolder("GroupDPS Report");
  var gIter=dpsFolder.getFoldersByName(groupName); return gIter.hasNext()?gIter.next():dpsFolder.createFolder(groupName);
}
function getGroupLoanFolder(groupName){var r=DriveApp.getFoldersByName("MicroFin Archives"); var root=r.hasNext()?r.next():DriveApp.createFolder("MicroFin Archives");var glIter=root.getFoldersByName("GroupLoan Report"); var glFolder=glIter.hasNext()?glIter.next():root.createFolder("GroupLoan Report");var gIter=glFolder.getFoldersByName(groupName); return gIter.hasNext()?gIter.next():glFolder.createFolder(groupName);}
// NEW: Helper for FD Closing Reports
function getFDReportFolder(){
  var r=DriveApp.getFoldersByName("MicroFin Archives"); var root=r.hasNext()?r.next():DriveApp.createFolder("MicroFin Archives");
  var fdIter=root.getFoldersByName("FD Closing Report"); var fdFolder=fdIter.hasNext()?fdIter.next():root.createFolder("FD Closing Report");
  return fdFolder;
}
`;
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const GOOGLE_SCRIPT_URL = ""; // PASTE YOUR URL HERE
        
        // --- UTILS ---
        const Utils = {
            id: (p) => p + '-' + Math.floor(1000 + Math.random() * 9000) + String.fromCharCode(65 + Math.floor(Math.random() * 26)),
            generateNextId: (prefix, list) => {
                const existingIds = list.map(i => i.id).filter(id => id && id.startsWith(prefix + '-'));
                let maxNum = 0;
                existingIds.forEach(id => {
                    const parts = id.split('-');
                    if (parts.length > 1) {
                        const num = parseInt(parts[1], 10);
                        if (!isNaN(num) && num > maxNum) maxNum = num;
                    }
                });
                return `${prefix}-${String(maxNum + 1).padStart(3, '0')}`;
            },
            timeAgo: (ms) => {
                if(!ms) return '';
                const sec = Math.floor((Date.now() - ms) / 1000);
                if(sec < 60) return 'Just now';
                const min = Math.floor(sec / 60);
                if(min < 60) return `${min}m ago`;
                const hr = Math.floor(min / 60);
                if(hr < 24) return `${hr}h ago`;
                return new Date(ms).toLocaleDateString(); 
            },
            currency: (n) => '‡ß≥' + Number(n).toLocaleString(),
            dateToday: () => {
                const d = new Date();
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            },
            formatISO: (str) => {
                if (!str) return '';
                if (str instanceof Date) { 
                    return `${str.getFullYear()}-${String(str.getMonth()+1).padStart(2,'0')}-${String(str.getDate()).padStart(2,'0')}`;
                }
                if (typeof str !== 'string') return String(str);
                if (str.includes('T')) {
                     const d = new Date(str);
                     if (isNaN(d.getTime())) return str.split('T')[0];
                     return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }
                return str;
            },
            parseDate: (str) => { 
                if(!str) return new Date(); 
                const parts = str.split('-');
                if(parts.length < 3) return new Date(); // Fallback
                const y = Number(parts[0]), m = Number(parts[1]), d = Number(parts[2]);
                if(isNaN(y) || isNaN(m) || isNaN(d)) return new Date();
                return new Date(y, m-1, d); 
            },
            cloneDate: (d) => new Date(d.getTime()),
            notify: (msg, type = 'success') => {
                const t = document.getElementById('notification-toast');
                t.innerHTML = `<i data-lucide="${type==='error'?'alert-circle':'check-circle'}" class="w-4 h-4"></i> ${msg}`;
                t.className = `fixed top-4 right-4 z-[100] px-4 py-3 rounded shadow-lg text-white text-sm flex items-center gap-2 animate-slideIn ${type==='error'?'bg-red-500':(type==='warning'?'bg-orange-500':'bg-green-600')}`;
                t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); lucide.createIcons();
            },
            setLoading: (btn, isLoading, text = 'Processing...') => {
                if(!btn) return;
                if(isLoading) { btn.disabled = true; btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ${text}`; btn.classList.add('opacity-70', 'cursor-not-allowed'); }
                else { btn.disabled = false; btn.innerHTML = btn.getAttribute('data-original-text') || 'Save'; btn.classList.remove('opacity-70', 'cursor-not-allowed'); }
                lucide.createIcons();
            },
            getReminderMsg: (memberId, amount, loanId) => {
                const m = Data.members.find(x => x.id === memberId); if (!m) return "";
                let msg = Data.smsTemplate || "Reminder!\nHello {name}, \nYou have a due of ‡ß≥{amount} for {loanId}. Kindly pay ASAP.\n\nRegards,\nGive&Take";
                return msg.replace('{name}', m.name).replace('{amount}', amount).replace('{loanId}', loanId || 'Loan');
            },
            getWelcomeMsg: (m) => {
                return `Welcome!\nYou're enlisted as a valuable member (${m.name}, ID: ${m.id}) of ${Data.receiptSignature}. Thanks for staying with us.`;
            },
            sendWhatsApp: () => {
                if(!App.receiptData?.phone) return Utils.notify("No phone number", "error");
                window.open(`https://wa.me/${App.receiptData.phone.replace(/[^0-9]/g, '').replace(/^01/, '8801')}?text=${encodeURIComponent(App.receiptData.text)}`, '_blank');
            },
            // --- UPDATED: SMART SMS (API FIRST, LINK FALLBACK) ---
            sendSMS: async (phone, text, silent = false) => {
                if (!phone) return Utils.notify("No phone number", "error");
                
                // Clean phone number (Keep + for international and comma for bulk, strip everything else)
                const p = phone.replace(/[^0-9+,]/g, '');
                
                // Check if API Key is set in Settings
                const apiKey = Data.smsApiKey;
                
                if (apiKey) {
                    // --- API MODE ---
                    // Detect bulk
                    const isBulk = p.includes(',');
                    if (!silent) Utils.notify(isBulk ? "Sending Bulk SMS..." : "Sending SMS via API...", "warning");
                    
                    const url = "https://api.smsmobileapi.com/sendsms/";
                    const data = {
                        recipients: p,
                        message: text,
                        apikey: apiKey
                    };
                    
                    try {
                        const response = await fetch(url, {
                            method: "POST",
                            headers: { "Content-Type": "application/x-www-form-urlencoded" },
                            body: new URLSearchParams(data)
                        });
                        
                        const result = await response.text();
                        
                        if (response.ok) {
                            if (!silent) Utils.notify("SMS Sent Successfully!");
                        } else {
                            if (!silent) Utils.notify("SMS Failed: " + result, "error");
                        }
                    } catch (error) {
                        console.error("SMS Error:", error);
                        if (!silent) Utils.notify("SMS Network Error", "error");
                    }
                } else {
                    // --- FALLBACK TO MANUAL LINK ---
                    const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    const separator = isiOS ? '&' : '?';
                    window.location.href = `sms:${p}${separator}body=${encodeURIComponent(text)}`;
                    if (!silent) Utils.notify("Opening SMS App (No API Key set)", "warning");
                }
            },
            // --- NEW: NOTIFY ADMIN HELPER ---
            notifyAdmin: (type, details) => {
                const adminPhone = Data.adminMobile;
                
                // 1. Build Notification Object for Dashboard (Transient)
                if (!App.sessionNotifications) App.sessionNotifications = [];
                App.sessionNotifications.unshift({
                    type: type,
                    details: details,
                    time: new Date().toLocaleTimeString(),
                    date: Utils.dateToday()
                });
                
                // 2. Check User Role for Notification Silence
                const role = App.currentUser ? App.currentUser.role : '';
                const isSilent = (role === 'Manager' || role === 'Staff');

                // 3. Send SMS to Admin if configured
                if (adminPhone && Data.smsApiKey) {
                    const msg = `[Admin Alert] ${type}: ${details}. Time: ${new Date().toLocaleTimeString()}`;
                    // Fire and forget - don't await to block UI
                    Utils.sendSMS(adminPhone, msg, isSilent).catch(() => {});
                } else {
                    // Fallback visual confirmation for the operator if SMS is off (only for Admin)
                    if (!isSilent) Utils.notify(`System Alert Logged: ${type}`, "warning");
                }
            },
            sendReminder: (memberId, amount, loanId) => {
                const m = Data.members.find(x => x.id === memberId); if (!m || !m.phone) return Utils.notify("No phone number found", "error");
                window.open(`https://wa.me/${m.phone.replace(/[^0-9]/g, '').replace(/^01/, '8801')}?text=${encodeURIComponent(Utils.getReminderMsg(memberId, amount, loanId))}`, '_blank');
            },
            sendWelcome: (id) => {
                const m = Data.members.find(x => x.id === id);
                if(!m || !m.phone) return Utils.notify("No phone number found", "error");
                Utils.sendSMS(m.phone, Utils.getWelcomeMsg(m));
            },
            getSavingsReminderMsg: (memberId, amount, date) => {
                const m = Data.members.find(x => x.id === memberId); if (!m) return "";
                const msg = `Reminder!\nHello ${m.name}, \nFriendly reminder to deposit your ${m.savingType || 'regular'} savings of ‡ß≥${amount} due by ${date}.\n\nRegards,\n${Data.receiptSignature}`;
                return msg;
            },
            sendSavingsReminder: (memberId, amount, date) => {
                const m = Data.members.find(x => x.id === memberId); if (!m || !m.phone) return Utils.notify("No phone number found", "error");
                window.open(`https://wa.me/${m.phone.replace(/[^0-9]/g, '').replace(/^01/, '8801')}?text=${encodeURIComponent(Utils.getSavingsReminderMsg(memberId, amount, date))}`, '_blank');
            },
            copySavingsReminder: (memberId, amount, date) => { const msg = Utils.getSavingsReminderMsg(memberId, amount, date); if(msg) Utils.copy(msg); },
            copyReminder: (memberId, amount, loanId) => { const msg = Utils.getReminderMsg(memberId, amount, loanId); if(msg) Utils.copy(msg); },
            copyUpcomingLoanMsg: (memberId, amount, loanId, date) => { const msg = Utils.getUpcomingLoanMsg(memberId, amount, loanId, date); if(msg) Utils.copy(msg); },
            getUpcomingLoanMsg: (memberId, amount, loanId, date) => {
                const m = Data.members.find(x => x.id === memberId); if (!m) return "";
                return `Hello ${m.name}, \nFriendly reminder: Your payment of ‡ß≥${amount} for ${loanId} is due on ${date}. Please keep your balance ready.\n\nRegards,\n${Data.receiptSignature}`;
            },
            sendUpcomingLoanReminder: (memberId, amount, loanId, date) => {
                const m = Data.members.find(x => x.id === memberId); if (!m || !m.phone) return Utils.notify("No phone number found", "error");
                window.open(`https://wa.me/${m.phone.replace(/[^0-9]/g, '').replace(/^01/, '8801')}?text=${encodeURIComponent(Utils.getUpcomingLoanMsg(memberId, amount, loanId, date))}`, '_blank');
            },
            copyGroupReminder: (mName, gName, deficit, due, bal) => { 
                const msg = `Reminder! Hello ${mName}, please deposit ‡ß≥${deficit} for ${gName} contribution due on ${due}. Current Balance: ‡ß≥${bal}.`; 
                Utils.copy(msg); 
            },
            copy: (text) => {
                const ta = document.createElement("textarea"); ta.value = text; ta.style.position = "fixed"; ta.style.left = "-9999px"; document.body.appendChild(ta); ta.select();
                try { document.execCommand('copy'); Utils.notify("Copied!"); } catch (e) { Utils.notify("Copy failed", "error"); } document.body.removeChild(ta);
            },
            copyReceipt: () => Utils.copy(App.receiptData.text),
            downloadJSON: (data, filename) => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            },
            escapeHtml: (text) => text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"),
            toTitleCase: (str) => (str != null && str !== '') ? String(str).toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : "",
            safeParse: (str) => { try { return JSON.parse(str || '[]'); } catch(e) { return []; } },
            // NEW: Safe parser specifically for Objects to fix Persistence Bug
            safeParseObj: (str) => { try { const res = JSON.parse(str || '{}'); return (Array.isArray(res) ? {} : res); } catch(e) { return {}; } }
        };

        // --- DATA STORE ---
        const Data = {
            scriptUrl: GOOGLE_SCRIPT_URL || localStorage.getItem('mf_script_url') || '',
            smsApiKey: localStorage.getItem('mf_sms_api_key') || '',
            adminMobile: localStorage.getItem('mf_admin_mobile') || '',
            syncMode: localStorage.getItem('mf_sync_mode') || '5', 
            showBalanceOnReceipt: localStorage.getItem('mf_show_balance') !== 'false',
            adminPasscode: localStorage.getItem('mf_admin_pass') || '1234',
            receiptSignature: localStorage.getItem('mf_receipt_sig') || 'Give&Take',
            autoLockMinutes: Number(localStorage.getItem('mf_auto_lock_mins')) || 5,
            smsTemplate: localStorage.getItem('mf_sms_template') || "Reminder!\nHello {name}, \nYou have a due of ‡ß≥{amount} for {loanId}. Kindly pay ASAP.\n\nRegards,\nGive&Take",
            
            members: [], loans: [], transactions: [], archivedLoans: [], groups: [], groupDPS: [], users: [], inventory: [], fixedDeposits: [], notice: '', 
            income: [], // NEW: Income Store
            recentHistory: [], // New for Admin Alerts
            // NEW: System Config for Freeze/Pause
            sysConfig: {
                freeze: { member: false, loan: false, group: false, dps: false },
                pause: { savings: false, collection: false, groupRun: false, dpsRun: false }
            },
            
            pending: [], 
            isSyncing: false,

            initQueue: () => {
                try {
                    const stored = localStorage.getItem('mf_pending');
                    Data.pending = stored ? JSON.parse(stored) : [];
                    App.updateSyncIndicator();
                } catch(e) { Data.pending = []; }
            },
            sync: async (silent = false) => {
                if(!Data.scriptUrl || !Data.scriptUrl.startsWith('http')) return;
                await Data.processQueue(silent);

                const btn = document.getElementById('sync-btn'); btn?.classList.add('animate-spin');
                try {
                    // PATCH: Added timestamp (&t=...) to prevent browser caching of GET requests
                    const res = await fetch(`${Data.scriptUrl}?op=getData&t=${Date.now()}`); 
                    
                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    
                    const text = await res.text();
                    let d;
                    try { 
                        d = JSON.parse(text); 
                    } catch(jsonErr) { 
                        if(text.trim().startsWith('<') || text.includes('Google Accounts')) {
                            throw new Error("ACCESS DENIED: Script permissions are wrong. Set 'Who has access' to 'Anyone' in deployment.");
                        }
                        throw new Error("Invalid Data format. Re-deploy script."); 
                    }
                    
                    if(d.status === 'error') throw new Error(d.message);

                    // Robust Data Mapping using safeParse
                    Data.members = (d.members || []).filter(x => x && x[0]).map(r => ({ id: String(r[0]), name: Utils.toTitleCase(r[1]), phone: String(r[2]), address: r[3], status: r[4], accountType: r[5]||'Personal', savingType: r[6]||'Daily', savingAmount: r[7]||0, savingDate: r[8]||'', savingsBalance: 0, flag: r[10] || '', restrictions: Utils.safeParseObj(r[11]) })); 
                    // UPDATED LOAN MAPPING: disbursementDate is now at index 0, everything else shifted by +1
                    Data.loans = (d.loans || []).filter(x => x && x[1]).map(r => ({ 
                        disbursementDate: r[0]||'', 
                        id: String(r[1]), 
                        memberId: String(r[2]), 
                        memberName: Utils.toTitleCase(r[3]), 
                        principal: Number(r[4])||0, 
                        rate: Number(r[5])||0, 
                        totalRepayable: Number(r[6])||0, 
                        paid: 0, 
                        status: r[8], 
                        loanType: r[9], 
                        category: r[10]||'Cash', 
                        productName: r[11]||'', 
                        guarantorName: r[12]||'', 
                        guarantorPhone: r[13]||'', 
                        duration: Number(r[14])||0, 
                        refNo: r[15] || '', 
                        remarks: r[16] || '', 
                        penalty: Number(r[17])||0, 
                        operator: r[18]||'',
                        productId: r[19]||'' // NEW: Map productId for margin calculation
                    }));
                    Data.transactions = (d.transactions || []).filter(x => x && x[0]).map(r => ({ id: String(r[0]), loanId: String(r[1]), memberName: Utils.toTitleCase(r[2]), amount: Number(r[3])||0, date: Utils.formatISO(r[4]), category: r[5], collectedBy: r[6]||'', operator: r[7]||'-' }));
                    
                    Data.transactions.reverse();
                    Data.transactions.sort((a,b) => (a.date < b.date) ? 1 : ((a.date > b.date) ? -1 : 0));

                    Data.archivedLoans = (d.archivedLoans || []).filter(x => x && x[0]).map(r => ({ id: String(r[0]), disbursementDate: r[1], memberId: String(r[2]), memberName: Utils.toTitleCase(r[3]), principal: Number(r[4])||0, rate: Number(r[5])||0, totalRepayable: Number(r[6])||0, paid: Number(r[7])||0, status: 'Archived', loanType: r[9], category: r[10]||'Cash', refNo: r[11]||'', archivedDate: r[12], driveLink: r[13]||'' })).reverse();
                    
                    Data.groups = (d.groups || []).filter(x => x && x[0]).map(r => ({ id: String(r[0]), name: r[1], memberIDs: Utils.safeParse(r[2]), contribution: Number(r[3]), frequency: r[4], startDate: Utils.formatISO(r[5]), history: Utils.safeParse(r[6]), status: r[7] || 'Active', penalty: Number(r[8])||0 }));
                    Data.groupDPS = (d.groupDPS || []).map(r => ({ id: String(r[0]), name: r[1], memberIDs: Utils.safeParse(r[2]), contribution: Number(r[3]), frequency: r[4], startDate: Utils.formatISO(r[5]), duration: Number(r[6]), status: r[7] || 'Active', history: Utils.safeParse(r[9]), penalty: Number(r[10])||0 }));
                    
                    Data.inventory = (d.inventory || []).filter(x => x && x[0]).map(r => ({ id: String(r[0]), name: r[1], category: r[2], buyPrice: Number(r[3])||0, sellPrice: Number(r[4])||0, stock: Number(r[5])||0, minStock: Number(r[6])||0 }));

                    // FD Mapping - UPDATED: Parse history from PayoutTxID column (index 10)
                    Data.fixedDeposits = (d.fixedDeposits || []).filter(x => x && x[0]).map(r => {
                        const m = Data.members.find(m => m.id === String(r[1]));
                        let history = [];
                        try { history = JSON.parse(r[10] || '[]'); if(!Array.isArray(history)) history = []; } catch(e) { history = []; }
                        return {
                            id: String(r[0]), 
                            memberId: String(r[1]), 
                            memberName: m ? m.name : 'Unknown Member', 
                            principal: Number(r[2]), 
                            rate: Number(r[3]), 
                            duration: Number(r[4]), 
                            startDate: Utils.formatISO(r[5]), 
                            maturityDate: Utils.formatISO(r[6]), 
                            maturityAmount: Number(r[7]), 
                            status: r[8] || 'Active', 
                            operator: r[9] || '-', 
                            payoutTxID: r[10] || '',
                            interestHistory: history, // New property for tracking monthly payments
                            frequency: r[11] || 'Maturity'
                        };
                    });

                    // NEW: Income Mapping
                    Data.income = (d.income || []).map(r => ({ 
                        id: String(r[0]), 
                        date: Utils.formatISO(r[1]), 
                        memberName: r[2], 
                        refId: r[3], 
                        amount: Number(r[4])||0, 
                        sourceType: r[5], 
                        reason: r[6], 
                        remarks: r[7], 
                        operator: r[8] 
                    }));

                    Data.groupDPS.forEach(g => {
                        if (g.history && Array.isArray(g.history)) {
                            const dpsTxs = g.history.map(h => ({ id: `Batch-${g.id}-${h.serial}`, loanId: g.id, memberName: 'Batch Collection', amount: Number(h.amount) || 0, date: Utils.formatISO(h.date), category: 'Group DPS Contrib.', collectedBy: 'System', operator: '-' }));
                            Data.transactions = Data.transactions.concat(dpsTxs);
                        }
                    });

                    const remoteUsers = (d.users || []).map(r => ({ id: String(r[0]), name: r[1], pin: String(r[2]), role: r[3], status: r[4] }));
                    if(remoteUsers.length > 0) { Data.users = remoteUsers; localStorage.setItem('mf_users', JSON.stringify(Data.users)); } 
                    else if (d.users && d.users.length === 0) {
                        if(Data.users.length === 0) {
                             Data.users.push({ id: 'U-ADMIN', name: 'Demo Admin', role: 'Admin', pin: '1234', status: 'Active' });
                             localStorage.setItem('mf_users', JSON.stringify(Data.users));
                        }
                    }
                    
                    // New: Update Notice & SysConfig & SMS Key
                    if (d.notice !== undefined) { Data.notice = d.notice; localStorage.setItem('mf_admin_notice', Data.notice); }
                    if (d.sysConfig) { try { const parsedConfig = JSON.parse(d.sysConfig); Data.sysConfig = { freeze: { ...Data.sysConfig.freeze, ...(parsedConfig.freeze || {}) }, pause: { ...Data.sysConfig.pause, ...(parsedConfig.pause || {}) } }; localStorage.setItem('mf_sys_config', JSON.stringify(Data.sysConfig)); } catch(e) {} }
                    if (d.smsKey !== undefined) { Data.smsApiKey = d.smsKey; localStorage.setItem('mf_sms_api_key', d.smsKey); }
                    if (d.adminMobile !== undefined) { Data.adminMobile = d.adminMobile; localStorage.setItem('mf_admin_mobile', d.adminMobile); }
                    
                    // Recent Logs for Admin Alerts
                    Data.recentHistory = d.recentHistory || [];

                    // --- CACHING: SAVE TO LOCAL STORAGE ---
                    try {
                        const cachePayload = {
                            members: Data.members, loans: Data.loans, transactions: Data.transactions, archivedLoans: Data.archivedLoans, groups: Data.groups, groupDPS: Data.groupDPS, users: Data.users, inventory: Data.inventory, fixedDeposits: Data.fixedDeposits, income: Data.income
                        };
                        localStorage.setItem('mf_cache_data', JSON.stringify(cachePayload));
                    } catch(e) { console.warn("Cache save failed (quota?)", e); }

                    Data.lastSync = Date.now(); localStorage.setItem('mf_last_sync', Data.lastSync); App.updateLastSyncLabel();
                    Logic.recalcBalances(); 
                    if(!silent) Utils.notify("Synced Successfully"); 
                    App.renderContent();
                    
                    if (App.isLocked) App.lockApp();

                } catch(e) { console.warn("Sync error:", e); if(!silent) Utils.notify("Sync Failed: " + e.message, "error"); } finally { btn?.classList.remove('animate-spin'); }
            },
            getDeleted: async () => { try { const res = await fetch(`${Data.scriptUrl}?op=getDeleted&t=${Date.now()}`); const d = await res.json(); return d.data || []; } catch(e){ return []; } },
            getHistory: async () => { try { const res = await fetch(`${Data.scriptUrl}?op=getHistory&t=${Date.now()}`); const d = await res.json(); return d.data || []; } catch(e){ return []; } },
            post: async (type, payload) => {
                if(!Data.scriptUrl || !Data.scriptUrl.startsWith('http')) return; 
                const operator = App.currentUser ? `${App.currentUser.name} (${App.currentUser.id})` : 'System';
                try { 
                    const res = await fetch(Data.scriptUrl, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        body: JSON.stringify({ type, ...payload, operator }) 
                    });
                    if (Data.pending.length > 0) Data.processQueue(true);
                    if (Data.syncMode === 'change') setTimeout(() => Data.sync(true), 500); 
                    return res;
                } catch(e) { 
                    Data.queueRequest({ type, ...payload, operator }); 
                    return { status: 'offline' }; 
                }
            },
            queueRequest: (req) => { Data.pending.push(req); localStorage.setItem('mf_pending', JSON.stringify(Data.pending)); App.updateSyncIndicator(); Utils.notify("Saved Offline (Pending)", "warning"); },
            processQueue: async (silent = false) => {
                if (Data.isSyncing || Data.pending.length === 0) return;
                Data.isSyncing = true;
                if (!silent) Utils.notify("Syncing pending items...");
                const indicator = document.getElementById('offline-indicator'); if(indicator) indicator.classList.add('animate-pulse');
                const snapshot = [...Data.pending]; Data.pending = []; localStorage.setItem('mf_pending', JSON.stringify(Data.pending)); App.updateSyncIndicator();
                const failed = []; let successCount = 0;
                for (const req of snapshot) { try { await fetch(Data.scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(req) }); successCount++; } catch (e) { failed.push(req); } }
                if (failed.length > 0) { Data.pending = [...failed, ...Data.pending]; localStorage.setItem('mf_pending', JSON.stringify(Data.pending)); }
                App.updateSyncIndicator(); if(indicator) indicator.classList.remove('animate-pulse'); Data.isSyncing = false;
                if (successCount > 0) { if (!silent) Utils.notify(`${successCount} items synced!`); if (Data.syncMode === 'change') setTimeout(() => Data.sync(true), 500); }
            }
        };

        const Logic = {
            recalcBalances: () => {
                Data.loans.forEach(l => l.paid = 0); Data.members.forEach(m => m.savingsBalance = 0);
                Data.transactions.forEach(t => {
                    if (!isNaN(t.amount)) {
                        // Loan Repayment Logic (Excludes Penalty)
                        if (t.amount > 0 && t.loanId !== 'SAVINGS' && !t.loanId.startsWith('GD-') && t.category !== 'Down Payment' && t.category !== 'Expense' && t.category !== 'Penalty') { 
                            const l = Data.loans.find(x => x.id === t.loanId); 
                            if (l) l.paid += t.amount; 
                        }
                        // Savings Balance Logic
                        if (t.loanId === 'SAVINGS') { 
                            const m = Data.members.find(x => x.name === t.memberName); 
                            if (m) {
                                // If Penalty is explicitly deducted from savings, handle it. 
                                // Current assumption: Penalties are cash payments (inflow) and do not reduce savings balance unless explicitly withdrawn.
                                // If t.category IS 'Penalty', we ignore it for savings balance (it's a fee).
                                if(t.category !== 'Penalty') m.savingsBalance += t.amount; 
                            }
                        }
                    }
                });
            },
            calcPrincipal: () => {
                const p = Number(document.getElementById('prod-price').value) || 0, d = Number(document.getElementById('prod-dp').value) || 0;
                document.getElementById('loan-principal').value = Math.max(0, p - d); Logic.calcEMI();
            },
            calcRefinance: () => {
                const oldBal = Number(document.getElementById('ref-old-bal-val').value) || 0;
                const topUp = Number(document.getElementById('ref-topup').value) || 0;
                const newPrincipal = oldBal + topUp;
                document.getElementById('ref-new-principal').innerHTML = `<div class="text-right"><div>${Utils.currency(newPrincipal)}</div><div class="text-[10px] text-green-600 font-normal">Cash Out: ${Utils.currency(topUp)}</div></div>`;
                document.getElementById('ref-new-principal-val').value = newPrincipal;
            },
            calcFD: () => {
                const p = Number(document.getElementById('fd-principal').value) || 0;
                const r = Number(document.getElementById('fd-rate').value) || 0;
                const d = Number(document.getElementById('fd-duration').value) || 0;
                const startDateStr = document.getElementById('fd-start-date').value;
                const freq = document.getElementById('fd-frequency').value; // 'Maturity' or 'Monthly'
                
                if (p > 0 && d > 0 && startDateStr) {
                    const start = Utils.parseDate(startDateStr);
                    const end = new Date(start);
                    end.setMonth(start.getMonth() + d);
                    
                    const maturityDateStr = Utils.formatISO(end);
                    document.getElementById('fd-end-date').value = maturityDateStr;
                    
                    // Simple Interest Formula: P + (P * R * T/12)/100
                    const profit = Math.round((p * r * d) / 1200);
                    const monthlyInterest = Math.round((p * r) / 1200);
                    
                    if (freq === 'Monthly') {
                        document.getElementById('fd-final-label').innerText = "Monthly Payout";
                        document.getElementById('fd-maturity-display').innerText = Utils.currency(monthlyInterest);
                        document.getElementById('fd-profit-display').innerText = `Total: ${Utils.currency(profit)}`;
                        document.getElementById('fd-mode-display').innerText = "Monthly Payout";
                        
                        // For Monthly FDs, maturity amount stored is effectively Principal (to return at end)
                        // But UI shows the monthly interest now
                        document.getElementById('fd-maturity-val').value = p; 
                    } else {
                        const total = p + profit;
                        document.getElementById('fd-final-label').innerText = "Maturity Amount";
                        document.getElementById('fd-maturity-display').innerText = Utils.currency(total);
                        document.getElementById('fd-profit-display').innerText = Utils.currency(profit);
                        document.getElementById('fd-mode-display').innerText = "On Maturity";
                        document.getElementById('fd-maturity-val').value = total;
                    }
                }
            },
            
            // NEW: Simulator Logic (Hardened)
            calcSim: () => {
                const p = Number(document.getElementById('sim-principal').value) || 0;
                const r = Number(document.getElementById('sim-rate').value) || 0;
                const d = Number(document.getElementById('sim-duration').value) || 0;
                
                if(p > 0 && d > 0) {
                    const interest = p * (r/100);
                    const total = p + interest;
                    const emi = Math.ceil(total / d);
                    
                    document.getElementById('sim-emi').innerText = Utils.currency(emi);
                    document.getElementById('sim-total').innerText = Utils.currency(total);
                    document.getElementById('sim-interest').innerText = Utils.currency(interest);
                    document.getElementById('sim-result-box').classList.remove('opacity-50');
                } else {
                    document.getElementById('sim-emi').innerText = '0';
                    document.getElementById('sim-total').innerText = '0';
                    document.getElementById('sim-interest').innerText = '0';
                    document.getElementById('sim-result-box').classList.add('opacity-50');
                }
            },

            calcEMI: () => {
                const p = Number(document.getElementById('loan-principal').value), r = Number(document.getElementById('loan-rate').value), d = Number(document.getElementById('loan-duration').value);
                if(p > 0 && d > 0) {
                    const total = p + (p * (r/100)); document.getElementById('calc-total').innerText = Utils.currency(total);
                    document.getElementById('calc-emi').innerText = Utils.currency(Math.ceil(total/d)); document.getElementById('emi-preview').classList.remove('hidden');
                } else document.getElementById('emi-preview').classList.add('hidden');
            },
            checkIsDueOn: (loan, targetDateObj) => {
                const dis = Data.transactions.find(t => t.loanId === loan.id && t.category === 'Disbursement'); if (!dis) return false; 
                const disDate = Utils.parseDate(dis.date), target = new Date(targetDateObj); target.setHours(0,0,0,0);
                if (target <= disDate) return false;
                if (loan.loanType === 'Daily') return true;
                if (loan.loanType === 'Weekly') return disDate.getDay() === target.getDay();
                if (loan.loanType === 'Monthly') {
                    const startDay = disDate.getDate();
                    const targetDay = target.getDate();
                    const lastDayOfTargetMonth = new Date(target.getFullYear(), target.getMonth() + 1, 0).getDate();
                    if (startDay > lastDayOfTargetMonth) { return targetDay === lastDayOfTargetMonth; }
                    return startDay === targetDay;
                }
                return false;
            },
            calculateArrears: (l) => {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const disTx = Data.transactions.find(t => t.loanId === l.id && t.category === 'Disbursement');
                if (!disTx) return 0;
                const disDate = Utils.parseDate(disTx.date);
                const endDate = new Date(yesterday); endDate.setHours(0,0,0,0);
                if (disDate >= endDate) return 0;
                let expectedAmount = 0;
                let loopDate = new Date(disDate);
                const emi = Math.ceil(l.totalRepayable / (l.duration || 1));
                let safety = 0;
                // INCREASED SAFETY LIMIT FROM 1000 TO 5000 TO SUPPORT LONG-TERM LOANS (>3 YEARS)
                while(loopDate <= endDate && safety < 5000) { if(Logic.checkIsDueOn(l, loopDate)) expectedAmount += emi; loopDate.setDate(loopDate.getDate() + 1); safety++; }
                return Math.max(0, Math.min(expectedAmount, l.totalRepayable) - l.paid);
            },
            calculateDPSMaturity: (dps) => {
                const startDate = Utils.parseDate(dps.startDate);
                const maturityDate = new Date(startDate);
                maturityDate.setMonth(startDate.getMonth() + dps.duration);
                return maturityDate;
            },
            getDPSTotalCollected: (dpsId) => {
                return Data.transactions
                    .filter(t => t.loanId === dpsId && (t.category === 'Group DPS Contrib.' || t.category === 'Group Contrib.'))
                    .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
            },
            getSavingsStatus: (m) => {
                const today = new Date(); today.setHours(0,0,0,0);
                const lastTx = Data.transactions.reduce((max, t) => (t.loanId === 'SAVINGS' && t.memberName === m.name && t.category === 'Deposit' && t.amount > 0 && (!max || t.date > max.date)) ? t : max, null);
                const lastDate = lastTx ? Utils.parseDate(lastTx.date) : null;
                let nextDue = Utils.cloneDate(today); let isDue = false;
                if (m.savingType === 'Daily') { if (lastDate && lastDate.getTime() === today.getTime()) { nextDue.setDate(today.getDate() + 1); isDue = false; } else { nextDue = today; isDue = true; } } 
                else if (m.savingType === 'Weekly') {
                     const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'], targetDayIdx = days.indexOf(m.savingDate || 'Saturday'), currentDayIdx = today.getDay();
                     let diff = targetDayIdx - currentDayIdx; let targetThisWeek = Utils.cloneDate(today); targetThisWeek.setDate(today.getDate() + diff);
                     let nextPotential = Utils.cloneDate(targetThisWeek); if (nextPotential < today) nextPotential.setDate(nextPotential.getDate() + 7);
                     nextDue = nextPotential; let prevDeadline = Utils.cloneDate(nextPotential); prevDeadline.setDate(prevDeadline.getDate() - 7);
                     if (!lastDate || lastDate < prevDeadline || (lastDate >= prevDeadline && lastDate < nextPotential && nextPotential.getTime() === today.getTime())) isDue = true; else isDue = false;
                } else if (m.savingType === 'Monthly') {
                    const targetDay = parseInt(m.savingDate) || 1; 
                    let nextPotential = new Date(today.getFullYear(), today.getMonth(), targetDay);
                    const lastDayOfThisMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                    if (targetDay > lastDayOfThisMonth) nextPotential.setDate(lastDayOfThisMonth);
                    if (nextPotential < today) {
                        nextPotential.setMonth(nextPotential.getMonth() + 1);
                        const lastDayOfNextMonth = new Date(nextPotential.getFullYear(), nextPotential.getMonth() + 1, 0).getDate();
                        if (targetDay > lastDayOfNextMonth) nextPotential.setDate(lastDayOfNextMonth);
                    }
                    nextDue = nextPotential; 
                    let prevDeadline = new Date(nextPotential); prevDeadline.setMonth(prevDeadline.getMonth() - 1);
                    if (!lastDate || lastDate < prevDeadline || (lastDate >= prevDeadline && lastDate < nextPotential && nextPotential.getTime() === today.getTime())) isDue = true; else isDue = false;
                }
                return { lastDate, lastTxDate: lastTx ? lastTx.date : null, nextDue, isDue };
            },
            getGroupStatus: (g, type) => {
                const start = Utils.parseDate(g.startDate), today = new Date(); today.setHours(0,0,0,0);
                let next = new Date(start);
                if (type === 'loan') { 
                    const c = (g.history||[]).length;
                    if (g.frequency === 'Monthly') next.setMonth(start.getMonth() + c);
                    else next.setDate(start.getDate() + (c * (g.frequency === 'Weekly' ? 7 : 1)));
                } else { 
                    if (g.frequency === 'Monthly') { next.setFullYear(today.getFullYear(), today.getMonth(), start.getDate()); if (next < today) next.setMonth(next.getMonth() + 1); }
                    else if (g.frequency === 'Weekly') { const d = start.getDay() - today.getDay(); next = new Date(today); next.setDate(today.getDate() + (d < 0 ? d + 7 : d)); }
                    else next = new Date(today);
                    const last = g.history?.slice(-1)[0]; 
                    if (last && Utils.parseDate(last.date) >= next) {
                        if (g.frequency === 'Monthly') next.setMonth(next.getMonth() + 1);
                        else next.setDate(next.getDate() + (g.frequency === 'Weekly' ? 7 : 1));
                    }
                }
                const days = Math.ceil((next - today) / 864e5);
                const badge = days <= 0 ? `<span class="bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded animate-pulse border border-red-200 shadow-sm flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> DUE TODAY</span>` : 
                              (days <= 2 ? `<span class="bg-orange-100 text-orange-600 text-[10px] font-bold px-2 py-1 rounded border border-orange-200">Due in ${days}d</span>` : 
                              `<span class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded border border-slate-200">Next: ${next.toLocaleDateString()}</span>`);
                // Updated to return 'days' for dashboard calculation
                return { badge, canRun: (App.currentUser?.role === 'Admin' || days <= 0), days: days };
            },
            filterDataByDate: (list, mode, dStart, dEnd) => {
                if (mode === 'today') return list.filter(t => t.date === Utils.dateToday());
                if (mode === 'specific' && (dEnd || dStart)) return list.filter(t => t.date === (dEnd || dStart));
                if (mode === 'upto' && (dEnd || dStart)) return list.filter(t => t.date <= (dEnd || dStart));
                if (mode === 'range' && dStart && dEnd) return list.filter(t => t.date >= dStart && t.date <= dEnd);
                return list; 
            }
        };

        const UI = {
            toggleSavingDate: (val) => { document.getElementById('mem-saving-weekly-box').classList.toggle('hidden', val !== 'Weekly'); document.getElementById('mem-saving-monthly-box').classList.toggle('hidden', val !== 'Monthly'); },
            toggleFilterVisibility: (prefix, renderFn) => {
                const type = document.getElementById(`${prefix}-filter`).value, dStart = document.getElementById(`${prefix}-date-start`) || document.getElementById(`${prefix}-date-input`), dEnd = document.getElementById(`${prefix}-date-end`);
                if(dStart) dStart.classList.add('hidden'); if(dEnd) dEnd.classList.add('hidden');
                if(type === 'specific' || type === 'upto') { const target = dEnd || dStart; if(target) { target.classList.remove('hidden'); if(!target.value) target.value = Utils.dateToday(); } } 
                else if (type === 'range') { if(dStart) dStart.classList.remove('hidden'); if(dEnd) dEnd.classList.remove('hidden'); }
                if(renderFn) renderFn();
            },
            toggleLoanType: (type) => {
                const isCash = type === 'Cash';
                document.getElementById('type-cash').className = isCash ? "flex-1 py-2 rounded bg-white shadow text-blue-600" : "flex-1 py-2 rounded text-slate-500";
                document.getElementById('type-product').className = !isCash ? "flex-1 py-2 rounded bg-white shadow text-blue-600" : "flex-1 py-2 rounded text-slate-500";
                document.getElementById('product-fields').classList.toggle('hidden', isCash);
                document.getElementById('loanCategory').value = type; document.getElementById('loan-principal').readOnly = !isCash; if(isCash) document.getElementById('loan-principal').value = '';
            },
            
            // NEW: Copy Helper for Simulator
            copySimulatorResult: () => {
                const p = document.getElementById('sim-principal').value;
                const r = document.getElementById('sim-rate').value;
                const d = document.getElementById('sim-duration').value;
                const f = document.getElementById('sim-freq').value;
                const emi = document.getElementById('sim-emi').innerText;
                const total = document.getElementById('sim-total').innerText;
                
                if(!p || !d) return Utils.notify("Please calculate first", "error");
                
                const text = `*Loan Quote*\nPrincipal: ${Utils.currency(p)}\nRate: ${r}%\nDuration: ${d} ${f}\n\n*EMI: ${emi}*\nTotal Payable: ${total}\n\nGenerated by ${Data.receiptSignature}`;
                Utils.copy(text);
            },

            // NEW Helper for Flags
            getFlagIcon: (flag) => {
                const map = {
                    'High Risk': { i: 'üö©', c: 'text-red-500', t: 'High Risk' },
                    'VIP': { i: 'üåü', c: 'text-yellow-500', t: 'VIP' },
                    'Flight Risk': { i: '‚ö†Ô∏è', c: 'text-orange-500', t: 'Flight Risk' },
                    'Defaulter': { i: 'üö´', c: 'text-slate-900', t: 'Defaulter' }
                };
                const f = map[flag];
                return f ? `<span class="${f.c} ml-1" title="${f.t}">${f.i}</span>` : '';
            },

            filterFDMember: (val) => {
                const list = document.getElementById('fd-member-dropdown'); 
                list.classList.remove('hidden'); 
                const term = val.toLowerCase();
                list.innerHTML = Data.members.filter(m => m.name.toLowerCase().includes(term) || m.id.toLowerCase().includes(term) || m.phone.includes(term))
                    .slice(0, 10)
                    .map(m => `<div onclick="UI.selectFDMember('${m.id}', '${m.name.replace(/'/g, "\\'")}')" class="p-2 hover:bg-indigo-50 cursor-pointer border-b text-sm"><div class="flex justify-between items-center mb-0.5"><span class="font-bold text-slate-700">${m.name}</span><span class="font-mono text-[10px] text-slate-500">${m.id}</span></div></div>`).join('');
                lucide.createIcons();
            },

            selectFDMember: (id, name) => {
                document.getElementById('fd-member-search').value = name;
                document.getElementById('fd-member-id').value = id;
                document.getElementById('fd-member-dropdown').classList.add('hidden');
            },

            // NEW: Filter Logic for Transaction Modal
            filterTxMember: (val) => {
                const list = document.getElementById('tx-member-dropdown'); 
                const term = val.toLowerCase();
                if (!term) { list.classList.add('hidden'); return; } // Hide if empty
                list.classList.remove('hidden'); 
                list.innerHTML = Data.members.filter(m => m.name.toLowerCase().includes(term) || m.id.toLowerCase().includes(term) || m.phone.includes(term))
                    .slice(0, 10) // Limit results for speed
                    .map(m => `<div onclick="UI.selectTxMember('${m.id}', '${m.name.replace(/'/g, "\\'")}')" class="p-2 hover:bg-blue-50 cursor-pointer border-b text-sm"><div class="flex justify-between items-center mb-0.5"><span class="font-bold text-slate-700">${m.name} ${UI.getFlagIcon(m.flag)}</span><span class="font-mono text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border">${m.id}</span></div><div class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${m.phone}</div></div>`).join('');
                lucide.createIcons();
            },

            // NEW: Select Member Logic for Transaction Modal
            selectTxMember: (id, name) => {
                document.getElementById('tx-member-search').value = name;
                document.getElementById('tx-specific-member').value = name;
                document.getElementById('tx-member-dropdown').classList.add('hidden');
                
                // Show hint for selected member
                const m = Data.members.find(x => x.id === id);
                if (m) {
                    const hint = document.getElementById('tx-hint');
                    const lastTx = Data.transactions.find(t => t.memberName === m.name && t.category === 'Deposit');
                    hint.innerHTML = `Bal: ${Utils.currency(m.savingsBalance)}<span class="text-slate-400 font-normal ml-2 text-[10px] uppercase tracking-wide">Last Deposit: ${lastTx ? lastTx.date : 'Never'}</span>`; 
                    hint.classList.remove('hidden'); 
                    hint.className = "text-xs font-bold text-blue-600 flex items-center mt-1";
                    
                    // Auto-fill target amount if any
                    if(m.savingAmount > 0) document.getElementById('tx-amount').value = m.savingAmount;
                }
            },

            filterDropdown: (val) => {
                const list = document.getElementById('member-dropdown'); 
                const term = val.toLowerCase();
                
                // FIX: Hide dropdown if input is empty to prevent "frozen" list
                if (!term) {
                    list.classList.add('hidden');
                    return;
                }

                list.classList.remove('hidden'); 
                
                // FIX: Hide warning when user starts typing/searching
                const warningBox = document.getElementById('loan-member-warning');
                if (warningBox) warningBox.classList.add('hidden');

                const exactMatch = Data.members.find(m => m.name.toLowerCase() === term); document.getElementById('selected-member-id').value = exactMatch ? exactMatch.id : '';
                list.innerHTML = Data.members.filter(m => m.name.toLowerCase().includes(term) || m.id.toLowerCase().includes(term) || m.phone.includes(term)).map(m => `<div onclick="UI.selectMember('${m.id}', '${m.name.replace(/'/g, "\\'")}')" class="p-2 hover:bg-blue-50 cursor-pointer border-b text-sm"><div class="flex justify-between items-center mb-0.5"><span class="font-bold text-slate-700">${m.name} ${UI.getFlagIcon(m.flag)}</span><span class="font-mono text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border">${m.id}</span></div><div class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${m.phone}</div></div>`).join('');
                lucide.createIcons();
            },
            selectMember: (id, name) => { 
                document.getElementById('member-search').value = name; 
                document.getElementById('selected-member-id').value = id; 
                document.getElementById('member-dropdown').classList.add('hidden');
                
                // Immediate Warning Logic
                const warningBox = document.getElementById('loan-member-warning');
                if (warningBox) {
                    const activeLoans = Data.loans.filter(l => String(l.memberId) === String(id) && l.status.toLowerCase() === 'active' && (l.totalRepayable - l.paid) > 1);
                    if (activeLoans.length > 0) {
                        const totalDue = activeLoans.reduce((s, l) => s + (l.totalRepayable - l.paid), 0);
                        warningBox.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4"></i> <span>Warning: Has ${activeLoans.length} Active Loan(s). Due: ${Utils.currency(totalDue)}</span>`;
                        warningBox.classList.remove('hidden');
                        lucide.createIcons();
                    } else {
                        warningBox.classList.add('hidden');
                    }
                }
            },
            openModal: (id) => document.getElementById(id).classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            switchAssistantTab: (tab) => {
                App.activeAssistantTab = tab; const tCol = document.getElementById('tab-ast-collection'), tUpc = document.getElementById('tab-ast-upcoming'), tRem = document.getElementById('tab-ast-reminder');
                const active = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 border-indigo-600 text-indigo-600 bg-white transition-colors", inactive = "flex-1 py-3 text-xs font-bold uppercase tracking-wider border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors";
                tCol.className = (tab === 'collection') ? active + " rounded-tl-lg" : inactive; tUpc.className = (tab === 'upcoming') ? active : inactive; tRem.className = (tab === 'reminder') ? active : inactive;
                document.getElementById('ast-filter-select').classList.toggle('hidden', App.assistantMode !== 'loan'); App.renderAssistant();
            },
            openTransactionModal: (ctxId, cat, title, prefillAmount = null, specificMemberName = null, penaltyAmount = 0, referenceId = null) => {
                // GUARD: Check Global Pauses
                if (cat === 'Deposit' || cat === 'Withdrawal') {
                    if (Data.sysConfig.pause.savings) return Utils.notify("Savings operations are PAUSED globally.", "error");
                }
                if (cat === 'Collection') {
                    if (Data.sysConfig.pause.collection) return Utils.notify("Collections are PAUSED globally.", "error");
                }

                // GUARD: Check Member Restrictions (Hard Block at Open)
                let m = null;
                if (specificMemberName) m = Data.members.find(x => x.name === specificMemberName);
                else if (ctxId !== 'SAVINGS' && ctxId !== 'CAPITAL' && ctxId !== 'OFFICE') {
                    const l = Data.loans.find(x => x.id === ctxId);
                    if (l) m = Data.members.find(x => x.id === l.memberId);
                }
                
                if (m && m.restrictions) {
                    if (m.restrictions.block) return Utils.notify(`Member ${m.name} is BLOCKED from all transactions.`, "error");
                    if (cat === 'Withdrawal' && m.restrictions.noWithdraw) return Utils.notify(`Member ${m.name} is blocked from Withdrawals.`, "error");
                }

                document.getElementById('form-transaction').reset(); document.getElementById('tx-title').innerText = title;
                document.getElementById('tx-context-id').value = ctxId; document.getElementById('tx-category').value = cat; document.getElementById('tx-editing-id').value = ''; 
                document.getElementById('tx-specific-member').value = specificMemberName || '';
                document.getElementById('tx-reference-id').value = referenceId || ''; // Store Reference ID
                document.querySelector('[name="date"]').value = Utils.dateToday();
                const hint = document.getElementById('tx-hint'); hint.classList.add('hidden');
                const metaInput = document.getElementById('tx-meta-input');
                const metaLabel = document.getElementById('tx-meta-label');
                
                // NEW: Handle Quick Deposit Member Selection
                const memberSelectBox = document.getElementById('tx-member-select-box');
                const memberSearchInput = document.getElementById('tx-member-search');
                
                if (ctxId === 'SAVINGS' && !specificMemberName) {
                    // This is a "Quick Deposit" - show search
                    memberSelectBox.classList.remove('hidden');
                    memberSearchInput.value = ''; // Reset search
                    document.getElementById('tx-specific-member').value = ''; // Clear previous
                } else {
                    // Standard transaction - hide search
                    memberSelectBox.classList.add('hidden');
                }

                // Penalty Logic
                const pBox = document.getElementById('tx-penalty-box');
                const pInput = document.getElementById('tx-penalty');
                const pBtn = document.getElementById('btn-waive-penalty');
                pInput.readOnly = App.currentUser.role === 'Staff';
                pBtn.classList.toggle('hidden', App.currentUser.role === 'Staff');

                if (penaltyAmount > 0) {
                    pBox.classList.remove('hidden');
                    pInput.value = penaltyAmount;
                } else {
                    pBox.classList.add('hidden');
                    pInput.value = '';
                }

                if(cat === 'Withdrawal' || cat === 'Expense' || cat === 'Other Income') { metaLabel.innerText = 'Remarks'; metaInput.placeholder = 'Optional notes...'; metaInput.value = ''; }
                else if (cat.includes('Capital')) { metaLabel.innerText = 'Description'; metaInput.placeholder = 'Source/Reason...'; metaInput.value = ''; }
                else { metaLabel.innerText = 'Remarks'; metaInput.placeholder = 'Optional notes/Collector'; metaInput.value = App.currentUser ? App.currentUser.name : 'System'; }
                
                if (prefillAmount !== null) document.getElementById('tx-amount').value = prefillAmount;
                else if (cat === 'Collection') {
                    const l = Data.loans.find(x => x.id === ctxId);
                    if (l) { 
                        const due = l.totalRepayable - l.paid, emi = l.duration > 0 ? Math.ceil(l.totalRepayable / l.duration) : due; 
                        document.getElementById('tx-amount').value = Math.min(emi, due); 
                        hint.innerText = `Due: ${Utils.currency(due)}`; hint.classList.remove('hidden'); hint.className = "text-xs font-bold text-red-600";
                        
                        // Auto-suggest penalty if overdue
                        const arrears = Logic.calculateArrears(l);
                        if (arrears > 0 && l.penalty > 0) {
                            pBox.classList.remove('hidden');
                            pInput.value = l.penalty;
                        }
                    }
                } else if ((cat === 'Withdrawal' || cat === 'Deposit') && m) { 
                    // Only prefill if m exists (specific member)
                    if(cat === 'Deposit' && m.savingAmount > 0) document.getElementById('tx-amount').value = m.savingAmount;
                    const lastTx = Data.transactions.find(t => t.memberName === m.name && t.category === cat);
                    hint.innerHTML = `Bal: ${Utils.currency(m.savingsBalance)}<span class="text-slate-400 font-normal ml-2 text-[10px] uppercase tracking-wide">Last ${cat}: ${lastTx ? lastTx.date : 'Never'}</span>`; hint.classList.remove('hidden'); hint.className = "text-xs font-bold text-blue-600 flex items-center"; 
                } 
                
                const amtEl = document.getElementById('tx-amount');
                amtEl.readOnly = (cat === 'FD Interest');
                amtEl.classList.toggle('bg-slate-100', cat === 'FD Interest');
                amtEl.classList.toggle('cursor-not-allowed', cat === 'FD Interest');

                const btn = document.getElementById('btn-save-tx'); if(btn) btn.setAttribute('data-original-text', '<span>Confirm</span>'); UI.openModal('modal-transaction');
            },
            openReceipt: (tx) => {
                const loan = Data.loans.find(l => l.id === tx.loanId), combinedId = (loan && tx.id !== loan.id) ? `${tx.id}/${loan.id}` : tx.id;
                let html = `<div class="flex justify-between"><span>Date:</span><span class="font-bold">${tx.date}</span></div><div class="flex justify-between"><span>Type:</span><span class="font-bold uppercase">${tx.category}</span></div><div class="flex justify-between"><span>ID:</span><span class="font-bold text-xs">${combinedId}</span></div><div class="flex justify-between"><span>Name:</span><span class="font-bold">${tx.memberName||'Office'}</span></div><div class="flex justify-between"><span>Remarks:</span><span class="font-bold">${tx.collectedBy||'-'}</span></div>`, txt = `*Receipt*\nDate: ${tx.date}\nType: ${tx.category}\nID: ${combinedId}\nName: ${tx.memberName||'Office'}`; 
                if(tx.collectedBy) txt += `\nRemarks: ${tx.collectedBy}`;
                if (loan) {
                    const prevOut = loan.totalRepayable - loan.paid, currDue = prevOut - Math.abs(tx.amount); 
                    if (loan.category === 'Product') {
                        const prodIdentifier = loan.refNo || loan.productName; html += `<hr class="my-2 border-dashed"><div class="flex justify-between"><span>Product:</span><span class="font-bold">${prodIdentifier}</span></div>`; txt += `\nProduct: ${prodIdentifier}`;
                        const dpTx = Data.transactions.find(t => t.loanId === loan.id && t.category === 'Down Payment'), dp = dpTx ? Math.abs(dpTx.amount) : 0, totalPrice = loan.totalRepayable + dp;
                        if(tx.category === 'Collection') { html += `<div class="flex justify-between"><span>Prev Due:</span><span>${Utils.currency(prevOut)}</span></div><div class="flex justify-between"><span>Paid:</span><span>${Utils.currency(Math.abs(tx.amount))}</span></div><div class="flex justify-between text-red-600 font-bold"><span>Curr Due:</span><span>${Utils.currency(currDue)}</span></div>`; txt += `\nPrev Due: ${Utils.currency(prevOut)}\nPaid: ${Utils.currency(Math.abs(tx.amount))}\nCurr Due: ${Utils.currency(currDue)}`; } 
                        else { html += `<div class="flex justify-between"><span>Total Price:</span><span>${Utils.currency(totalPrice)}</span></div><div class="flex justify-between"><span>Down Pay:</span><span>${Utils.currency(Math.abs(tx.amount))}</span></div><div class="flex justify-between text-red-600 font-bold"><span>Balance Due:</span><span>${Utils.currency(currDue)}</span></div>`; txt += `\nTotal Price: ${Utils.currency(totalPrice)}\nDown Pay: ${Utils.currency(Math.abs(tx.amount))}\nBalance Due: ${Utils.currency(currDue)}`; }
                    } else if (tx.category === 'Collection') { 
                        html += `<hr class="my-2 border-dashed"><div class="flex justify-between"><span>Due Amount:</span><span>${Utils.currency(prevOut)}</span></div><div class="flex justify-between"><span>Paid:</span><span>${Utils.currency(Math.abs(tx.amount))}</span></div><div class="flex justify-between text-red-600 font-bold border-t border-dashed pt-1 mt-1"><span>Curr Due:</span><span>${Utils.currency(currDue)}</span></div>`;
                        txt += `\nDue Amount: ${Utils.currency(prevOut)}\nPaid: ${Utils.currency(Math.abs(tx.amount))}\nCurr Due: ${Utils.currency(currDue)}`;
                    } else txt += `\nAmount: ${Utils.currency(Math.abs(tx.amount))}`;
                } else {
                    if (tx.loanId === 'SAVINGS' && Data.showBalanceOnReceipt) {
                        let runningBalance = 0;
                        for (let i = Data.transactions.length - 1; i >= 0; i--) { const t = Data.transactions[i]; if (t.loanId === 'SAVINGS' && t.memberName === tx.memberName) { runningBalance += t.amount; if (t.id === tx.id) break; } }
                        html += `<hr class="my-2 border-dashed"><div class="flex justify-between text-blue-600 font-bold"><span>Balance:</span><span>${Utils.currency(runningBalance)}</span></div>`; txt += `\nAmount: ${Utils.currency(Math.abs(tx.amount))}\nBalance: ${Utils.currency(runningBalance)}`;
                    } else txt += `\nAmount: ${Utils.currency(Math.abs(tx.amount))}`;
                }
                html += `<div class="my-3 py-2 border-y-2 border-dashed flex justify-between font-bold text-lg"><span>TOTAL</span><span>${Utils.currency(Math.abs(tx.amount))}</span></div>`; document.getElementById('rcpt-content').innerHTML = html;
                
                if (tx.category.includes('FD') || String(tx.loanId).startsWith('FD')) {
                    txt += `\n\nRegards,\nGive&Take`;
                } else {
                    txt += (tx.category === 'Withdrawal' || tx.category === 'Disbursement') ? `\n\nThanks,\n${Data.receiptSignature}` : `\n\nThanks for payment,\n${Data.receiptSignature}`;
                }
                
                App.receiptData = { phone: Data.members.find(m=>m.name===tx.memberName)?.phone, text: txt }; UI.openModal('modal-receipt');
            },
            viewReceipt: (id) => { const t = Data.transactions.find(x => x.id === id); if(t) UI.openReceipt(t); },
            renderHistoryTable: (filter) => {
                const ctx = App.activeHistoryContext; if(!ctx) return;
                let h = (ctx.type === 'member') ? Data.transactions.filter(t => t.memberName === ctx.name) : Data.transactions.filter(t => t.loanId === ctx.id);
                if (App.activeTab === 'savings' && ctx.type === 'member') h = h.filter(t => ['Deposit','Withdrawal','DPS Withdrawal','Balance Forward','Group Contrib.','Group Payout','DPS Payment','FD Withdrawal','FD Interest'].includes(t.category));
                if(filter !== 'All') h = h.filter(t => t.category === filter);
                document.getElementById('pb-body').innerHTML = h.slice(0, 50).map(t => {
                    const m = Data.members.find(x => x.name === t.memberName), idDisplay = m ? `<span class="font-mono text-[9px] bg-slate-100 border px-1 rounded text-slate-500 ml-1 whitespace-nowrap">${m.id}</span>` : '';
                    let colBy = t.collectedBy || '-', link = ''; if(colBy.includes('|http')) { const parts = colBy.split('|'); colBy = parts[0]; link = parts[1]; }
                    const isNeg = t.amount < 0 || t.category === 'Penalty';
                    return `<tr class="border-b hover:bg-slate-50">
                        <td class="p-2 text-xs whitespace-nowrap text-slate-500">${t.date}</td>
                        <td class="p-2 text-xs font-mono text-slate-400">${t.id}</td>
                        <td class="p-2 text-xs font-bold ${t.category==='Balance Forward'?'text-indigo-600':''}">
                            <div class="${t.category==='Balance Forward'?'flex items-center gap-1':''}">${t.category==='Balance Forward'?'<i data-lucide="arrow-right-circle" class="w-3 h-3"></i>':''}${t.category}</div>
                        </td>
                        <td class="p-2 text-xs text-slate-500">
                            <div class="flex items-center gap-1">${colBy}${link ? `<a href="${link}" target="_blank" class="text-blue-600 hover:bg-blue-100 p-1 rounded transition"><i data-lucide="file-text" class="w-3 h-3"></i></a>` : ''}</div>
                        </td>
                        <td class="p-2 text-xs text-slate-400 font-mono">${t.operator || '-'}</td>
                        <td class="p-2 text-xs text-right font-bold ${isNeg ? 'text-red-600' : (t.category==='Balance Forward'?'text-indigo-600':'text-green-600')}">${Utils.currency(Math.abs(t.amount))}</td>
                    </tr>`;
                }).join('') || '<tr><td colspan="6" class="p-4 text-center text-xs text-slate-400 italic">No records found</td></tr>'; lucide.createIcons();
            },
            viewCashBreakdown: () => {
                const term = App.searchTerm, searchFn = (i) => !term || Object.values(i || {}).some(v => String(v).toLowerCase().includes(term));
                const txList = Data.transactions.filter(searchFn), sums = { col:0, dp:0, dep:0, wit:0, dis:0, exp:0, capIn:0, capOut:0, balFwd:0, dpsIn: 0, pen: 0 };
                txList.forEach(t => { 
                    const a = Math.abs(t.amount); 
                    if(t.category === 'Collection') sums.col += a; 
                    else if(t.category === 'Down Payment') sums.dp += a; 
                    else if(t.category === 'Deposit') sums.dep += a;
                    else if(t.category === 'Penalty') sums.pen += a;
                    else if(t.category === 'Balance Forward') sums.balFwd += t.amount; 
                    else if(t.category === 'Withdrawal' || t.category === 'DPS Withdrawal' || t.category === 'DPS Payment' || t.category === 'DPS Installment' || t.category === 'FD Withdrawal' || t.category === 'FD Interest') sums.wit += a; 
                    else if(t.category === 'Group DPS Contrib.') sums.dpsIn += a;
                    else if(t.category === 'Disbursement') sums.dis += a; 
                    else if(t.category === 'Expense') sums.exp += a; 
                    else if(t.category === 'Capital Injection') sums.capIn += a; 
                    else if(t.category === 'Equity Withdraw') sums.capOut += a; 
                });
                const netCash = (sums.col + sums.dp + sums.dep + sums.pen + sums.capIn + sums.balFwd + sums.dpsIn) - (sums.wit + sums.dis + sums.exp + sums.capOut);
                document.getElementById('cb-content').innerHTML = `<div class="flex justify-between"><span>Collection:</span><span class="font-bold">${Utils.currency(sums.col)}</span></div><div class="flex justify-between"><span>Down Pay:</span><span class="font-bold">${Utils.currency(sums.dp)}</span></div><div class="flex justify-between"><span>Deposit:</span><span class="font-bold">${Utils.currency(sums.dep)}</span></div><div class="flex justify-between text-red-600"><span>Penalty:</span><span class="font-bold">${Utils.currency(sums.pen)}</span></div>${sums.dpsIn > 0 ? `<div class="flex justify-between text-teal-600"><span>DPS Internal In:</span><span class="font-bold">${Utils.currency(sums.dpsIn)}</span></div>` : ''}${sums.balFwd!==0 ? `<div class="flex justify-between text-blue-600"><span>Bal. Fwd:</span><span class="font-bold">${Utils.currency(sums.balFwd)}</span></div>`:''}<div class="flex justify-between text-indigo-600"><span>Capital Inj.:</span><span class="font-bold">${Utils.currency(sums.capIn)}</span></div><hr class="my-2"><div class="flex justify-between text-red-600"><span>Withdraw/Transfer:</span><span>${Utils.currency(sums.wit)}</span></div><div class="flex justify-between text-red-600"><span>Disburse:</span><span>${Utils.currency(sums.dis)}</span></div><div class="flex justify-between text-red-600"><span>Expense:</span><span>${Utils.currency(sums.exp)}</span></div><div class="flex justify-between text-orange-600"><span>Capital Out:</span><span>${Utils.currency(sums.capOut)}</span></div><div class="bg-slate-900 text-white p-3 rounded mt-2 flex justify-between font-bold text-lg"><span>Net Cash:</span><span>${Utils.currency(netCash)}</span></div>`; 
                UI.openModal('modal-cash-breakdown');
            },
            header: (title, btns) => `<div class="flex justify-between mb-4 items-center">${title}${btns}</div>`,
            empty: (text, col=1) => `<tr><td colspan="${col}" class="p-8 text-center text-slate-400 italic">${text}</td></tr>`
        };

        const App = {
            activeTab: 'dashboard', incomeSubTab: 'ledger', searchTerm: '', receiptData: {}, confirmIsSecure: false, confirmCallback: null, 
            loanFilter: 'active', loanTypeFilter: 'all', activeAssistantTab: 'collection', assistantMode: 'loan',
            memberFilterType: 'all', memberFilterFreq: 'all', assistantUpcomingFilter: 'all', transactionPage: 1, itemsPerPage: 50, deletedPage: 1, historyPage: 1, tempModalData: [], tempModalType: 'deleted', tempConsolidateData: null, tempGlobalDPSData: null,
            isLocked: false, idleTimer: null, syncIntervalRef: null,
            currentUser: null, activeRiskCheckId: null,
            archivingFilter: 'individual', 
            noticeIndex: 0, noticeTimer: null,
            sessionNotifications: [], // New session store
            showClosedFDs: false, // New property to toggle visibility

            // --- INVENTORY LOGIC ---
            openProductModal: (prod = null) => {
                const form = document.getElementById('form-product');
                form.reset();
                document.getElementById('prod-modal-title').innerText = prod ? 'Edit Product' : 'Add Inventory Item';
                document.getElementById('btn-save-product').innerText = prod ? 'Update Product' : 'Save Product';
                
                if (prod) {
                    form.querySelector('[name="id"]').value = prod.id;
                    form.querySelector('[name="name"]').value = prod.name;
                    form.querySelector('[name="category"]').value = prod.category;
                    form.querySelector('[name="buyPrice"]').value = prod.buyPrice;
                    form.querySelector('[name="sellPrice"]').value = prod.sellPrice;
                    form.querySelector('[name="stock"]').value = prod.stock;
                    form.querySelector('[name="minStock"]').value = prod.minStock;
                } else {
                    form.querySelector('[name="id"]').value = '';
                }
                UI.openModal('modal-product');
            },
            
            handleProductSubmit: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-save-product');
                Utils.setLoading(btn, true);
                const fd = new FormData(e.target);
                
                const d = {
                    id: fd.get('id') || Utils.id('P'),
                    name: Utils.toTitleCase(fd.get('name')),
                    category: fd.get('category'),
                    buyPrice: Number(fd.get('buyPrice')),
                    sellPrice: Number(fd.get('sellPrice')),
                    stock: Number(fd.get('stock')),
                    minStock: Number(fd.get('minStock'))
                };
                
                const isEdit = !!fd.get('id');
                const idx = Data.inventory.findIndex(x => x.id === d.id);
                
                if (isEdit && idx > -1) Data.inventory[idx] = d;
                else Data.inventory.unshift(d);
                
                await Data.post(isEdit ? 'editProduct' : 'addProduct', d);
                Utils.setLoading(btn, false);
                UI.closeModal('modal-product');
                Utils.notify("Product Saved");
                App.renderContent();
            },
            
            // --- BROADCAST LOGIC ---
            openBroadcastModal: () => {
                if (App.currentUser.role !== 'Admin') return Utils.notify("Access Denied", "error");
                document.getElementById('bc-message').value = '';
                document.getElementById('bc-target').value = 'all';
                document.getElementById('bc-char-count').innerText = '0';
                App.toggleBroadcastTarget('all');
                UI.openModal('modal-broadcast');
            },
            
            toggleBroadcastTarget: (val) => {
                const box = document.getElementById('bc-group-select-box');
                const sel = document.getElementById('bc-specific-group');
                if (val === 'all') {
                    box.classList.add('hidden');
                } else {
                    box.classList.remove('hidden');
                    const items = (val === 'group') ? Data.groups : Data.groupDPS;
                    // Filter active groups only
                    const activeItems = items.filter(i => i.status !== 'Archived' && i.status !== 'Closed');
                    
                    if (activeItems.length === 0) {
                        sel.innerHTML = '<option value="">No Active Groups Found</option>';
                    } else {
                        sel.innerHTML = activeItems.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
                    }
                }
            },
            
            handleBroadcastSubmit: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-send-broadcast');
                Utils.setLoading(btn, true, 'Preparing...');
                
                const target = document.getElementById('bc-target').value;
                const msg = document.getElementById('bc-message').value;
                let recipients = [];

                // 1. Gather Members
                if (target === 'all') {
                    recipients = Data.members.filter(m => m.status === 'Active' && m.phone && m.phone.length > 5);
                } else {
                    const groupId = document.getElementById('bc-specific-group').value;
                    if (!groupId) {
                        Utils.notify("Please select a group", "error");
                        Utils.setLoading(btn, false);
                        return;
                    }
                    const groupList = (target === 'group') ? Data.groups : Data.groupDPS;
                    const group = groupList.find(g => g.id === groupId);
                    if (group) {
                        recipients = group.memberIDs
                            .map(id => Data.members.find(m => m.id === id))
                            .filter(m => m && m.status === 'Active' && m.phone && m.phone.length > 5);
                    }
                }

                if (recipients.length === 0) {
                    Utils.notify("No members with valid phones found in selection.", "error");
                    Utils.setLoading(btn, false);
                    return;
                }

                // 2. Extract Numbers
                const numbers = recipients.map(m => m.phone).join(',');
                
                // 3. Confirm & Send
                if (confirm(`Send to ${recipients.length} recipients?\n\nMessage: "${msg}"`)) {
                    await Utils.sendSMS(numbers, msg);
                    UI.closeModal('modal-broadcast');
                }
                
                Utils.setLoading(btn, false);
            },

            deleteProduct: (id) => {
                if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied", "error");
                App.askConfirm("Delete this product permanently?", async () => {
                    Data.inventory = Data.inventory.filter(x => x.id !== id);
                    await Data.post('deleteProduct', { id });
                    Utils.notify("Product Deleted");
                    App.renderContent();
                }, true);
            },
            
            filterInventoryDropdown: (val) => {
                const list = document.getElementById('inv-dropdown-loan');
                list.classList.remove('hidden');
                const term = val.toLowerCase();
                
                if(!term) { list.classList.add('hidden'); return; }
                
                const matches = Data.inventory.filter(p => p.name.toLowerCase().includes(term) && p.stock > 0).slice(0, 5);
                
                if (matches.length === 0) {
                    list.innerHTML = `<div class="p-2 text-xs text-slate-400 italic">No items found in stock.</div>`;
                } else {
                    list.innerHTML = matches.map(p => `
                        <div onclick="App.selectInventoryItem('${p.id}')" class="p-2 hover:bg-purple-50 cursor-pointer border-b last:border-0">
                            <div class="font-bold text-slate-700 text-sm">${p.name}</div>
                            <div class="flex justify-between text-xs text-slate-500">
                                <span>Price: ${Utils.currency(p.sellPrice)}</span>
                                <span class="text-green-600 font-bold">In Stock: ${p.stock}</span>
                            </div>
                        </div>
                    `).join('');
                }
            },
            
            selectInventoryItem: (id) => {
                const prod = Data.inventory.find(p => p.id === id);
                if (!prod) return;
                
                document.getElementById('inv-search-loan').value = '';
                document.getElementById('inv-dropdown-loan').classList.add('hidden');
                
                // Fill fields
                document.getElementById('loan-prod-name').value = prod.name;
                document.getElementById('prod-price').value = prod.sellPrice;
                document.getElementById('selected-product-id').value = prod.id;
                document.getElementById('prod-dp').focus();
                
                Logic.calcPrincipal();
            },

            // --- FIXED DEPOSIT LOGIC ---
            openFDModal: () => {
                if (Data.sysConfig.freeze.dps) return Utils.notify("New FD creation is FROZEN.", "error"); // Reuse DPS freeze
                document.getElementById('form-fd').reset();
                document.getElementById('fd-member-search').value = '';
                document.getElementById('fd-member-id').value = '';
                document.getElementById('fd-start-date').value = Utils.dateToday();
                UI.openModal('modal-fixed-deposit');
            },

            handleFDSubmit: async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-save-fd');
                Utils.setLoading(btn, true);
                
                const fdMemberId = document.getElementById('fd-member-id').value;
                if (!fdMemberId) {
                    Utils.notify("Select a member first", "error");
                    Utils.setLoading(btn, false);
                    return;
                }
                
                const m = Data.members.find(x => x.id === fdMemberId);
                const formData = new FormData(e.target);
                const fd = {
                    id: Utils.id('FD'),
                    memberId: m.id,
                    memberName: m.name,
                    principal: Number(formData.get('principal')),
                    rate: Number(formData.get('rate')),
                    duration: Number(formData.get('duration')),
                    startDate: formData.get('startDate'),
                    maturityDate: formData.get('maturityDate'),
                    maturityAmount: Number(formData.get('maturityAmount')),
                    frequency: formData.get('frequency') || 'Maturity',
                    status: 'Active',
                    operator: App.currentUser.name
                };
                
                // Create FD record locally
                Data.fixedDeposits.unshift(fd);
                
                // Create Transaction record (Deposit)
                const txId = Utils.id('D');
                const tx = { id: txId, loanId: fd.id, memberName: m.name, amount: fd.principal, date: fd.startDate, category: 'Deposit', collectedBy: 'Fixed Deposit Principal' };
                Data.transactions.unshift(tx);
                
                // Sync
                await Data.post('addFD', { ...fd, txId: txId });
                
                Utils.setLoading(btn, false);
                UI.closeModal('modal-fixed-deposit');
                Utils.notify("Fixed Deposit Created");
                
                // Auto-download removed. Manual download available in list.
                App.renderContent();
            },

            generateFDCertificate: async (fd) => {
                const container = document.getElementById('pdf-generator-container');
                container.innerHTML = `
                    <div class="p-10 bg-white text-slate-900 border-4 border-double border-slate-800 h-full relative">
                        <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="award" class="w-32 h-32"></i></div>
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-serif font-bold uppercase tracking-widest text-slate-800">Fixed Deposit Certificate</h1>
                            <p class="text-sm text-slate-500 mt-2">${Data.receiptSignature}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6 mb-8 text-sm border-t border-b border-slate-200 py-6">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">Certificate No</p>
                                <p class="font-mono text-lg font-bold">${fd.id}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-bold text-slate-400 uppercase">Date of Issue</p>
                                <p class="font-bold">${fd.startDate}</p>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase">Member Name</p>
                                <p class="text-xl font-bold text-indigo-700">${fd.memberName}</p>
                                <p class="font-mono text-xs text-slate-500">ID: ${fd.memberId}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs font-bold text-slate-400 uppercase">Principal Amount</p>
                                <p class="text-2xl font-bold text-slate-800">${Utils.currency(fd.principal)}</p>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-8">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <p class="text-xs font-bold text-slate-500 uppercase">Interest Rate</p>
                                    <p class="text-lg font-bold">${fd.rate}%</p>
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-slate-500 uppercase">Duration</p>
                                    <p class="text-lg font-bold">${fd.duration} Months</p>
                                </div>
                                <div>
                                    <p class="text-xs font-bold text-slate-500 uppercase">Maturity Date</p>
                                    <p class="text-lg font-bold text-blue-600">${fd.maturityDate}</p>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-200 text-center">
                                <p class="text-xs font-bold text-slate-500 uppercase">Payout Type</p>
                                <p class="text-lg font-bold text-slate-700 mb-2">${fd.frequency || 'On Maturity'}</p>
                                <p class="text-xs font-bold text-slate-500 uppercase">Maturity / Final Value</p>
                                <p class="text-3xl font-bold text-green-700 mt-1">${Utils.currency(fd.maturityAmount)}</p>
                            </div>
                        </div>
                        
                        <div class="text-center text-[10px] text-slate-400 mt-12">
                            <p>This certificate is computer generated and valid without signature.</p>
                            <p>Authorized by ${App.currentUser.name} on ${new Date().toLocaleString()}</p>
                        </div>
                    </div>
                `;
                lucide.createIcons({ root: container });
                await new Promise(r => setTimeout(r, 500));
                
                const opt = { margin: 0.5, filename: `FD_Certificate_${fd.id}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
                html2pdf().set(opt).from(container).save();
            },

            closeFD: (id) => {
                if(App.currentUser.role === 'Staff') return Utils.notify("Access Denied", "error");
                const fd = Data.fixedDeposits.find(f => f.id === id); if (!fd) return;
                const today = new Date(), maturity = Utils.parseDate(fd.maturityDate), isPremature = today < maturity, payout = fd.maturityAmount;
                
                // ADDED 'true' as the 4th argument (manualClose) to keep modal open during processing
                App.askConfirm(`Payout ${isPremature ? 'PREMATURELY' : 'on Maturity'}? (${Utils.currency(payout)})`, async () => {
                    const btn = document.getElementById('btn-confirm-yes'); 
                    
                    // STEP 1: Generating Report Feedback
                    Utils.setLoading(btn, true, 'Generating Report...');
                    await new Promise(r => setTimeout(r, 100));

                    const txId = Utils.id('D'), date = Utils.dateToday();
                    
                    // --- COMPRESSED PROFESSIONAL REPORT ---
                    const container = document.getElementById('pdf-generator-container');
                    container.innerHTML = `
                        <div class="p-8 bg-white font-sans text-slate-800 border-2 border-slate-900 h-full">
                            <div class="flex justify-between items-end border-b-2 border-slate-800 pb-4 mb-6">
                                <div><h1 class="text-2xl font-bold tracking-tighter">${Data.receiptSignature}</h1><p class="text-[10px] uppercase tracking-widest">Financial Services</p></div>
                                <div class="text-right"><h2 class="font-bold uppercase text-slate-600">Closure Statement</h2><p class="text-xs font-mono">Ref: ${fd.id}</p></div>
                            </div>
                            <div class="flex justify-between mb-6 text-sm">
                                <div><span class="text-[10px] uppercase text-slate-400 block">Member</span><b class="text-lg">${fd.memberName}</b><br><span class="font-mono text-xs text-slate-500">${fd.memberId}</span></div>
                                <div class="text-right"><span class="text-[10px] uppercase text-slate-400 block">Date</span><b>${date}</b><br><span class="font-mono text-xs text-slate-500">Tx: ${txId}</span></div>
                            </div>
                            <table class="w-full text-sm mb-6">
                                <tr class="border-b"><td class="py-2 text-slate-500">Principal Deposit</td><td class="py-2 text-right font-bold">${Utils.currency(fd.principal)}</td></tr>
                                <tr class="border-b"><td class="py-2 text-slate-500">Interest (${fd.rate}%, ${fd.duration}m)</td><td class="py-2 text-right font-bold text-green-600">+ ${Utils.currency(payout - fd.principal)}</td></tr>
                                <tr class="bg-slate-100"><td class="py-3 pl-2 font-bold uppercase">Net Payout</td><td class="py-3 pr-2 text-right font-bold text-xl">${Utils.currency(payout)}</td></tr>
                            </table>
                            <div class="flex justify-between text-xs mb-12"><span>Status: <b>${isPremature?'Premature':'Matured'}</b></span><span>To: <b>Savings Account</b></span></div>
                            <div class="flex justify-between pt-4 border-t text-center">
                                <div><div class="h-px w-24 bg-slate-300 mb-1"></div><p class="text-[10px] uppercase text-slate-400">Member</p></div>
                                <div><div class="h-px w-24 bg-slate-300 mb-1"></div><p class="text-[10px] uppercase text-slate-400">Officer (${App.currentUser.name})</p></div>
                            </div>
                        </div>`;
                    lucide.createIcons({ root: container });
                    await new Promise(r => setTimeout(r, 500));
                    
                    let pdfBase64 = '';
                    try { const opt = { margin: 0.5, filename: `FD_Close_${fd.id}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter' } }; const pdfBlob = await html2pdf().set(opt).from(container).outputPdf('datauristring'); pdfBase64 = pdfBlob.split(',')[1]; } catch(e) {}

                    // STEP 2: Syncing Feedback
                    Utils.setLoading(btn, true, 'Syncing...');
                    await new Promise(r => setTimeout(r, 50));

                    const tx = { id: txId, loanId: 'SAVINGS', memberName: Data.members.find(m=>m.id===fd.memberId)?.name||'Member', amount: payout, date: date, category: 'Deposit', collectedBy: `FD Maturity: ${fd.id}` };
                    
                    fd.status = 'Closed'; 
                    if (!fd.interestHistory) fd.interestHistory = []; 
                    fd.interestHistory.push({ type: 'Closing', link: '', txId: txId, date: date, amount: payout });
                    
                    // Remove Original Principal Deposit Locally
                    Data.transactions = Data.transactions.filter(t => !(t.loanId === fd.id && t.category === 'Deposit'));
                    
                    Data.transactions.unshift(tx);
                    
                    await Data.post('closeFD', { id: fd.id, txId: txId, memberName: tx.memberName, payoutAmount: payout, date: tx.date, target: 'SAVINGS', pdf: pdfBase64, fileName: `FD_Close_${fd.memberName}_${fd.id}` });
                    
                    // --- ALERT: FD Closed ---
                    Utils.notifyAdmin('FD Closed', `${isPremature ? 'Premature' : 'Matured'} Payout: ${Utils.currency(payout)} for ${fd.memberName} (${fd.id})`);
                    
                    Logic.recalcBalances(); Utils.setLoading(btn, false); UI.closeModal('modal-confirm'); Utils.notify("FD Closed & Principal Cleaned"); App.renderContent();
                }, true, true);
            },

            payFDInterest: (id) => {
                const fd = Data.fixedDeposits.find(f => f.id === id);
                if (!fd) return;
                
                const monthlyInterest = Math.round((fd.principal * fd.rate) / 1200);
                // UPDATED: Using 'short' month format (e.g. "Feb 2026")
                const monthName = new Date().toLocaleString('default', { month: 'short', year: 'numeric' });
                
                // --- DUPLICATE CHECK ---
                if (fd.interestHistory && fd.interestHistory.some(h => h.month === monthName)) {
                    return Utils.notify(`Interest for ${monthName} already paid!`, "error");
                }

                // Changed category to 'FD Interest' to trigger special handling
                UI.openTransactionModal('SAVINGS', 'FD Interest', 'Pay Monthly Interest', monthlyInterest, fd.memberName, 0, fd.id);
                
                // Store the target month in hidden field for handler to pick up
                setTimeout(() => {
                    // UPDATED FORMAT: "FD Int. (ID) Month Year"
                    document.getElementById('tx-meta-input').value = `FD Int. (${fd.id}) ${monthName}`;
                    document.getElementById('tx-custom-data').value = monthName;
                }, 100);
            },

            viewFDInterestHistory: (id) => {
                const fd = Data.fixedDeposits.find(f => f.id === id);
                if (!fd) return;
                
                document.getElementById('dps-history-title').innerText = `Interest History: ${fd.memberName}`;
                const list = document.getElementById('dps-history-list');
                const history = fd.interestHistory || [];
                
                if (history.length === 0) {
                    list.innerHTML = `<div class="text-center text-slate-400 p-8 italic">No interest payments recorded yet.</div>`;
                } else {
                    list.innerHTML = history.slice().reverse().map(h => {
                        const isClosing = h.type === 'Closing';
                        const title = isClosing ? 'Principal Return (Closed)' : (h.month || 'Payout');
                        const icon = isClosing ? '<i data-lucide="check-circle-2" class="w-3 h-3 text-green-600 inline mr-1"></i>' : '';
                        const bgClass = isClosing ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200';
                        
                        return `
                        <div class="flex justify-between items-center p-3 ${bgClass} border rounded mb-2 hover:bg-white hover:shadow-sm transition">
                            <div>
                                <div class="font-bold text-slate-800 text-sm">${icon}${title}</div>
                                <div class="text-xs text-slate-500">${h.date} ‚Ä¢ Tx: <span class="font-mono text-slate-400">${h.txId || '-'}</span></div>
                            </div>
                            <div class="font-bold text-green-600 text-sm">+${Utils.currency(h.amount)}</div>
                        </div>
                    `}).join('');
                }
                lucide.createIcons();
                UI.openModal('modal-dps-history');
            },

            // --- EXISTING FUNCTIONS ---
            toggleWaivePenalty: () => {
                const inp = document.getElementById('tx-penalty');
                if (inp.value == 0) {
                    // Revert to loan default if possible, else just 0
                    // Since we don't store original default in UI easily, just clear it or set 0
                    // We assume user manually puts it back or relies on auto-fill next time
                    inp.value = ''; 
                } else {
                    inp.value = 0;
                }
            },

            // --- Notice Board Logic ---
            toggleNoticeEdit: (save = false) => {
                const view = document.getElementById('notice-view-wrapper');
                const edit = document.getElementById('notice-edit');
                if (!view || !edit) return;
                
                if (!save) {
                    // Show Edit Mode
                    edit.classList.remove('hidden');
                    document.getElementById('notice-input').focus();
                } else {
                    // Hide Edit Mode (Cancel/Save)
                    edit.classList.add('hidden');
                }
            },
            
            saveNotice: async () => {
                const txt = document.getElementById('notice-input').value;
                Data.notice = txt;
                localStorage.setItem('mf_admin_notice', txt);
                
                App.toggleNoticeEdit(true);
                await Data.post('updateNotice', { text: txt });
                Utils.notify("Notice Updated");
                
                // Refresh dashboard to restart notice cycle
                if (App.activeTab === 'dashboard') {
                    App.renderContent();
                }
            },
            
            rotateNotice: () => {
                const el = document.getElementById('notice-text');
                if(!el || document.getElementById('notice-edit')?.classList.contains('hidden') === false) return;
                
                const raw = Data.notice || 'Welcome to MicroFin Manager';
                const list = raw.split(';').map(s=>s.trim()).filter(s=>s);
                if(list.length <= 1) return;

                App.noticeIndex = (App.noticeIndex + 1) % list.length;
                
                el.style.opacity = '0';
                el.style.transform = 'translateY(10px)';
                
                setTimeout(() => {
                    el.innerText = list[App.noticeIndex];
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, 500);
            },

            startNoticeTimer: () => {
                if(App.noticeTimer) clearInterval(App.noticeTimer);
                App.noticeIndex = 0;
                const raw = Data.notice || '';
                if(raw.split(';').length > 1) {
                    App.noticeTimer = setInterval(App.rotateNotice, 4000);
                }
            },

            archiveGroup: (id) => {
                const g = Data.groups.find(x => x.id === id);
                if(!g) return;
                
                // Calculate Income (Penalties)
                const txs = Data.transactions.filter(t => t.loanId === g.id && t.category === 'Penalty');
                const totalPenalties = txs.reduce((s,t) => s + t.amount, 0);
                
                App.askConfirm(`Archive Group "${g.name}"?\n\nTotal Income (Penalties): ${Utils.currency(totalPenalties)}\nThis will consolidate all income into a single record.`, async () => {
                    const btn = document.getElementById('btn-confirm-yes');
                    Utils.setLoading(btn, true, 'Archiving...');
                    
                    let incomeSummary = null;
                    if (totalPenalties > 0) {
                        const newIncId = Utils.id('I');
                        incomeSummary = {
                            id: newIncId,
                            date: Utils.dateToday(),
                            memberName: g.name,
                            refId: g.id,
                            amount: totalPenalties,
                            remarks: `Group Penalties: ${Utils.currency(totalPenalties)}`
                        };
                        
                        // Update Local Income
                        Data.income = Data.income.filter(i => i.refId !== g.id);
                        Data.income.push({
                            id: newIncId,
                            date: Utils.dateToday(),
                            memberName: g.name,
                            refId: g.id,
                            amount: totalPenalties,
                            sourceType: 'Group Income',
                            reason: 'Archive Summary',
                            remarks: incomeSummary.remarks,
                            operator: App.currentUser.name
                        });
                    }

                    g.status = 'Archived';
                    
                    // Backend Call
                    await Data.post('archiveGroup', { 
                        id: g.id, 
                        incomeSummary: incomeSummary 
                    });
                    
                    Utils.setLoading(btn, false);
                    UI.closeModal('modal-confirm');
                    Utils.notify("Group Archived & Income Consolidated");
                    App.renderContent();
                }, true);
            },

            setArchivingFilter: (val) => {
                App.archivingFilter = val;
                App.renderContent();
            },

            // NEW: Income Tab Switching
            setIncomeSubTab: (val) => {
                App.incomeSubTab = val;
                App.renderContent();
            },

            // --- GLOBAL CONTROLS LOGIC ---
            toggleSysConfig: async (type, key) => {
                if(App.currentUser.role !== 'Admin') return Utils.notify("Admins Only", "error");
                
                // Ensure structure exists
                if (!Data.sysConfig[type]) Data.sysConfig[type] = {};
                
                Data.sysConfig[type][key] = !Data.sysConfig[type][key];
                localStorage.setItem('mf_sys_config', JSON.stringify(Data.sysConfig));
                App.renderContent(); // Refresh UI to show state change
                
                // Sync to Server
                try {
                    await Data.post('updateSysConfig', { config: Data.sysConfig });
                    Utils.notify(`${key} ${Data.sysConfig[type][key] ? 'Enabled' : 'Disabled'}`);
                } catch(e) {
                    Utils.notify("Failed to save config remotely", "warning");
                }
            },

            // --- MEMBER RESTRICTION LOGIC ---
            openRestrictionManager: () => {
                if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied", "error");
                document.getElementById('restrict-search').value = '';
                App.renderRestrictionList();
                UI.openModal('modal-restrictions');
            },
            renderRestrictionList: (search = '') => {
                const list = document.getElementById('restrict-list');
                const term = search.toLowerCase();
                // Filter only members matching search OR having existing restrictions
                const members = Data.members.filter(m => {
                    const hasRestrict = m.restrictions && (m.restrictions.block || m.restrictions.noWithdraw || m.restrictions.noLoan);
                    const matches = m.name.toLowerCase().includes(term) || m.id.toLowerCase().includes(term) || m.phone.includes(term);
                    return term ? matches : hasRestrict; // Show all restricted if no search, else search
                }).slice(0, 50);

                if (members.length === 0) {
                    list.innerHTML = `<div class="text-center text-slate-400 p-6 italic">No members found. Search to add restrictions.</div>`;
                    return;
                }

                list.innerHTML = members.map(m => {
                    const r = m.restrictions || {};
                    return `
                    <div class="bg-white p-3 rounded border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-slate-800">${m.name}</div>
                                <div class="text-[10px] text-slate-500 font-mono">${m.id}</div>
                            </div>
                            ${r.block ? '<span class="bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">BLOCKED</span>' : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="App.toggleRestriction('${m.id}', 'block')" class="flex-1 py-1.5 rounded text-[10px] font-bold border transition ${r.block ? 'bg-red-600 text-white border-red-600' : 'bg-slate-50 text-slate-500 border-slate-200 hover:bg-slate-100'}">Block All</button>
                            <button onclick="App.toggleRestriction('${m.id}', 'noWithdraw')" class="flex-1 py-1.5 rounded text-[10px] font-bold border transition ${r.noWithdraw ? 'bg-orange-500 text-white border-orange-500' : 'bg-slate-50 text-slate-500 border-slate-200 hover:bg-slate-100'}">No Withdraw</button>
                            <button onclick="App.toggleRestriction('${m.id}', 'noLoan')" class="flex-1 py-1.5 rounded text-[10px] font-bold border transition ${r.noLoan ? 'bg-amber-500 text-white border-amber-500' : 'bg-slate-50 text-slate-500 border-slate-200 hover:bg-slate-100'}">No Loan</button>
                        </div>
                    </div>`;
                }).join('');
            },
            toggleRestriction: async (mid, key) => {
                const m = Data.members.find(x => x.id === mid);
                if (!m) return;
                if (!m.restrictions) m.restrictions = {};
                m.restrictions[key] = !m.restrictions[key];
                
                // Update Local & UI
                const searchVal = document.getElementById('restrict-search').value;
                App.renderRestrictionList(searchVal);
                
                // Sync
                const d = { id: m.id, name: m.name, phone: m.phone, address: m.address, status: m.status, accountType: m.accountType, savingType: m.savingType, savingAmount: m.savingAmount, savingDate: m.savingDate, flag: m.flag, restrictions: JSON.stringify(m.restrictions) };
                
                // We use existing editMember endpoint but ensure restrictions are passed
                // Update local store first
                const idx = Data.members.findIndex(x => x.id === mid);
                if(idx > -1) Data.members[idx] = m;
                
                await Data.post('editMember', d);
                Utils.notify(`Restriction updated for ${m.name}`);
            },

            // --- RESTORED MISSING FUNCTIONS ---
            updateLastSyncLabel: () => { const ts = Number(localStorage.getItem('mf_last_sync')); const el = document.getElementById('last-sync-label'); if(el) el.innerText = ts ? `Synced: ${Utils.timeAgo(ts)}` : 'Not synced yet'; },
            updateSyncIndicator: () => { const el = document.getElementById('offline-indicator'), count = document.getElementById('offline-count'); if(!el || !count) return; if(Data.pending.length > 0) { el.classList.remove('hidden'); el.classList.add('flex'); count.innerText = Data.pending.length; } else { el.classList.add('hidden'); el.classList.remove('flex'); } },
            switchTab: (t) => { App.activeTab = t; App.transactionPage = 1; App.toggleMobileMenu(false); App.renderNav(); App.renderContent(); },
            toggleMobileMenu: (s) => document.getElementById('mobile-menu-overlay').classList.toggle('hidden', !s),
            handleSearch: (v) => { App.searchTerm = v.toLowerCase(); App.transactionPage = 1; document.getElementById('search-clear').classList.toggle('hidden', !v); App.renderContent(); },
            clearSearch: () => { document.getElementById('search-input').value = ''; App.handleSearch(''); },
            setLoanFilter: (v) => { App.loanFilter = v; App.renderContent(); },
            setLoanTypeFilter: (v) => { App.loanTypeFilter = v; App.renderContent(); },
            setMemberFilterType: (v) => { App.memberFilterType = v; App.renderContent(); },
            setMemberFilterFreq: (v) => { App.memberFilterFreq = v; App.renderContent(); },
            changeTransactionPage: (delta) => { App.transactionPage += delta; App.renderContent(); },
            copyScript: () => { Utils.copy(APPS_SCRIPT_TEMPLATE); },
            downloadPDF: (id, name) => { const el = document.getElementById(id); if(!el) return Utils.notify("Element not found", "error"); const opt = { margin: 0.3, filename: `${name}_${Utils.dateToday()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }; Utils.notify("Generating PDF..."); html2pdf().set(opt).from(el).save(); },
            viewWriteOffDetails: (refString) => { let loanId = refString.replace('Ref: ', '').trim(); if (loanId.includes(' ')) loanId = loanId.split(' ')[0]; if(loanId) App.viewLoanHistory(loanId); },
            viewDailyReport: () => { document.getElementById('dr-filter').value = 'today'; UI.toggleFilterVisibility('dr', App.renderDailyReport); UI.openModal('modal-daily-report'); },
            downloadDailyReportPDF: () => { App.downloadPDF('dr-content', 'CashFlow_Report'); },
            renderDailyReport: () => {
                const type = document.getElementById('dr-filter').value;
                let dStart = document.getElementById('dr-date-start').value;
                let dEnd = document.getElementById('dr-date-end').value;
                if (type === 'specific' || type === 'upto') {
                    if (!dEnd && dStart) dEnd = dStart;
                    if (!dEnd) dEnd = Utils.dateToday();
                }
                document.getElementById('dr-display-date').innerText = (type==='specific')?dEnd:(type==='upto'?`Up to ${dEnd}`:(type==='range'?`${dStart} to ${dEnd}`:Utils.dateToday()));
                document.getElementById('dr-timestamp').innerText = new Date().toLocaleString();
                const txs = Logic.filterDataByDate(Data.transactions, type, dStart, dEnd), summary = { 'Collection':{count:0,amount:0,type:'in',l:'Collection'},'Down Payment':{count:0,amount:0,type:'in',l:'Down Payment'},'Deposit':{count:0,amount:0,type:'in',l:'Savings Deposit'},'Group DPS Contrib.':{count:0,amount:0,type:'in',l:'DPS Internal (In)'},'Penalty':{count:0,amount:0,type:'in',l:'Penalty / Fine'},'Other Income':{count:0,amount:0,type:'in',l:'Other Income'},'Withdrawal':{count:0,amount:0,type:'out',l:'Savings Withdrawal'},'DPS Payment':{count:0,amount:0,type:'out',l:'DPS Payment (Out)'}, 'DPS Withdrawal':{count:0,amount:0,type:'out',l:'DPS Settlement'},'FD Withdrawal':{count:0,amount:0,type:'out',l:'FD Payout'},'FD Interest':{count:0,amount:0,type:'out',l:'FD Interest'},'Expense':{count:0,amount:0,type:'out',l:'Expense'},'Cash Loan':{count:0,amount:0,type:'out',l:'Cash Loan Provided'},'Product Sale':{count:0,amount:0,type:'neutral',l:'Product Sale Value'},'Capital Injection':{count:0,amount:0,type:'in',l:'Capital Injection'},'Equity Withdraw':{count:0,amount:0,type:'out',l:'Equity Withdraw'} };
                let totalIn = 0, totalOut = 0;
                txs.forEach(t => { const amt = Math.abs(t.amount); let k = t.category; if (k === 'Disbursement') { const l = Data.loans.find(x => x.id === t.loanId); k = (l && l.category === 'Product') ? 'Product Sale' : 'Cash Loan'; } if (summary[k]) { summary[k].count++; summary[k].amount += amt; if (summary[k].type === 'in') totalIn += amt; if (summary[k].type === 'out') totalOut += amt; } });
                document.getElementById('dr-total-in').innerText = Utils.currency(totalIn); document.getElementById('dr-total-out').innerText = Utils.currency(totalOut); document.getElementById('dr-net').innerText = Utils.currency(totalIn - totalOut);
                
                document.getElementById('dr-body').innerHTML = Object.keys(summary).map(k => summary[k].count ? `<tr><td class="p-2 font-medium"><button onclick="App.viewCategoryDetails('${k}','${summary[k].l}')" class="text-blue-600 hover:underline flex items-center gap-1">${summary[k].l} <i data-lucide="chevrons-right" class="w-3 h-3"></i></button></td><td class="p-2 text-center text-slate-500">${summary[k].count}</td><td class="p-2 text-right font-bold ${k==='Penalty'?'text-red-600':(summary[k].type==='in'?'text-green-600':(summary[k].type==='out'?'text-red-600':'text-purple-600'))}">${Utils.currency(summary[k].amount)}</td></tr>` : '').join('') || UI.empty('No transactions found', 3);
                document.getElementById('dr-total-count').innerText = Object.values(summary).reduce((s,i)=>s+i.count,0); 
                document.getElementById('dr-net-total').innerText = Utils.currency(totalIn - totalOut); 
                lucide.createIcons();
            },
            viewCategoryDetails: (catKey, catLabel) => {
                document.getElementById('cd-title').innerText = `Details: ${catLabel}`;
                const type = document.getElementById('dr-filter').value, dStart = document.getElementById('dr-date-start').value, dEnd = document.getElementById('dr-date-end').value;
                const filtered = Logic.filterDataByDate(Data.transactions, type, dStart, dEnd).filter(t => { let k = t.category; if (k === 'Disbursement') { const l = Data.loans.find(x => x.id === t.loanId); k = (l && l.category === 'Product') ? 'Product Sale' : 'Cash Loan'; } return k === catKey; });
                const container = document.getElementById('cd-list');
                if (!filtered.length) { container.innerHTML = `<div class="text-center text-slate-400 p-4">No records found.</div>`; } 
                else {
                    let html = `<div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b text-slate-500 font-bold text-xs uppercase"><tr><th class="p-3">Date</th><th class="p-3">ID</th><th class="p-3">Name / Desc</th><th class="p-3 text-right">Amount</th></tr></thead><tbody class="divide-y divide-slate-100">`;
                    html += filtered.map(t => { const amt = Math.abs(t.amount), isOut = ['Cash Loan', 'Withdrawal', 'DPS Withdrawal', 'DPS Payment', 'FD Withdrawal', 'FD Interest', 'Expense', 'Disbursement', 'Equity Withdraw'].includes(catKey); const isPen = catKey === 'Penalty'; let desc = (catKey === 'Expense') ? (t.collectedBy || 'General Expense') : (t.memberName || 'Office'), subDesc = (catKey === 'Expense') ? '<span class="text-slate-400 text-xs">(Expense)</span>' : (t.collectedBy ? `<span class="text-slate-400 text-xs">(${t.collectedBy})</span>` : ''); return `<tr class="hover:bg-slate-50"><td class="p-3 text-slate-500 text-xs whitespace-nowrap">${t.date}</td><td class="p-3 font-mono text-xs text-slate-400">${t.id}</td><td class="p-3"><div class="font-bold text-slate-700 text-sm">${desc}</div>${subDesc}</td><td class="p-3 text-right font-bold ${isOut || isPen ? 'text-red-600' : 'text-green-600'}">${Utils.currency(amt)}</td></tr>`; }).join('') + `</tbody></table></div>`;
                    container.innerHTML = html + `<div class="bg-slate-50 p-3 flex justify-between items-center border-t border-slate-200 mt-2 rounded-b"><span class="font-bold text-slate-600 uppercase text-xs">Total</span><span class="font-bold text-lg text-slate-800">${Utils.currency(filtered.reduce((s,t)=>s+Math.abs(t.amount),0))}</span></div>`;
                } UI.openModal('modal-cat-detail');
            },
            handleModalSearch: (val) => { if(App.tempModalType === 'deleted') App.deletedPage = 1; else App.historyPage = 1; App.renderModalTable(val); },
            changeModalPage: (delta) => { if(App.tempModalType === 'deleted') App.deletedPage += delta; else App.historyPage += delta; const searchInput = document.getElementById('modal-search-input'); App.renderModalTable(searchInput ? searchInput.value : ''); },
            renderModalTable: (searchTerm = '') => {
                const list = document.getElementById('deleted-list'), data = App.tempModalData, type = App.tempModalType, page = (type === 'deleted') ? App.deletedPage : App.historyPage;
                const filtered = data.filter(row => row.join(' ').toLowerCase().includes(searchTerm.toLowerCase()));
                const totalPages = Math.ceil(filtered.length / App.itemsPerPage), validPage = Math.max(1, Math.min(page, totalPages || 1));
                if(type === 'deleted') App.deletedPage = validPage; else App.historyPage = validPage;
                const start = (validPage - 1) * App.itemsPerPage, paginated = filtered.slice(start, start + App.itemsPerPage);
                const searchBar = `<div class="mb-4 relative"><i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i><input type="text" id="modal-search-input" value="${Utils.escapeHtml(searchTerm)}" oninput="App.handleModalSearch(this.value)" placeholder="Search..." class="w-full border border-slate-300 p-2 pl-10 rounded text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-shadow"></div>`;
                let table = '';
                if(paginated.length === 0) { table = `<div class="text-center text-slate-400 p-10 italic">No records found.</div>`; } else {
                    if(type === 'deleted') table = `<div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100 font-bold text-xs uppercase text-slate-600"><tr><th class="p-3">Deleted Date</th><th class="p-3">Tx Date</th><th class="p-3">TxID</th><th class="p-3">Ref. ID</th><th class="p-3">Type</th><th class="p-3">Name</th><th class="p-3 text-right">Amount</th><th class="p-3">Remarks</th></tr></thead><tbody class="divide-y divide-slate-200">${paginated.map(row => `<tr class="hover:bg-slate-50"><td class="p-3 text-xs text-slate-500 whitespace-nowrap">${row[0]?new Date(row[0]).toLocaleString():'-'}</td><td class="p-3 text-xs text-slate-800 whitespace-nowrap font-bold">${row[1]?row[1].split('T')[0]:'-'}</td><td class="p-3 font-mono text-xs text-slate-500">${row[2]}</td><td class="p-3 font-mono text-xs text-blue-600 font-bold">${row[5]}</td><td class="p-3 text-xs font-bold uppercase text-slate-600">${row[3]}</td><td class="p-3 text-sm font-medium text-slate-700">${row[4]}</td><td class="p-3 text-right font-bold text-slate-800">${Utils.currency(Math.abs(row[6]))}</td><td class="p-3 text-xs text-slate-500">${row[7]}</td></tr>`).join('')}</tbody></table></div>`;
                    else table = `<div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100 font-bold text-xs uppercase text-slate-600"><tr><th class="p-3">Timestamp</th><th class="p-3">Type</th><th class="p-3">ID</th><th class="p-3">Changes</th><th class="p-3">Operator</th></tr></thead><tbody class="divide-y divide-slate-200">${paginated.map(row => `<tr class="hover:bg-slate-50"><td class="p-3 text-xs text-slate-500 whitespace-nowrap">${row[0]?new Date(row[0]).toLocaleString():'-'}</td><td class="p-3 text-xs font-bold uppercase text-slate-600">${row[1]}</td><td class="p-3 font-mono text-xs text-blue-600 font-bold">${row[2]}</td><td class="p-3 text-sm text-slate-700 whitespace-pre-wrap">${row[3]}</td><td class="p-3 text-xs text-indigo-600 font-bold">${row[4]||'-'}</td></tr>`).join('')}</tbody></table></div>`;
                }
                const controls = filtered.length > 0 ? `<div class="flex justify-between items-center p-3 bg-slate-50 border-t mt-auto"><button onclick="App.changeModalPage(-1)" ${validPage === 1 ? 'disabled' : ''} class="px-3 py-1 bg-white border rounded shadow-sm text-sm disabled:opacity-50">Previous</button><span class="text-xs text-slate-500 font-bold">Page ${validPage} of ${Math.max(1, totalPages)} (${filtered.length} items)</span><button onclick="App.changeModalPage(1)" ${validPage >= totalPages ? 'disabled' : ''} class="px-3 py-1 bg-white border rounded shadow-sm text-sm disabled:opacity-50">Next</button></div>` : '';
                list.innerHTML = searchBar + table + controls; lucide.createIcons();
                const newCtxInput = document.getElementById('modal-search-input'); if(newCtxInput && searchTerm) { newCtxInput.focus(); const val = newCtxInput.value; newCtxInput.value = ''; newCtxInput.value = val; }
            },
            viewDeletedItems: async () => {
                if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied: Admins Only", "error");
                const list = document.getElementById('deleted-list'); document.getElementById('deleted-modal-title').innerText = "Deleted Receipts";
                list.innerHTML = `<div class="flex justify-center items-center h-40"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-slate-400"></i></div>`; UI.openModal('modal-deleted-items'); lucide.createIcons();
                const data = await Data.getDeleted(); if(!data) { list.innerHTML = `<div class="text-center text-slate-400 p-10 italic">Error loading data.</div>`; return; }
                App.tempModalData = data; App.tempModalType = 'deleted'; App.deletedPage = 1; App.renderModalTable();
            },
            viewEditingHistory: async () => {
                if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied: Admins Only", "error");
                const list = document.getElementById('deleted-list'); document.getElementById('deleted-modal-title').innerText = "Editing Logs";
                list.innerHTML = `<div class="flex justify-center items-center h-40"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-slate-400"></i></div>`; UI.openModal('modal-deleted-items'); lucide.createIcons();
                const data = await Data.getHistory(); if(!data) { list.innerHTML = `<div class="text-center text-slate-400 p-10 italic">Error loading data.</div>`; return; }
                App.tempModalData = data; App.tempModalType = 'history'; App.historyPage = 1; App.renderModalTable();
            },
            editMember: (id) => {
                const m = Data.members.find(x => x.id === id); if(!m) return;
                const f = document.getElementById('form-member'); if(!f) return Utils.notify("Error: Form not found", "error");
                const welcomeBox = document.getElementById('box-send-welcome'); if(welcomeBox) welcomeBox.classList.add('hidden');
                f.querySelector('input[name="id"]').value = m.id; f.querySelector('input[name="name"]').value = m.name; f.querySelector('input[name="phone"]').value = m.phone; f.querySelector('input[name="address"]').value = m.address; f.querySelector('select[name="status"]').value = m.status;
                if(f.querySelector('select[name="type"]')) f.querySelector('select[name="type"]').value = m.accountType || 'Personal'; if(f.querySelector('input[name="savingAmount"]')) f.querySelector('input[name="savingAmount"]').value = m.savingAmount || '';
                const sType = m.savingType || 'Daily'; if(f.querySelector('select[name="savingType"]')) f.querySelector('select[name="savingType"]').value = sType; UI.toggleSavingDate(sType);
                if (sType === 'Weekly') document.getElementById('mem-saving-date-weekly').value = m.savingDate || 'Saturday'; else if (sType === 'Monthly') document.getElementById('mem-saving-date-monthly').value = m.savingDate || '';
                const flagSelect = f.querySelector('select[name="flag"]');
                if (flagSelect) {
                    flagSelect.value = m.flag || '';
                    const flagBox = document.getElementById('member-flag-box');
                    if (flagBox) { if(App.currentUser.role === 'Admin') flagBox.classList.remove('hidden'); else flagBox.classList.add('hidden'); }
                }
                const btn = document.getElementById('btn-save-member'); if(btn) btn.setAttribute('data-original-text', '<span>Save</span>'); UI.openModal('modal-member');
            },
            openMemberModal: () => {
                if (Data.sysConfig.freeze.member) return Utils.notify("New Member creation is FROZEN globally.", "error");
                document.getElementById('form-member').reset(); 
                const welcomeBox = document.getElementById('box-send-welcome'); if(welcomeBox) welcomeBox.classList.remove('hidden'); 
                document.getElementById('chk-send-welcome').checked = false; 
                const flagBox = document.getElementById('member-flag-box'); if (flagBox) { if (App.currentUser.role === 'Admin') flagBox.classList.remove('hidden'); else flagBox.classList.add('hidden'); }
                UI.openModal('modal-member');
            },
            handleMemberSubmit: async (e) => {
                e.preventDefault(); const btn = document.getElementById('btn-save-member'); Utils.setLoading(btn, true);
                const fd = new FormData(e.target), id = fd.get('id'), name = Utils.toTitleCase(fd.get('name')), sType = fd.get('savingType');
                let restrictions = '{}'; if(id) { const m = Data.members.find(x => x.id === id); if(m) restrictions = JSON.stringify(m.restrictions || {}); }
                const d = { id: id || Utils.generateNextId('M', Data.members), name: name, phone: fd.get('phone'), address: fd.get('address'), status: fd.get('status'), accountType: fd.get('type'), savingType: sType, savingAmount: fd.get('savingAmount'), savingDate: (sType === 'Weekly') ? fd.get('savingDateWeekly') : (sType === 'Monthly' ? fd.get('savingDateMonthly') : ''), flag: fd.get('flag') || '', restrictions: restrictions };
                if(id) { 
                    const idx = Data.members.findIndex(m => m.id === id); 
                    if(idx > -1) { 
                        const oldName = Data.members[idx].name; 
                        Data.members[idx] = { ...Data.members[idx], ...d, restrictions: JSON.parse(restrictions) }; 
                        if(oldName !== name) { 
                            Data.loans.forEach(l => { if(l.memberId === id) l.memberName = name; }); 
                            Data.transactions.forEach(t => { if(t.loanId === 'SAVINGS' && t.memberName === oldName) t.memberName = name; else if(Data.loans.find(l => l.id === t.loanId && l.memberId === id)) t.memberName = name; }); 
                        } 
                    } 
                    await Data.post('editMember', d); 
                } else { 
                    Data.members.push({ ...d, savingsBalance: 0, restrictions: {} }); 
                    await Data.post('addMember', d); 
                    if(document.getElementById('chk-send-welcome').checked) Utils.sendWelcome(d.id);
                    // --- ALERT: New Member ---
                    Utils.notifyAdmin('New Member', `${d.name} (${d.id}) added by ${App.currentUser.name}`);
                }
                Utils.setLoading(btn, false); UI.closeModal('modal-member'); App.renderContent();
            },
            handleLoanSubmit: async (e) => {
                e.preventDefault(); 
                const btn = document.getElementById('btn-save-loan'); 
                Utils.setLoading(btn, true);
                const fd = new FormData(e.target);
                const memberId = document.getElementById('selected-member-id').value;
                const member = Data.members.find(m => m.id === memberId);
                if (!member) { Utils.notify("Please select a valid member", "error"); Utils.setLoading(btn, false); return; }
                if (member.restrictions && member.restrictions.noLoan) { Utils.notify("This member is BLOCKED from new loans.", "error"); Utils.setLoading(btn, false); return; }
                if (member.restrictions && member.restrictions.block) { Utils.notify("This member is globally BLOCKED.", "error"); Utils.setLoading(btn, false); return; }
                if (member.flag === 'Defaulter' || member.flag === 'High Risk') { if (!confirm(`WARNING: This member is flagged as "${member.flag}". Proceed with lending?`)) { Utils.setLoading(btn, false); return; } }
                
                const gPhone = fd.get('guarantorPhone');
                if (gPhone) {
                    const activeGuarantees = Data.loans.filter(l => l.status === 'Active' && l.paid < l.totalRepayable && l.guarantorPhone === gPhone);
                    if (activeGuarantees.length > 0) {
                        const existingNames = activeGuarantees.map(l => l.memberName).join(', ');
                        if (!confirm(`RISK ALERT:\nThis Guarantor is already guaranteeing ${activeGuarantees.length} active loan(s):\n${existingNames}\n\nDo you want to proceed?`)) { Utils.setLoading(btn, false); return; }
                    }
                }
                await App.processLoanSave(fd, member, btn);
            },
            processLoanSave: async (fd, m, btn) => {
                const id = fd.get('id'), d = { id: id || Utils.id('L'), memberId: m.id, memberName: m.name, principal: Number(fd.get('principal')), rate: Number(fd.get('rate')), loanType: fd.get('loanType'), duration: Number(fd.get('duration')), category: fd.get('category'), productName: fd.get('productName'), guarantorName: fd.get('guarantorName'), guarantorPhone: fd.get('guarantorPhone'), refNo: fd.get('refNo'), remarks: fd.get('remarks'), downPayment: Number(fd.get('downPayment')) || 0, penalty: Number(fd.get('penalty')) || 0, productId: fd.get('productId') };
                d.totalRepayable = d.principal + (d.principal * (d.rate/100));
                if(id) { 
                    const idx = Data.loans.findIndex(l => l.id === d.id); 
                    if(idx > -1) { 
                        Data.loans[idx] = { ...Data.loans[idx], ...d }; 
                        const disTx = Data.transactions.find(t => t.loanId === d.id && t.category === 'Disbursement'); if(disTx) disTx.amount = -d.principal; 
                        if(d.category === 'Product') { const dpTx = Data.transactions.find(t => t.loanId === d.id && t.category === 'Down Payment'); if(dpTx) dpTx.amount = d.downPayment; } 
                    } 
                    await Data.post('editLoan', d); 
                } else { 
                    const txDate = Utils.dateToday(); 
                    const loan = { ...d, paid: 0, status: 'Active', disbursementDate: txDate }; 
                    Data.loans.push(loan); 
                    Data.transactions.unshift({ id: loan.id, loanId: loan.id, memberName: m.name, amount: -d.principal, date: txDate, category: 'Disbursement', collectedBy: 'System', operator: App.currentUser.name }); 
                    if(d.category === 'Product' && d.downPayment > 0) { const dpId = Utils.id('C') + '-DP'; Data.transactions.unshift({ id: dpId, loanId: loan.id, memberName: m.name, amount: d.downPayment, date: txDate, category: 'Down Payment', collectedBy: 'System', operator: App.currentUser.name }); d.dpId = dpId; } 
                    if(d.productId) { const pIdx = Data.inventory.findIndex(p => p.id === d.productId); if(pIdx > -1 && Data.inventory[pIdx].stock > 0) Data.inventory[pIdx].stock--; }
                    await Data.post('addLoan', { ...d, date: txDate });
                    Utils.notifyAdmin('New Loan Disbursed', `${d.loanType} Loan: ${Utils.currency(d.principal)} for ${m.name} (${m.id})`);
                    setTimeout(() => {
                        const smsText = `Dear ${m.name}, your ${d.loanType} Loan of ${Utils.currency(d.principal)} has been disbursed. Loan ID: ${d.id}.\n\nRegards,\n${Data.receiptSignature}`;
                        App.askConfirm(`Loan Disbursed Successfully!\n\nSend SMS notification to ${m.name}?`, () => Utils.sendSMS(m.phone, smsText));
                    }, 500);
                }
                Logic.recalcBalances(); Utils.setLoading(btn, false); UI.closeModal('modal-loan'); App.renderContent();
            },
            editTransaction: (id) => {
                if(App.currentUser.role === 'Staff') return Utils.notify("Access Denied", "error");
                const t = Data.transactions.find(x => x.id === id); if(!t) return;
                if(App.currentUser.role === 'Manager' && (t.category === 'Expense' || t.category === 'Bad Debt')) { return Utils.notify("Managers cannot edit expenses", "error"); }
                const contextName = (t.loanId === 'SAVINGS' || t.loanId === 'CAPITAL' || t.loanId === 'OFFICE') ? t.memberName : t.loanId;
                UI.openTransactionModal(contextName, t.category, 'Edit Transaction');
                document.getElementById('tx-editing-id').value = id;
                document.getElementById('tx-context-id').value = t.loanId; 
                document.getElementById('tx-amount').value = Math.abs(t.amount);
                const dateField = document.querySelector('input[name="date"]'); if(dateField) dateField.value = t.date;
                const metaInput = document.getElementById('tx-meta-input'); if(metaInput) metaInput.value = t.collectedBy || '';
                document.getElementById('tx-specific-member').value = t.memberName || '';
            },
            editLoan: (id) => {
                if(App.currentUser.role === 'Staff') return Utils.notify("Access Denied", "error");
                const l = Data.loans.find(x => x.id === id); if(!l) return;
                const f = document.getElementById('form-loan'); if(!f) return Utils.notify("Error: Form not found", "error");
                f.querySelector('input[name="id"]').value = l.id; document.getElementById('loan-modal-title').innerText = 'Edit Loan';
                const btn = document.getElementById('btn-save-loan'); if(btn) btn.setAttribute('data-original-text', '<span>Update</span>');
                UI.toggleLoanType(l.category); document.getElementById('selected-member-id').value = l.memberId; document.getElementById('member-search').value = l.memberName;
                f.principal.value = l.principal; f.rate.value = l.rate; f.loanType.value = l.loanType; f.duration.value = l.duration; f.guarantorName.value = l.guarantorName; f.guarantorPhone.value = l.guarantorPhone; f.refNo.value = l.refNo; f.remarks.value = l.remarks; f.penalty.value = l.penalty || '';
                if(l.category === 'Product') { f.productName.value = l.productName; const dpTx = Data.transactions.find(t => t && t.loanId === l.id && t.category === 'Down Payment'); document.getElementById('prod-price').value = l.principal + (dpTx ? Math.abs(dpTx.amount) : 0); document.getElementById('prod-dp').value = dpTx ? Math.abs(dpTx.amount) : 0; }
                setTimeout(Logic.calcEMI, 100); UI.openModal('modal-loan');
            },
            openRefinanceModal: (lid) => {
                if(App.currentUser.role === 'Staff') return Utils.notify("Access Denied", "error");
                const l = Data.loans.find(x => x.id === lid); if(!l) return;
                const balance = l.totalRepayable - l.paid;
                document.getElementById('form-refinance').reset(); document.getElementById('ref-old-id').value = lid; document.getElementById('ref-old-name').innerText = `${l.memberName} (${l.id})`; document.getElementById('ref-old-bal').innerText = Utils.currency(balance); document.getElementById('ref-old-bal-val').value = balance; document.getElementById('ref-duration').value = l.duration; document.getElementById('ref-rate').value = l.rate; Logic.calcRefinance(); UI.openModal('modal-refinance');
            },
            handleRefinanceSubmit: async (e) => {
                e.preventDefault(); const btn = document.getElementById('btn-save-refinance'); Utils.setLoading(btn, true);
                const oldId = document.getElementById('ref-old-id').value, oldLoan = Data.loans.find(x => x.id === oldId), oldBalance = Number(document.getElementById('ref-old-bal-val').value) || 0, topUp = Number(document.getElementById('ref-topup').value) || 0, newPrincipal = oldBalance + topUp, newDuration = Number(document.getElementById('ref-duration').value) || 0, newRate = Number(document.getElementById('ref-rate').value) || 0;
                if(!oldLoan) return; if (isNaN(newPrincipal) || newPrincipal <= 0) { Utils.notify("Invalid Amount", "error"); Utils.setLoading(btn, false); return; }
                const date = Utils.dateToday(), newLoanId = Utils.id('L'), newLoan = { ...oldLoan, id: newLoanId, principal: newPrincipal, rate: newRate, duration: newDuration, paid: 0, status: 'Active', refNo: `Ref-${oldId}`, category: 'Cash', productName: '', downPayment: 0 };
                oldLoan.status = 'Refinanced'; oldLoan.paid += oldBalance; newLoan.totalRepayable = newPrincipal + (newPrincipal * (newRate/100));
                const disId = Utils.id('D'), colId = Utils.id('R'); const disTx = { id: disId, loanId: newLoanId, memberName: newLoan.memberName, amount: -newPrincipal, date: date, category: 'Disbursement', collectedBy: 'System' }; const colTx = { id: colId, loanId: oldId, memberName: oldLoan.memberName, amount: oldBalance, date: date, category: 'Collection', collectedBy: 'Refinance' };
                Data.loans.push(newLoan); Data.transactions.unshift(disTx); Data.transactions.unshift(colTx);
                await Data.post('editLoan', { id: oldId, status: 'Refinanced' }); await Data.post('addLoan', { ...newLoan, date: date }); await Data.post('addCollection', { ...colTx, typeTx: 'Collection' });
                Logic.recalcBalances(); Utils.setLoading(btn, false); UI.closeModal('modal-refinance'); Utils.notify('Refinance Successful'); App.renderContent();
            },
            handleWriteOff: (lid) => { if(App.currentUser.role === 'Staff') return Utils.notify("Access Denied", "error"); let l = Data.loans.find(x => x.id === lid); if(!l) return; App.executeFullWriteOff(l); },
            executeFullWriteOff: (l) => {
                let balance = l.totalRepayable - l.paid; if (isNaN(balance)) balance = 0; const name = l.memberName;
                App.askConfirm(`Write Off loan ${l.id} (${name})? Loss Amount: ${Utils.currency(balance)}`, async () => {
                    const btn = document.getElementById('btn-confirm-yes'); Utils.setLoading(btn, true, 'Processing...'); l.status = 'Written Off';
                    const expTx = { id: Utils.id('X'), loanId: 'OFFICE', memberName: name, amount: -balance, date: Utils.dateToday(), category: 'Bad Debt', collectedBy: `Ref: ${l.id}` };
                    Data.transactions.unshift(expTx); await Data.post('editLoan', { id: l.id, status: 'Written Off' }); await Data.post('addSavingsTx', { ...expTx, typeTx: 'Bad Debt' }); Logic.recalcBalances(); Utils.setLoading(btn, false); UI.closeModal('modal-confirm'); Utils.notify("Loan Written Off"); App.renderContent();
                }, true, true);
            },
            executeArchiveLoan: (id, force) => {
                const l = Data.loans.find(x => x.id === id); if (!l) return;
                App.askConfirm(force ? `Force Archive ${l.memberName}?` : `Archive ${l.memberName}?`, async () => {
                    const btn = document.getElementById('btn-confirm-yes'); Utils.setLoading(btn, true, 'Generating PDF...'); await new Promise(r => setTimeout(r, 500)); 
                    const txs = Data.transactions.filter(t => t.loanId === l.id), totalPaid = txs.filter(t => t.amount > 0 && t.category === 'Collection').reduce((s,t) => s + t.amount, 0); const disTx = txs.find(t => t.category === 'Disbursement'); const disDate = disTx ? disTx.date : '';
                    const container = document.getElementById('pdf-generator-container'); container.innerHTML = `<div class="p-8 bg-white text-slate-900 font-sans"><div class="text-center border-b pb-4 mb-4"><h1 class="text-2xl font-bold uppercase tracking-widest">Loan Statement</h1><p class="text-sm text-slate-500">${Data.receiptSignature}</p></div><div class="grid grid-cols-2 gap-4 text-xs mb-6 bg-slate-50 p-4 rounded border"><div>Loan ID: <b>${l.id}</b></div><div>Archived: <b>${Utils.dateToday()}</b></div><div>Member: <b>${l.memberName}</b> (${l.memberId})</div><div>Type: <b>${l.category} / ${l.loanType}</b></div><div>Ref No: <b>${l.refNo || '-'}</b></div></div><div class="grid grid-cols-3 gap-4 mb-6 text-center"><div class="bg-slate-100 p-2 rounded"><div class="text-[10px] uppercase text-slate-500 font-bold">Principal</div><div class="font-bold">${Utils.currency(l.principal)}</div></div><div class="bg-slate-100 p-2 rounded"><div class="text-[10px] uppercase text-slate-500 font-bold">Total Repayable</div><div class="font-bold">${Utils.currency(l.totalRepayable)}</div></div><div class="bg-green-100 p-2 rounded text-green-700"><div class="text-[10px] uppercase font-bold">Total Paid</div><div class="font-bold">${Utils.currency(totalPaid)}</div></div></div><h3 class="font-bold text-xs mb-2 text-slate-500 uppercase border-b pb-1">Transaction History</h3><table class="w-full text-xs border-collapse border border-slate-200"><thead class="bg-slate-100"><tr><th class="border p-2 text-left">Date</th><th class="border p-2 text-left">Type</th><th class="border p-2 text-right">Amount</th></tr></thead><tbody>${txs.map(t => `<tr><td class="border p-2">${t.date}</td><td class="border p-2">${t.category}</td><td class="border p-2 text-right font-mono">${Utils.currency(Math.abs(t.amount))}</td></tr>`).join('')}</tbody></table><div class="mt-8 text-[10px] text-slate-400 text-center">Generated by MicroFin Manager</div></div>`; lucide.createIcons({ root: container }); await new Promise(r => setTimeout(r, 500));
                    let pdfBase64 = null; try { const opt = { margin: 10, filename: `Loan_Statement_${l.id}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } }; const pdfBlob = await html2pdf().set(opt).from(container).outputPdf('datauristring'); pdfBase64 = pdfBlob.split(',')[1]; } catch(e) {}
                    Utils.setLoading(btn, true, 'Syncing...'); await new Promise(r => setTimeout(r, 50));
                    l.status = 'Archived'; const idx = Data.loans.findIndex(x => x.id === id); if (idx > -1) { const archivedItem = { ...l, archivedDate: Utils.dateToday() }; Data.archivedLoans.unshift(archivedItem); Data.loans.splice(idx, 1); }
                    
                    // --- INCOME ONE-ROW LOGIC ---
                    const margin = (l.category === 'Product' && l.productId) ? ((l.principal + (l.downPayment || 0)) - (Data.inventory.find(i=>i.id===l.productId)?.buyPrice || 0)) : 0;
                    const interestRatio = l.totalRepayable > 0 ? (l.totalRepayable - l.principal) / l.totalRepayable : 0;
                    const realizedInterest = totalPaid * interestRatio;
                    // Capture penalties from transactions
                    const totalPenalties = txs.filter(t => t.category === 'Penalty').reduce((s, t) => s + t.amount, 0);

                    // Combine into Single Entry
                    const totalIncome = realizedInterest + margin + totalPenalties;
                    let incomeSummary = null;

                    if (totalIncome > 0) {
                        // Create breakdown string for parsing later
                        const breakdown = `Int:${Math.round(realizedInterest)} Mrg:${Math.round(margin)} Pen:${Math.round(totalPenalties)}`;
                        const newIncId = Utils.id('I');
                        
                        incomeSummary = { 
                            id: newIncId, 
                            date: Utils.dateToday(), 
                            memberName: l.memberName, 
                            refId: l.id, 
                            amount: totalIncome, 
                            remarks: breakdown
                        };

                        // Update Local Data: Remove old, add new
                        Data.income = Data.income.filter(i => i.refId !== l.id); // Remove distinct penalties
                        Data.income.push({
                            id: newIncId, 
                            date: Utils.dateToday(), 
                            memberName: l.memberName, 
                            refId: l.id, 
                            amount: totalIncome, 
                            sourceType: 'Loan Profit', 
                            reason: 'Archive Summary', 
                            remarks: breakdown, 
                            operator: App.currentUser.name
                        });
                    }
                    // -----------------------------

                    Data.transactions = Data.transactions.filter(t => t.loanId !== id); 
                    
                    // Send to Backend (Atomic Archive + Income Update)
                    await Data.post('archiveLoan', { 
                        id: id, 
                        pdf: pdfBase64, 
                        name: `Loan_Statement_${l.memberName}_${l.id}`, 
                        disbursementDate: disDate,
                        incomeSummary: incomeSummary
                    }); 
                    
                    Utils.setLoading(btn, false); UI.closeModal('modal-confirm'); Utils.notify("Loan Archived & Income Consolidated"); App.renderContent();
                }, true, true);
            },
            openSavingsAction: (type, mName) => UI.openTransactionModal(mName, type, type + ' for ' + mName),
            openNewLoanModal: () => { 
                if (Data.sysConfig.freeze.loan) return Utils.notify("New Loan creation is FROZEN globally.", "error");
                const f = document.getElementById('form-loan'); f.reset(); f.querySelector('input[name="id"]').value = ''; document.getElementById('loan-modal-title').innerText = 'New Loan'; const btn = document.getElementById('btn-save-loan'); if(btn) { btn.setAttribute('data-original-text', '<span>Save</span>'); btn.innerHTML = '<span>Save</span>'; btn.disabled = false; btn.classList.remove('opacity-70', 'cursor-not-allowed'); } UI.toggleLoanType('Cash'); document.getElementById('member-search').value = ''; document.getElementById('selected-member-id').value = ''; document.getElementById('emi-preview').classList.add('hidden'); 
                document.getElementById('inv-search-loan').value = ''; document.getElementById('selected-product-id').value = '';
                const warningBox = document.getElementById('loan-member-warning'); if (warningBox) warningBox.classList.add('hidden');
                document.getElementById('member-dropdown').classList.add('hidden');
                UI.openModal('modal-loan'); 
            },
            openGroupModal: () => { if (Data.sysConfig.freeze.group) return Utils.notify("New Group creation is FROZEN globally.", "error"); const form = document.getElementById('form-group'); form.reset(); document.getElementById('group-id').value = ''; document.getElementById('group-modal-title').innerText = 'Create Group Loan'; document.getElementById('btn-save-group').innerText = 'Create Group'; const list = document.getElementById('group-member-list'), members = Data.members.filter(m => m.status === 'Active'); list.innerHTML = members.map(m => `<label class="flex items-center gap-3 p-2 hover:bg-slate-50 cursor-pointer border-b last:border-0 border-slate-100 transition-colors"><input type="checkbox" name="members" value="${m.id}" onchange="App.calcGroupPot()" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300"><div><div class="text-sm font-bold text-slate-700 leading-tight">${m.name} ${UI.getFlagIcon(m.flag)}</div><div class="text-[10px] text-slate-400 font-mono">${m.id}</div></div></label>`).join(''); App.calcGroupPot(); UI.openModal('modal-group'); },
            initGroupEdit: (id) => {
                const g = Data.groups.find(x => x.id === id); if(!g) return;
                const form = document.getElementById('form-group'); form.reset(); document.getElementById('group-id').value = g.id; document.getElementById('group-modal-title').innerText = 'Edit Group Loan'; document.getElementById('btn-save-group').innerText = 'Update Group';
                form.querySelector('input[name="name"]').value = g.name; form.querySelector('select[name="frequency"]').value = g.frequency; form.querySelector('input[name="contribution"]').value = g.contribution; form.querySelector('input[name="penalty"]').value = g.penalty || '';
                const list = document.getElementById('group-member-list'), members = Data.members.filter(m => m.status === 'Active');
                list.innerHTML = members.map(m => { const isChecked = g.memberIDs.includes(m.id); return `<label class="flex items-center gap-3 p-2 hover:bg-slate-50 cursor-pointer border-b last:border-0 border-slate-100 transition-colors"><input type="checkbox" name="members" value="${m.id}" ${isChecked?'checked':''} onchange="App.calcGroupPot()" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300"><div><div class="text-sm font-bold text-slate-700 leading-tight">${m.name} ${UI.getFlagIcon(m.flag)}</div><div class="text-[10px] text-slate-400 font-mono">${m.id}</div></div></label>`; }).join('');
                App.calcGroupPot(); UI.openModal('modal-group');
            },
            openAssistant: (mode = 'loan') => { App.assistantMode = mode; document.getElementById('ast-title').innerHTML = mode === 'loan' ? '<i data-lucide="bot" class="w-5 h-5 text-indigo-600"></i> Loan Assistant' : '<i data-lucide="bot" class="w-5 h-5 text-blue-600"></i> Savings Assistant'; const tabs = document.getElementById('ast-tabs'); tabs.style.display = 'flex'; const tabCol = document.getElementById('tab-ast-collection'), tabUpc = document.getElementById('tab-ast-upcoming'), tabRem = document.getElementById('tab-ast-reminder'); document.getElementById('ast-filter-select').classList.remove('hidden'); if (mode === 'savings') { tabCol.innerText = 'Due Now'; tabUpc.innerText = 'Upcoming'; tabRem.innerText = 'Missed / Dormant'; tabRem.style.display = 'block'; } else { tabCol.innerText = 'Collections'; tabUpc.innerText = 'Upcoming'; tabRem.innerText = 'Reminders'; tabRem.style.display = 'block'; } App.renderAssistant(); UI.openModal('modal-assistant'); },
            renderAssistant: () => {
                const list = document.getElementById('ast-list'); list.innerHTML = '';
                const btnClassWA = "bg-green-100 text-green-700 p-2 rounded hover:bg-green-200 transition";
                const btnClassSMS = "bg-sky-100 text-sky-700 p-2 rounded hover:bg-sky-200 transition";
                const btnClassCopy = "bg-slate-100 text-slate-500 p-2 rounded hover:bg-slate-200 transition";

                if (App.assistantMode === 'savings') {
                    let fdDue = [];
                    const today = new Date(); today.setHours(0,0,0,0);
                    const currentMonthStr = today.toLocaleString('default', { month: 'short', year: 'numeric' });
                    
                    Data.fixedDeposits.forEach(fd => {
                        if(fd.status === 'Active') {
                            const mat = Utils.parseDate(fd.maturityDate);
                            const days = Math.ceil((mat - today) / (1000 * 60 * 60 * 24));
                            if (fd.frequency === 'Monthly') {
                                const historyPaid = fd.interestHistory && fd.interestHistory.some(h => h.month === currentMonthStr);
                                const lastInterestTx = Data.transactions.find(t => t.loanId === fd.id && t.category === 'FD Interest' && t.collectedBy && t.collectedBy.includes(currentMonthStr));
                                if (!historyPaid && !lastInterestTx) fdDue.push({ fd, days, type: 'interest' });
                            }
                            if(days <= 7) {
                                const existing = fdDue.find(x => x.fd.id === fd.id);
                                if(existing) existing.type = 'both'; else fdDue.push({ fd, days, type: 'maturity' });
                            }
                        }
                    });

                    let activeMembers = Data.members.filter(m => m.status === 'Active');
                    if (App.assistantUpcomingFilter !== 'all') activeMembers = activeMembers.filter(m => m.savingType === App.assistantUpcomingFilter);
                    const dueNow = [], upcoming = [], missed = [];
                    activeMembers.forEach(m => {
                        const { lastDate, nextDue, isDue } = Logic.getSavingsStatus(m), daysSinceLast = lastDate ? Math.floor((today - lastDate) / (1000 * 60 * 60 * 24)) : 999;
                        let isMissed = false; if (isDue) { if (m.savingType === 'Daily' && daysSinceLast > 3) isMissed = true; else if (m.savingType === 'Weekly' && daysSinceLast > 10) isMissed = true; else if (m.savingType === 'Monthly' && daysSinceLast > 40) isMissed = true; if (!lastDate) isMissed = true; }
                        if (isMissed) missed.push({ m, days: daysSinceLast, lastDate }); else if (isDue) dueNow.push({ m, lastDate }); else if (nextDue) { const daysLeft = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24)); let threshold = 30; if (m.savingType === 'Daily') threshold = 1; else if (m.savingType === 'Weekly') threshold = 3; else if (m.savingType === 'Monthly') threshold = 10; if (daysLeft > 0 && daysLeft <= threshold) upcoming.push({ m, due: nextDue, days: daysLeft, lastDate }); }
                    });
                    const totalDueAmt = dueNow.reduce((s, x) => s + (Number(x.m.savingAmount)||0), 0), totalMissedAmt = missed.reduce((s, x) => s + (Number(x.m.savingAmount)||0), 0);
                    document.getElementById('ast-stat-label').innerText = "Due Now"; document.getElementById('ast-total-due').innerText = Utils.currency(totalDueAmt); document.getElementById('ast-total-overdue').innerText = Utils.currency(totalMissedAmt); document.getElementById('ast-grand-outstanding').innerText = '-'; document.getElementById('ast-count').innerText = dueNow.length + missed.length; document.getElementById('ast-risk').innerText = missed.length;
                    
                    if (App.activeAssistantTab === 'collection') {
                        const fdHtml = fdDue.map(x => {
                            const isMat = x.type === 'maturity' || x.type === 'both', isInt = x.type === 'interest' || x.type === 'both';
                            return `<div class="p-3 bg-indigo-50 border border-indigo-200 rounded mb-2 flex justify-between items-center shadow-sm"><div><span class="text-xs font-bold text-indigo-700 uppercase block mb-1">${isMat ? 'FD Maturity' : 'FD Interest Due'}</span><span class="font-bold text-slate-800">${x.fd.memberName}</span><div class="text-xs text-slate-500">Maturity: ${x.fd.maturityDate}</div></div><div class="text-right flex flex-col gap-1 items-end">${isInt ? `<button onclick="App.payFDInterest('${x.fd.id}')" class="bg-blue-100 text-blue-700 text-[10px] px-2 py-1 rounded hover:bg-blue-200 font-bold">Pay Interest</button>` : ''}${isMat ? `<button onclick="App.closeFD('${x.fd.id}')" class="bg-indigo-600 text-white text-[10px] px-2 py-1 rounded hover:bg-indigo-700 font-bold">Payout Principal</button>` : ''}</div></div>`;
                        }).join('');
                        list.innerHTML = fdHtml + (dueNow.map(x => `<div class="flex justify-between items-center p-3 bg-white border border-blue-100 rounded shadow-sm hover:border-blue-400 transition"><div><div class="font-bold text-slate-800">${x.m.name} ${UI.getFlagIcon(x.m.flag)} <span class="text-[10px] font-normal text-slate-400 bg-slate-50 px-1 rounded border">${x.m.savingType}</span></div><div class="flex items-center gap-2 mt-0.5 text-xs text-slate-500"><span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${x.m.phone}</span><span class="text-slate-300">|</span><span class="text-[10px] text-slate-400">Last: ${x.lastDate ? x.lastDate.toLocaleDateString() : 'Never'}</span></div></div><div class="flex items-center gap-2"><span class="font-bold text-blue-600 mr-1 text-lg">${Utils.currency(x.m.savingAmount)}</span><button onclick="Utils.sendSavingsReminder('${x.m.id}', '${x.m.savingAmount}', '${Utils.dateToday()}')" class="${btnClassWA}" title="WhatsApp Reminder"><i data-lucide="message-circle" class="w-4 h-4"></i></button><button onclick="Utils.sendSMS('${x.m.phone}', Utils.getSavingsReminderMsg('${x.m.id}', '${x.m.savingAmount}', '${Utils.dateToday()}'))" class="${btnClassSMS}" title="Send SMS"><i data-lucide="message-square" class="w-4 h-4"></i></button><button onclick="Utils.copySavingsReminder('${x.m.id}', '${x.m.savingAmount}', '${Utils.dateToday()}')" class="${btnClassCopy}" title="Copy Text"><i data-lucide="copy" class="w-4 h-4"></i></button><button onclick="UI.openTransactionModal('SAVINGS', 'Deposit', 'Deposit for ${x.m.name}', ${x.m.savingAmount}, '${x.m.name}')" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow hover:bg-blue-700">Deposit</button></div></div>`).join('') || (fdHtml ? '' : UI.empty("No regular savings due.", 1))); 
                    }
                    else if (App.activeAssistantTab === 'upcoming') { 
                        list.innerHTML = upcoming.map(x => `<div class="flex justify-between items-center p-3 bg-white border border-slate-100 rounded shadow-sm hover:border-slate-300 transition opacity-80 hover:opacity-100"><div><div class="font-bold text-slate-700">${x.m.name} ${UI.getFlagIcon(x.m.flag)}</div><div class="flex items-center gap-2 mt-0.5 text-xs text-slate-500"><span class="text-blue-600 font-bold">Due: ${x.due.toLocaleDateString()} (${x.days}d)</span><span class="text-slate-300">|</span><span class="text-[10px] text-slate-400 font-mono">${x.m.savingType}</span></div></div><div class="flex items-center gap-2"><span class="font-bold text-slate-500 mr-1 text-sm">${Utils.currency(x.m.savingAmount)}</span><button onclick="Utils.sendSavingsReminder('${x.m.id}', '${x.m.savingAmount}', '${x.due.toLocaleDateString()}')" class="${btnClassWA}" title="WhatsApp Reminder"><i data-lucide="message-circle" class="w-4 h-4"></i></button><button onclick="Utils.sendSMS('${x.m.phone}', Utils.getSavingsReminderMsg('${x.m.id}', '${x.m.savingAmount}', '${x.due.toLocaleDateString()}'))" class="${btnClassSMS}" title="Send SMS"><i data-lucide="message-square" class="w-4 h-4"></i></button><button onclick="Utils.copySavingsReminder('${x.m.id}', '${x.m.savingAmount}', '${x.due.toLocaleDateString()}')" class="${btnClassCopy}" title="Copy Text"><i data-lucide="copy" class="w-4 h-4"></i></button></div></div>`).join('') || UI.empty("No upcoming savings soon.", 1); 
                    }
                    else { 
                        list.innerHTML = missed.map(x => `<div class="flex justify-between items-center p-3 bg-white border border-red-100 rounded shadow-sm hover:border-red-300 transition"><div><div class="font-bold text-slate-800">${x.m.name} ${UI.getFlagIcon(x.m.flag)} <span class="text-[10px] font-bold text-red-600 bg-red-50 px-1.5 rounded uppercase tracking-wider">Missed</span></div><div class="flex items-center gap-2 mt-0.5 text-xs text-slate-500"><span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${x.m.phone}</span><span class="text-slate-300">|</span><span class="text-[10px] text-red-500 font-bold">Last: ${x.lastDate ? `${x.days} days ago` : 'Never Paid'}</span></div></div><div class="flex items-center gap-2"><div class="text-right mr-2"><div class="font-bold text-slate-700 text-sm">${Utils.currency(x.m.savingAmount)}</div></div><button onclick="Utils.sendSavingsReminder('${x.m.id}', '${x.m.savingAmount}', 'ASAP')" class="${btnClassWA}" title="WhatsApp Reminder"><i data-lucide="message-circle" class="w-4 h-4"></i></button><button onclick="Utils.sendSMS('${x.m.phone}', Utils.getSavingsReminderMsg('${x.m.id}', '${x.m.savingAmount}', 'ASAP'))" class="${btnClassSMS}" title="Send SMS"><i data-lucide="message-square" class="w-4 h-4"></i></button><button onclick="Utils.copySavingsReminder('${x.m.id}', '${x.m.savingAmount}', 'ASAP')" class="${btnClassCopy}" title="Copy Text"><i data-lucide="copy" class="w-4 h-4"></i></button><button onclick="UI.openTransactionModal('SAVINGS', 'Deposit', 'Late Deposit for ${x.m.name}', ${x.m.savingAmount}, '${x.m.name}')" class="bg-slate-800 text-white px-3 py-1.5 rounded text-xs font-bold shadow hover:bg-slate-700">Collect</button></div></div>`).join('') || UI.empty("No missed savings found.", 1); 
                    }
                } else {
                    const activeLoans = Data.loans.filter(l => l.status === 'Active' && l.paid < l.totalRepayable); const filteredLoans = activeLoans.filter(l => App.assistantUpcomingFilter === 'all' || l.loanType === App.assistantUpcomingFilter);
                    if (App.activeAssistantTab === 'collection') {
                        const dueLoans = filteredLoans.filter(l => Logic.checkIsDueOn(l, new Date())); const totalDue = dueLoans.reduce((s,l) => s + Math.ceil(l.totalRepayable/(l.duration||1)), 0);
                        document.getElementById('ast-stat-label').innerText = "Due Today"; document.getElementById('ast-total-due').innerText = Utils.currency(totalDue); document.getElementById('ast-total-overdue').innerText = '-'; document.getElementById('ast-count').innerText = dueLoans.length;
                        list.innerHTML = dueLoans.map(l => { const emi = Math.ceil(l.totalRepayable / (l.duration || 1)); const mem = Data.members.find(m => m.id === l.memberId); const phone = mem ? mem.phone : ''; return `<div class="flex justify-between items-center p-3 bg-white border rounded shadow-sm hover:border-indigo-300 transition"><div><div class="font-bold text-slate-800">${l.memberName} ${UI.getFlagIcon(mem?.flag)} <span class="text-xs font-normal text-slate-500">(${l.loanType})</span></div><div class="flex items-center gap-2 mt-0.5 text-xs text-slate-500"><span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${phone}</span><span class="text-slate-300">|</span><span class="text-[10px] text-slate-400">Due: ${Utils.currency(l.totalRepayable - l.paid)}</span></div></div><div class="flex items-center gap-2"><button onclick="App.viewLoanHistory('${l.id}')" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-slate-50 rounded-full transition" title="History"><i data-lucide="history" class="w-4 h-4"></i></button><button onclick="Utils.sendReminder('${l.memberId}', ${emi}, '${l.id}')" class="${btnClassWA}" title="WhatsApp Reminder"><i data-lucide="message-circle" class="w-4 h-4"></i></button><button onclick="Utils.sendSMS('${phone}', Utils.getReminderMsg('${l.memberId}', ${emi}, '${l.id}'))" class="${btnClassSMS}" title="Send SMS"><i data-lucide="message-square" class="w-4 h-4"></i></button><button onclick="Utils.copyReminder('${l.memberId}', ${emi}, '${l.id}')" class="${btnClassCopy}" title="Copy Text"><i data-lucide="copy" class="w-4 h-4"></i></button><span class="font-bold text-indigo-600 text-lg mr-2 ml-1">${Utils.currency(emi)}</span><button onclick="UI.openTransactionModal('${l.id}', 'Collection', 'Collect Today', ${emi})" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-indigo-700 shadow-sm">Collect</button></div></div>`; }).join('') || UI.empty("No collections due today.", 1);
                    } else if (App.activeAssistantTab === 'upcoming') {
                        const upcoming = [], today = new Date(); today.setHours(0,0,0,0);
                        filteredLoans.forEach(l => {
                            let nextDue = null; const disTx = Data.transactions.find(t => t.loanId === l.id && t.category === 'Disbursement'); if(!disTx) return; const disDate = Utils.parseDate(disTx.date);
                            if (l.loanType === 'Daily') { nextDue = Utils.cloneDate(today); nextDue.setDate(today.getDate() + 1); } else if (l.loanType === 'Weekly') { const diff = disDate.getDay() - today.getDay(); nextDue = Utils.cloneDate(today); nextDue.setDate(today.getDate() + (diff <= 0 ? diff + 7 : diff)); } else if (l.loanType === 'Monthly') { nextDue = new Date(today.getFullYear(), today.getMonth(), disDate.getDate()); if (nextDue <= today) nextDue.setMonth(nextDue.getMonth() + 1); }
                            if (nextDue) { const daysLeft = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24)); if (daysLeft > 0 && daysLeft <= ((l.loanType === 'Daily') ? 1 : 2)) upcoming.push({ loan: l, due: nextDue, days: daysLeft }); }
                        });
                        document.getElementById('ast-stat-label').innerText = "Upcoming"; document.getElementById('ast-total-due').innerText = upcoming.length; document.getElementById('ast-total-overdue').innerText = '-'; document.getElementById('ast-count').innerText = upcoming.length;
                        list.innerHTML = upcoming.map(item => { const l = item.loan; const emi = Math.ceil(l.totalRepayable / (l.duration || 1)); const mem = Data.members.find(m => m.id === l.memberId); const phone = mem ? mem.phone : ''; return `<div class="flex justify-between items-center p-3 bg-white border border-blue-100 rounded shadow-sm hover:border-blue-300 transition"><div><div class="font-bold text-slate-800">${item.loan.memberName} ${UI.getFlagIcon(mem?.flag)} <span class="text-xs font-normal text-slate-500">(${item.loan.loanType})</span></div><div class="flex items-center gap-2 mt-0.5 text-xs text-slate-500"><span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${phone}</span><span class="text-slate-300">|</span><span class="text-blue-600 font-bold">Due ${item.due.toLocaleDateString()} (${item.days}d)</span></div></div><div class="flex items-center gap-2"><button onclick="App.viewLoanHistory('${l.id}')" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-slate-50 rounded-full transition" title="History"><i data-lucide="history" class="w-4 h-4"></i></button><span class="font-bold text-slate-600 mr-2 text-sm">${Utils.currency(emi)}</span><button onclick="Utils.sendUpcomingLoanReminder('${l.memberId}', ${emi}, '${l.id}', '${item.due.toLocaleDateString()}')" class="${btnClassWA}" title="WhatsApp Reminder"><i data-lucide="message-circle" class="w-4 h-4"></i></button><button onclick="Utils.sendSMS('${phone}', Utils.getUpcomingLoanMsg('${l.memberId}', ${emi}, '${l.id}', '${item.due.toLocaleDateString()}'))" class="${btnClassSMS}" title="Send SMS"><i data-lucide="message-square" class="w-4 h-4"></i></button><button onclick="Utils.copyUpcomingLoanMsg('${l.memberId}', ${emi}, '${l.id}', '${item.due.toLocaleDateString()}')" class="${btnClassCopy}" title="Copy Text"><i data-lucide="copy" class="w-4 h-4"></i></button></div></div>` }).join('') || UI.empty("No upcoming payments soon.", 1);
                    } else {
                        const overdueLoans = filteredLoans.filter(l => Logic.calculateArrears(l) > 0), totalArrears = overdueLoans.reduce((s,l) => s + Logic.calculateArrears(l), 0);
                        document.getElementById('ast-stat-label').innerText = "Overdue"; document.getElementById('ast-total-due').innerText = '-'; document.getElementById('ast-total-overdue').innerText = Utils.currency(totalArrears); document.getElementById('ast-count').innerText = overdueLoans.length;
                        list.innerHTML = overdueLoans.map(l => { const arrears = Logic.calculateArrears(l); const mem = Data.members.find(m => m.id === l.memberId); const phone = mem ? mem.phone : ''; return `<div class="flex justify-between items-center p-3 bg-white border border-orange-100 rounded shadow-sm hover:border-orange-300 transition"><div><div class="font-bold text-slate-800">${l.memberName} ${UI.getFlagIcon(mem?.flag)} <span class="text-xs font-normal text-slate-500">(${l.loanType})</span></div><div class="flex items-center gap-2 mt-0.5 text-xs text-slate-500"><span class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${phone}</span><span class="text-slate-300">|</span><span class="text-orange-500 font-bold">Arrears: ${Utils.currency(arrears)}</span></div></div><div class="flex gap-2"><button onclick="App.viewLoanHistory('${l.id}')" class="bg-slate-100 text-slate-600 p-1.5 rounded hover:bg-slate-200 hover:text-blue-600 transition" title="History"><i data-lucide="history" class="w-4 h-4"></i></button><button onclick="Utils.sendReminder('${l.memberId}', ${arrears}, '${l.id}')" class="${btnClassWA}" title="WhatsApp Reminder"><i data-lucide="message-circle" class="w-4 h-4"></i></button><button onclick="Utils.sendSMS('${phone}', Utils.getReminderMsg('${l.memberId}', ${arrears}, '${l.id}'))" class="${btnClassSMS}" title="Send SMS"><i data-lucide="message-square" class="w-4 h-4"></i></button><button onclick="Utils.copyReminder('${l.memberId}', ${arrears}, '${l.id}')" class="${btnClassCopy}" title="Copy Text"><i data-lucide="copy" class="w-4 h-4"></i></button></div></div>`; }).join('') || UI.empty("No overdue loans.", 1);
                    }
                } lucide.createIcons();
            },
            viewRiskSummary: (type) => {
                const isGroup = type === 'group';
                const items = isGroup ? Data.groups : Data.groupDPS;
                const riskyMembers = [];
                let totalDeficit = 0;

                items.forEach(g => {
                    if (g.status === 'Active' && Logic.getGroupStatus(g, isGroup ? 'loan' : 'dps').days <= 0) {
                        g.memberIDs.forEach(mid => {
                            const m = Data.members.find(x => x.id === mid);
                            if (m && m.savingsBalance < g.contribution) {
                                const deficit = g.contribution - m.savingsBalance;
                                riskyMembers.push({ m, g, deficit });
                                totalDeficit += deficit;
                            }
                        });
                    }
                });

                if (riskyMembers.length === 0) return Utils.notify("No risks found.", "success");

                App.activeRiskCheckId = { type: 'summary_' + type, id: null };
                document.querySelector('#modal-group-risk h3').innerHTML = `<i data-lucide="alert-triangle" class="w-5 h-5"></i> All ${isGroup ? 'Group' : 'DPS'} Risks`;
                document.getElementById('gr-date').innerText = `${riskyMembers.length} Members`;
                document.getElementById('gr-days-tag').innerText = "Action Required";
                document.getElementById('gr-days-tag').className = 'text-xs font-bold px-2 py-0.5 rounded-full bg-red-100 text-red-700';
                document.getElementById('gr-info').innerText = `Total Deficit: ${Utils.currency(totalDeficit)}`;
                document.getElementById('gr-count').innerText = riskyMembers.length;
                
                const list = document.getElementById('gr-list');
                list.innerHTML = riskyMembers.map(item => `
                    <div class="flex justify-between items-center p-3 bg-white border border-red-100 rounded hover:bg-red-50 transition mb-2">
                        <div>
                            <div class="font-bold text-slate-800 text-sm">${item.m.name} ${UI.getFlagIcon(item.m.flag)}</div>
                            <div class="text-[10px] text-indigo-600 font-bold mb-0.5">${item.g.name}</div>
                            <div class="text-[10px] text-slate-400 flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${item.m.phone}</div>
                            <div class="text-xs text-slate-500">Bal: <span class="font-bold text-red-600">${Utils.currency(item.m.savingsBalance)}</span></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold text-red-400">-${Utils.currency(item.deficit)}</span>
                            <button onclick="UI.openTransactionModal('${item.m.name.replace(/'/g, "\\'")}', 'Deposit', 'Deposit for ${item.m.name.replace(/'/g, "\\'")}', ${item.deficit}, null, ${item.g.penalty||0}, '${item.g.id}')" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 transition shadow-sm" title="Collect Deficit"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            <button onclick="Utils.copyGroupReminder('${item.m.name.replace(/'/g, "\\'")}', '${item.g.name.replace(/'/g, "\\'")}', '${item.deficit}', 'ASAP', '${item.m.savingsBalance}')" class="bg-slate-100 text-slate-500 p-2 rounded hover:bg-slate-200 transition"><i data-lucide="copy" class="w-4 h-4"></i></button>
                            <button onclick="Utils.sendSMS('${item.m.phone}', 'Hello ${item.m.name.replace(/'/g, "\\'")}, deposit ${Utils.currency(item.deficit)} for ${item.g.name.replace(/'/g, "\\'")}.')" class="bg-slate-800 text-white p-2 rounded hover:bg-slate-900 transition"><i data-lucide="message-square" class="w-4 h-4"></i></button>
                        </div>
                    </div>`).join('');
                
                document.getElementById('gr-safe-msg').classList.add('hidden');
                UI.openModal('modal-group-risk');
                lucide.createIcons();
            },
            handleTransactionSubmit: async (e) => { e.preventDefault(); const btn = document.getElementById('btn-save-tx'); Utils.setLoading(btn, true); const fd = new FormData(e.target), ctxId = fd.get('contextId'), cat = fd.get('category'), amt = Number(fd.get('amount')), date = fd.get('date'), by = fd.get('collectedBy'), editId = fd.get('editingTxId'); const specMember = document.getElementById('tx-specific-member').value; const penalty = Number(fd.get('penalty')) || 0; const refId = document.getElementById('tx-reference-id').value; if (amt <= 0 || isNaN(amt)) { Utils.notify("Invalid Amount", "error"); Utils.setLoading(btn, false); return; } let mName = '', loanId = ctxId; if(cat === 'Deposit' || cat === 'Withdrawal' || cat === 'FD Interest') { loanId = 'SAVINGS'; mName = specMember || ctxId; 
                if (mName === 'SAVINGS' || !mName) { Utils.notify("Please select a member first", "error"); Utils.setLoading(btn, false); return; }
                const m = Data.members.find(x => x.name === mName); if(cat === 'Withdrawal' && m && m.savingsBalance < amt) { Utils.notify(`Insufficient Balance`, "error"); Utils.setLoading(btn, false); return; } } else if (cat.includes('Capital') || cat.includes('Expense') || cat === 'Other Income') { loanId = (cat.includes('Expense') || cat === 'Other Income') ? 'OFFICE' : 'CAPITAL'; mName = (cat.includes('Expense') || cat === 'Other Income') ? 'Office' : 'Equity'; } else { const l = Data.loans.find(x => x.id === ctxId); if(l) mName = specMember || l.memberName; } 
                
                const finalAmt = (['Withdrawal', 'Disbursement', 'Expense', 'Equity Withdraw', 'DPS Transfer', 'DPS Installment', 'DPS Payment', 'DPS Withdrawal', 'FD Withdrawal'].includes(cat)) ? -amt : amt; 
                
                const finalBy = by || (App.currentUser ? App.currentUser.name : 'System'); 
                const targetMember = Data.members.find(m => m.name === mName);
                if (targetMember && targetMember.restrictions) {
                    if (targetMember.restrictions.block) { Utils.notify(`Transaction Blocked: ${mName} is restricted.`, "error"); Utils.setLoading(btn, false); return; }
                    if (cat === 'Withdrawal' && targetMember.restrictions.noWithdraw) { Utils.notify(`Withdrawal Blocked: ${mName} is restricted.`, "error"); Utils.setLoading(btn, false); return; }
                }
                if (editId) { 
                    const txIdx = Data.transactions.findIndex(t => t.id === editId); if (txIdx > -1) Data.transactions[txIdx] = { ...Data.transactions[txIdx], amount: finalAmt, date: date, collectedBy: finalBy }; await Data.post('editTransaction', { id: editId, amount: finalAmt, date: date, collectedBy: finalBy }); 
                } else { 
                    const txId = Utils.id(cat[0]);
                    
                    if (cat === 'FD Interest') {
                        const customMonth = document.getElementById('tx-custom-data').value;
                        const fdRecord = Data.fixedDeposits.find(f => f.id === refId);
                        
                        if(fdRecord) {
                            if(!fdRecord.interestHistory) fdRecord.interestHistory = [];
                            fdRecord.interestHistory.push({ month: customMonth, txId: txId, amount: amt, date: date });
                        }
                        
                        const tx = { id: txId, loanId: 'SAVINGS', memberName: mName, amount: finalAmt, date, category: cat, collectedBy: finalBy, operator: App.currentUser.name };
                        Data.transactions.unshift(tx);
                        await Data.post('payFDMonthlyInterest', { ...tx, txId: txId, id: refId, month: customMonth });
                    }
                    else {
                        const tx = { id: txId, loanId, memberName: mName, amount: finalAmt, date, category: cat, collectedBy: finalBy, operator: App.currentUser.name }; 
                        Data.transactions.unshift(tx); 
                        const isGeneralTx = loanId === 'SAVINGS' || cat === 'Expense' || loanId === 'CAPITAL' || cat === 'FD Interest' || cat === 'FD Withdrawal' || cat === 'Other Income';
                    await Data.post(isGeneralTx ? 'addSavingsTx' : 'addCollection', { ...tx, typeTx: cat }); 
                }
                
                if(cat !== 'Capital Injection' && cat !== 'Equity Withdraw') UI.openReceipt(Data.transactions[0]); 
                if (penalty > 0) {
                    let reason = 'Late Fee'; if (cat === 'Collection') reason = `Late Installment (${loanId})`; else if (refId) { if (refId.startsWith('GD')) reason = `DPS Shortfall (${refId})`; else if (refId.startsWith('G')) reason = `Group Deficit (${refId})`; }
                    
                    // FIX: Ensure Income Record links to specific ID (Group/DPS/Loan) instead of generic context
                    const specificRefId = (refId && refId !== '') ? refId : loanId;
                    
                    // Determine specific Source Type
                    let refinedSourceType = 'Loan';
                    if (specificRefId.startsWith('GD')) refinedSourceType = 'Group DPS';
                    else if (specificRefId.startsWith('G')) refinedSourceType = 'Group Loan';
                    else if (specificRefId === 'SAVINGS') refinedSourceType = 'Savings';

                    const penTx = { 
                        id: Utils.id('X'), 
                        loanId: specificRefId, // Use specific ID for cloud storage linkage
                        memberName: mName, 
                        amount: penalty, 
                        date: date, 
                        category: 'Penalty', 
                        collectedBy: `${reason} (${finalBy})`, 
                        reason: reason, 
                        sourceType: refinedSourceType, 
                        pureCollector: finalBy 
                    };
                    
                    Data.transactions.unshift(penTx); 
                    
                    // NEW: Update Local Income State immediately to avoid sync delay and prevent double counting logic issues
                    Data.income.unshift({
                        id: penTx.id,
                        date: penTx.date,
                        memberName: penTx.memberName,
                        refId: penTx.loanId,
                        amount: penTx.amount,
                        sourceType: penTx.sourceType,
                        reason: penTx.reason,
                        remarks: penTx.collectedBy,
                        operator: App.currentUser.name
                    });

                    await Data.post('addPenalty', { ...penTx, collectedBy: finalBy });
                }

                if (cat === 'Withdrawal') {
                    Utils.notifyAdmin('Withdrawal Processed', `${Utils.currency(amt)} by ${mName} (${App.currentUser.name})`);
                    }
                } 
                Logic.recalcBalances(); Data.transactions.sort((a,b) => (a.date < b.date) ? 1 : ((a.date > b.date) ? -1 : 0)); 
                if(App.activeRiskCheckId && !document.getElementById('modal-group-risk').classList.contains('hidden')) { if(App.activeRiskCheckId.type === 'group') App.checkGroupRisk(App.activeRiskCheckId.id); else if(App.activeRiskCheckId.type === 'dps') App.checkGroupDPSRisk(App.activeRiskCheckId.id); else if(App.activeRiskCheckId.type === 'summary_group') App.viewRiskSummary('group'); else if(App.activeRiskCheckId.type === 'summary_dps') App.viewRiskSummary('dps'); } 
                Utils.setLoading(btn, false); UI.closeModal('modal-transaction'); App.renderContent(); 
            },
            deleteEntity: (type, id) => { 
                if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied: Admins Only", "error"); 
                if (type === 'member') { const hasActiveLoan = Data.loans.some(l => l.memberId === id && l.status === 'Active' && l.paid < l.totalRepayable); const isInGroup = Data.groups.some(g => g.status === 'Active' && g.memberIDs.includes(id)); if (hasActiveLoan || isInGroup) return Utils.notify("Cannot delete: Active loans/group found", "error"); } 
                App.askConfirm("Delete this record permanently?", async () => { if(type === 'member') { Data.members = Data.members.filter(x => x.id !== id); await Data.post('deleteMember', {id}); } else if(type === 'loan') { Data.loans = Data.loans.filter(x => x.id !== id); Data.transactions = Data.transactions.filter(t => t.loanId !== id); await Data.post('deleteLoan', {id}); } else if(type === 'tx') { const t = Data.transactions.find(x => x.id === id); Data.transactions = Data.transactions.filter(x => x.id !== id); if(t) Logic.recalcBalances(); await Data.post('deleteTransaction', {id}); } if(App.activeTab === 'admin-dashboard') App.chartInstance = null; Utils.notify("Deleted"); App.renderContent(); }, true); 
            },
            resetData: () => { if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied", "error"); App.askConfirm("Factory Reset? All data will be lost.", () => { localStorage.clear(); location.reload(); }, true); },
            exportData: () => { const d = { members: Data.members, loans: Data.loans, transactions: Data.transactions, archived: Data.archivedLoans, groups: Data.groups, dps: Data.groupDPS, users: Data.users, inventory: Data.inventory, fixedDeposits: Data.fixedDeposits }; Utils.downloadJSON(d, `MicroFin_Backup_${Utils.dateToday()}.json`); },
            importData: () => { const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json'; input.onchange = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const d = JSON.parse(event.target.result); if (d.members) Data.members = d.members; if (d.loans) Data.loans = d.loans; if (d.transactions) Data.transactions = d.transactions; if (d.archived) Data.archivedLoans = d.archived; if (d.groups) Data.groups = d.groups; if (d.dps) Data.groupDPS = d.dps; if (d.users) Data.users = d.users; if (d.inventory) Data.inventory = d.inventory; if (d.fixedDeposits) Data.fixedDeposits = d.fixedDeposits; Logic.recalcBalances(); App.renderContent(); Utils.notify("Data Restored. Sync to cloud recommended.", "warning"); } catch (err) { Utils.notify("Invalid File", "error"); } }; reader.readAsText(file); }; input.click(); },
            initIdleTimer: () => { if(Data.autoLockMinutes > 0) { ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => document.addEventListener(evt, App.resetIdleTimer)); App.resetIdleTimer(); } },
            resetIdleTimer: () => { if(App.idleTimer) clearTimeout(App.idleTimer); if(Data.autoLockMinutes > 0 && !App.isLocked) App.idleTimer = setTimeout(App.lockApp, Data.autoLockMinutes * 60 * 1000); },

            init: async () => { 
                try {
                    const cached = localStorage.getItem('mf_cache_data');
                    if (cached) {
                        const d = JSON.parse(cached);
                        Data.members = d.members || [];
                        Data.loans = d.loans || [];
                        Data.transactions = d.transactions || [];
                        Data.archivedLoans = d.archivedLoans || [];
                        Data.groups = d.groups || [];
                        Data.groupDPS = d.groupDPS || [];
                        Data.users = d.users || [];
                        Data.inventory = d.inventory || [];
                        Data.fixedDeposits = d.fixedDeposits || [];
                        Data.income = d.income || []; // Load cached income
                    } else {
                        Data.members = []; Data.loans = []; Data.transactions = []; Data.archivedLoans = []; Data.groups = []; Data.groupDPS = []; Data.inventory = []; Data.fixedDeposits = []; Data.income = [];
                        try { Data.users = JSON.parse(localStorage.getItem('mf_users')) || []; } catch(e) { Data.users = []; }
                    }
                } catch(e) { console.warn("Main Cache load error", e); Data.members = []; Data.loans = []; }

                try { Data.notice = localStorage.getItem('mf_admin_notice') || ''; } catch(e) { Data.notice = ''; }
                
                try {
                    const rawConfig = JSON.parse(localStorage.getItem('mf_sys_config') || '{}');
                    Data.sysConfig = {
                        freeze: { ...Data.sysConfig.freeze, ...(rawConfig.freeze || {}) },
                        pause: { ...Data.sysConfig.pause, ...(rawConfig.pause || {}) }
                    };
                } catch(e) { console.warn("Config load error", e); }

                if (Data.users.length === 0) {
                    Data.users.push({ id: 'U-ADMIN', name: 'Demo Admin', role: 'Admin', pin: '1234', status: 'Active' });
                    localStorage.setItem('mf_users', JSON.stringify(Data.users));
                }
                
                Data.initQueue();
                Logic.recalcBalances(); 
                
                const lockScreen = document.getElementById('modal-lock-screen'), loadingDiv = document.getElementById('login-loading'), formDiv = document.getElementById('login-form-container'), hasUrl = !!Data.scriptUrl;
                lockScreen.classList.remove('hidden');
                if (hasUrl) {
                    loadingDiv.classList.remove('hidden'); formDiv.classList.add('hidden'); lucide.createIcons();
                    try { await Data.sync(true); } catch(e) { console.warn("Startup sync failed", e); Utils.notify("Offline: Using local data", "warning"); }
                    loadingDiv.classList.add('hidden'); formDiv.classList.remove('hidden');
                }
                App.lockApp(); App.resetSyncTimer(); App.updateLastSyncLabel(); setInterval(App.updateLastSyncLabel, 60000);
                window.addEventListener('online', () => { Utils.notify("Back Online: Syncing..."); Data.processQueue(); });

                document.addEventListener('keydown', (e) => {
                    if (e.key === '/' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
                        e.preventDefault();
                        const search = document.getElementById('search-input');
                        if(search) search.focus();
                    }
                    if (e.key === 'Escape') {
                        const openModals = document.querySelectorAll('[id^="modal-"]:not(.hidden)');
                        openModals.forEach(m => {
                            if (m.id !== 'modal-lock-screen') UI.closeModal(m.id);
                        });
                    }
                });
            },
            
            resetSyncTimer: () => { if (App.syncIntervalRef) clearInterval(App.syncIntervalRef); const mode = Data.syncMode; if (mode !== 'change' && mode !== '0') { const mins = parseInt(mode); if (!isNaN(mins) && mins > 0) App.syncIntervalRef = setInterval(() => Data.sync(true), mins * 60 * 1000); } },
            lockApp: () => {
                App.isLocked = true; document.getElementById('modal-lock-screen').classList.remove('hidden'); document.getElementById('lock-passcode').value = '';
                const select = document.getElementById('login-user-select'), formContainer = document.getElementById('login-form-container'), activeUsers = Data.users.filter(u => u.status === 'Active');
                if (activeUsers.length === 0) {
                    formContainer.innerHTML = `<div class="bg-red-500/10 border border-red-500/50 rounded-lg p-4 text-center animate-pulse"><i data-lucide="alert-octagon" class="w-8 h-8 text-red-400 mx-auto mb-2"><h3 class="text-red-400 font-bold text-lg">System Locked</h3><p class="text-slate-400 text-xs mt-1">No user data found in the database.</p></div><button onclick="location.reload()" class="mt-4 w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded text-sm font-bold flex justify-center items-center gap-2"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Retry Connection</button>`; lucide.createIcons();
                } else {
                    formContainer.innerHTML = `<p class="text-slate-300 text-sm mb-6">Select your profile to login.</p><form onsubmit="App.unlockApp(event)" class="space-y-4"><div class="relative"><select id="login-user-select" class="w-full bg-slate-800/80 border border-slate-600 rounded-lg px-4 py-3 text-white appearance-none focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 cursor-pointer text-sm font-medium">${'<option value="" disabled selected>Select User</option>' + activeUsers.map(u => `<option value="${u.id}">${u.name} (${u.role})</option>`).join('')}</select><i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i></div><input type="password" id="lock-passcode" class="w-full bg-slate-800/80 border border-slate-600 rounded-lg px-4 py-3 text-center text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all tracking-widest font-mono" placeholder="Enter PIN" autocomplete="off" inputmode="numeric"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-blue-900/50 transition-all transform hover:scale-[1.02] active:scale-95 flex justify-center items-center gap-2"><span>Login</span> <i data-lucide="arrow-right" class="w-4 h-4"></i></button></form>`; lucide.createIcons();
                }
            },
            unlockApp: (e) => { e.preventDefault(); const userId = document.getElementById('login-user-select').value; const pin = document.getElementById('lock-passcode').value; if(!userId) return Utils.notify("Select a user", "error"); const user = Data.users.find(u => u.id === userId); if (user && user.pin === pin) { App.currentUser = user; App.isLocked = false; document.getElementById('modal-lock-screen').classList.add('hidden'); document.getElementById('user-avatar').innerText = user.name.substring(0,2).toUpperCase(); document.getElementById('user-name').innerText = user.name; document.getElementById('user-role').innerText = user.role; App.renderNav(); App.renderContent(); App.initIdleTimer(); Utils.notify(`Welcome, ${user.name}`); } else { Utils.notify("Incorrect PIN", "error"); document.getElementById('lock-passcode').classList.add('animate-shake'); setTimeout(()=>document.getElementById('lock-passcode').classList.remove('animate-shake'), 300); } },
            logout: () => { App.currentUser = null; App.lockApp(); },
            handleUserAdd: async (e) => { e.preventDefault(); const btn = document.getElementById('btn-save-user'); Utils.setLoading(btn, true); const fd = new FormData(e.target); const newUser = { id: Utils.id('U'), name: fd.get('name'), role: fd.get('role'), pin: fd.get('pin'), status: 'Active' }; Data.users.push(newUser); localStorage.setItem('mf_users', JSON.stringify(Data.users)); await Data.post('addUser', newUser); Utils.setLoading(btn, false); UI.closeModal('modal-user-management'); Utils.notify("User Added Successfully"); App.renderContent(); },
            deleteUser: (id) => { if(id === App.currentUser.id) return Utils.notify("Cannot delete yourself", "error"); App.askConfirm("Delete this user?", async () => { Data.users = Data.users.filter(u => u.id !== id); localStorage.setItem('mf_users', JSON.stringify(Data.users)); await Data.post('deleteUser', {id}); Utils.notify("User Deleted"); App.renderContent(); }, true); },
            
            runIntegrityCheck: () => {
                Utils.notify("Checking Data Integrity...", "warning");
                setTimeout(() => {
                    Logic.recalcBalances();
                    App.renderContent();
                    Utils.notify("Integrity Check Complete: Balances Recalculated");
                }, 500);
            },
            
            quickConsolidate: (id, name) => {
                if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied: Admins Only", "error");
                App.openConsolidateModal();
                setTimeout(() => {
                    document.getElementById('cons-member-search').value = name;
                    document.getElementById('cons-member-id').value = id;
                    App.updateConsolidatePreview(id);
                }, 50);
            },

            openConsolidateModal: () => { if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied: Admins Only", "error"); document.getElementById('form-consolidate').reset(); document.getElementById('cons-preview').classList.add('hidden'); document.getElementById('cons-member-dropdown').classList.add('hidden'); document.getElementById('btn-exec-consolidate').disabled = true; App.tempConsolidateData = null; UI.openModal('modal-consolidate-savings'); },
            filterConsolidateMembers: (val) => { const list = document.getElementById('cons-member-dropdown'); list.classList.remove('hidden'); list.innerHTML = Data.members.filter(m => m.name.toLowerCase().includes(val.toLowerCase()) || m.id.toLowerCase().includes(val.toLowerCase())).slice(0, 10).map(m => `<div onclick="App.selectConsolidateMember('${m.id}', '${m.name}')" class="p-2 hover:bg-indigo-50 cursor-pointer border-b text-sm"><div class="font-bold text-slate-700">${m.name}</div><div class="text-[10px] text-slate-500 font-mono">${m.id}</div></div>`).join(''); },
            selectConsolidateMember: (id, name) => { document.getElementById('cons-member-search').value = name; document.getElementById('cons-member-id').value = id; document.getElementById('cons-member-dropdown').classList.add('hidden'); App.updateConsolidatePreview(id); },
            updateConsolidatePreview: (memberId) => { const m = Data.members.find(x => x.id === memberId); if(!m) return; const txs = Data.transactions.filter(t => t.memberName === m.name && t.loanId === 'SAVINGS'), totalIn = txs.filter(t => t.amount > 0).reduce((s,t) => s + t.amount, 0), totalOut = Math.abs(txs.filter(t => t.amount < 0).reduce((s,t) => s + t.amount, 0)); document.getElementById('cons-count').innerText = txs.length; document.getElementById('cons-balance').innerText = Utils.currency(totalIn - totalOut); document.getElementById('cons-balance-val').value = totalIn - totalOut; document.getElementById('cons-in').innerText = Utils.currency(totalIn); document.getElementById('cons-out').innerText = Utils.currency(totalOut); document.getElementById('cons-preview').classList.remove('hidden'); const btn = document.getElementById('btn-exec-consolidate'); if(txs.length > 1) { btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); App.tempConsolidateData = { member: m, transactions: txs, balance: totalIn - totalOut }; } else { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); Utils.notify(txs.length === 1 ? "Already consolidated." : "No transactions.", "warning"); } },
            handleConsolidateSubmit: async (e) => { 
                e.preventDefault(); 
                const passcode = document.getElementById('cons-passcode').value; 
                if(passcode !== App.currentUser.pin) return Utils.notify("Wrong Passcode", "error"); 
                if(!App.tempConsolidateData) return; 
                const btn = document.getElementById('btn-exec-consolidate'); 
                Utils.setLoading(btn, true, 'Processing...'); 
                
                const { member, transactions, balance } = App.tempConsolidateData, newTxId = Utils.id('C'), date = Utils.dateToday(); 
                const operatorName = App.currentUser ? App.currentUser.name : 'System';
                const operatorFull = App.currentUser ? `${App.currentUser.name} (${App.currentUser.id})` : 'System';

                const container = document.getElementById('pdf-generator-container'); 
                container.innerHTML = `<div class="p-6 bg-white text-slate-900 font-sans"><h1 class="text-2xl font-bold border-b pb-2 mb-4">Savings Consolidation</h1><div class="grid grid-cols-2 gap-4 text-xs mb-6 bg-slate-50 p-4 rounded border"><div>Member: <b>${member.name}</b></div><div>Date: <b>${new Date().toLocaleString()}</b></div><div>Archived: <b>${transactions.length}</b></div><div class="text-blue-700">Net Bal: <b>${Utils.currency(balance)}</b></div></div><h3 class="font-bold text-xs mb-2 text-slate-500 uppercase">Archived History</h3><table class="w-full text-xs border border-slate-300"><thead class="bg-slate-100"><tr><th class="border p-2">Date</th><th class="border p-2">Type</th><th class="border p-2 text-right">Amount</th></tr></thead><tbody>${transactions.map(t => `<tr><td class="border p-2">${t.date}</td><td class="border p-2">${t.category}</td><td class="border p-2 text-right font-mono font-bold ${t.amount < 0 ? 'text-red-600' : 'text-green-600'}">${Utils.currency(Math.abs(t.amount))}</td></tr>`).join('')}</tbody></table><div class="mt-8 text-[10px] text-center">MicroFin Data Protection</div></div>`; 
                lucide.createIcons({ root: container }); 
                await new Promise(r => setTimeout(r, 500)); 
                
                try { 
                    const opt = { margin: 10, filename: `Savings_${member.name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } }; 
                    const pdfBlob = await html2pdf().set(opt).from(container).outputPdf('datauristring'); 
                    
                    const newTx = { id: newTxId, loanId: 'SAVINGS', memberName: member.name, amount: balance, date: date, category: 'Balance Forward', collectedBy: 'System', operator: operatorName }; 
                    
                    const payload = { type: 'consolidateSavings', idsToRemove: transactions.map(t=>t.id), newTx: newTx, pdf: pdfBlob.split(',')[1], name: `Savings_Consol_${member.name}`, folderName: `${member.id}_${member.name}`, operator: operatorFull }; 
                    
                    try { 
                        const res = await fetch(Data.scriptUrl, { method: 'POST', body: JSON.stringify(payload) }); 
                        const result = await res.json(); 
                        if(result.link) newTx.collectedBy += '|' + result.link; 
                    } catch(err) { 
                        Data.queueRequest(payload); 
                    } 
                    
                    Data.transactions = Data.transactions.filter(t => !payload.idsToRemove.includes(t.id)); 
                    Data.transactions.unshift(newTx); 
                    Logic.recalcBalances(); 
                    Utils.notify("Consolidated Successfully"); 
                    UI.closeModal('modal-consolidate-savings'); 
                    App.renderContent(); 
                } catch(err) { 
                    console.error(err); 
                    Utils.notify("Failed", "error"); 
                } finally { 
                    Utils.setLoading(btn, false); 
                } 
            },
            askConfirm: (msg, cb, isSecure = false, manualClose = false) => { document.getElementById('confirm-msg').innerText = msg; document.getElementById('confirm-input-pass').classList.toggle('hidden', !isSecure); document.getElementById('confirm-input-pass').value = ''; App.confirmIsSecure = isSecure; App.confirmCallback = cb; App.confirmManualClose = manualClose; UI.openModal('modal-confirm'); },
            executeConfirm: () => { if(App.confirmIsSecure) { const pass = document.getElementById('confirm-input-pass').value; if(pass !== App.currentUser.pin) return Utils.notify("Wrong Passcode. Use your login PIN.", "error"); } if(App.confirmCallback) App.confirmCallback(); if (!App.confirmManualClose) { UI.closeModal('modal-confirm'); } },
            viewPassbook: (id) => { 
                const m = Data.members.find(x => x.id === id); 
                if(!m) return; 
                App.activeHistoryContext = { type: 'member', name: m.name, id: m.id }; 
                document.getElementById('pb-name').innerHTML = `Transactions: <span class="font-normal">${m.name}</span> <span class="text-sm font-normal text-slate-500">(${m.id})</span>`; 
                document.getElementById('pb-stats-member').innerHTML = ''; 
                document.getElementById('pb-stats-member').classList.add('hidden'); 
                document.getElementById('pb-stats-loan').classList.add('hidden'); 
                document.getElementById('pb-filter-type').value = 'All'; 
                UI.renderHistoryTable('All'); 
                UI.openModal('modal-passbook'); 
            },
            viewLoanHistory: (id) => { const l = Data.loans.find(x => x.id === id) || Data.archivedLoans.find(x => x.id === id); if(!l) return; App.activeHistoryContext = { type: 'loan', name: l.memberName, id: l.id }; document.getElementById('pb-name').innerText = `Loan: ${l.id} - ${l.memberName}`; const paid = l.paid || 0; const total = l.totalRepayable; document.getElementById('pb-stats-loan').innerHTML = `<div class="bg-blue-50 p-3 rounded border border-blue-200 flex justify-between items-center"><div><p class="text-[10px] text-blue-600 font-bold uppercase">Progress</p><p class="font-bold text-lg">${Utils.currency(paid)} / ${Utils.currency(total)}</p></div><div class="text-xl font-bold text-blue-700">${Math.round((paid/total)*100)}%</div></div>`; document.getElementById('pb-stats-member').classList.add('hidden'); document.getElementById('pb-stats-loan').classList.remove('hidden'); document.getElementById('pb-filter-type').value = 'All'; UI.renderHistoryTable('All'); UI.openModal('modal-passbook'); },
            viewSchedule: (id) => { const l = Data.loans.find(x => x.id === id); if(!l) return; const disTx = Data.transactions.find(t => t.loanId === l.id && t.category === 'Disbursement'); if(!disTx) return Utils.notify("Disbursement record missing", "error"); const startDate = Utils.parseDate(disTx.date), emi = Math.ceil(l.totalRepayable / (l.duration || 1)); let html = `<div class="mb-4 bg-slate-50 p-3 rounded border"><h4 class="font-bold text-slate-800">${l.memberName} ${UI.getFlagIcon(Data.members.find(m=>m.id===l.memberId)?.flag)}</h4><div class="text-xs text-slate-500 flex gap-4 mt-1"><span>Principal: ${Utils.currency(l.principal)}</span><span>Total: ${Utils.currency(l.totalRepayable)}</span><span>Paid: ${Utils.currency(l.paid)}</span></div></div><table class="w-full text-sm text-left"><thead class="bg-slate-100 font-bold text-xs uppercase text-slate-600"><tr><th class="p-2">#</th><th class="p-2">Due Date</th><th class="p-2 text-right">Amount</th><th class="p-2 text-right">Status</th></tr></thead><tbody class="divide-y divide-slate-100">`; let balance = l.paid, currentDate = new Date(startDate); for(let i=1; i<=l.duration; i++) { if (l.loanType === 'Daily') currentDate.setDate(currentDate.getDate() + 1); else if (l.loanType === 'Weekly') currentDate.setDate(currentDate.getDate() + 7); else if (l.loanType === 'Monthly') currentDate.setMonth(currentDate.getMonth() + 1); const isPaid = balance >= emi, status = isPaid ? '<span class="text-green-600 font-bold">Paid</span>' : (currentDate < new Date() ? '<span class="text-red-500 font-bold">Overdue</span>' : '<span class="text-slate-400">Pending</span>'); balance -= emi; html += `<tr><td class="p-2 text-slate-500 font-mono text-xs">${i}</td><td class="p-2">${currentDate.toLocaleDateString()}</td><td class="p-2 text-right font-mono">${Utils.currency(emi)}</td><td class="p-2 text-right text-xs">${status}</td></tr>`; if(i > 200) break; } document.getElementById('schedule-content').innerHTML = html + `</tbody></table>`; UI.openModal('modal-schedule'); },
            checkGroupRisk: (id) => { const g = Data.groups.find(x => x.id === id); if (!g) return; App.activeRiskCheckId = { type: 'group', id: id }; const startDate = Utils.parseDate(g.startDate), cyclesRun = g.history.length; let nextDue = new Date(startDate); if (g.frequency === 'Daily') nextDue.setDate(startDate.getDate() + cyclesRun); else if (g.frequency === 'Weekly') nextDue.setDate(startDate.getDate() + (cyclesRun * 7)); else if (g.frequency === 'Monthly') nextDue.setMonth(startDate.getMonth() + cyclesRun); const today = new Date(); today.setHours(0,0,0,0); nextDue.setHours(0,0,0,0); const daysRemaining = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24)); document.getElementById('gr-date').innerText = nextDue.toLocaleDateString(); const tag = document.getElementById('gr-days-tag'); if (daysRemaining < 0) { tag.innerText = `${Math.abs(daysRemaining)} Days Overdue`; tag.className = 'text-xs font-bold px-2 py-0.5 rounded-full bg-red-100 text-red-700'; } else if (daysRemaining === 0) { tag.innerText = 'Due Today'; tag.className = 'text-xs font-bold px-2 py-0.5 rounded-full bg-orange-100 text-orange-700'; } else { tag.innerText = `${daysRemaining} Days Left`; tag.className = 'text-xs font-bold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700'; } document.getElementById('gr-info').innerText = `${g.name} ‚Ä¢ Req: ${Utils.currency(g.contribution)}`; const riskyMembers = []; g.memberIDs.forEach(mid => { const m = Data.members.find(x => x.id === mid); if (m && m.savingsBalance < g.contribution) riskyMembers.push(m); }); document.getElementById('gr-count').innerText = riskyMembers.length; const list = document.getElementById('gr-list'), safeMsg = document.getElementById('gr-safe-msg'); if (riskyMembers.length === 0) { list.innerHTML = ''; safeMsg.classList.remove('hidden'); } else { safeMsg.classList.add('hidden'); list.innerHTML = riskyMembers.map(m => { const deficit = g.contribution - m.savingsBalance; return `<div class="flex justify-between items-center p-3 bg-white border border-red-100 rounded hover:bg-red-50 transition"><div><div class="font-bold text-slate-800 text-sm">${m.name} ${UI.getFlagIcon(m.flag)}</div><div class="text-[10px] text-slate-400 flex items-center gap-1 my-0.5"><i data-lucide="phone" class="w-3 h-3"></i> ${m.phone}</div><div class="text-xs text-slate-500">Bal: <span class="font-bold text-red-600">${Utils.currency(m.savingsBalance)}</span></div></div><div class="flex items-center gap-2"><span class="text-[10px] font-bold text-red-400">-${Utils.currency(deficit)}</span><button onclick="UI.openTransactionModal('${m.name.replace(/'/g, "\\'")}', 'Deposit', 'Deposit for ${m.name.replace(/'/g, "\\'")}', ${deficit}, null, ${g.penalty||0}, '${g.id}')" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 transition shadow-sm" title="Collect Deficit"><i data-lucide="plus" class="w-4 h-4"></i></button><button onclick="Utils.copyGroupReminder('${m.name.replace(/'/g, "\\'")}', '${g.name.replace(/'/g, "\\'")}', '${deficit}', '${nextDue.toLocaleDateString()}', '${m.savingsBalance}')" class="bg-slate-100 text-slate-500 p-2 rounded hover:bg-slate-200 transition"><i data-lucide="copy" class="w-4 h-4"></i></button><button onclick="Utils.sendSMS('${m.phone}', 'Hello ${m.name.replace(/'/g, "\\'")}, deposit ${Utils.currency(deficit)} for ${g.name.replace(/'/g, "\\'")}.')" class="bg-slate-800 text-white p-2 rounded hover:bg-slate-900 transition"><i data-lucide="message-square" class="w-4 h-4"></i></button></div></div>`; }).join(''); } UI.openModal('modal-group-risk'); lucide.createIcons(); },
            deleteGroup: (id) => { if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied: Admins Only", "error"); const g = Data.groups.find(x => x.id === id); if (g) App.askConfirm(`Permanently delete group "${g.name}"?`, async () => { const idx = Data.groups.findIndex(x => x.id === id); if (idx > -1) Data.groups.splice(idx, 1); await Data.post('deleteGroup', { id: id }); App.renderContent(); Utils.notify("Group deleted"); }, true); },
            calcGroupPot: () => { const count = document.querySelectorAll('#group-member-list input:checked').length; const perPerson = Number(document.querySelector('#form-group input[name="contribution"]').value) || 0; document.getElementById('group-selected-count').innerText = `${count} selected`; document.getElementById('group-pot-preview').innerText = Utils.currency(count * perPerson); },
            handleGroupSubmit: async (e) => { e.preventDefault(); const btn = document.getElementById('btn-save-group'); Utils.setLoading(btn, true); const fd = new FormData(e.target), memberIDs = Array.from(document.querySelectorAll('#group-member-list input:checked')).map(cb => cb.value), id = fd.get('id'); if (memberIDs.length < 2) { Utils.notify("Select at least 2 members", "error"); Utils.setLoading(btn, false); return; } const d = { name: fd.get('name'), memberIDs: JSON.stringify(memberIDs), contribution: Number(fd.get('contribution')), frequency: fd.get('frequency'), penalty: Number(fd.get('penalty'))||0 }; if (id) { const idx = Data.groups.findIndex(g => g.id === id); if (idx > -1) { Data.groups[idx] = { ...Data.groups[idx], ...d, memberIDs: memberIDs }; await Data.post('editGroup', { id: id, ...d }); } } else { d.id = Utils.id('G'); d.startDate = Utils.dateToday(); d.history = JSON.stringify([]); d.status = 'Active'; Data.groups.push({ ...d, memberIDs: memberIDs, history: [] }); await Data.post('addGroup', d); } Utils.setLoading(btn, false); UI.closeModal('modal-group'); App.renderContent(); },
            runGroupCycle: (groupId) => { 
                if (Data.sysConfig.pause.groupRun) return Utils.notify("Group Cycles are PAUSED globally.", "error");
                const g = Data.groups.find(x => x.id === groupId); if (!g) return; 
                const brokeMembers = g.memberIDs.map(mid => Data.members.find(m => m.id === mid)).filter(m => m && m.savingsBalance < g.contribution); 
                if (brokeMembers.length > 0) { const names = brokeMembers.map(m => m.name).join(', '); alert(`Cannot Run Cycle!\n\nThe following members have insufficient balance:\n${names}\n\nRequired: ${Utils.currency(g.contribution)}`); return Utils.notify("Cycle Blocked: Insufficient Funds", "error"); } 
                const winners = g.history.map(h => h.winnerId), candidates = g.memberIDs.filter(id => !winners.includes(id)), cycleNum = g.history.length + 1, totalPot = g.memberIDs.length * g.contribution; 
                if (candidates.length === 0) return Utils.notify("Cycle complete!", "warning"); 
                
                App.askConfirm(`Run Cycle #${cycleNum}?`, async () => { 
                    const btn = document.getElementById('btn-confirm-yes'); Utils.setLoading(btn, true, 'Generating PDF...'); await new Promise(r => setTimeout(r, 50)); 
                    const winnerId = candidates[Math.floor(Math.random() * candidates.length)], winner = Data.members.find(m => m.id === winnerId), date = Utils.dateToday(), batchTxs = []; 
                    g.memberIDs.forEach(mid => { const m = Data.members.find(x => x.id === mid); if (m) batchTxs.push({ id: Utils.id('W'), loanId: 'SAVINGS', memberName: m.name, amount: -g.contribution, date: date, category: 'Group Contrib.', collectedBy: g.name }); }); 
                    batchTxs.push({ id: Utils.id('P'), loanId: 'SAVINGS', memberName: winner.name, amount: totalPot, date: date, category: 'Group Payout', collectedBy: `Winner: Cycle #${cycleNum}` }); 
                    
                    const reportContainer = document.getElementById('group-cycle-report-container'); 
                    reportContainer.innerHTML = `<div class="p-8 bg-white text-slate-900 font-sans"><div class="border-b pb-4 mb-6 text-center"><h1 class="text-2xl font-bold uppercase tracking-widest text-slate-800">Cycle Winner Report</h1><p class="text-sm text-slate-500">${Data.receiptSignature}</p></div><div class="bg-indigo-50 border border-indigo-100 p-6 rounded-xl text-center mb-8"><p class="text-xs font-bold text-indigo-500 uppercase tracking-widest mb-2">WINNER DECLARED</p><h2 class="text-3xl font-bold text-slate-800 mb-1">${winner.name} ${UI.getFlagIcon(winner.flag)}</h2><p class="font-mono text-slate-500 text-sm mb-4">ID: ${winner.id}</p><div class="inline-block bg-white px-4 py-2 rounded-lg border border-indigo-200 shadow-sm"><span class="text-xs text-slate-400 uppercase font-bold mr-2">Prize Pot</span><span class="text-xl font-bold text-indigo-700">${Utils.currency(totalPot)}</span></div></div><div class="grid grid-cols-2 gap-4 text-xs mb-6 bg-slate-50 p-4 rounded border"><div>Group: <b>${g.name}</b></div><div>Cycle: <b>#${cycleNum}</b></div><div>Date: <b>${date}</b></div><div>Contrib: <b>${Utils.currency(g.contribution)} / person</b></div></div><h3 class="font-bold text-xs mb-2 text-slate-500 uppercase border-b pb-1">Contributors</h3><div class="grid grid-cols-2 gap-2 text-xs">${g.memberIDs.map(mid => { const m = Data.members.find(x=>x.id===mid); return `<div class="flex justify-between p-2 bg-slate-50 rounded border border-slate-100"><span>${m?m.name:mid}</span><span class="font-bold text-green-600">PAID</span></div>`; }).join('')}</div><div class="mt-8 text-[10px] text-center text-slate-400">Generated by MicroFin Manager</div></div>`; 
                    lucide.createIcons({ root: reportContainer }); await new Promise(r => setTimeout(r, 100)); 
                    let pdfBase64 = null; try { const opt = { margin: 0.5, filename: `GroupLoan_${g.name}_Cycle${cycleNum}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter' } }; const pdfBlob = await html2pdf().set(opt).from(reportContainer).outputPdf('datauristring'); pdfBase64 = pdfBlob.split(',')[1]; } catch(e) {} 
                    
                    Utils.setLoading(btn, true, 'Syncing...'); 
                    batchTxs.forEach(tx => Data.transactions.unshift(tx)); 
                    const payload = { type: 'runGroupLoanCycle', id: g.id, groupName: g.name, cycleNo: cycleNum, winnerId: winner.id, winnerName: winner.name, potAmount: totalPot, date: date, txs: batchTxs, pdf: pdfBase64, folderName: g.name, fileName: `${g.name.replace(/\s/g,'_')}_Cycle${cycleNum}_${date}` }; 
                    const res = await fetch(Data.scriptUrl, { method: 'POST', body: JSON.stringify({...payload, operator: App.currentUser.name}) }); 
                    const resData = await res.json(); 
                    
                    g.history.push({ cycle: cycleNum, date: date, winnerId: winnerId, winnerName: winner.name, amount: totalPot, link: resData.link || '' }); 
                    if (g.history.length === g.memberIDs.length) g.status = 'Completed'; 
                    Logic.recalcBalances(); 
                    Utils.notifyAdmin('Group Cycle Run', `${g.name} #${cycleNum} won by ${winner.name} (${Utils.currency(totalPot)})`);
                    
                    Utils.setLoading(btn, false); 
                    UI.closeModal('modal-confirm'); 
                    App.renderContent(); 
                    
                    setTimeout(() => {
                        const formattedCycle = String(cycleNum).padStart(2, '0');
                        const smsText = `Congratulations!\nYou (${winner.id}) are the winner of group loan "${g.name}" Cycle #${formattedCycle}.\nAmount: ${Utils.currency(totalPot)}\n\nRegards,\n${Data.receiptSignature}`;
                        App.askConfirm(`Cycle Complete! Winner: ${winner.name}\n\nSend SMS notification?`, () => Utils.sendSMS(winner.phone, smsText));
                    }, 500);

                }, true, true); },
            viewGroupLoanHistory: (id) => { const g = Data.groups.find(x => x.id === id); if(!g) return; document.getElementById('dps-history-title').innerText = `${g.name} - Cycle History`; const list = document.getElementById('dps-history-list'); const history = g.history || []; if (history.length === 0) { list.innerHTML = `<div class="text-center text-slate-400 p-8 italic">No cycles run yet.</div>`; } else { list.innerHTML = history.slice().reverse().map(h => `<div class="flex justify-between items-center p-3 bg-slate-50 border border-slate-200 rounded mb-2 hover:bg-white hover:shadow-sm transition"><div><div class="font-bold text-slate-800 text-sm">Cycle #${h.cycle || '?'}</div><div class="text-xs text-slate-500">${h.date} ‚Ä¢ Winner: <b>${h.winnerName}</b></div></div><div class="flex items-center gap-3"><span class="font-bold text-indigo-700 text-sm">${Utils.currency(h.amount)}</span>${h.link ? `<a href="${h.link}" target="_blank" class="bg-blue-100 text-blue-700 p-1.5 rounded hover:bg-blue-200 transition" title="View Report"><i data-lucide="file-text" class="w-4 h-4"></i></a>` : '<span class="text-slate-300 text-xs italic">No Link</span>'}</div></div>`).join(''); } lucide.createIcons(); UI.openModal('modal-dps-history'); },
            openGroupDPSModal: (dps = null) => { 
                if (Data.sysConfig.freeze.dps) return Utils.notify("New Group DPS creation is FROZEN globally.", "error");
                if(dps && App.currentUser.role === 'Staff') return Utils.notify("Access Denied", "error"); const form = document.getElementById('form-group-dps'); form.reset(); document.getElementById('dps-member-search').value = ''; document.getElementById('dps-id').value = dps ? dps.id : ''; document.getElementById('dps-modal-title').innerText = dps ? 'Edit DPS Group' : 'Create Group DPS'; document.getElementById('btn-save-dps').innerText = dps ? 'Update Group' : 'Save DPS Group'; const list = document.getElementById('dps-member-list'), members = Data.members.filter(m => m.status === 'Active'); if(dps) { form.querySelector('input[name="name"]').value = dps.name; form.querySelector('select[name="frequency"]').value = dps.frequency; form.querySelector('input[name="contribution"]').value = dps.contribution; form.querySelector('input[name="duration"]').value = dps.duration; form.querySelector('input[name="startDate"]').value = dps.startDate; form.querySelector('input[name="penalty"]').value = dps.penalty || ''; } else form.querySelector('input[name="startDate"]').value = Utils.dateToday(); list.innerHTML = members.map(m => { const isChecked = dps && dps.memberIDs.includes(m.id); return `<label class="flex items-center gap-3 p-2 hover:bg-slate-50 cursor-pointer border-b last:border-0 border-slate-100 transition-colors"><input type="checkbox" name="members" value="${m.id}" ${isChecked ? 'checked' : ''} onchange="App.calcDPSPot()" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300"><div><div class="text-sm font-bold text-slate-700 leading-tight">${m.name} ${UI.getFlagIcon(m.flag)}</div><div class="text-[10px] text-slate-400 font-mono">${m.id}</div></div></label>`; }).join(''); App.calcDPSPot(); UI.openModal('modal-group-dps'); },
            calcDPSPot: () => { const count = document.querySelectorAll('#dps-member-list input:checked').length; const perPerson = Number(document.querySelector('#form-group-dps input[name="contribution"]').value) || 0; document.getElementById('dps-selected-count').innerText = `${count} selected`; document.getElementById('dps-pot-preview').innerText = Utils.currency(count * perPerson); },
            filterDPSMembers: (val) => { const term = val.toLowerCase(); document.querySelectorAll('#dps-member-list label').forEach(lbl => { lbl.classList.toggle('hidden', !lbl.innerText.toLowerCase().includes(term)); lbl.classList.toggle('flex', lbl.innerText.toLowerCase().includes(term)); }); },
            handleGroupDPSSubmit: async (e) => { e.preventDefault(); const btn = document.getElementById('btn-save-dps'); Utils.setLoading(btn, true); const fd = new FormData(e.target), memberIDs = Array.from(document.querySelectorAll('#dps-member-list input:checked')).map(cb => cb.value); if (memberIDs.length < 1) { Utils.notify("Select at least 1 member", "error"); Utils.setLoading(btn, false); return; } const d = { id: fd.get('id') || `GD-${Math.floor(1000+Math.random()*9000)}`, name: fd.get('name'), memberIDs: JSON.stringify(memberIDs), contribution: Number(fd.get('contribution')), frequency: fd.get('frequency'), startDate: fd.get('startDate'), duration: Number(fd.get('duration')), status: 'Active', penalty: Number(fd.get('penalty'))||0 }; const existingIdx = Data.groupDPS.findIndex(g => g.id === d.id); const dpsObj = { ...d, memberIDs: memberIDs }; if(existingIdx > -1) Data.groupDPS[existingIdx] = dpsObj; else Data.groupDPS.push(dpsObj); await Data.post(existingIdx > -1 ? 'editGroupDPS' : 'addGroupDPS', d); Utils.setLoading(btn, false); UI.closeModal('modal-group-dps'); Utils.notify("Group DPS Saved!"); App.renderContent(); },
            deleteGroupDPS: (id) => { if(App.currentUser.role !== 'Admin') return Utils.notify("Access Denied: Admins Only", "error"); App.askConfirm("Delete this DPS Group?", async () => { Data.groupDPS = Data.groupDPS.filter(g => g.id !== id); await Data.post('deleteGroupDPS', { id }); App.renderContent(); Utils.notify("Deleted"); }, true); },
            checkGroupDPSRisk: (id) => { const g = Data.groupDPS.find(x => x.id === id); if (!g) return; App.activeRiskCheckId = { type: 'dps', id: id }; const startDate = Utils.parseDate(g.startDate), today = new Date(); today.setHours(0,0,0,0); let nextDue = new Date(startDate); if (g.frequency === 'Monthly') { nextDue.setFullYear(today.getFullYear(), today.getMonth(), startDate.getDate()); if (nextDue < today) nextDue.setMonth(nextDue.getMonth() + 1); } else if (g.frequency === 'Weekly') { const diff = startDate.getDay() - today.getDay(); nextDue = new Date(today); nextDue.setDate(today.getDate() + (diff < 0 ? diff + 7 : diff)); } else nextDue = new Date(today); const daysRemaining = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24)); document.getElementById('gr-date').innerText = nextDue.toLocaleDateString(); const tag = document.getElementById('gr-days-tag'); if (daysRemaining === 0) { tag.innerText = 'Due Today'; tag.className = 'text-xs font-bold px-2 py-0.5 rounded-full bg-orange-100 text-orange-700'; } else { tag.innerText = `${daysRemaining} Days Left`; tag.className = 'text-xs font-bold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700'; } document.getElementById('gr-info').innerText = `${g.name} ‚Ä¢ DPS: ${Utils.currency(g.contribution)}`; const riskyMembers = []; g.memberIDs.forEach(mid => { const m = Data.members.find(x => x.id === mid); if (m && m.savingsBalance < g.contribution) riskyMembers.push(m); }); document.getElementById('gr-count').innerText = riskyMembers.length; const list = document.getElementById('gr-list'), safeMsg = document.getElementById('gr-safe-msg'); if (riskyMembers.length === 0) { list.innerHTML = ''; safeMsg.classList.remove('hidden'); } else { safeMsg.classList.add('hidden'); list.innerHTML = riskyMembers.map(m => { const deficit = g.contribution - m.savingsBalance; return `<div class="flex justify-between items-center p-3 bg-white border border-red-100 rounded hover:bg-red-50 transition"><div><div class="font-bold text-slate-800 text-sm">${m.name} ${UI.getFlagIcon(m.flag)}</div><div class="text-[10px] text-slate-400 flex items-center gap-1 my-0.5"><i data-lucide="phone" class="w-3 h-3"></i> ${m.phone}</div><div class="text-xs text-slate-500">Bal: <span class="font-bold text-red-600">${Utils.currency(m.savingsBalance)}</span></div></div><div class="flex items-center gap-2"><span class="text-[10px] font-bold text-red-400">-${Utils.currency(deficit)}</span><button onclick="UI.openTransactionModal('${m.name.replace(/'/g, "\\'")}', 'Deposit', 'Deposit for ${m.name.replace(/'/g, "\\'")}', ${deficit}, null, ${g.penalty||0}, '${g.id}')" class="bg-green-600 text-white p-2 rounded hover:bg-green-700 transition shadow-sm" title="Collect Deficit"><i data-lucide="plus" class="w-4 h-4"></i></button><button onclick="Utils.copyGroupReminder('${m.name.replace(/'/g, "\\'")}', '${g.name.replace(/'/g, "\\'")}', '${deficit}', '${nextDue.toLocaleDateString()}', '${m.savingsBalance}')" class="bg-slate-100 text-slate-500 p-2 rounded hover:bg-slate-200 transition"><i data-lucide="copy" class="w-4 h-4"></i></button><button onclick="Utils.sendSMS('${m.phone}', 'Hello ${m.name.replace(/'/g, "\\'")}, deposit ${Utils.currency(deficit)} for ${g.name.replace(/'/g, "\\'")}.')" class="bg-slate-800 text-white p-2 rounded hover:bg-slate-900 transition"><i data-lucide="message-square" class="w-4 h-4"></i></button></div></div>`; }).join(''); } UI.openModal('modal-group-risk'); lucide.createIcons(); },
            runDPSBatch: (dpsId) => { 
                if (Data.sysConfig.pause.dpsRun) return Utils.notify("DPS Batches are PAUSED globally.", "error");
                const dps = Data.groupDPS.find(g => g.id === dpsId); if (!dps) return; const brokeMembers = dps.memberIDs.map(mid => Data.members.find(m => m.id === mid)).filter(m => m && m.savingsBalance < dps.contribution); if (brokeMembers.length > 0) { const names = brokeMembers.map(m => m.name).join(', '); alert(`Cannot Run Batch!\n\nThe following members have insufficient balance:\n${names}\n\nRequired: ${Utils.currency(dps.contribution)}`); return Utils.notify("Batch Blocked: Insufficient Funds", "error"); } App.askConfirm(`Run Auto-Collection for ${dps.frequency}?`, async () => { const btn = document.getElementById('btn-confirm-yes'); Utils.setLoading(btn, true, 'Processing...'); await new Promise(r => setTimeout(r, 100)); const batchTxs = [], failed = [], date = Utils.dateToday(), history = dps.history || []; const batchSerial = history.length + 1, batchMembers = []; let batchTotal = 0; const previousTotal = Logic.getDPSTotalCollected(dps.id); dps.memberIDs.forEach(mid => { const m = Data.members.find(x => x.id === mid); if (!m) return; if (m.savingsBalance < dps.contribution) { failed.push(`${m.name}: Low Balance`); batchMembers.push({name: m.name, id: m.id, status: 'Failed', amount: 0, refs: '-'}); } else { const wId = Utils.id('W'); batchTxs.push({ id: wId, loanId: 'SAVINGS', memberName: m.name, amount: -dps.contribution, date: date, category: 'DPS Installment', collectedBy: `DPS: ${dps.name} (${dps.id}) - Batch #${batchSerial}` }); batchMembers.push({name: m.name, id: m.id, status: 'Paid', amount: dps.contribution, refs: `${wId}`}); batchTotal += dps.contribution; } }); const grandTotal = previousTotal + batchTotal; const reportContainer = document.getElementById('dps-report-container'); reportContainer.innerHTML = `<div class="p-8 bg-white text-slate-900 font-sans"><div class="border-b pb-4 mb-4 text-center"><h1 class="text-xl font-bold uppercase">DPS Collection Report</h1><p class="text-sm text-slate-500">${Data.receiptSignature}</p></div><div class="grid grid-cols-2 gap-4 text-xs mb-6 bg-slate-50 p-4 rounded border"><div>Group: <b>${dps.name}</b> <span class="font-mono text-[10px] text-slate-500">(${dps.id})</span></div><div>Batch No: <b>#${batchSerial}</b></div><div>Date: <b>${date}</b></div><div>Current Batch: <b class="text-slate-700">${Utils.currency(batchTotal)}</b></div><div class="col-span-2 border-t pt-2 mt-1">Total DPS Fund (Cumulative): <b class="text-blue-700 text-sm">${Utils.currency(grandTotal)}</b></div></div><table class="w-full text-xs border-collapse text-left border border-slate-200"><thead class="bg-slate-100 uppercase"><tr><th class="border p-2">Member</th><th class="border p-2 text-center">Status / Ref</th><th class="border p-2 text-right">Amount</th></tr></thead><tbody>${batchMembers.map(bm => `<tr><td class="border p-2"><div class="font-medium text-slate-800">${bm.name}</div><div class="text-[9px] text-slate-500 font-mono">${bm.id}</div></td><td class="border p-2 text-center"><div class="${bm.status==='Paid'?'text-green-600 font-bold':'text-red-500'}">${bm.status}</div>${bm.status==='Paid' ? `<div class="text-[9px] text-slate-400 font-mono mt-0.5">(${bm.refs})</div>` : ''}</td><td class="border p-2 text-right font-mono">${Utils.currency(bm.amount)}</td></tr>`).join('')}</tbody></table><div class="mt-8 pt-4 border-t border-dashed flex justify-between text-[10px] text-slate-400"><span>Generated: ${new Date().toLocaleString()}</span><span>Operator: ${App.currentUser.name}</span></div></div>`; let pdfBase64 = null; try { const opt = { margin: 0.5, filename: `DPS_${dps.name}_Batch${batchSerial}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter' } }; const pdfBlob = await html2pdf().set(opt).from(reportContainer).outputPdf('datauristring'); pdfBase64 = pdfBlob.split(',')[1]; } catch(e) {} if (batchTxs.length > 0) { batchTxs.forEach(tx => Data.transactions.unshift(tx)); 
                const summaryTx = { id: Utils.id('G'), loanId: dps.id, memberName: 'Batch Collection', amount: batchTotal, date: date, category: 'Group DPS Contrib.', collectedBy: 'System', operator: App.currentUser.name }; Data.transactions.unshift(summaryTx); Logic.recalcBalances(); const payload = { type: 'updateGroupDPSCollection', id: dps.id, serial: batchSerial, date: date, batchAmount: batchTotal, pdf: pdfBase64, folderName: dps.name, fileName: `${dps.name.replace(/\s/g,'_')}_${batchSerial}_${date}`, txs: batchTxs }; const res = await fetch(Data.scriptUrl, { method: 'POST', body: JSON.stringify({...payload, operator: App.currentUser.name}) }); const resData = await res.json(); if(!dps.history) dps.history = []; dps.history.push({ serial: batchSerial, date: date, amount: batchTotal, link: resData.link || '' }); } 
                Utils.notifyAdmin('DPS Batch Run', `${dps.name} Batch #${batchSerial} (${Utils.currency(batchTotal)})`);
                
                Utils.setLoading(btn, false); UI.closeModal('modal-confirm'); document.getElementById('dps-result-msg').innerText = `Processed ${batchTxs.length} members. Total: ${Utils.currency(batchTotal)}`; const failList = document.getElementById('dps-fail-list'); if(failed.length > 0) { failList.innerHTML = failed.map(f => `<div>‚Ä¢ ${f}</div>`).join(''); failList.classList.remove('hidden'); } else failList.classList.add('hidden'); UI.openModal('modal-dps-result'); App.renderContent(); }, true, true); },
            viewGroupDPSHistory: (id) => { const dps = Data.groupDPS.find(g => g.id === id); if(!dps) return; document.getElementById('dps-history-title').innerText = `${dps.name} - History`; const list = document.getElementById('dps-history-list'); const history = dps.history || []; if (history.length === 0) { list.innerHTML = `<div class="text-center text-slate-400 p-8 italic">No collections run yet.</div>`; } else { list.innerHTML = history.slice().reverse().map(h => `<div class="flex justify-between items-center p-3 bg-slate-50 border border-slate-200 rounded mb-2 hover:bg-white hover:shadow-sm transition"><div><div class="font-bold text-slate-800 text-sm">Batch #${h.serial}</div><div class="text-xs text-slate-500">${h.date}</div></div><div class="flex items-center gap-3"><span class="font-bold text-indigo-700 text-sm">${Utils.currency(h.amount)}</span>${h.link ? `<a href="${h.link}" target="_blank" class="bg-blue-100 text-blue-700 p-1.5 rounded hover:bg-blue-200 transition" title="View Report"><i data-lucide="file-text" class="w-4 h-4"></i></a>` : '<span class="text-slate-300 text-xs italic">No Link</span>'}</div></div>`).join(''); } lucide.createIcons(); UI.openModal('modal-dps-history'); },
            
            viewGlobalDPSReport: () => { const dpsGroups = Data.groupDPS; const membersMap = {}; dpsGroups.forEach(g => { const batchesRun = (g.history || []).length; const amountPerMember = batchesRun * g.contribution; if (amountPerMember > 0 || batchesRun === 0) { g.memberIDs.forEach(mid => { if (!membersMap[mid]) { const m = Data.members.find(x => x.id === mid); if (m) membersMap[mid] = { name: m.name, id: m.id, phone: m.phone, groups: [], totalDep: 0 }; } if (membersMap[mid]) { membersMap[mid].groups.push({ groupId: g.id, groupName: g.name, deposited: amountPerMember }); membersMap[mid].totalDep += amountPerMember; } }); } }); const reportData = Object.values(membersMap).sort((a,b) => b.totalDep - a.totalDep); App.tempGlobalDPSData = reportData; const totalMembers = reportData.length; const totalFunds = reportData.reduce((sum, m) => sum + m.totalDep, 0); const container = document.getElementById('global-dps-list'); const statsHtml = `<div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4 text-center"><div class="bg-indigo-50 p-3 rounded border border-indigo-100"><p class="text-[10px] text-indigo-600 font-bold uppercase">Total Members</p><h3 class="text-xl font-bold text-slate-800">${totalMembers}</h3></div><div class="bg-teal-50 p-3 rounded border border-teal-100"><p class="text-[10px] text-teal-600 font-bold uppercase">Total DPS Fund</p><h3 class="text-xl font-bold text-teal-700">${Utils.currency(totalFunds)}</h3></div><div class="bg-slate-50 p-3 rounded border border-slate-200"><p class="text-[10px] text-slate-500 font-bold uppercase">Active Groups</p><h3 class="text-xl font-bold text-slate-700">${dpsGroups.length}</h3></div></div>`; const searchHtml = `<div class="mb-4 relative"><i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i><input type="text" placeholder="Search member name, ID or phone..." class="w-full pl-10 pr-4 py-2 border rounded-lg text-sm focus:outline-none focus:border-indigo-500 bg-slate-50 focus:bg-white transition-colors" oninput="App.renderGlobalDPSTable(this.value)"></div>`; const tableHtml = `<div class="overflow-x-auto"><table class="w-full text-sm text-left border-collapse border border-slate-200"><thead class="bg-slate-100 text-slate-600 font-bold text-xs uppercase"><tr><th class="p-3 border w-1/3">Member</th><th class="p-3 border">Group Breakdown</th><th class="p-3 border text-right w-32">Total</th></tr></thead><tbody id="global-dps-table-body" class="divide-y divide-slate-200"></tbody></table></div><div class="mt-6 text-center text-[10px] text-slate-400 border-t pt-4">Generated: ${new Date().toLocaleString()} ‚Ä¢ ${Data.receiptSignature}</div>`; container.innerHTML = statsHtml + searchHtml + tableHtml; App.renderGlobalDPSTable(''); lucide.createIcons(); UI.openModal('modal-global-dps'); },
            renderGlobalDPSTable: (searchTerm) => { const data = App.tempGlobalDPSData || []; const term = searchTerm.toLowerCase(); const filtered = data.filter(m => m.name.toLowerCase().includes(term) || m.id.toLowerCase().includes(term) || m.phone.includes(term)); const tbody = document.getElementById('global-dps-table-body'); if (!tbody) return; if (filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="3" class="p-6 text-center text-slate-400 italic">No matching members found.</td></tr>`; } else { tbody.innerHTML = filtered.map(m => { const groupDetails = m.groups.map(g => { const grpObj = Data.groupDPS.find(x => x.id === g.groupId); const grpId = grpObj ? grpObj.id : ''; return `<div class="flex justify-between items-center text-xs py-1.5 border-b last:border-0 border-dashed border-slate-100 group hover:bg-white px-1 -mx-1 rounded transition"><span class="text-slate-600 font-medium">${g.groupName}</span><div class="flex items-center gap-2"><span class="font-mono text-slate-800 font-bold">${Utils.currency(g.deposited)}</span>${grpId ? `<div class="flex gap-1"><button onclick="App.initMemberMaturity('${grpId}', '${m.id}', '${m.name}', ${g.deposited}, '${g.groupName}')" class="text-green-500 hover:text-green-700 bg-green-50 px-1.5 py-0.5 rounded border border-green-200 transition" title="Maturity Payout"><i data-lucide="check-circle" class="w-3 h-3"></i></button><button onclick="App.initMemberExit('${grpId}', '${m.id}', '${m.name}', ${g.deposited}, '${g.groupName}')" class="text-red-400 hover:text-red-600 bg-red-50 px-1.5 py-0.5 rounded border border-red-200 transition" title="Early Exit"><i data-lucide="log-out" class="w-3 h-3"></i></button></div>` : ''}</div></div>`; }).join(''); return `<tr class="hover:bg-slate-50"><td class="p-3 border align-top"><div class="font-bold text-slate-800">${m.name} ${UI.getFlagIcon(m.flag)}</div><div class="text-[10px] text-slate-500 font-mono">${m.id}</div><div class="text-[10px] text-slate-400 mt-1 flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${m.phone}</div></td><td class="p-3 border align-top bg-slate-50/30">${groupDetails}</td><td class="p-3 border align-top text-right font-bold text-indigo-700 text-base">${Utils.currency(m.totalDep)}</td></tr>`; }).join(''); } lucide.createIcons({ root: tbody }); },
            
            viewMemberProfile: (id) => {
                const m = Data.members.find(x => x.id === id); if (!m) return;
                
                // 1. Gather Loans
                const loans = Data.loans.filter(l => l.memberId === id); 
                const activeLoans = loans.filter(l => l.status === 'Active' && l.paid < l.totalRepayable); 
                const totalActiveDue = activeLoans.reduce((s, l) => s + (l.totalRepayable - l.paid), 0);
                
                // 2. Gather Fixed Deposits
                const fds = Data.fixedDeposits.filter(f => f.memberId === id); 
                const activeFDs = fds.filter(f => f.status === 'Active');
                const totalFDValue = activeFDs.reduce((s, f) => s + f.principal, 0);
                
                // 3. Gather Groups
                const groups = Data.groups.filter(g => g.memberIDs.includes(id));
                
                // 4. Gather DPS
                const dps = Data.groupDPS.filter(g => g.memberIDs.includes(id)); 
                const dpsStats = dps.map(g => {
                    const batchesRun = (g.history || []).length;
                    const deposited = batchesRun * g.contribution;
                    return { group: g, deposited, batchesRun };
                });
                const totalDPSValue = dpsStats.reduce((s, d) => s + d.deposited, 0);

                const container = document.getElementById('mp-content');
                document.getElementById('mp-header-name').innerHTML = `Portfolio: <span class="font-normal">${m.name}</span> <span class="text-sm font-normal text-slate-500">(${m.id})</span>`;
                
                let html = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <p class="text-xs font-bold text-blue-600 uppercase mb-1">Savings Balance</p>
                            <h3 class="text-2xl font-bold text-slate-800">${Utils.currency(m.savingsBalance)}</h3>
                        </div>
                        <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                            <p class="text-xs font-bold text-red-600 uppercase mb-1">Active Loans Due</p>
                            <h3 class="text-2xl font-bold text-slate-800">${Utils.currency(totalActiveDue)}</h3>
                            <p class="text-[10px] text-red-400 mt-1">${activeLoans.length} Active Loans</p>
                        </div>
                        <div class="bg-teal-50 p-4 rounded-xl border border-teal-100">
                            <p class="text-xs font-bold text-teal-600 uppercase mb-1">DPS Value</p>
                            <h3 class="text-2xl font-bold text-slate-800">${Utils.currency(totalDPSValue)}</h3>
                            <p class="text-[10px] text-teal-500 mt-1">${dps.length} Active Plans</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <p class="text-xs font-bold text-indigo-600 uppercase mb-1">FD Principal</p>
                            <h3 class="text-2xl font-bold text-slate-800">${Utils.currency(totalFDValue)}</h3>
                            <p class="text-[10px] text-indigo-400 mt-1">${activeFDs.length} Active FDs</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-4 overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 font-bold text-slate-700 flex justify-between items-center">
                            <span><i data-lucide="credit-card" class="w-4 h-4 inline mr-2"></i> Personal Loans</span>
                            <span class="text-xs bg-slate-200 px-2 py-0.5 rounded-full">${loans.length} Total</span>
                        </div>
                        <div class="divide-y divide-slate-100">
                            ${loans.length > 0 ? loans.map(l => {
                                const isActive = l.status === 'Active' && l.paid < l.totalRepayable;
                                const progress = Math.min(100, Math.round((l.paid / l.totalRepayable) * 100));
                                return `<div class="p-4 hover:bg-slate-50 transition"><div class="flex justify-between items-start mb-2"><div><div class="font-bold text-sm text-slate-800">${l.category} Loan <span class="font-normal text-slate-500 text-xs">(${l.loanType})</span></div><div class="text-xs text-slate-500 font-mono">${l.id}</div></div><span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase ${isActive ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}">${isActive ? 'Active' : (l.status === 'Active' ? 'Paid' : l.status)}</span></div><div class="flex justify-between text-xs text-slate-600 mb-1"><span>Principal: ${Utils.currency(l.principal)}</span><span>Due: <span class="${isActive ? 'text-red-600 font-bold' : ''}">${Utils.currency(l.totalRepayable - l.paid)}</span></span></div><div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div class="bg-blue-600 h-full" style="width: ${progress}%"></div></div></div>`;
                            }).join('') : '<div class="p-4 text-center text-slate-400 italic text-sm">No loan history.</div>'}
                        </div>
                    </div>`;

                // Group & DPS Grid
                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">`;
                
                // Group Loans
                html += `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 font-bold text-slate-700 text-sm flex justify-between items-center">
                            <span><i data-lucide="users" class="w-4 h-4 inline mr-2"></i> Group Loans</span>
                            <span class="text-xs bg-slate-200 px-2 py-0.5 rounded-full">${groups.length} Total</span>
                        </div>
                        <div class="divide-y divide-slate-100 max-h-48 overflow-y-auto">
                            ${groups.length > 0 ? groups.map(g => `
                                <div class="p-3 hover:bg-slate-50 transition text-sm">
                                    <div class="flex justify-between font-bold text-slate-700">
                                        <span>${g.name} <span class="font-mono text-[10px] font-normal text-slate-400 ml-1">(${g.id})</span></span>
                                        <span class="${g.status==='Active'?'text-green-600':'text-slate-400'} text-[10px] uppercase">${g.status}</span>
                                    </div>
                                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                                        <span>Contrib: ${Utils.currency(g.contribution)}</span>
                                        <span>Freq: ${g.frequency}</span>
                                    </div>
                                </div>
                            `).join('') : '<div class="p-4 text-center text-slate-400 italic text-sm">No group memberships.</div>'}
                        </div>
                    </div>
                `;

                // DPS
                html += `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 font-bold text-slate-700 text-sm flex justify-between items-center">
                            <span><i data-lucide="layers" class="w-4 h-4 inline mr-2"></i> Group DPS</span>
                            <span class="text-xs bg-slate-200 px-2 py-0.5 rounded-full">${dpsStats.length} Total</span>
                        </div>
                        <div class="divide-y divide-slate-100 max-h-48 overflow-y-auto">
                            ${dpsStats.length > 0 ? dpsStats.map(d => `
                                <div class="p-3 hover:bg-slate-50 transition text-sm">
                                    <div class="flex justify-between font-bold text-slate-700">
                                        <span>${d.group.name} <span class="font-mono text-[10px] font-normal text-slate-400 ml-1">(${d.group.id})</span></span>
                                        <span class="text-indigo-600">${Utils.currency(d.deposited)}</span>
                                    </div>
                                    <div class="flex justify-between text-xs text-slate-500 mt-1">
                                        <span>${d.batchesRun} Batches Paid</span>
                                        <span>${d.group.status}</span>
                                    </div>
                                </div>
                            `).join('') : '<div class="p-4 text-center text-slate-400 italic text-sm">No DPS plans.</div>'}
                        </div>
                    </div>
                `;
                html += `</div>`;

                // Fixed Deposits
                html += `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 font-bold text-slate-700 text-sm">
                            <i data-lucide="lock" class="w-4 h-4 inline mr-2"></i> Fixed Deposits
                        </div>
                        <div class="divide-y divide-slate-100">
                            ${fds.length > 0 ? fds.map(f => `
                                <div class="p-3 hover:bg-slate-50 transition flex justify-between items-center text-sm">
                                    <div>
                                        <div class="font-bold text-slate-700">${Utils.currency(f.principal)} <span class="font-normal text-slate-500 text-xs">@ ${f.rate}%</span></div>
                                        <div class="text-xs text-slate-500 mt-0.5"><span class="font-mono text-[10px] bg-slate-100 px-1 rounded mr-1">${f.id}</span> Maturity: ${f.maturityDate}</div>
                                    </div>
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase ${f.status==='Active'?'bg-green-100 text-green-700':'bg-slate-100 text-slate-500'}">${f.status}</span>
                                </div>
                            `).join('') : '<div class="p-4 text-center text-slate-400 italic text-sm">No Fixed Deposits.</div>'}
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                lucide.createIcons({ root: container });
                UI.openModal('modal-member-profile');
            },

            initMemberMaturity: (gid, mid, mname, amount, gname) => { if(App.currentUser.role === 'Staff') return Utils.notify("Access Denied", "error"); App.askConfirm(`Process Maturity Payout for ${mname}?\n\nGroup: ${gname}\nAmount: ${Utils.currency(amount)}\n\nThis will transfer funds to their Savings as a DPS Payment.`, async () => { const btn = document.getElementById('btn-confirm-yes'); Utils.setLoading(btn, true, 'Processing...'); try { const group = Data.groupDPS.find(g => g.id === gid); const member = Data.members.find(m => m.id === mid); if (!group || !member) throw new Error("Data not found"); const newMembers = group.memberIDs.filter(id => id !== mid); group.memberIDs = newMembers; if (amount > 0) { const date = Utils.dateToday(); const txSav = { id: Utils.id('D'), loanId: 'SAVINGS', memberName: member.name, amount: amount, date: date, category: 'Deposit', collectedBy: `DPS Maturity: ${group.name}` }; Data.transactions.unshift(txSav); await Data.post('addSavingsTx', { ...txSav, typeTx: 'Deposit' }); const txDps = { id: Utils.id('X'), loanId: gid, memberName: member.name, amount: -amount, date: date, category: 'DPS Payment', collectedBy: `Maturity: ${member.name}` }; Data.transactions.unshift(txDps); await Data.post('addSavingsTx', { ...txDps, typeTx: 'DPS Payment' }); } await Data.post('editGroupDPS', { id: gid, name: group.name, memberIDs: JSON.stringify(newMembers), contribution: group.contribution, frequency: group.frequency, startDate: group.startDate, duration: group.duration, status: group.status }); Logic.recalcBalances(); Utils.notify("Maturity Payout Successful"); UI.closeModal('modal-confirm'); UI.closeModal('modal-global-dps'); App.renderContent(); } catch (err) { console.error(err); Utils.notify("Operation Failed", "error"); Utils.setLoading(btn, false); } }, true, true); },
            initMemberExit: (gid, mid, mname, amount, gname) => { if(App.currentUser.role === 'Staff') return Utils.notify("Access Denied", "error"); App.askConfirm(`Exit ${mname} from ${gname}?\n\nTotal Balance: ${Utils.currency(amount)}\nThis amount will be transferred to their Savings account.`, async () => { const btn = document.getElementById('btn-confirm-yes'); Utils.setLoading(btn, true, 'Processing...'); try { const group = Data.groupDPS.find(g => g.id === gid); const member = Data.members.find(m => m.id === mid); if (!group || !member) throw new Error("Data not found"); const newMembers = group.memberIDs.filter(id => id !== mid); group.memberIDs = newMembers; if (amount > 0) { const date = Utils.dateToday(); const txSav = { id: Utils.id('D'), loanId: 'SAVINGS', memberName: member.name, amount: amount, date: date, category: 'Deposit', collectedBy: `DPS Exit: ${group.name}` }; Data.transactions.unshift(txSav); await Data.post('addSavingsTx', { ...txSav, typeTx: 'Deposit' }); const txDps = { id: Utils.id('X'), loanId: gid, memberName: member.name, amount: -amount, date: date, category: 'DPS Withdrawal', collectedBy: `Exit: ${member.name}` }; Data.transactions.unshift(txDps); await Data.post('addSavingsTx', { ...txDps, typeTx: 'DPS Withdrawal' }); } await Data.post('editGroupDPS', { id: gid, name: group.name, memberIDs: JSON.stringify(newMembers), contribution: group.contribution, frequency: group.frequency, startDate: group.startDate, duration: group.duration, status: group.status }); Logic.recalcBalances(); Utils.notify("Member Exited & Balance Transferred"); UI.closeModal('modal-confirm'); UI.closeModal('modal-global-dps'); App.renderContent(); } catch (err) { console.error(err); Utils.notify("Operation Failed", "error"); Utils.setLoading(btn, false); } }, true, true); },
            
            toggleClosedFDs: () => { App.showClosedFDs = !App.showClosedFDs; App.renderContent(); },

            testConnection: async () => { const url = document.getElementById('set-script-url').value; if(!url) return Utils.notify("Please enter a Script URL", "error"); const btn = document.getElementById('btn-test-conn'); Utils.setLoading(btn, true, 'Pinging...'); try { const res = await fetch(`${url}?op=getData`); if(res.ok) { const d = await res.json(); if(d.version) Utils.notify(`Success! Connected to v${d.version}`); else Utils.notify("Connected, but response format invalid", "warning"); } else throw new Error("HTTP " + res.status); } catch(e) { Utils.notify("Connection Failed: " + e.message, "error"); } finally { Utils.setLoading(btn, false); } },
            saveScriptUrl: () => { const url = document.getElementById('set-script-url').value; if(url) { localStorage.setItem('mf_script_url', url); Data.scriptUrl = url; Utils.notify("URL Saved & Updated"); Data.sync(); } },
            saveSMSKey: async () => {
                const k = document.getElementById('set-sms-key').value;
                const btn = document.querySelector('#set-sms-key + button'); 
                Utils.setLoading(btn, true, 'Saving...');
                try {
                    localStorage.setItem('mf_sms_api_key', k);
                    Data.smsApiKey = k;
                    await Data.post('updateSmsKey', { key: k });
                    Utils.notify(k ? "SMS API Key Saved Globally" : "API Key Cleared Globally");
                } catch(e) {
                    Utils.notify("Failed to save globally (saved locally)", "warning");
                } finally {
                    Utils.setLoading(btn, false);
                }
            },
            saveAdminMobile: async () => {
                const m = document.getElementById('set-admin-mobile').value;
                const btn = document.querySelector('#set-admin-mobile + button');
                Utils.setLoading(btn, true, 'Saving...');
                try {
                    localStorage.setItem('mf_admin_mobile', m);
                    Data.adminMobile = m;
                    await Data.post('updateAdminMobile', { mobile: m });
                    Utils.notify("Admin Mobile Saved");
                } catch(e) {
                    Utils.notify("Failed to save globally (saved locally)", "warning");
                } finally {
                    Utils.setLoading(btn, false);
                }
            },

            renderNav: () => { 
                const l = [{id:'dashboard',l:'Dashboard',i:'layout-grid'},{id:'members',l:'Members',i:'users'},{id:'loans',l:'Loans',i:'credit-card'},{id:'group',l:'Group Loans',i:'users-round'},{id:'savings',l:'Savings',i:'wallet'},{id:'fixed-deposits',l:'Fixed Deposits',i:'lock'},{id:'group-dps',l:'Group DPS',i:'layers'},{id:'sales',l:'Sales',i:'shopping-bag'},{id:'inventory',l:'Inventory',i:'package'},{id:'income',l:'Income',i:'trending-up'},{id:'expenses',l:'Expenses',i:'file-minus'},{id:'transactions',l:'Transactions',i:'history'},{id:'archiving',l:'Archiving',i:'archive'}];
                if(App.currentUser?.role==='Admin') { l.unshift({id:'admin-dashboard',l:'Admin Dashboard',i:'layout-dashboard'}); l.push({id:'settings',l:'Settings',i:'settings'}); }
                
                document.getElementById('desktop-nav').innerHTML=l.map(k=>App.currentUser.role==='Staff'&&k.id==='expenses'?'':`<button onclick="App.switchTab('${k.id}')" class="w-full flex gap-3 px-4 py-3 rounded text-sm font-medium transition-colors ${App.activeTab===k.id?'bg-blue-600 text-white shadow':'text-slate-400 hover:text-white hover:bg-slate-800'}"><i data-lucide="${k.i}" class="w-5"></i> ${k.l}</button>`).join(''); 
                document.getElementById('mobile-nav').innerHTML=document.getElementById('desktop-nav').innerHTML; 
                lucide.createIcons(); 
            },
            renderContent: () => {
                const c=document.getElementById('content-area'); document.getElementById('page-title').innerText = App.activeTab === 'admin-dashboard' ? 'Admin Dashboard' : App.activeTab.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                if(!App.currentUser)return;
                const tm=App.searchTerm, sf=i=>!tm||Object.values(i).some(v=>String(v).toLowerCase().includes(tm));
                const fM=Data.members.filter(sf), fL=Data.loans.filter(sf), fT=Data.transactions.filter(sf), fA=Data.archivedLoans.filter(sf);
                let h='';
                
                if(App.activeTab==='dashboard'){
                    const today = Utils.dateToday();
                    const txToday = Data.transactions.filter(t => t.date === today);
                    const colToday = txToday.filter(t => t.amount > 0 && t.category !== 'Capital Injection').reduce((s,t) => s + t.amount, 0);
                    const outToday = Math.abs(txToday.filter(t => t.amount < 0 && t.category !== 'Equity Withdraw').reduce((s,t) => s + t.amount, 0));
                    
                    const loansDue = Data.loans.filter(l => l.status === 'Active' && l.paid < l.totalRepayable && Logic.checkIsDueOn(l, new Date())).length;
                    const depositsDue = Data.members.filter(m => m.status === 'Active' && Logic.getSavingsStatus(m).isDue).length;
                    const groupsDue = Data.groups.filter(g => g.status === 'Active' && Logic.getGroupStatus(g, 'loan').days <= 0).length;
                    const dpsDue = Data.groupDPS.filter(g => g.status === 'Active' && Logic.getGroupStatus(g, 'dps').days <= 0).length;

                    const groupsBlocked = Data.groups.filter(g => { if (g.status !== 'Active' || Logic.getGroupStatus(g, 'loan').days > 0) return false; return g.memberIDs.some(mid => { const m = Data.members.find(x => x.id === mid); return m && m.savingsBalance < g.contribution; }); }).length;
                    const dpsBlocked = Data.groupDPS.filter(g => { if (g.status !== 'Active' || Logic.getGroupStatus(g, 'dps').days > 0) return false; return g.memberIDs.some(mid => { const m = Data.members.find(x => x.id === mid); return m && m.savingsBalance < g.contribution; }); }).length;

                    const todayDate = new Date(); todayDate.setHours(0,0,0,0);
                    const loansUpcoming = Data.loans.filter(l => { if(l.status !== 'Active' || l.paid >= l.totalRepayable) return false; const disTx = Data.transactions.find(t => t.loanId === l.id && t.category === 'Disbursement'); if(!disTx) return false; const disDate = Utils.parseDate(disTx.date); let nextDue = null; if (l.loanType === 'Daily') { nextDue = new Date(todayDate); nextDue.setDate(todayDate.getDate() + 1); } else if (l.loanType === 'Weekly') { const diff = disDate.getDay() - todayDate.getDay(); nextDue = new Date(todayDate); nextDue.setDate(todayDate.getDate() + (diff <= 0 ? diff + 7 : diff)); } else if (l.loanType === 'Monthly') { nextDue = new Date(todayDate.getFullYear(), todayDate.getMonth(), disDate.getDate()); if (nextDue <= todayDate) nextDue.setMonth(nextDue.getMonth() + 1); } if (!nextDue) return false; const days = Math.ceil((nextDue - todayDate) / (1000 * 60 * 60 * 24)); return days > 0 && days <= 3; }).length;
                    const depositsUpcoming = Data.members.filter(m => { if(m.status !== 'Active') return false; const { nextDue, isDue } = Logic.getSavingsStatus(m); if(isDue || !nextDue) return false; const days = Math.ceil((nextDue - todayDate) / (1000 * 60 * 60 * 24)); return days > 0 && days <= 3; }).length;

                    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); const tomorrowDayName = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][tomorrow.getDay()]; const tomorrowDateNum = tomorrow.getDate();
                    const savingsForecast = Data.members.filter(m => { if(m.status !== 'Active') return false; if(m.savingType === 'Daily') return true; if(m.savingType === 'Weekly') return m.savingDate === tomorrowDayName; if(m.savingType === 'Monthly') return parseInt(m.savingDate) === tomorrowDateNum; return false; }).reduce((sum, m) => sum + (Number(m.savingAmount) || 0), 0);
                    const loansForecast = Data.loans.filter(l => { if(l.status !== 'Active' || l.paid >= l.totalRepayable) return false; return Logic.checkIsDueOn(l, tomorrow); }).reduce((sum, l) => sum + Math.ceil(l.totalRepayable / (l.duration || 1)), 0);
                    const totalForecast = savingsForecast + loansForecast;

                    const hasNotice = Data.notice && Data.notice.trim().length > 0;
                    let noticeBoard = '';
                    if (hasNotice || App.currentUser.role === 'Admin') {
                        const displayNotice = hasNotice ? Data.notice.split(';')[0] : 'No active notices. Click pencil to add.';
                        noticeBoard = `<div class="bg-slate-900 text-slate-300 p-6 rounded-xl shadow-lg mb-6 relative overflow-hidden group animate-fadeIn"><div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="bell" class="w-24 h-24"></i></div><div class="relative z-10 flex justify-between items-start"><div class="flex-1"><h3 class="font-bold text-xs uppercase tracking-widest text-indigo-400 mb-3 flex items-center gap-2"><i data-lucide="bell-ring" class="w-4 h-4"></i> Notice Board</h3><div id="notice-view-wrapper" class="min-h-[40px] flex items-center"><div id="notice-text" class="text-lg font-medium text-white transition-all duration-500 transform translate-y-0 leading-snug">${displayNotice}</div></div><div id="notice-edit" class="hidden mt-3 bg-slate-800/50 p-2 rounded border border-slate-700"><textarea id="notice-input" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white focus:outline-none focus:border-indigo-500 mb-2 font-mono" rows="2" placeholder="Notice 1; Notice 2...">${Utils.escapeHtml(Data.notice || '')}</textarea><div class="flex gap-2"><button onclick="App.saveNotice()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-indigo-500 shadow-sm">Update Board</button><button onclick="App.toggleNoticeEdit(true)" class="text-slate-400 px-3 py-1 rounded text-xs hover:text-white">Cancel</button></div></div></div>${App.currentUser.role === 'Admin' ? `<button onclick="App.toggleNoticeEdit()" class="text-slate-500 hover:text-white p-2 rounded hover:bg-white/10 transition opacity-0 group-hover:opacity-100" title="Edit Notices"><i data-lucide="pencil" class="w-4 h-4"></i></button>` : ''}</div></div>`;
                    }

                    const topStats = `<div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-xl p-6 text-white shadow-lg mb-6 animate-fadeIn relative overflow-hidden"><div class="flex justify-between items-center mb-4 relative z-10"><div><h2 class="text-2xl font-bold">Hello, ${App.currentUser.name}</h2><p class="text-blue-100 text-sm">Here is today's snapshot ‚Ä¢ ${new Date().toLocaleDateString()}</p></div><div class="bg-white/10 p-2 rounded-lg backdrop-blur-sm"><i data-lucide="sun" class="w-6 h-6 text-yellow-300"></i></div></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4 relative z-10"><div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm"><p class="text-[10px] uppercase font-bold text-blue-200">Collected Today</p><p class="text-xl font-bold">${Utils.currency(colToday)}</p></div><div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm"><p class="text-[10px] uppercase font-bold text-blue-200">Disbursed/Out</p><p class="text-xl font-bold">${Utils.currency(outToday)}</p></div><div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm"><p class="text-[10px] uppercase font-bold text-blue-200">Tx Count</p><p class="text-xl font-bold">${txToday.length}</p></div><div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm cursor-pointer hover:bg-white/20 transition" onclick="App.viewDailyReport()"><p class="text-[10px] uppercase font-bold text-blue-200 flex items-center gap-1">Net Cash <i data-lucide="arrow-right" class="w-3 h-3"></i></p><p class="text-xl font-bold">${Utils.currency(colToday - outToday)}</p></div></div><div class="mt-4 pt-3 border-t border-white/20 flex flex-col md:flex-row justify-between items-center gap-2 relative z-10"><div class="flex items-center gap-2"><div class="bg-white/20 p-1.5 rounded-full animate-pulse"><i data-lucide="sparkles" class="w-4 h-4 text-yellow-300"></i></div><div><p class="text-[10px] uppercase font-bold text-blue-200">Tomorrow's Liquidity Forecast</p><p class="text-xs text-blue-100 opacity-80">Expected Inflow (${tomorrow.toLocaleDateString()})</p></div></div><div class="text-right"><p class="text-2xl font-bold text-white tracking-tight">${Utils.currency(totalForecast)}</p><p class="text-[10px] text-blue-100 font-medium">Loans: ${Utils.currency(loansForecast)} ‚Ä¢ Savings: ${Utils.currency(savingsForecast)}</p></div></div><div class="absolute -bottom-10 -right-10 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div></div>`;
                    
                    const targetsSection = `<h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2 px-1"><i data-lucide="target" class="w-4 h-4 text-indigo-500"></i> Today's Targets</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 animate-fadeIn"><div onclick="App.openAssistant('loan'); UI.switchAssistantTab('collection')" class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100 hover:border-indigo-400 cursor-pointer transition group"><div class="flex justify-between items-start"><div><p class="text-[10px] text-slate-500 font-bold uppercase">Loans Due</p><h3 class="text-2xl font-bold text-indigo-700 mt-1">${loansDue}</h3></div><div class="bg-indigo-50 p-2 rounded-full text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition"><i data-lucide="credit-card" class="w-5 h-5"></i></div></div><div class="mt-2 text-[10px] text-slate-400">Collect Installments</div></div><div onclick="App.openAssistant('savings'); UI.switchAssistantTab('collection')" class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 hover:border-blue-400 cursor-pointer transition group"><div class="flex justify-between items-start"><div><p class="text-[10px] text-slate-500 font-bold uppercase">Savings Due</p><h3 class="text-2xl font-bold text-blue-700 mt-1">${depositsDue}</h3></div><div class="bg-blue-50 p-2 rounded-full text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition"><i data-lucide="wallet" class="w-5 h-5"></i></div></div><div class="mt-2 text-[10px] text-slate-400">Regular Savings</div></div><div onclick="App.switchTab('group')" class="bg-white p-4 rounded-xl shadow-sm border border-purple-100 hover:border-purple-400 cursor-pointer transition group"><div class="flex justify-between items-start"><div><p class="text-[10px] text-slate-500 font-bold uppercase">Groups Run</p><h3 class="text-2xl font-bold text-purple-700 mt-1">${groupsDue}</h3></div><div class="bg-purple-50 p-2 rounded-full text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition"><i data-lucide="users" class="w-5 h-5"></i></div></div><div class="mt-2 text-[10px] text-slate-400">Lottery / Cycles</div></div><div onclick="App.switchTab('group-dps')" class="bg-white p-4 rounded-xl shadow-sm border border-teal-100 hover:border-teal-400 cursor-pointer transition group"><div class="flex justify-between items-start"><div><p class="text-[10px] text-slate-500 font-bold uppercase">DPS Run</p><h3 class="text-2xl font-bold text-teal-700 mt-1">${dpsDue}</h3></div><div class="bg-teal-50 p-2 rounded-full text-teal-600 group-hover:bg-teal-600 group-hover:text-white transition"><i data-lucide="layers" class="w-5 h-5"></i></div></div><div class="mt-2 text-[10px] text-slate-400">Batch Collections</div></div></div>`;

                    const combinedSection = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 animate-fadeIn"><div><h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2 px-1"><i data-lucide="calendar-clock" class="w-4 h-4 text-orange-500"></i> Upcoming (Next 3 Days)</h3><div class="grid grid-cols-2 gap-4"><div onclick="App.openAssistant('loan'); UI.switchAssistantTab('upcoming')" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 hover:border-indigo-300 cursor-pointer transition group"><div class="flex justify-between items-start"><div><p class="text-[10px] text-slate-400 font-bold uppercase">Loans</p><h3 class="text-2xl font-bold text-slate-600 mt-1 group-hover:text-indigo-600 transition">${loansUpcoming}</h3></div><div class="bg-slate-50 p-2 rounded-full text-slate-400 group-hover:text-indigo-500 transition"><i data-lucide="calendar" class="w-5 h-5"></i></div></div><div class="mt-2 text-[10px] text-slate-400">Expected Payments</div></div><div onclick="App.openAssistant('savings'); UI.switchAssistantTab('upcoming')" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 hover:border-blue-300 cursor-pointer transition group"><div class="flex justify-between items-start"><div><p class="text-[10px] text-slate-400 font-bold uppercase">Savings</p><h3 class="text-2xl font-bold text-slate-600 mt-1 group-hover:text-blue-600 transition">${depositsUpcoming}</h3></div><div class="bg-slate-50 p-2 rounded-full text-slate-400 group-hover:text-blue-500 transition"><i data-lucide="clock" class="w-5 h-5"></i></div></div><div class="mt-2 text-[10px] text-slate-400">Expected Deposits</div></div></div></div><div><h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2 px-1"><i data-lucide="alert-triangle" class="w-4 h-4 text-red-500"></i> Risk Monitor</h3><div class="grid grid-cols-2 gap-4"><div onclick="${groupsBlocked > 0 ? "App.viewRiskSummary('group')" : "App.switchTab('group')"}" class="${groupsBlocked > 0 ? 'bg-red-50 border-red-200 hover:border-red-400' : 'bg-white border-slate-200 hover:border-indigo-300'} p-4 rounded-xl shadow-sm border cursor-pointer transition group"><div class="flex justify-between items-start"><div><p class="text-[10px] ${groupsBlocked > 0 ? 'text-red-600' : 'text-slate-500'} font-bold uppercase">Groups Stalled</p><h3 class="text-2xl font-bold ${groupsBlocked > 0 ? 'text-red-700' : 'text-slate-700'} mt-1">${groupsBlocked}</h3></div><div class="${groupsBlocked > 0 ? 'bg-white text-red-500' : 'bg-slate-50 text-slate-400'} p-2 rounded-full shadow-sm transition"><i data-lucide="users" class="w-5 h-5"></i></div></div><div class="mt-2 text-[10px] ${groupsBlocked > 0 ? 'text-red-500' : 'text-green-600 font-bold'} font-medium">${groupsBlocked > 0 ? 'Insufficient Member Funds' : '<i data-lucide="check" class="w-3 h-3 inline"></i> No Issues'}</div></div><div onclick="${dpsBlocked > 0 ? "App.viewRiskSummary('dps')" : "App.switchTab('group-dps')"}" class="${dpsBlocked > 0 ? 'bg-red-50 border-red-200 hover:border-red-400' : 'bg-white border-slate-200 hover:border-indigo-300'} p-4 rounded-xl shadow-sm border cursor-pointer transition group"><div class="flex justify-between items-start"><div><p class="text-[10px] ${dpsBlocked > 0 ? 'text-red-600' : 'text-slate-500'} font-bold uppercase">DPS Stalled</p><h3 class="text-2xl font-bold ${dpsBlocked > 0 ? 'text-red-700' : 'text-slate-700'} mt-1">${dpsBlocked}</h3></div><div class="${dpsBlocked > 0 ? 'bg-white text-red-500' : 'bg-slate-50 text-slate-400'} p-2 rounded-full shadow-sm transition"><i data-lucide="layers" class="w-5 h-5"></i></div></div><div class="mt-2 text-[10px] ${dpsBlocked > 0 ? 'text-red-500' : 'text-green-600 font-bold'} font-medium">${dpsBlocked > 0 ? 'Insufficient Member Funds' : '<i data-lucide="check" class="w-3 h-3 inline"></i> No Issues'}</div></div></div></div></div>`;
                    
                    const quickActions = `<h3 class="font-bold text-slate-700 mb-3 px-1">Quick Actions</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 animate-fadeIn"><button onclick="UI.openModal('modal-loan-simulator'); setTimeout(()=>document.getElementById('sim-principal').focus(), 100);" class="bg-white p-4 rounded-xl shadow-sm border hover:border-indigo-400 transition text-left group"><div class="bg-indigo-50 w-10 h-10 rounded-full flex items-center justify-center mb-2 text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition"><i data-lucide="calculator" class="w-5 h-5"></i></div><h3 class="font-bold text-slate-700">Loan Simulator</h3><p class="text-[10px] text-slate-400">Calculate EMI</p></button><button onclick="App.openMemberModal()" class="bg-white p-4 rounded-xl shadow-sm border hover:border-blue-400 transition text-left group"><div class="bg-blue-50 w-10 h-10 rounded-full flex items-center justify-center mb-2 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition"><i data-lucide="user-plus" class="w-5 h-5"></i></div><h3 class="font-bold text-slate-700">New Member</h3><p class="text-[10px] text-slate-400">Register client</p></button><button onclick="App.openNewLoanModal()" class="bg-white p-4 rounded-xl shadow-sm border hover:border-blue-400 transition text-left group"><div class="bg-emerald-50 w-10 h-10 rounded-full flex items-center justify-center mb-2 text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition"><i data-lucide="credit-card" class="w-5 h-5"></i></div><h3 class="font-bold text-slate-700">New Loan</h3><p class="text-[10px] text-slate-400">Disburse cash</p></button><button onclick="UI.openTransactionModal('SAVINGS','Deposit','Quick Deposit')" class="bg-white p-4 rounded-xl shadow-sm border hover:border-blue-400 transition text-left group"><div class="bg-orange-50 w-10 h-10 rounded-full flex items-center justify-center mb-2 text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition"><i data-lucide="wallet" class="w-5 h-5"></i></div><h3 class="font-bold text-slate-700">Quick Deposit</h3><p class="text-[10px] text-slate-400">Add savings</p></button></div>`;

                    h = noticeBoard + topStats + targetsSection + combinedSection + quickActions;
                    setTimeout(App.startNoticeTimer, 100); 
                }
                else if(App.activeTab==='admin-dashboard'){
                    if(App.currentUser.role!=='Admin'){h='<div class="text-center p-8 text-slate-400 italic">Access Denied: Admins Only</div>'}else{
                        const dis=fL.reduce((s,l)=>s+l.principal,0);
                        const col=fL.reduce((s,l)=>s+(l.paid * (l.totalRepayable>0?l.principal/l.totalRepayable:0)),0);
                        const sav=fM.reduce((s,m)=>s+m.savingsBalance,0), dps=fT.filter(t=>t.category==='Group DPS Contrib.').reduce((s,t)=>s+t.amount,0), cash=fT.filter(t=>t.category!=='Bad Debt').reduce((s,t)=>s+t.amount,0), fdTotal=Data.fixedDeposits.filter(f=>f.status==='Active').reduce((s,f)=>s+f.principal,0);
                        
                        const todayStr = Utils.dateToday();
                        const dailyTxs = Data.transactions.filter(t => t.date === todayStr && t.amount > 0); 
                        const staffMap = {};
                        dailyTxs.forEach(t => { let n = t.operator || 'System'; if (n !== 'System' && n.includes('(')) { n = n.split('(')[0].trim(); } if(!staffMap[n]) staffMap[n] = { amt: 0, count: 0 }; staffMap[n].amt += t.amount; staffMap[n].count++; });
                        const sortedStaff = Object.entries(staffMap).sort((a,b) => b[1].amt - a[1].amt);
                        
                        const leaderboardWidget = `<div class="bg-white rounded-xl shadow-sm border p-5 animate-fadeIn flex flex-col h-full"><h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><div class="bg-orange-100 p-1.5 rounded-full text-orange-600"><i data-lucide="trophy" class="w-4 h-4"></i></div>Today's Leaders</h3><div class="space-y-3 flex-1 overflow-y-auto max-h-64 pr-1">${sortedStaff.length ? sortedStaff.map(([name, s], i) => `<div class="flex items-center justify-between p-2.5 rounded-lg border ${i===0 ? 'bg-yellow-50 border-yellow-200' : (i===1 ? 'bg-slate-50 border-slate-200' : 'bg-white border-slate-100 hover:bg-slate-50 transition')}"><div class="flex items-center gap-3"><div class="font-black ${i===0?'text-yellow-600':(i===1?'text-slate-400':(i===2?'text-orange-400':'text-slate-200'))} text-lg w-6 text-center">#${i+1}</div><div><div class="font-bold text-slate-700 text-sm leading-tight">${name}</div><div class="text-[10px] text-slate-400">${s.count} Collections</div></div></div><div class="font-mono font-bold text-indigo-700 text-sm">${Utils.currency(s.amt)}</div></div>`).join('') : `<div class="text-center text-slate-400 italic text-xs py-10 border-2 border-dashed rounded-lg">No collections recorded today.</div>`}</div></div>`;

                        const recentLogs = Data.recentHistory || [], sessionLogs = App.sessionNotifications || [];
                        const alertsHtml = `<div class="bg-white rounded-xl shadow-sm border p-5 animate-fadeIn flex flex-col h-full mt-6 lg:mt-0"><h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><div class="bg-red-100 p-1.5 rounded-full text-red-600"><i data-lucide="radio" class="w-4 h-4"></i></div>Live System Alerts</h3><div class="space-y-3 flex-1 overflow-y-auto max-h-64 pr-1">${sessionLogs.length > 0 ? sessionLogs.map(l => `<div class="p-2 border-l-4 border-blue-500 bg-blue-50 text-xs rounded-r mb-2"><div class="font-bold text-blue-700">${l.type} <span class="float-right font-normal text-blue-400">${l.time}</span></div><div class="text-slate-600">${l.details}</div></div>`).join('') : ''}${recentLogs.length > 0 ? recentLogs.map(l => `<div class="p-2 border-l-4 border-slate-300 bg-slate-50 text-xs rounded-r mb-2"><div class="font-bold text-slate-700">${l[1]} <span class="float-right font-normal text-slate-400">${new Date(l[0]).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div><div class="text-slate-500">${l[3]}</div><div class="text-[9px] text-slate-400 mt-1">By: ${l[4]}</div></div>`).join('') : '<div class="text-center text-slate-400 italic text-xs">No recent alerts.</div>'}</div></div>`;

                        const commsBar = `<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 flex justify-between items-center animate-fadeIn"><div><h3 class="font-bold text-slate-800 text-sm">Communication Center</h3><p class="text-xs text-slate-500">Send bulk announcements to members.</p></div><button onclick="App.openBroadcastModal()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-4 py-2 rounded-lg shadow hover:shadow-lg hover:from-orange-600 hover:to-red-700 transition flex items-center gap-2 text-xs font-bold"><i data-lucide="megaphone" class="w-4 h-4"></i> Broadcast Message</button></div>`;

                        h = `<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6 animate-fadeIn"><div class="bg-indigo-50 p-4 rounded shadow-sm border border-indigo-100"><p class="text-xs text-indigo-600 font-bold uppercase tracking-wider">Disbursed (Active)</p><h3 class="text-xl font-bold text-slate-800">${Utils.currency(dis)}</h3></div><div class="bg-green-50 p-4 rounded shadow-sm border border-green-100"><p class="text-xs text-green-600 font-bold uppercase tracking-wider">Principal Recovered</p><h3 class="text-xl font-bold text-green-700">${Utils.currency(col)}</h3></div><div class="bg-blue-50 p-4 rounded shadow-sm border border-blue-100"><p class="text-xs text-blue-600 font-bold uppercase tracking-wider">Savings</p><h3 class="text-xl font-bold text-blue-700">${Utils.currency(sav)}</h3></div><div class="bg-teal-50 p-4 rounded shadow-sm border border-teal-100"><p class="text-xs text-teal-600 font-bold uppercase tracking-wider">DPS Funds</p><h3 class="text-xl font-bold text-teal-700">${Utils.currency(dps)}</h3></div><div onclick="App.switchTab('fixed-deposits')" class="bg-fuchsia-50 p-4 rounded shadow-sm border border-fuchsia-200 cursor-pointer hover:border-fuchsia-400 hover:shadow-md transition group relative overflow-hidden"><div class="absolute -right-3 -top-3 opacity-10 group-hover:scale-125 group-hover:-rotate-12 transition-transform duration-500"><i data-lucide="lock" class="w-16 h-16 text-fuchsia-700"></i></div><p class="text-xs text-fuchsia-700 font-bold uppercase tracking-wider relative z-10">FD Principal</p><h3 class="text-xl font-bold text-fuchsia-800 relative z-10">${Utils.currency(fdTotal)}</h3></div><div onclick="UI.viewCashBreakdown()" class="bg-slate-800 text-white p-4 rounded shadow-lg cursor-pointer border border-slate-700 hover:bg-slate-900 transition"><p class="text-xs text-slate-300 font-bold uppercase tracking-wider">Net Cash</p><h3 class="text-xl font-bold">${Utils.currency(cash)}</h3></div></div>${commsBar}<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fadeIn mb-6"><div class="lg:col-span-1">${leaderboardWidget}</div><div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-sm border h-80"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-700 text-xs uppercase tracking-widest">Cash Flow Analysis</h3><select onchange="localStorage.setItem('mf_exp_filter_type',this.value);App.renderContent()" class="text-[10px] border rounded bg-slate-50 p-1"><option value="all">All Time</option><option value="this_month">This Month</option></select></div><div class="h-64"><canvas id="cfChart"></canvas></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6">${alertsHtml}<div class="bg-white rounded-xl shadow-sm border p-5 animate-fadeIn"><h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="history" class="w-4 h-4 text-slate-400"></i> Recent Transactions</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-xs text-slate-500 uppercase font-bold border-b"><tr><th class="p-3">Time/Date</th><th class="p-3">Name</th><th class="p-3">Type</th><th class="p-3 text-right">Amount</th></tr></thead><tbody class="divide-y divide-slate-100">${Data.transactions.slice(0,5).map(t => `<tr><td class="p-3 text-xs text-slate-500">${t.date}</td><td class="p-3 font-medium text-slate-700">${t.memberName}</td><td class="p-3"><span class="bg-slate-100 text-slate-600 text-[10px] px-2 py-0.5 rounded border">${t.category}</span></td><td class="p-3 text-right font-bold ${(t.amount>0 && t.category !== 'Penalty')?'text-green-600':'text-red-600'}">${Utils.currency(Math.abs(t.amount))}</td></tr>`).join('') || '<tr><td colspan="4" class="p-4 text-center text-slate-400 italic">No activity yet.</td></tr>'}</tbody></table></div><div class="mt-3 text-center"><button onclick="App.switchTab('transactions')" class="text-xs font-bold text-blue-600 hover:underline">View All Transactions</button></div></div></div>`;
                        
                        setTimeout(()=>{const x=document.getElementById('cfChart');if(x){if(App.chartInstance)App.chartInstance.destroy();App.chartInstance=new Chart(x,{type:'bar',data:{labels:['In','Out'],datasets:[{label:'Flow',data:[fT.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0),Math.abs(fT.filter(t=>t.amount<0&&t.category!=='Bad Debt').reduce((s,t)=>s+t.amount,0))],backgroundColor:['#22c55e','#ef4444']}]}})}},100);
                    }
                }
                
                else if(App.activeTab==='members'){
                    let filteredMembers = fM; if (App.memberFilterType !== 'all') filteredMembers = filteredMembers.filter(m => (m.accountType || 'Personal') === App.memberFilterType); if (App.memberFilterFreq !== 'all') filteredMembers = filteredMembers.filter(m => (m.savingType || 'Daily') === App.memberFilterFreq);
                    const stats = { personal: fM.filter(m => (m.accountType || 'Personal') === 'Personal').length, business: fM.filter(m => m.accountType === 'Business').length, daily: fM.filter(m => (m.savingType || 'Daily') === 'Daily').length, weekly: fM.filter(m => m.savingType === 'Weekly').length, monthly: fM.filter(m => m.savingType === 'Monthly').length };
                    const statsHtml = `<div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6 animate-fadeIn"><div class="bg-blue-50 p-3 rounded shadow-sm border border-blue-100 text-center"><p class="text-[10px] text-blue-600 font-bold uppercase tracking-wider">Personal</p><h3 class="text-xl font-bold text-slate-800">${stats.personal}</h3></div><div class="bg-indigo-50 p-3 rounded shadow-sm border border-indigo-100 text-center"><p class="text-[10px] text-indigo-600 font-bold uppercase tracking-wider">Business</p><h3 class="text-xl font-bold text-slate-800">${stats.business}</h3></div><div class="bg-emerald-50 p-3 rounded shadow-sm border border-emerald-100 text-center"><p class="text-[10px] text-emerald-600 font-bold uppercase tracking-wider">Daily</p><h3 class="text-xl font-bold text-slate-800">${stats.daily}</h3></div><div class="bg-amber-50 p-3 rounded shadow-sm border border-amber-100 text-center"><p class="text-[10px] text-amber-600 font-bold uppercase tracking-wider">Weekly</p><h3 class="text-xl font-bold text-slate-800">${stats.weekly}</h3></div><div class="bg-purple-50 p-3 rounded shadow-sm border border-purple-100 text-center"><p class="text-[10px] text-purple-600 font-bold uppercase tracking-wider">Monthly</p><h3 class="text-xl font-bold text-slate-800">${stats.monthly}</h3></div></div>`;
                    const header = UI.header(`<div class="flex items-center gap-2"><h2 class="text-xl font-bold">Members</h2><span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold border border-slate-200">${filteredMembers.length}</span></div>`, `<div class="flex flex-wrap gap-2 items-center"><div class="relative"><select onchange="App.setMemberFilterType(this.value)" class="appearance-none bg-white border text-slate-600 pl-3 pr-8 py-2 rounded text-sm focus:outline-none focus:border-blue-500 font-medium cursor-pointer"><option value="all" ${App.memberFilterType==='all'?'selected':''}>All Types</option><option value="Personal" ${App.memberFilterType==='Personal'?'selected':''}>Personal</option><option value="Business" ${App.memberFilterType==='Business'?'selected':''}>Business</option></select><i data-lucide="filter" class="absolute right-2 top-2.5 w-4 h-4 text-slate-400 pointer-events-none"></i></div><div class="relative"><select onchange="App.setMemberFilterFreq(this.value)" class="appearance-none bg-white border text-slate-600 pl-3 pr-8 py-2 rounded text-sm focus:outline-none focus:border-blue-500 font-medium cursor-pointer"><option value="all" ${App.memberFilterFreq==='all'?'selected':''}>All Frequencies</option><option value="Daily" ${App.memberFilterFreq==='Daily'?'selected':''}>Daily</option><option value="Weekly" ${App.memberFilterFreq==='Weekly'?'selected':''}>Weekly</option><option value="Monthly" ${App.memberFilterFreq==='Monthly'?'selected':''}>Monthly</option></select><i data-lucide="clock" class="absolute right-2 top-2.5 w-4 h-4 text-slate-400 pointer-events-none"></i></div><button onclick="App.openMemberModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm flex gap-2 items-center shadow hover:bg-blue-700 transition"><i data-lucide="plus" class="w-4"></i> Add</button></div>`);
                    h = `${statsHtml}${header}<div class="bg-white rounded shadow-sm border overflow-x-auto"><table class="w-full text-sm text-left border-collapse"><thead class="bg-slate-100 text-slate-600 font-bold text-xs uppercase border-b border-slate-200"><tr><th class="p-3 border-r border-slate-200 w-20">ID</th><th class="p-3 border-r border-slate-200">Name</th><th class="p-3 border-r border-slate-200">Phone</th><th class="p-3 border-r border-slate-200">Type</th><th class="p-3 border-r border-slate-200 text-center w-24">Status</th><th class="p-3 text-center w-40">Actions</th></tr></thead><tbody class="divide-y divide-slate-200">${filteredMembers.length ? filteredMembers.map(m => {
                        const txCount = Data.transactions.filter(t => t.memberName === m.name && t.loanId === 'SAVINGS').length;
                        const consolidateBtn = (App.currentUser.role === 'Admin' && txCount >= 10) ? `<button onclick="App.quickConsolidate('${m.id}', '${m.name.replace(/'/g, "\\'")}')" class="p-1.5 bg-gradient-to-br from-amber-400 to-orange-500 text-white shadow hover:shadow-lg hover:from-amber-500 hover:to-orange-600 rounded transition relative group" title="Optimize ${txCount} Records"><i data-lucide="zap" class="w-3.5 h-3.5 drop-shadow-sm"></i><span class="absolute -top-1 -right-1 flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-amber-200 border border-amber-500"></span></span></button>` : '';
                        return `<tr class="hover:bg-blue-50 transition-colors"><td class="p-2 border-r border-slate-200 font-mono text-xs text-slate-500 font-bold text-center">${m.id}</td><td class="p-2 border-r border-slate-200 font-medium text-slate-800">${m.name} ${UI.getFlagIcon(m.flag)}</td><td class="p-2 border-r border-slate-200 text-slate-600 text-xs">${m.phone}</td><td class="p-2 border-r border-slate-200 text-slate-600 text-xs">${m.accountType||'Personal'} <span class="text-[10px] text-slate-400 bg-slate-50 px-1 rounded border ml-1">${m.savingType||'Daily'}</span></td><td class="p-2 border-r border-slate-200 text-center"><span class="${m.status==='Active'?'bg-green-100 text-green-700 border-green-200':'bg-red-100 text-red-700 border-red-200'} border text-[8px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider">${m.status}</span></td><td class="p-2 text-center"><div class="flex justify-center items-center gap-1.5">${consolidateBtn}<button onclick="App.viewMemberProfile('${m.id}')" class="p-1.5 hover:bg-indigo-100 rounded text-indigo-600 transition" title="View Profile"><i data-lucide="user" class="w-3.5 h-3.5"></i></button><button onclick="Utils.sendWelcome('${m.id}')" class="p-1.5 hover:bg-green-100 rounded text-green-600 transition" title="Send Welcome"><i data-lucide="message-square" class="w-3.5 h-3.5"></i></button><button onclick="App.viewPassbook('${m.id}')" class="p-1.5 hover:bg-slate-200 rounded text-slate-500 transition" title="View Passbook"><i data-lucide="book-open" class="w-3.5 h-3.5"></i></button>${App.currentUser.role !== 'Staff' ? `<button onclick="App.editMember('${m.id}')" class="p-1.5 hover:bg-blue-100 rounded text-blue-600 transition" title="Edit"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>` : ''}${App.currentUser.role === 'Admin' ? `<button onclick="App.deleteEntity('member', '${m.id}')" class="p-1.5 hover:bg-red-100 rounded text-red-600 transition" title="Delete"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>` : ''}</div></td></tr>`
                    }).join('') : UI.empty('No members found', 6)}</tbody></table></div>`;
                }
                else if(App.activeTab==='loans'){
                    let dL=[]; if(App.loanFilter==='all')dL=[...fL]; else if(App.loanFilter==='paid')dL=fL.filter(l=>l.paid>=l.totalRepayable); else dL=fL.filter(l=>l.paid<l.totalRepayable&&l.status==='Active');
                    if(App.loanTypeFilter!=='all'){if(App.loanTypeFilter==='Product')dL=dL.filter(l=>l.category==='Product');else dL=dL.filter(l=>l.loanType===App.loanTypeFilter)}
                    
                    const calc = (arr) => ({ total: arr.length, cash: arr.filter(l=>l.category==='Cash').length, prod: arr.filter(l=>l.category==='Product').length });
                    const stT = calc(fL);
                    const stA = calc(fL.filter(l=>l.paid<l.totalRepayable&&l.status==='Active'));
                    const stC = calc(fL.filter(l=>l.paid>=l.totalRepayable));

                    const box = (t, c, s) => `<div class="bg-${c}-50 p-4 rounded shadow-sm border border-${c}-100 text-center"><p class="text-[10px] text-${c}-600 font-bold uppercase tracking-wider mb-1">${t}</p><h3 class="text-2xl font-bold text-slate-800 mb-1">${s.total}</h3><p class="text-[10px] text-slate-500 bg-white inline-block px-2 py-0.5 rounded border border-${c}-100 font-medium">Cash: <b class="text-slate-700">${s.cash}</b> ‚Ä¢ Prod: <b class="text-slate-700">${s.prod}</b></p></div>`;
                    
                    const stats = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 animate-fadeIn">${box('Total Disbursed','purple',stT)}${box('Active','red',stA)}${box('Collected','green',stC)}</div>`;
                    
                    const hd=`<div class="flex flex-col md:flex-row justify-between mb-4 gap-3 items-end md:items-center"><div class="flex items-center gap-3"><h2 class="text-xl font-bold">Loans</h2><button onclick="App.openAssistant()" class="bg-indigo-100 text-indigo-700 p-1.5 rounded-full hover:bg-indigo-200 transition shadow-sm" title="Loan Assistant"><i data-lucide="bot" class="w-5 h-5"></i></button></div><div class="flex flex-wrap gap-2 items-center"><div class="relative"><select onchange="App.setLoanFilter(this.value)" class="appearance-none bg-white border text-slate-600 pl-3 pr-8 py-2 rounded text-sm focus:outline-none focus:border-blue-500 font-medium"><option value="active" ${App.loanFilter==='active'?'selected':''}>Active Only</option><option value="all" ${App.loanFilter==='all'?'selected':''}>All</option><option value="paid" ${App.loanFilter==='paid'?'selected':''}>Paid</option></select><i data-lucide="filter" class="absolute right-2 top-2.5 w-4 h-4 text-slate-400 pointer-events-none"></i></div><div class="relative"><select onchange="App.setLoanTypeFilter(this.value)" class="appearance-none bg-white border text-slate-600 pl-3 pr-8 py-2 rounded text-sm focus:outline-none focus:border-blue-500 font-medium"><option value="all" ${App.loanTypeFilter==='all'?'selected':''}>All Types</option><option value="Daily" ${App.loanTypeFilter==='Daily'?'selected':''}>Daily</option><option value="Weekly" ${App.loanTypeFilter==='Weekly'?'selected':''}>Weekly</option><option value="Monthly" ${App.loanTypeFilter==='Monthly'?'selected':''}>Monthly</option><option value="Product" ${App.loanTypeFilter==='Product'?'selected':''}>Product</option></select><i data-lucide="tag" class="absolute right-2 top-2.5 w-4 h-4 text-slate-400 pointer-events-none"></i></div><button onclick="App.openNewLoanModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm flex gap-2 items-center hover:bg-blue-700 transition shadow-sm"><i data-lucide="plus" class="w-4 h-4"></i> New</button></div></div>`;
                    h=`${stats}${hd}${dL.length===0?'<div class="text-center p-8 text-slate-400 italic border-2 border-dashed rounded-xl">No loans.</div>':''}<div class="grid gap-3">${dL.map(l=>{const mem=Data.members.find(m=>m.id===l.memberId); const p=l.paid>=l.totalRepayable,r=l.status==='Refinanced',w=l.status==='Written Off',bg=w?'<span class="bg-red-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase ml-2">Written Off</span>':(r?'<span class="bg-slate-500 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase ml-2">Refinanced</span>':'');let act='';if(!w&&!r)act=`<button onclick="App.viewSchedule('${l.id}')" class="bg-slate-100 p-2 rounded text-slate-600 hover:text-blue-600" title="Schedule"><i data-lucide="calendar" class="w-4 h-4"></i></button><button onclick="App.viewLoanHistory('${l.id}')" class="bg-slate-100 p-2 rounded text-slate-600 hover:text-blue-600" title="History"><i data-lucide="history" class="w-4 h-4"></i></button>`;if(!p&&l.status==='Active'){act+=`${App.currentUser.role!=='Staff'?`<button onclick="App.openRefinanceModal('${l.id}')" class="bg-indigo-50 p-2 rounded text-indigo-600 hover:bg-indigo-100"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>`:''}<button onclick="UI.openTransactionModal('${l.id}','Collection','Collect')" class="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-green-700">Collect</button>${App.currentUser.role!=='Staff'?`<button onclick="App.editLoan('${l.id}')" class="text-blue-500 p-2 hover:bg-blue-50 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="App.handleWriteOff('${l.id}')" class="text-red-400 p-2 hover:bg-red-50 hover:text-red-600 rounded"><i data-lucide="skull" class="w-4 h-4"></i></button>`:''}`}else{if(p&&!w&&!r&&App.currentUser.role!=='Staff')act+=`<button onclick="App.executeArchiveLoan('${l.id}',false)" class="bg-teal-50 text-teal-700 px-2 py-1 rounded text-xs font-bold hover:bg-teal-100 border border-teal-200">Archive</button>`;if(r&&Data.loans.find(n=>n.refNo===`Ref-${l.id}`))act+=`<button onclick="App.viewLoanHistory('${Data.loans.find(n=>n.refNo===`Ref-${l.id}`).id}')" class="text-teal-600 p-2 hover:bg-teal-50 rounded font-bold"><i data-lucide="arrow-right-circle" class="w-4 h-4"></i></button>`;if(App.currentUser.role==='Admin')act+=`<button onclick="App.deleteEntity('loan','${l.id}')" class="text-red-500 p-2 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`} return `<div class="bg-white p-4 rounded shadow-sm border flex flex-col md:flex-row justify-between items-center gap-4 animate-fadeIn ${w?'opacity-60 grayscale':''} ${r?'bg-slate-50 opacity-75':''}"><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="bg-indigo-100 text-indigo-700 text-xs px-2 rounded font-mono font-bold border border-indigo-200">${l.id}</span><h3 class="font-bold">${l.memberName} ${UI.getFlagIcon(mem?.flag)}</h3>${l.category==='Product'&&l.productName?`<span class="bg-purple-100 text-purple-700 text-[10px] px-2 rounded font-bold">${l.productName}</span>`:''}${bg}</div><div class="text-sm text-slate-500"><span class="font-bold text-blue-600 uppercase text-xs mr-1">${l.loanType}</span>${l.disbursementDate ? `<span class="text-xs mr-1 text-slate-400">(${l.disbursementDate})</span>` : ''} ‚Ä¢ Prin: ${Utils.currency(l.principal)} ‚Ä¢ Rate: ${l.rate}% ‚Ä¢ <b>Total: ${Utils.currency(l.totalRepayable)}</b> <span class="bg-yellow-100 text-yellow-800 text-[10px] px-1.5 py-0.5 rounded border border-yellow-200 ml-1">Ref: ${l.refNo||'N/A'}</span></div></div><div class="w-full md:w-32 text-center"><div class="text-xs mb-1">Paid: ${Math.round((l.paid/l.totalRepayable)*100)}%</div><div class="w-full bg-slate-100 h-2 rounded"><div class="h-2 ${w?'bg-red-400':'bg-blue-600'} rounded" style="width:${Math.min(100,(l.paid/l.totalRepayable)*100)}%"></div></div></div><div class="flex gap-2 items-center">${act}</div></div>`}).join('')}</div>`;
                }
                else if(App.activeTab === 'fixed-deposits'){
                    const allFds = Data.fixedDeposits.filter(sf);
                    const activeVal = allFds.filter(f=>f.status==='Active').reduce((s,f)=>s+f.principal, 0);
                    const displayFds = App.showClosedFDs ? allFds : allFds.filter(f => f.status === 'Active');
                    const toggleBtn = `<button onclick="App.toggleClosedFDs()" class="bg-white text-slate-500 border border-slate-200 px-3 py-1.5 rounded text-xs hover:bg-slate-50 hover:text-slate-700 flex gap-1 items-center transition shadow-sm"><i data-lucide="${App.showClosedFDs ? 'eye-off' : 'eye'}" class="w-3 h-3"></i> ${App.showClosedFDs ? 'Hide Closed' : 'Show Closed'}</button>`;
                    const hd = UI.header(`<div class="flex items-center gap-2"><h2 class="text-xl font-bold">Fixed Deposits</h2><span class="bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full text-xs font-bold border border-indigo-200">${displayFds.length}</span></div>`, `<div class="flex gap-2">${toggleBtn}<button onclick="App.openFDModal()" class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs shadow hover:bg-indigo-700 flex gap-1 items-center"><i data-lucide="plus" class="w-3 h-3"></i> New FD</button></div>`);
                    const stats = `<div class="bg-white p-4 rounded shadow-sm border border-indigo-100 mb-6 flex justify-between items-center"><div class="flex items-center gap-4"><div class="bg-indigo-50 p-3 rounded-full text-indigo-600"><i data-lucide="lock" class="w-6 h-6"></i></div><div><p class="text-xs text-slate-500 uppercase font-bold">Total Active Principal</p><h3 class="text-2xl font-bold text-slate-800">${Utils.currency(activeVal)}</h3></div></div><div class="text-right text-xs text-slate-400"><p>Active: ${allFds.filter(f=>f.status==='Active').length}</p><p>Closed: ${allFds.filter(f=>f.status==='Closed').length}</p></div></div>`;
                    const grid = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${displayFds.length ? displayFds.map(fd => {
                        const isClosed = fd.status === 'Closed';
                        let closingInfo = '', closingLink = '';
                        if (isClosed) {
                            const closingEntry = (fd.interestHistory || []).find(h => h.type === 'Closing');
                            if (closingEntry && closingEntry.link) { closingLink = closingEntry.link; closingInfo = `<a href="${closingLink}" target="_blank" class="bg-red-50 text-red-600 px-3 py-1 rounded text-xs font-bold hover:bg-red-100 flex items-center gap-1 shadow-sm"><i data-lucide="file-text" class="w-3 h-3"></i> View Report</a>`; } 
                            else { closingInfo = `<span class="text-[10px] text-slate-400 self-center">Paid (Tx: ${closingEntry ? closingEntry.txId : (fd.payoutTxID || '-')})</span>`; }
                        }
                        return `<div class="bg-white p-4 rounded shadow border hover:border-indigo-300 transition relative overflow-hidden ${isClosed ? 'opacity-75 bg-slate-50' : ''}">${isClosed ? '<div class="absolute top-2 right-2 bg-slate-200 text-slate-500 text-[10px] px-2 py-0.5 rounded font-bold uppercase">Closed</div>' : '<div class="absolute top-2 right-2 bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase">Active</div>'}<div class="mb-3"><div class="text-xs text-slate-400 font-mono mb-1">ID: ${fd.id}</div><h3 class="font-bold text-lg text-slate-800">${fd.memberName}</h3><div class="text-xs text-slate-500 mt-1">Principal: <span class="font-bold text-slate-700">${Utils.currency(fd.principal)}</span></div></div><div class="grid grid-cols-2 gap-2 text-xs bg-slate-50 p-2 rounded border border-slate-100 mb-3"><div><span class="block text-slate-400">Rate</span><span class="font-bold">${fd.rate}%</span></div><div><span class="block text-slate-400">Maturity</span><span class="font-bold text-blue-600">${fd.maturityDate}</span></div><div class="col-span-2 border-t pt-1 mt-1 flex justify-between"><span class="text-slate-400">Maturity Value</span><span class="font-bold text-green-700">${Utils.currency(fd.maturityAmount)}</span></div></div><div class="flex justify-end gap-2 border-t pt-3 border-dashed">${!isClosed && fd.frequency === 'Monthly' ? `<button onclick="App.payFDInterest('${fd.id}')" class="text-blue-600 hover:text-blue-800 bg-blue-50 p-1.5 rounded text-xs font-bold mr-auto">Pay Interest</button>` : ''} ${fd.frequency === 'Monthly' ? `<button onclick="App.viewFDInterestHistory('${fd.id}')" class="text-slate-500 hover:text-blue-600 p-1.5 rounded hover:bg-slate-100 transition" title="Interest History"><i data-lucide="history" class="w-4 h-4"></i></button>` : ''} <button onclick="App.generateFDCertificate(Data.fixedDeposits.find(x=>x.id=='${fd.id}'))" class="text-slate-500 hover:text-blue-600 p-1.5 rounded hover:bg-slate-100 transition" title="Certificate"><i data-lucide="award" class="w-4 h-4"></i></button> ${!isClosed ? `<button onclick="App.closeFD('${fd.id}')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-indigo-700 shadow-sm">Payout / Close</button>` : closingInfo}</div></div>`; }).join('') : UI.empty('No Fixed Deposits found.', 3)}</div>`;
                    h = stats + hd + grid;
                }
                else if(App.activeTab==='group'){
                    const g = Data.groups.filter(x => x.status !== 'Archived');
                    const hd=UI.header(`<div class="flex items-center gap-2"><h2 class="text-xl font-bold">Groups</h2><span class="bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full text-xs font-bold">${g.length}</span></div>`,`<button onclick="App.openGroupModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs shadow hover:bg-blue-700 flex gap-1 items-center"><i data-lucide="plus" class="w-3 h-3"></i> Create</button>`);
                    h=`${hd}<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${g.length?g.map(x=>{
                        const st=Logic.getGroupStatus(x,'loan'), c=x.memberIDs.length, h=x.history.length, d=c*x.contribution, cmp=x.status==='Completed'||h>=c;
                        return `<div class="bg-white p-4 rounded shadow border hover:border-blue-300 transition"><div class="flex justify-between items-start mb-3"><div><div class="flex items-center gap-2 mb-1"><h3 class="font-bold">${x.name}</h3>${!cmp?st.badge:''}</div><div class="text-xs text-slate-500 font-mono">${x.frequency} ‚Ä¢ ${Utils.currency(x.contribution)}</div></div><div class="flex items-center gap-2">${App.currentUser.role!=='Staff'?`<button onclick="App.initGroupEdit('${x.id}')" class="text-slate-400 hover:text-blue-600 p-1" title="Edit"><i data-lucide="pencil" class="w-4 h-4"></i></button>`:''}<span class="${cmp?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700'} text-[10px] px-2 py-1 rounded font-bold h-fit uppercase">${cmp?'DONE':'ACTIVE'}</span></div></div><div class="mb-3"><div class="flex justify-between text-xs mb-1 font-bold text-slate-500"><span>Progress</span><span>${h}/${c}</span></div><div class="w-full bg-slate-100 h-1.5 rounded-full"><div class="bg-blue-600 h-full rounded-full" style="width:${(h/c)*100}%"></div></div></div><div class="flex justify-end gap-2 pt-3 border-t border-dashed">${!cmp?`<button onclick="App.checkGroupRisk('${x.id}')" class="bg-orange-50 text-orange-600 px-2 py-1 rounded text-xs font-bold">Check</button><button ${st.canRun?`onclick="App.runGroupCycle('${x.id}')"`:'disabled'} class="${st.canRun?'bg-indigo-600 text-white':'bg-slate-200 text-slate-400'} px-3 py-1 rounded text-xs font-bold">Run Cycle</button>`:`<span class="text-green-600 text-xs font-bold mr-auto flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> Completed</span><button onclick="App.archiveGroup('${x.id}')" class="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold hover:bg-slate-700 flex items-center gap-1 shadow"><i data-lucide="archive" class="w-3 h-3"></i> Archive</button>`}<button onclick="App.viewGroupLoanHistory('${x.id}')" class="text-slate-500 hover:text-blue-600"><i data-lucide="history" class="w-4 h-4"></i></button>${App.currentUser.role==='Admin'?`<button onclick="App.deleteGroup('${x.id}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}</div></div>`
                    }).join(''):UI.empty('No groups',3)}</div>`;
                }
                else if(App.activeTab==='savings'){
                    const sM = fM.filter(m => m.status === 'Active');
                    const totalSav = sM.reduce((s,m) => s + m.savingsBalance, 0);
                    const todayCol = fT.filter(t => t.date === Utils.dateToday() && t.loanId === 'SAVINGS' && t.amount > 0).reduce((s,t) => s + t.amount, 0);
                    const todayWit = Math.abs(fT.filter(t => t.date === Utils.dateToday() && t.loanId === 'SAVINGS' && t.amount < 0).reduce((s,t) => s + t.amount, 0));

                    const stats = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 animate-fadeIn"><div class="bg-blue-50 p-4 rounded shadow-sm border border-blue-100 flex justify-between items-center"><div><p class="text-xs text-blue-600 font-bold uppercase tracking-wider">Total Savings</p><h3 class="text-2xl font-bold text-slate-800">${Utils.currency(totalSav)}</h3></div><div class="bg-blue-100 p-2 rounded-full text-blue-600"><i data-lucide="wallet" class="w-6 h-6"></i></div></div><div class="bg-green-50 p-4 rounded shadow-sm border border-green-100 flex justify-between items-center"><div><p class="text-xs text-green-600 font-bold uppercase tracking-wider">Collected Today</p><h3 class="text-2xl font-bold text-green-700">${Utils.currency(todayCol)}</h3></div><div class="bg-green-100 p-2 rounded-full text-green-600"><i data-lucide="arrow-down-circle" class="w-6 h-6"></i></div></div><div class="bg-red-50 p-4 rounded shadow-sm border border-red-100 flex justify-between items-center"><div><p class="text-xs text-red-600 font-bold uppercase tracking-wider">Withdrawn Today</p><h3 class="text-2xl font-bold text-red-700">${Utils.currency(todayWit)}</h3></div><div class="bg-red-100 p-2 rounded-full text-red-600"><i data-lucide="arrow-up-circle" class="w-6 h-6"></i></div></div></div>`;

                    const hd = UI.header(`<div class="flex items-center gap-2"><h2 class="text-xl font-bold">Savings Accounts</h2><span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-bold border border-blue-200">${sM.length}</span></div>`, `<div class="flex gap-2"><button onclick="App.openAssistant('savings')" class="bg-white border text-slate-600 px-3 py-1.5 rounded text-xs hover:bg-slate-50 flex gap-2 items-center"><i data-lucide="bot" class="w-4 h-4"></i> Assistant</button><button onclick="UI.openTransactionModal('SAVINGS', 'Deposit', 'Quick Deposit')" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs shadow hover:bg-blue-700 flex gap-2 items-center"><i data-lucide="plus" class="w-4 h-4"></i> Quick Deposit</button></div>`);

                    const table = `<div class="bg-white rounded shadow-sm border overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b text-slate-500 font-bold text-xs uppercase"><tr><th class="p-3">Member</th><th class="p-3 text-right">Balance</th><th class="p-3 text-center">Last Activity</th><th class="p-3 text-center">Actions</th></tr></thead><tbody class="divide-y divide-slate-100">${sM.map(m => {
                        const lastTx = Data.transactions.find(t => t.memberName === m.name && t.loanId === 'SAVINGS');
                        return `<tr class="hover:bg-slate-50"><td class="p-3"><div class="font-bold text-slate-800">${m.name} ${UI.getFlagIcon(m.flag)}</div><div class="text-xs text-slate-500 font-mono">${m.id}</div></td><td class="p-3 text-right font-bold text-slate-700 font-mono">${Utils.currency(m.savingsBalance)}</td><td class="p-3 text-center text-xs text-slate-500">${lastTx ? lastTx.date : '-'}</td><td class="p-3 text-center"><div class="flex justify-center gap-2"><button onclick="App.openSavingsAction('Deposit','${m.name}')" class="bg-green-100 text-green-700 p-1.5 rounded hover:bg-green-200 font-bold text-[10px] uppercase">In</button><button onclick="App.openSavingsAction('Withdrawal','${m.name}')" class="bg-red-100 text-red-700 p-1.5 rounded hover:bg-red-200 font-bold text-[10px] uppercase">Out</button><button onclick="App.viewPassbook('${m.id}')" class="bg-slate-100 text-slate-600 p-1.5 rounded hover:bg-slate-200" title="Passbook"><i data-lucide="book-open" class="w-4 h-4"></i></button></div></td></tr>`;
                    }).join('')}</tbody></table></div>`;

                    h = stats + hd + table;
                }
                else if(App.activeTab==='group-dps'){
                    const d=Data.groupDPS;
                    const hd=UI.header(`<div class="flex items-center gap-2"><h2 class="text-xl font-bold">DPS Groups</h2><span class="bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full text-xs font-bold">${d.length}</span></div>`,`<div class="flex gap-2"><button onclick="App.viewGlobalDPSReport()" class="bg-white border text-slate-700 px-3 py-1.5 rounded text-xs flex gap-2 items-center hover:bg-slate-50">Members</button><button onclick="App.openGroupDPSModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs shadow hover:bg-blue-700 flex gap-1 items-center"><i data-lucide="plus" class="w-3 h-3"></i> Create</button></div>`);
                    h=`${hd}<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${d.length?d.map(x=>{
                        const st=Logic.getGroupStatus(x,'dps'), tc=Logic.getDPSTotalCollected(x.id), md=Logic.calculateDPSMaturity(x), tp=Math.min(100,Math.max(0,((new Date()-Utils.parseDate(x.startDate))/(md-Utils.parseDate(x.startDate)))*100));
                        return `<div class="bg-white p-4 rounded shadow border hover:border-indigo-300 transition"><div class="flex justify-between mb-3"><div><div class="flex items-center gap-2 mb-1"><h3 class="font-bold">${x.name}</h3>${st.badge}</div><div class="text-xs text-slate-500 font-mono">${x.frequency} ‚Ä¢ ${x.memberIDs.length} Mem</div></div><div class="flex gap-2">${App.currentUser.role!=='Staff'?`<button onclick="App.openGroupDPSModal(Data.groupDPS.find(z=>z.id=='${x.id}'))" class="text-slate-400 hover:text-blue-600"><i data-lucide="pencil" class="w-4 h-4"></i></button>`:''}${App.currentUser.role==='Admin'?`<button onclick="App.deleteGroupDPS('${x.id}')" class="text-slate-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}</div></div><div class="grid grid-cols-2 gap-4 mb-4 text-xs"><div class="bg-slate-50 p-2 rounded"><span class="block text-slate-400 font-bold">Contrib</span><span class="font-bold text-slate-700">${Utils.currency(x.contribution)}</span></div><div class="bg-indigo-50 p-2 rounded"><span class="block text-indigo-400 font-bold">Fund</span><span class="font-bold text-indigo-700">${Utils.currency(tc)}</span></div></div><div class="mb-2"><div class="flex justify-between text-xs mb-1 font-bold text-slate-500"><span>Maturity</span><span>${md.toLocaleDateString()}</span></div><div class="w-full bg-slate-100 h-1.5 rounded-full"><div class="bg-green-500 h-full rounded-full" style="width:${tp}%"></div></div></div><div class="flex justify-between items-center pt-3 border-t border-dashed"><button onclick="App.viewGroupDPSHistory('${x.id}')" class="text-indigo-600 text-xs font-bold hover:underline">History</button><div class="flex gap-2"><button onclick="App.checkGroupDPSRisk('${x.id}')" class="bg-orange-50 text-orange-700 px-2 py-1 rounded text-xs font-bold">Status</button><button ${st.canRun?`onclick="App.runDPSBatch('${x.id}')"`:'disabled'} class="${st.canRun?'bg-indigo-600 text-white':'bg-slate-200 text-slate-400'} px-3 py-1 rounded text-xs font-bold">Run</button></div></div></div>`
                    }).join(''):UI.empty('No DPS',3)}</div>`;
                }
                else if(App.activeTab==='sales'){
                    const aP=[...fL].filter(l=>l.category==='Product');
                    const gt=aP.reduce((a,l)=>{const dp=Data.transactions.find(t=>t.loanId===l.id&&t.category==='Down Payment'),d=dp?Math.abs(dp.amount):0;a.p+=l.totalRepayable+d;a.d+=d;a.c+=l.paid;a.u+=(l.totalRepayable-l.paid);return a},{p:0,d:0,c:0,u:0});
                    const stats=`<div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 animate-fadeIn"><div class="bg-white p-4 rounded shadow border border-slate-100"><p class="text-xs text-slate-500 font-bold uppercase">Total Payable</p><h3 class="text-xl font-bold text-slate-800">${Utils.currency(gt.p)}</h3></div><div class="bg-white p-4 rounded shadow border border-slate-100"><p class="text-xs text-slate-500 font-bold uppercase">Total DP Collected</p><h3 class="text-xl font-bold text-green-600">${Utils.currency(gt.d)}</h3></div><div class="bg-white p-4 rounded shadow border border-slate-100"><p class="text-xs text-slate-500 font-bold uppercase">EMI Collected</p><h3 class="text-xl font-bold text-blue-600">${Utils.currency(gt.c)}</h3></div><div class="bg-white p-4 rounded shadow border border-slate-100"><p class="text-xs text-slate-500 font-bold uppercase">Total Outstanding</p><h3 class="text-xl font-bold text-red-600">${Utils.currency(gt.u)}</h3></div></div>`;
                    h=`${stats}${UI.header(`<div class="flex gap-2 items-center"><h2 class="text-xl font-bold">Product Sales</h2><div class="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold">${aP.length}</div></div>`,`<button onclick="App.openNewLoanModal()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs flex gap-2 items-center shadow hover:bg-blue-700"><i data-lucide="plus" class="w-3 h-3"></i> New Sale</button>`)}<div class="bg-white rounded shadow-sm border overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b whitespace-nowrap text-xs uppercase text-slate-500"><tr><th class="p-3">Invoice</th><th class="p-3">Cust ID</th><th class="p-3">Customer</th><th class="p-3">Product</th><th class="p-3 text-right">Total</th><th class="p-3 text-right">Profit</th><th class="p-3 text-right">DP</th><th class="p-3 text-right">Paid</th><th class="p-3 text-right">Due</th><th class="p-3 text-center">Act</th></tr></thead><tbody id="sales-list">${aP.length===0?UI.empty('No sales.',10):aP.map(l=>{const dt=Data.transactions.find(t=>t.loanId===l.id&&t.category==='Down Payment'),d=dt?Math.abs(dt.amount):0,tp=l.totalRepayable+d,i=l.totalRepayable-l.principal,du=l.totalRepayable-l.paid;return`<tr class="border-b hover:bg-slate-50 whitespace-nowrap"><td class="p-3 font-mono text-xs text-slate-500">${l.id}</td><td class="p-3 font-mono text-xs text-slate-500">${l.memberId}</td><td class="p-3 font-medium text-slate-700">${l.memberName}</td><td class="p-3 font-bold text-slate-800">${l.productName}</td><td class="p-3 text-right font-medium">${Utils.currency(tp)}</td><td class="p-3 text-right text-xs text-slate-400">+${Utils.currency(i)}</td><td class="p-3 text-right text-green-600 text-xs">${Utils.currency(d)}</td><td class="p-3 text-right text-blue-600 text-xs font-bold">${Utils.currency(l.paid)}</td><td class="p-3 text-right text-red-600 font-bold">${Utils.currency(du)}</td><td class="p-3 text-center"><button onclick="App.viewLoanHistory('${l.id}')" class="text-blue-500 hover:text-blue-700 text-xs underline">View</button></td></tr>`}).join('')}</tbody></table></div>`;
                }
                else if(App.activeTab==='inventory'){
                    const inv = Data.inventory.filter(sf);
                    const totalVal = inv.reduce((s,i)=>s+(i.buyPrice*i.stock),0);
                    const lowStock = inv.filter(i=>i.stock<=i.minStock).length;
                    
                    const stats = `<div class="grid grid-cols-2 gap-4 mb-6"><div class="bg-purple-50 p-3 rounded border border-purple-100 flex justify-between items-center"><div><p class="text-xs text-purple-600 font-bold uppercase">Inventory Value</p><h3 class="text-xl font-bold text-purple-800">${Utils.currency(totalVal)}</h3></div><div class="bg-purple-100 p-2 rounded-full text-purple-600"><i data-lucide="package" class="w-5 h-5"></i></div></div><div class="bg-red-50 p-3 rounded border border-red-100 flex justify-between items-center"><div><p class="text-xs text-red-600 font-bold uppercase">Low Stock Alerts</p><h3 class="text-xl font-bold text-red-700">${lowStock}</h3></div><div class="bg-red-100 p-2 rounded-full text-red-600"><i data-lucide="alert-circle" class="w-5 h-5"></i></div></div></div>`;
                    
                    const header = UI.header(`<div class="flex items-center gap-2"><h2 class="text-xl font-bold">Inventory</h2><span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold border border-slate-200">${inv.length}</span></div>`, `<button onclick="App.openProductModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs shadow hover:bg-blue-700 flex gap-1 items-center"><i data-lucide="plus" class="w-3 h-3"></i> Add Product</button>`);
                    
                    const table = `<div class="bg-white rounded shadow-sm border overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b text-slate-500 font-bold text-xs uppercase"><tr><th class="p-3">Product Name</th><th class="p-3">Category</th><th class="p-3 text-right">Buy Price</th><th class="p-3 text-right">Sell Price</th><th class="p-3 text-center">Stock</th><th class="p-3 text-right">Total Value</th><th class="p-3 text-center">Action</th></tr></thead><tbody class="divide-y divide-slate-100">${inv.length?inv.map(i=>{const isLow=i.stock<=i.minStock; return `<tr class="hover:bg-slate-50"><td class="p-3 font-medium text-slate-800">${i.name}</td><td class="p-3"><span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded border">${i.category||'General'}</span></td><td class="p-3 text-right font-mono text-xs text-slate-500">${Utils.currency(i.buyPrice)}</td><td class="p-3 text-right font-mono font-bold text-green-600">${Utils.currency(i.sellPrice)}</td><td class="p-3 text-center"><span class="${isLow?'bg-red-100 text-red-700':'bg-green-100 text-green-700'} px-2 py-1 rounded font-bold text-xs">${i.stock}</span></td><td class="p-3 text-right font-mono font-bold text-slate-700">${Utils.currency(i.stock*i.buyPrice)}</td><td class="p-3 text-center flex justify-center gap-2"><button onclick="App.openProductModal(Data.inventory.find(x=>x.id=='${i.id}'))" class="text-blue-500 hover:bg-blue-50 p-1.5 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="App.deleteProduct('${i.id}')" class="text-red-500 hover:bg-red-50 p-1.5 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`}).join(''):UI.empty('No products in inventory',7)}</tbody></table></div>`;
                    
                    h = stats + header + table;
                }
                else if(App.activeTab==='income'){
                    if(App.currentUser.role === 'Staff'){ h='<div class="text-center p-8 text-slate-400 italic">Access Denied</div>'; } else {
                        
                        // --- NAVIGATION & HEADER ---
                        const subNav = `<div class="flex bg-slate-100 p-1 rounded-lg mb-4 w-fit">
                            <button onclick="App.setIncomeSubTab('performance')" class="px-4 py-1.5 rounded-md text-xs font-bold transition ${App.incomeSubTab === 'performance' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">Source Profitability (One Row)</button>
                            <button onclick="App.setIncomeSubTab('ledger')" class="px-4 py-1.5 rounded-md text-xs font-bold transition ${App.incomeSubTab === 'ledger' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">General Ledger</button>
                        </div>`;

                        const mainHeader = UI.header(`<div class="flex flex-col gap-1">
                            <div class="flex items-center gap-2"><h2 class="text-xl font-bold">Income & Revenue</h2><span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold border border-slate-200">FY ${new Date().getFullYear()}</span></div>
                            ${subNav}
                        </div>`, 
                        `<div class="flex gap-2">
                            <button onclick="UI.openTransactionModal('OFFICE', 'Other Income', 'Record Other Income')" class="bg-emerald-600 text-white px-4 py-2 rounded text-sm flex gap-2 items-center shadow hover:bg-emerald-700 transition"><i data-lucide="plus-circle" class="w-4 h-4"></i> Other Income</button>
                        </div>`);

                        // --- VIEW 1: GENERAL LEDGER ---
                        if (App.incomeSubTab === 'ledger') {
                            // 1. BUILD FULL DATASET
                            let totalInterest = 0, totalPenalties = 0, totalMargin = 0, totalOther = 0;
                            const fullIncomeList = [];
                            const processedIds = new Set();

                            // A. Active Ledger (Transactions)
                            Data.transactions.forEach(t => {
                                if (t.category === 'Penalty') {
                                    fullIncomeList.push({ date: t.date, type: 'Penalty', desc: t.collectedBy || 'Penalty', amount: t.amount, id: t.id, rawDate: t.date });
                                    processedIds.add(t.id);
                                    totalPenalties += t.amount;
                                } else if (t.category === 'Other Income') {
                                    fullIncomeList.push({ date: t.date, type: 'Other', desc: t.collectedBy || 'Other Income', amount: t.amount, id: t.id, rawDate: t.date });
                                    processedIds.add(t.id);
                                    totalOther += t.amount;
                                } else if (t.category === 'Collection') {
                                    const loan = Data.loans.find(l => l.id === t.loanId);
                                    if(loan && loan.totalRepayable > 0) {
                                        const interestRatio = (loan.totalRepayable - loan.principal) / loan.totalRepayable;
                                        const interestPortion = Math.abs(t.amount) * interestRatio;
                                        if(interestPortion > 0.01) {
                                            fullIncomeList.push({ date: t.date, type: 'Loan Interest (Active)', desc: `From ${loan.memberName} (${loan.id})`, amount: interestPortion, id: `INT-${t.id}`, rawDate: t.date });
                                            totalInterest += interestPortion;
                                        }
                                    }
                                } else if (t.category === 'Disbursement') {
                                    const loan = Data.loans.find(l => l.id === t.loanId);
                                    if(loan && loan.category === 'Product') {
                                        const invItem = Data.inventory.find(i => i.id === loan.productId || (i.name && loan.productName && i.name.toLowerCase().trim() === loan.productName.toLowerCase().trim()));
                                        if(invItem) {
                                            const dpTx = Data.transactions.find(tx => tx.loanId === loan.id && tx.category === 'Down Payment');
                                            const dpAmount = dpTx ? Math.abs(dpTx.amount) : 0;
                                            const margin = (loan.principal + dpAmount) - invItem.buyPrice;
                                            if(margin > 0) {
                                                fullIncomeList.push({ date: t.date, type: 'Product Margin', desc: `Sale: ${loan.productName}`, amount: margin, id: `MRG-${t.id}`, rawDate: t.date });
                                                totalMargin += margin;
                                            }
                                        }
                                    }
                                }
                            });

                            // B. Archived/Manual Income
                            Data.income.forEach(i => {
                                if (processedIds.has(i.id)) return; 
                                
                                if (i.reason === 'Archive Summary') {
                                    // Loan or Group Summary
                                    fullIncomeList.push({ date: i.date, type: i.sourceType || 'Summary', desc: `${i.memberName} (Merged)`, amount: i.amount, id: i.id, rawDate: i.date });
                                    
                                    // Parsing
                                    if (i.sourceType === 'Loan Profit') {
                                        const parts = i.remarks.match(/Int:(\d+) Mrg:(\d+) Pen:(\d+)/);
                                        if (parts) { totalInterest += Number(parts[1]); totalMargin += Number(parts[2]); totalPenalties += Number(parts[3]); }
                                        else totalInterest += i.amount;
                                    } else {
                                        totalPenalties += i.amount; // Assume Group Income is penalty driven
                                    }
                                    return;
                                }
                                
                                // ... existing archived items logic ...
                                if (i.reason === 'Archived Realized Interest') {
                                    fullIncomeList.push({ date: i.date, type: 'Loan Interest (Archived)', desc: i.remarks, amount: i.amount, id: i.id, rawDate: i.date });
                                    totalInterest += i.amount;
                                } else if (i.reason === 'Archived Product Margin') {
                                    fullIncomeList.push({ date: i.date, type: 'Product Margin (Archived)', desc: i.remarks, amount: i.amount, id: i.id, rawDate: i.date });
                                    totalMargin += i.amount;
                                } else if (i.sourceType === 'Other' || i.reason === 'Other Income') {
                                    fullIncomeList.push({ date: i.date, type: 'Other', desc: i.remarks || i.reason, amount: i.amount, id: i.id, rawDate: i.date });
                                    totalOther += i.amount;
                                } else {
                                    if (i.reason !== 'Archived Realized Interest') {
                                        fullIncomeList.push({ date: i.date, type: 'Penalty', desc: `${i.reason} - ${i.memberName}`, amount: i.amount, id: i.id, rawDate: i.date });
                                        totalPenalties += i.amount;
                                    }
                                }
                            });

                            // 2. FILTER & SORT
                            const tm = App.searchTerm;
                            const filteredList = fullIncomeList.filter(item => !tm || item.type.toLowerCase().includes(tm) || item.desc.toLowerCase().includes(tm) || item.date.includes(tm) || String(item.amount).includes(tm));
                            filteredList.sort((a,b) => (a.rawDate > b.rawDate ? -1 : (a.rawDate < b.rawDate ? 1 : 0)));
                            
                            const totalIncome = totalInterest + totalPenalties + totalMargin + totalOther;
                            const stats = `<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 animate-fadeIn">
                                <div class="bg-emerald-50 p-4 rounded shadow-sm border border-emerald-100"><p class="text-xs text-emerald-600 font-bold uppercase">Total Income</p><h3 class="text-2xl font-bold text-emerald-700">${Utils.currency(totalIncome)}</h3></div>
                                <div class="bg-blue-50 p-4 rounded shadow-sm border border-blue-100"><p class="text-xs text-blue-600 font-bold uppercase">Loan Interest</p><h3 class="text-2xl font-bold text-slate-800">${Utils.currency(totalInterest)}</h3><p class="text-[10px] text-blue-400">Realized + Archived</p></div>
                                <div class="bg-purple-50 p-4 rounded shadow-sm border border-purple-100"><p class="text-xs text-purple-600 font-bold uppercase">Product Margins</p><h3 class="text-2xl font-bold text-slate-800">${Utils.currency(totalMargin)}</h3><p class="text-[10px] text-purple-400">Est. from Sales</p></div>
                                <div class="bg-red-50 p-4 rounded shadow-sm border border-red-100"><p class="text-xs text-red-600 font-bold uppercase">Fines / Other</p><h3 class="text-2xl font-bold text-slate-800">${Utils.currency(totalPenalties + totalOther)}</h3><p class="text-[10px] text-red-400">Penalties: ${Utils.currency(totalPenalties)}</p></div>
                            </div>`;

                            const tb = `<div class="bg-white rounded shadow-sm border overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b text-slate-500 font-bold text-xs uppercase"><tr><th class="p-3">Date</th><th class="p-3">Type</th><th class="p-3">Description</th><th class="p-3 text-right">Amount</th></tr></thead><tbody class="divide-y divide-slate-100">${filteredList.length ? filteredList.map(i => `<tr class="hover:bg-slate-50"><td class="p-3 text-slate-500 text-xs whitespace-nowrap">${i.date}</td><td class="p-3"><span class="bg-slate-100 text-slate-600 text-[10px] px-2 py-0.5 rounded border font-bold uppercase">${i.type}</span></td><td class="p-3 font-medium text-slate-700">${i.desc}</td><td class="p-3 text-right font-bold text-emerald-600">+${Utils.currency(i.amount)}</td></tr>`).join('') : UI.empty('No income recorded.', 4)}</tbody></table></div>`;
                            h = mainHeader + stats + tb;
                        
                        } else {
                            // --- VIEW 2: SOURCE PROFITABILITY (ONE ROW PER SOURCE) ---
                            
                            const profitMap = {};
                            
                            // 1. Process Active Loans
                            Data.loans.forEach(l => {
                                let margin = 0;
                                if(l.category === 'Product') {
                                    const invItem = Data.inventory.find(i => i.id === l.productId || (i.name && l.productName && i.name.toLowerCase().trim() === l.productName.toLowerCase().trim()));
                                    if(invItem) {
                                        const dpTx = Data.transactions.find(tx => tx.loanId === l.id && tx.category === 'Down Payment');
                                        const dpAmount = dpTx ? Math.abs(dpTx.amount) : 0;
                                        margin = (l.principal + dpAmount) - invItem.buyPrice;
                                    }
                                }
                                const interestRatio = l.totalRepayable > 0 ? (l.totalRepayable - l.principal) / l.totalRepayable : 0;
                                const realizedInterest = l.paid * interestRatio;
                                profitMap[l.id] = { id: l.id, name: l.memberName, type: 'Loan', status: 'Active', int: realizedInterest, marg: margin, pen: 0 };
                            });

                            // 2. Process Archived Loans
                            Data.archivedLoans.forEach(l => {
                                profitMap[l.id] = { id: l.id, name: l.memberName, type: 'Loan', status: 'Archived', int: 0, marg: 0, pen: 0 };
                            });

                            // 3. Process Groups
                            Data.groups.forEach(g => {
                                profitMap[g.id] = { id: g.id, name: g.name, type: 'Group', status: g.status, int: 0, marg: 0, pen: 0 };
                            });
                            
                            // 4. Process DPS Groups
                            Data.groupDPS.forEach(g => {
                                profitMap[g.id] = { id: g.id, name: g.name, type: 'DPS', status: g.status, int: 0, marg: 0, pen: 0 };
                            });

                            // [REMOVED] 5. Aggregate Penalties from Active Transactions 
                            // This step caused DOUBLE COUNTING because penalties are also in Data.income (Step 6).
                            // We now rely solely on Data.income for penalty aggregation.

                            // 6. Aggregate Data from Income Sheet (One-Row Storage)
                            Data.income.forEach(i => {
                                if(i.refId && profitMap[i.refId]) {
                                    const rec = profitMap[i.refId];
                                    
                                    // Handle Archive Summary (One Row)
                                    if (i.reason === 'Archive Summary') {
                                        if (rec.type === 'Loan') {
                                            const parts = i.remarks.match(/Int:(\d+) Mrg:(\d+) Pen:(\d+)/);
                                            if (parts) {
                                                rec.int += Number(parts[1]) || 0;
                                                rec.marg += Number(parts[2]) || 0;
                                                rec.pen += Number(parts[3]) || 0;
                                            } else {
                                                rec.int += i.amount; // Fallback
                                            }
                                        } else {
                                            // Groups/DPS usually just penalty income
                                            rec.pen += i.amount;
                                        }
                                    } else {
                                        // Legacy Format
                                        const type = (i.sourceType || '').toLowerCase() + (i.reason || '').toLowerCase();
                                        if(type.includes('interest')) rec.int += i.amount;
                                        else if(type.includes('margin') || type.includes('product')) rec.marg += i.amount;
                                        else if(type.includes('penalty') || type.includes('fine') || type.includes('consolidated') || type.includes('group')) rec.pen += i.amount;
                                    }
                                }
                            });

                            // 7. Convert to Array, Filter & Sort
                            const profitList = Object.values(profitMap).filter(p => p.int + p.marg + p.pen > 0); // Hide zero income rows? Optional.
                            const tm = App.searchTerm.toLowerCase();
                            const filteredProfit = profitList.filter(p => !tm || p.name.toLowerCase().includes(tm) || p.id.toLowerCase().includes(tm));
                            filteredProfit.sort((a,b) => (b.int + b.marg + b.pen) - (a.int + a.marg + a.pen));

                            const profitTable = `<div class="bg-white rounded shadow-sm border overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-indigo-50 border-b text-indigo-900 font-bold text-xs uppercase"><tr><th class="p-3 w-24">Source ID</th><th class="p-3">Name / Source</th><th class="p-3 text-center">Type</th><th class="p-3 text-center">Status</th><th class="p-3 text-right">Interest</th><th class="p-3 text-right">Margin</th><th class="p-3 text-right text-red-600">Penalty</th><th class="p-3 text-right bg-indigo-100 text-indigo-800 border-l border-indigo-200">Total Profit</th></tr></thead><tbody class="divide-y divide-slate-100">${filteredProfit.length ? filteredProfit.map(p => {
                                const total = p.int + p.marg + p.pen;
                                const typeBadge = p.type==='Loan'?'bg-blue-100 text-blue-700':(p.type==='Group'?'bg-purple-100 text-purple-700':'bg-teal-100 text-teal-700');
                                return `<tr class="hover:bg-slate-50"><td class="p-3 font-mono text-xs text-slate-500">${p.id}</td><td class="p-3 font-medium text-slate-700">${p.name}</td><td class="p-3 text-center"><span class="text-[9px] px-2 py-0.5 rounded font-bold uppercase ${typeBadge}">${p.type}</span></td><td class="p-3 text-center"><span class="text-[9px] px-2 py-0.5 rounded font-bold uppercase ${p.status==='Active'?'bg-green-50 text-green-600 border border-green-200':'bg-slate-50 text-slate-500 border border-slate-200'}">${p.status}</span></td><td class="p-3 text-right text-slate-600">${Utils.currency(p.int)}</td><td class="p-3 text-right text-slate-600">${Utils.currency(p.marg)}</td><td class="p-3 text-right text-red-500">${Utils.currency(p.pen)}</td><td class="p-3 text-right font-bold text-indigo-700 bg-indigo-50/30 border-l border-indigo-100">${Utils.currency(total)}</td></tr>`;
                            }).join('') : UI.empty('No profitable sources found.', 8)}</tbody></table></div>`;

                            const totalProfit = filteredProfit.reduce((s,p)=>s+p.int+p.marg+p.pen, 0);
                            const summaryBox = `<div class="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm mb-4 text-center"><p class="text-xs text-indigo-500 uppercase font-bold tracking-widest mb-1">Total Lifetime Profit</p><h3 class="text-3xl font-bold text-slate-800">${Utils.currency(totalProfit)}</h3><p class="text-[10px] text-slate-400 mt-2">Active Projected Interest included.</p></div>`;

                            h = mainHeader + summaryBox + profitTable;
                        }
                    }
                }
                else if(App.activeTab==='expenses'){
                    if(App.currentUser.role==='Staff'){h='<div class="text-center p-8 text-slate-400 italic">Access Denied</div>'}else{
                        const ft=localStorage.getItem('mf_exp_filter_type')||'this_month', td=new Date(), y=td.getFullYear(), m=td.getMonth(), sm=new Date(y,m,1).toISOString().split('T')[0], em=new Date(y,m+1,0).toISOString().split('T')[0];
                        let fe=Data.transactions.filter(t=>(t.category==='Expense'||t.category==='Bad Debt')&&sf(t)); if(ft==='today')fe=fe.filter(t=>t.date===Utils.dateToday());else if(ft==='this_month')fe=fe.filter(t=>t.date>=sm&&t.date<=em);
                        const g=fe.filter(t=>t.category==='Expense').reduce((s,t)=>s+Math.abs(t.amount),0), w=fe.filter(t=>t.category==='Bad Debt').reduce((s,t)=>s+Math.abs(t.amount),0);
                        const st=`<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 animate-fadeIn"><div class="bg-red-50 p-4 rounded shadow-sm border border-red-100 flex justify-between items-center"><div><p class="text-xs text-red-600 font-bold uppercase tracking-wider">General Expenses</p><h3 class="text-2xl font-bold text-red-700">${Utils.currency(g)}</h3></div><div class="bg-red-100 p-2 rounded-full text-red-600"><i data-lucide="receipt" class="w-6 h-6"></i></div></div><div class="bg-orange-50 p-4 rounded shadow-sm border border-orange-100 flex justify-between items-center"><div><p class="text-xs text-orange-600 font-bold uppercase tracking-wider">Bad Debts (Write-offs)</p><h3 class="text-2xl font-bold text-orange-700">${Utils.currency(w)}</h3></div><div class="bg-orange-100 p-2 rounded-full text-orange-600"><i data-lucide="alert-triangle" class="w-6 h-6"></i></div></div><div class="bg-slate-800 text-white p-4 rounded shadow-sm border border-slate-700 flex justify-between items-center"><div><p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Total Outflow</p><h3 class="text-2xl font-bold">${Utils.currency(g+w)}</h3></div><div class="bg-slate-700 p-2 rounded-full text-slate-300"><i data-lucide="trending-down" class="w-6 h-6"></i></div></div></div>`;
                        const hd=`<div class="flex flex-col md:flex-row justify-between mb-4 gap-3 items-end md:items-center"><div class="flex items-center gap-3"><h2 class="text-xl font-bold">Expenses & Losses</h2><span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold border border-slate-200">${fe.length}</span></div><div class="flex gap-2 items-center"><div class="relative"><select onchange="localStorage.setItem('mf_exp_filter_type',this.value);App.renderContent()" class="appearance-none bg-white border text-slate-600 pl-3 pr-8 py-2 rounded text-sm focus:outline-none focus:border-blue-500 font-medium cursor-pointer"><option value="this_month" ${ft==='this_month'?'selected':''}>This Month</option><option value="today" ${ft==='today'?'selected':''}>Today</option><option value="all" ${ft==='all'?'selected':''}>All Time</option></select><i data-lucide="calendar" class="absolute right-2 top-2.5 w-4 h-4 text-slate-400 pointer-events-none"></i></div><button onclick="UI.openTransactionModal('OFFICE','Expense','Add Expense')" class="bg-red-600 text-white px-4 py-2 rounded text-sm flex gap-2 items-center shadow-lg hover:bg-red-700 transition"><i data-lucide="plus-circle" class="w-4 h-4"></i> Add Expense</button></div></div>`;
                        h=`${st}${hd}<div class="bg-white rounded shadow-sm border overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b text-slate-500 font-bold text-xs uppercase"><tr><th class="p-3 w-32">Date</th><th class="p-3 w-24">ID</th><th class="p-3">Description / Reference</th><th class="p-3">Type</th><th class="p-3 text-right">Amount</th><th class="p-3 text-center w-20">Action</th></tr></thead><tbody class="divide-y divide-slate-100">${fe.length?fe.map(t=>`<tr class="hover:bg-slate-50 transition"><td class="p-3 text-slate-500 whitespace-nowrap">${t.date}</td><td class="p-3 font-mono text-xs text-slate-400">${t.id}</td><td class="p-3"><div class="font-bold text-slate-700">${t.category==='Bad Debt'?`Write-off: ${t.memberName}`:(t.collectedBy||'Expense')}</div>${t.category==='Bad Debt'?`<div class="text-xs text-slate-400 mt-0.5 cursor-pointer hover:text-blue-500 hover:underline" onclick="App.viewWriteOffDetails('${t.collectedBy}')">${t.collectedBy} <i data-lucide="external-link" class="w-3 h-3 inline"></i></div>`:''}</td><td class="p-3"><span class="${t.category==='Bad Debt'?'bg-orange-100 text-orange-700 border-orange-200':'bg-red-50 text-red-600 border-red-100'} px-2 py-1 rounded text-[10px] font-bold uppercase border">${t.category}</span></td><td class="p-3 text-right font-bold ${t.category==='Bad Debt'?'text-orange-700':'text-red-700'}">${Utils.currency(Math.abs(t.amount))}</td><td class="p-3 text-center">${App.currentUser.role==='Admin'?`<div class="flex justify-center gap-2"><button onclick="App.editTransaction('${t.id}')" class="text-slate-400 hover:text-blue-600 p-1"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="App.deleteEntity('tx','${t.id}')" class="text-slate-400 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`:'-'}</td></tr>`).join(''):UI.empty('No expenses',6)}</tbody></table></div>`;
                    }
                }
                else if(App.activeTab==='transactions'){
                    const vTx=fT.filter(t=>t.category!=='Group DPS Contrib.'), tp=Math.ceil(vTx.length/App.itemsPerPage), st=(App.transactionPage-1)*App.itemsPerPage, pg=vTx.slice(st,st+App.itemsPerPage);
                    const ac=App.currentUser.role==='Admin'?`<div class="flex gap-2"><button onclick="App.viewDeletedItems()" class="text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition shadow-sm"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Deleted</button><button onclick="App.viewEditingHistory()" class="text-slate-600 bg-white hover:bg-slate-50 border border-slate-300 px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition shadow-sm"><i data-lucide="history" class="w-3.5 h-3.5"></i> Logs</button></div>`:'';
                    const hd=UI.header(`<div class="flex items-center gap-2"><h2 class="text-xl font-bold">Transactions</h2><span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold border border-slate-200">${vTx.length}</span></div>`,ac);
                    const pc=vTx.length>0?`<div class="flex justify-between items-center p-3 bg-slate-50 border-t"><button onclick="App.changeTransactionPage(-1)" ${App.transactionPage===1?'disabled':''} class="px-3 py-1 bg-white border rounded shadow-sm text-sm disabled:opacity-50">Previous</button><span class="text-xs text-slate-500 font-bold">Page ${App.transactionPage} of ${Math.max(1,tp)}</span><button onclick="App.changeTransactionPage(1)" ${App.transactionPage>=tp?'disabled':''} class="px-3 py-1 bg-white border rounded shadow-sm text-sm disabled:opacity-50">Next</button></div>`:'';
                    h=`${hd}<div class="bg-white rounded border overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-3">Date</th><th class="p-3">TxID</th><th class="p-3">Name</th><th class="p-3">Against</th><th class="p-3">Amount</th><th class="p-3">Operator</th><th class="p-3 text-right">Action</th></tr></thead><tbody>${pg.map(t=>{const lk=t.category==='Disbursement'||t.category==='Down Payment'||App.currentUser.role==='Staff', rb=`<button onclick="UI.viewReceipt('${t.id}')" class="text-slate-400 hover:text-blue-600 transition-colors p-1" title="Receipt"><i data-lucide="receipt" class="w-4 h-4"></i></button>`, ag=t.loanId==='SAVINGS'?'<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Savings</span>':(t.loanId==='OFFICE'?'<span class="bg-slate-100 text-slate-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Office</span>':(t.loanId==='CAPITAL'?'<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Equity</span>':`<span class="font-mono text-xs bg-slate-50 px-1 rounded border text-slate-600">${t.loanId}</span>`));return`<tr class="border-b hover:bg-slate-50"><td class="p-3 text-xs text-slate-500 whitespace-nowrap">${t.date}</td><td class="p-3 font-mono text-xs font-bold text-slate-600">${t.id}</td><td class="p-3 font-medium">${t.memberName||'Office'} <span class="text-xs text-slate-400">(${t.category})</span></td><td class="p-3">${ag}</td><td class="p-3 font-bold ${(t.amount>0 && t.category !== 'Penalty')?'text-green-600':'text-red-600'}">${Utils.currency(Math.abs(t.amount))}</td><td class="p-3 text-xs text-indigo-600 font-medium">${t.operator}</td><td class="p-3 text-right"><div class="flex items-center justify-end gap-2">${rb}${!lk?`<button onclick="App.editTransaction('${t.id}')" class="text-blue-400 hover:text-blue-600 p-1"><i data-lucide="pencil" class="w-4 h-4"></i></button>`:`<span class="text-slate-300 text-xs italic p-1"><i data-lucide="lock" class="w-3 h-3"></i></span>`}${App.currentUser.role==='Admin'?`<button onclick="App.deleteEntity('tx','${t.id}')" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}</div></td></tr>`}).join('')}</tbody></table>${pc}</div>`;
                }
                else if(App.activeTab==='settings'){
                    if(App.currentUser.role!=='Admin'){h='<div class="text-center p-8 text-slate-400 italic">Admins Only</div>'}else{
                        const cap=fT.filter(t=>t.category==='Capital Injection').reduce((s,t)=>s+t.amount,0)-Math.abs(fT.filter(t=>t.category==='Equity Withdraw').reduce((s,t)=>s+t.amount,0));
                        
                        const controls = `<div class="bg-white p-5 rounded shadow border border-slate-200"><h3 class="font-bold mb-4 border-b pb-2 flex items-center gap-2"><i data-lucide="shield" class="w-5 h-5 text-indigo-600"></i> Global Controls</h3><div class="mb-4"><h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Freeze New Actions</h4><div class="grid grid-cols-2 gap-4"><div class="flex items-center justify-between p-2 bg-slate-50 rounded border"><span class="text-sm font-medium text-slate-700">New Member</span><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="freeze_member" id="freeze_member" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${Data.sysConfig.freeze.member ? 'checked' : ''} onchange="App.toggleSysConfig('freeze', 'member')"/><label for="freeze_member" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></div><div class="flex items-center justify-between p-2 bg-slate-50 rounded border"><span class="text-sm font-medium text-slate-700">New Loan</span><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="freeze_loan" id="freeze_loan" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${Data.sysConfig.freeze.loan ? 'checked' : ''} onchange="App.toggleSysConfig('freeze', 'loan')"/><label for="freeze_loan" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></div><div class="flex items-center justify-between p-2 bg-slate-50 rounded border"><span class="text-sm font-medium text-slate-700">New Group</span><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="freeze_group" id="freeze_group" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${Data.sysConfig.freeze.group ? 'checked' : ''} onchange="App.toggleSysConfig('freeze', 'group')"/><label for="freeze_group" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></div><div class="flex items-center justify-between p-2 bg-slate-50 rounded border"><span class="text-sm font-medium text-slate-700">New DPS</span><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="freeze_dps" id="freeze_dps" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${Data.sysConfig.freeze.dps ? 'checked' : ''} onchange="App.toggleSysConfig('freeze', 'dps')"/><label for="freeze_dps" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></div></div></div><div><h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Pause Operations</h4><div class="grid grid-cols-2 gap-4"><div class="flex items-center justify-between p-2 bg-red-50 rounded border border-red-100"><span class="text-sm font-medium text-slate-700">Savings (In/Out)</span><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="pause_savings" id="pause_savings" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${Data.sysConfig.pause.savings ? 'checked' : ''} onchange="App.toggleSysConfig('pause', 'savings')"/><label for="pause_savings" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></div><div class="flex items-center justify-between p-2 bg-red-50 rounded border border-red-100"><span class="text-sm font-medium text-slate-700">Collections</span><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="pause_collection" id="pause_collection" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${Data.sysConfig.pause.collection ? 'checked' : ''} onchange="App.toggleSysConfig('pause', 'collection')"/><label for="pause_collection" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></div><div class="flex items-center justify-between p-2 bg-red-50 rounded border border-red-100"><span class="text-sm font-medium text-slate-700">Group Cycles</span><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="pause_groupRun" id="pause_groupRun" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${Data.sysConfig.pause.groupRun ? 'checked' : ''} onchange="App.toggleSysConfig('pause', 'groupRun')"/><label for="pause_groupRun" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></div><div class="flex items-center justify-between p-2 bg-red-50 rounded border border-red-100"><span class="text-sm font-medium text-slate-700">DPS Batches</span><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="pause_dpsRun" id="pause_dpsRun" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${Data.sysConfig.pause.dpsRun ? 'checked' : ''} onchange="App.toggleSysConfig('pause', 'dpsRun')"/><label for="pause_dpsRun" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></div></div></div><div class="mt-6 pt-4 border-t border-dashed"><h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Member Restrictions</h4><button onclick="App.openRestrictionManager()" class="w-full bg-slate-800 text-white py-2 rounded text-sm font-bold shadow hover:bg-slate-700 transition flex justify-center items-center gap-2"><i data-lucide="ban" class="w-4 h-4"></i> Manage Block List</button></div></div>`;

                        h=`<div class="max-w-xl mx-auto space-y-4 animate-fadeIn">${controls}<div class="bg-white p-5 rounded shadow border border-indigo-100"><h3 class="font-bold mb-4 border-b pb-2 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5 text-indigo-600"></i> Users</h3><div class="space-y-2 mb-4">${Data.users.map(u=>`<div class="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center font-bold text-xs text-slate-600">${u.name.substring(0,2).toUpperCase()}</div><div><div class="text-sm font-bold text-slate-800">${u.name} ${u.id===App.currentUser.id?'<span class="text-[10px] text-blue-600 bg-blue-50 px-1 rounded ml-1">(You)</span>':''}</div><div class="text-[10px] text-slate-500">${u.role}</div></div></div>${u.id!==App.currentUser.id?`<button onclick="App.deleteUser('${u.id}')" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}</div>`).join('')}</div><button onclick="UI.openModal('modal-user-management')" class="w-full bg-indigo-600 text-white py-2 rounded text-sm font-bold shadow hover:bg-indigo-700 transition">Add User</button></div><div class="bg-white p-5 rounded shadow border"><div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold flex items-center gap-2"><i data-lucide="briefcase" class="w-5 h-5 text-indigo-600"></i> Capital: ${Utils.currency(cap)}</h3></div><div class="grid grid-cols-2 gap-4"><button onclick="UI.openTransactionModal('CAPITAL','Capital Injection','Inject Capital')" class="bg-indigo-600 text-white p-3 rounded text-center shadow"><i data-lucide="arrow-down-circle" class="w-6 h-6 mx-auto mb-1"></i><span class="text-xs font-bold uppercase">Inject</span></button><button onclick="UI.openTransactionModal('CAPITAL','Equity Withdraw','Withdraw Capital')" class="bg-white text-slate-600 border p-3 rounded text-center shadow-sm"><i data-lucide="arrow-up-circle" class="w-6 h-6 mx-auto mb-1"></i><span class="text-xs font-bold uppercase">Withdraw</span></button></div></div><div class="bg-white p-5 rounded shadow border"><h3 class="font-bold mb-4 border-b pb-2">Maintenance</h3><div class="grid grid-cols-2 gap-4 mb-4"><button onclick="App.exportData()" class="bg-green-50 text-green-700 border border-green-200 p-3 rounded text-center font-bold text-sm">Backup</button><button onclick="App.importData()" class="bg-blue-50 text-blue-700 border border-blue-200 p-3 rounded text-center font-bold text-sm">Restore</button></div><button onclick="App.viewDailyReport()" class="w-full bg-white border border-slate-300 text-slate-700 p-3 rounded mb-2 font-bold text-sm flex justify-center items-center gap-2 hover:bg-slate-50 transition shadow-sm"><i data-lucide="file-bar-chart" class="w-4 h-4"></i> Daily Report</button><div class="grid grid-cols-2 gap-2"><button onclick="App.openConsolidateModal()" class="bg-indigo-50 border border-indigo-200 text-indigo-700 p-3 rounded font-bold text-sm flex justify-center items-center gap-2"><i data-lucide="archive" class="w-4 h-4"></i> Consolidate</button><button onclick="App.runIntegrityCheck()" class="bg-orange-50 border border-orange-200 text-orange-700 p-3 rounded font-bold text-sm flex justify-center items-center gap-2"><i data-lucide="activity" class="w-4 h-4"></i> Integrity</button></div><button onclick="App.resetData()" class="text-red-500 text-xs hover:underline w-full text-center mt-3">Factory Reset</button></div><div class="bg-white p-5 rounded shadow border"><h3 class="font-bold mb-4 border-b pb-2">Integrations & Connection</h3><div class="space-y-4"><div><label class="block text-xs font-bold mb-1 text-slate-600">Script URL</label><div class="flex gap-2"><input id="set-script-url" value="${Data.scriptUrl}" class="flex-1 border p-2 rounded text-sm placeholder-slate-400 font-mono text-xs"><button onclick="App.saveScriptUrl()" class="bg-slate-800 text-white px-3 rounded text-xs font-bold hover:bg-slate-700">Save</button></div><div class="mt-2 flex justify-between items-center"><p class="text-[10px] text-slate-400">For sync.</p><button id="btn-test-conn" onclick="App.testConnection()" class="text-xs font-bold text-blue-600 hover:underline flex items-center gap-1"><i data-lucide="wifi" class="w-3 h-3"></i> Test</button></div></div><div class="border-t border-dashed pt-2"><label class="block text-xs font-bold mb-1 text-slate-600">SMS Gateway API Key</label><div class="flex gap-2"><input id="set-sms-key" type="password" value="${Data.smsApiKey}" placeholder="Paste API Key here..." class="flex-1 border p-2 rounded text-sm font-mono text-xs"><button onclick="App.saveSMSKey()" class="bg-slate-800 text-white px-3 rounded text-xs font-bold hover:bg-slate-700">Save</button></div><p class="text-[10px] text-slate-400 mt-1">Provider: smsmobileapi.com (Leave empty to use default SMS app)</p></div><div class="border-t border-dashed pt-2"><label class="block text-xs font-bold mb-1 text-slate-600">Admin Mobile Number</label><div class="flex gap-2"><input id="set-admin-mobile" type="tel" value="${Data.adminMobile}" placeholder="e.g. 017..." class="flex-1 border p-2 rounded text-sm font-mono text-xs"><button onclick="App.saveAdminMobile()" class="bg-slate-800 text-white px-3 rounded text-xs font-bold hover:bg-slate-700">Save</button></div><p class="text-[10px] text-slate-400 mt-1">For receiving system alerts.</p></div></div></div><div class="bg-white p-5 rounded shadow border"><h3 class="font-bold mb-4 border-b pb-2">System Preferences</h3><div class="space-y-4"><div><label class="block text-xs font-bold mb-1">Signature</label><div class="flex gap-2"><input id="set-sig" value="${Data.receiptSignature}" class="flex-1 border p-2 rounded text-sm placeholder-slate-400"><button onclick="localStorage.setItem('mf_receipt_sig',document.getElementById('set-sig').value);Data.receiptSignature=document.getElementById('set-sig').value;Utils.notify('Saved')" class="bg-blue-600 text-white px-4 rounded text-sm font-bold shadow hover:bg-blue-700">Save</button></div></div><div class="flex items-center justify-between p-2 bg-slate-50 rounded border border-slate-100"><label class="text-xs font-bold text-slate-700">Receipt Balance</label><input type="checkbox" ${Data.showBalanceOnReceipt?'checked':''} onchange="localStorage.setItem('mf_show_balance',this.checked);Data.showBalanceOnReceipt=this.checked;Utils.notify('Saved')" class="w-5 h-5 rounded text-blue-600"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold mb-1">Auto-Lock</label><select onchange="const v=Number(this.value);localStorage.setItem('mf_auto_lock_mins',v);Data.autoLockMinutes=v;App.resetIdleTimer();Utils.notify('Updated')" class="w-full border p-2 rounded text-sm bg-white"><option value="1" ${Data.autoLockMinutes===1?'selected':''}>1 Min</option><option value="3" ${Data.autoLockMinutes===3?'selected':''}>3 Mins</option><option value="5" ${Data.autoLockMinutes===5?'selected':''}>5 Mins</option><option value="10" ${Data.autoLockMinutes===10?'selected':''}>10 Mins</option><option value="0" ${Data.autoLockMinutes===0?'selected':''}>Off</option></select></div><div><label class="block text-xs font-bold mb-1">Auto Sync</label><select onchange="localStorage.setItem('mf_sync_mode',this.value);Data.syncMode=this.value;App.resetSyncTimer();Utils.notify('Updated')" class="w-full border p-2 rounded text-sm bg-white"><option value="change" ${Data.syncMode==='change'?'selected':''}>Instant</option><option value="1" ${Data.syncMode==='1'?'selected':''}>1 Min</option><option value="3" ${Data.syncMode==='3'?'selected':''}>3 Mins</option><option value="5" ${Data.syncMode==='5'?'selected':''}>5 Mins</option><option value="0" ${Data.syncMode==='0'?'selected':''}>Manual</option></select></div></div><div class="pt-2 border-t border-dashed mt-2"><label class="block text-xs font-bold mb-1 text-slate-400">Master PIN</label><div class="flex gap-2"><input id="admin-pass" type="password" value="${Data.adminPasscode}" class="flex-1 border p-2 rounded text-sm font-mono"><button onclick="const p=document.getElementById('admin-pass').value;if(p){localStorage.setItem('mf_admin_pass',p);Data.adminPasscode=p;Utils.notify('Saved')}" class="bg-slate-700 text-white px-4 rounded text-sm font-bold shadow hover:bg-slate-800">Update</button></div></div></div></div><div class="bg-white p-5 rounded shadow border"><h3 class="font-bold mb-4 border-b pb-2">Code</h3><div class="bg-slate-100 p-3 rounded text-[10px] font-mono text-slate-500 border cursor-pointer h-16 overflow-hidden hover:bg-slate-200 transition-colors" onclick="App.copyScript()">${Utils.escapeHtml(APPS_SCRIPT_TEMPLATE)}</div><p class="text-[10px] text-center mt-2 text-slate-400">Click to Copy</p></div></div>`;
                    }
                }
                else if(App.activeTab==='archiving'){
                    const hd = UI.header(`<div class="flex items-center gap-3"><h2 class="text-xl font-bold text-slate-700">Archived Records</h2></div>`, 
                    `<div class="flex bg-slate-100 p-1 rounded-lg">
                        <button onclick="App.setArchivingFilter('individual')" class="px-3 py-1.5 rounded-md text-xs font-bold transition ${App.archivingFilter === 'individual' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">Individual</button>
                        <button onclick="App.setArchivingFilter('group')" class="px-3 py-1.5 rounded-md text-xs font-bold transition ${App.archivingFilter === 'group' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">Groups</button>
                    </div>`);

                    let tb = '';
                    if (App.archivingFilter === 'individual') {
                        const s=fA.reduce((a,l)=>{l.category==='Product'?a.p+=l.principal:a.c+=l.principal;return a},{c:0,p:0}), tot=s.c+s.p;
                        const subHeader = `<div class="flex gap-2 text-xs font-bold items-center mb-4"><span class="text-slate-700 bg-slate-100 px-2 py-1 rounded border border-slate-200">Total: ${Utils.currency(tot)}</span><span class="text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100">Cash: ${Utils.currency(s.c)}</span><span class="text-purple-600 bg-purple-50 px-2 py-1 rounded border border-purple-100">Product: ${Utils.currency(s.p)}</span></div>`;
                        const tableContent = fA.length===0?`<div class="text-center p-12 text-slate-400 italic border-2 border-dashed rounded-xl bg-slate-50">No archived loans.</div>`:`<div class="bg-white rounded shadow-sm border overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b text-slate-500 font-bold text-xs uppercase"><tr><th class="p-3">Archived</th><th class="p-3">Loan Date</th><th class="p-3">Loan ID</th><th class="p-3">Member</th><th class="p-3">Type</th><th class="p-3 text-right">Principal</th><th class="p-3 text-center">Statement</th></tr></thead><tbody class="divide-y divide-slate-100">${fA.map(l=>`<tr class="hover:bg-slate-50 transition"><td class="p-3 text-slate-500 whitespace-nowrap text-xs">${l.archivedDate||'-'}</td><td class="p-3 text-slate-800 whitespace-nowrap text-xs font-medium">${l.disbursementDate?l.disbursementDate.split('T')[0]:'-'}</td><td class="p-3 font-mono text-xs text-slate-400">${l.id}</td><td class="p-3 font-medium text-slate-700">${l.memberName} <div class="text-[10px] text-slate-400">ID: ${l.memberId}</div></td><td class="p-3"><div class="flex flex-col gap-1"><span class="text-xs font-bold ${l.category==='Product'?'text-purple-600':'text-blue-600'}">${l.category}</span><span class="text-[10px] text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded w-fit border">${l.loanType}</span></div></td><td class="p-3 text-right font-mono">${Utils.currency(l.principal)}</td><td class="p-3 text-center">${l.driveLink?`<a href="${l.driveLink}" target="_blank" class="text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded text-xs font-bold inline-flex items-center gap-1 transition"><i data-lucide="file-text" class="w-3 h-3"></i> PDF</a>`:`<span class="text-slate-300 text-xs italic">No File</span>`}</td></tr>`).join('')}</tbody></table></div>`;
                        tb = subHeader + tableContent;
                    } else {
                        const archivedGroups = Data.groups.filter(g => g.status === 'Archived' && sf(g));
                        tb = archivedGroups.length === 0 ? `<div class="text-center p-12 text-slate-400 italic border-2 border-dashed rounded-xl bg-slate-50">No archived groups.</div>` : 
                        `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${archivedGroups.map(x => {
                            const c=x.memberIDs.length, h=x.history.length;
                            return `<div class="bg-slate-50 p-4 rounded shadow-sm border border-slate-200 opacity-80 hover:opacity-100 transition"><div class="flex justify-between items-start mb-3"><div><div class="flex items-center gap-2 mb-1"><h3 class="font-bold text-slate-700">${x.name}</h3></div><div class="text-xs text-slate-500 font-mono">${x.frequency} ‚Ä¢ ${Utils.currency(x.contribution)}</div></div><span class="bg-slate-200 text-slate-600 text-[10px] px-2 py-1 rounded font-bold uppercase">Archived</span></div><div class="mb-3 text-xs text-slate-500"><span>Cycles Run: ${h}</span> <span class="mx-1">‚Ä¢</span> <span>Members: ${c}</span></div><div class="flex justify-end pt-3 border-t border-slate-200 border-dashed"><button onclick="App.viewGroupLoanHistory('${x.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center gap-1"><i data-lucide="history" class="w-3 h-3"></i> View History</button></div></div>`
                        }).join('')}</div>`;
                    }
                    h=hd+tb;
                }
                c.innerHTML=h; lucide.createIcons();
            }
        };

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>